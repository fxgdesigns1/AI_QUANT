<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trading Dashboard - Live Market Intelligence</title>
    
    <!-- Bootstrap 5.3 for Toast Notifications -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Socket.IO for Real-time Toast Notifications -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <!-- Chart.js for the price chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        /* CSS Variables for Consistent Theming (Like Crypto Dashboard) */
        :root {
            --primary: #3a86ff;
            --secondary: #8338ec;
            --success: #06d6a0;
            --danger: #ef476f;
            --warning: #ffd166;
            --info: #118ab2;
            --dark: #073b4c;
            --light: #f8f9fa;
            --bg-dark: #0a0a0a;
            --bg-card: #1a1a1a;
            --bg-hover: #2a2a2a;
            --border-color: #444;
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;
            --text-muted: #d0d0d0;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: var(--dark);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .header p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            font-weight: 300;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px 20px;
            background: rgba(15, 15, 35, 0.8);
            border-radius: 12px;
            border: 1px solid #374151;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-running { background-color: var(--success); }
        .status-warning { background-color: var(--warning); }
        .status-offline { background-color: var(--danger); }
        .status-unknown { background-color: var(--text-muted); }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 24px;
            margin-bottom: 30px;
        }

        .main-grid {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        .news-ai-section {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            background-color: var(--bg-hover);
            border-color: var(--primary);
        }

        .card h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 1.6rem;
        }

        .system-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #475569;
            transition: background-color 0.2s ease;
        }

        .system-item:hover {
            background-color: rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            padding: 16px 12px;
            margin: 0 -12px;
        }

        .system-item:last-child {
            border-bottom: none;
        }

        .system-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .system-status {
            display: flex;
            align-items: center;
            font-size: 0.95rem;
            gap: 8px;
        }

        .market-pair {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #475569;
            transition: background-color 0.2s ease;
        }

        .market-pair:hover {
            background-color: rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            padding: 12px 12px;
            margin: 0 -12px;
        }

        .market-pair:last-child {
            border-bottom: none;
        }

        .pair-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .pair-price {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            color: var(--info);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .risk-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .risk-level {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .risk-low { background-color: var(--success); color: var(--text-primary); }
        .risk-medium { background-color: var(--warning); color: var(--text-primary); }
        .risk-high { background-color: var(--danger); color: var(--text-primary); }

        /* Account Details Styling */
        .account-item {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .account-name {
            font-weight: bold;
            color: #f3f4f6;
            font-size: 16px;
        }
        
        .account-balance {
            font-size: 18px;
            font-weight: bold;
            color: #10b981;
        }
        
        .account-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .account-metric {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #374151;
        }
        
        .account-metric:last-child {
            border-bottom: none;
        }
        
        .account-metric span:first-child {
            color: #9ca3af;
        }
        
        .account-metric span:last-child {
            color: #f3f4f6;
            font-weight: 500;
        }
        
        .positions-list {
            margin-top: 10px;
        }
        
        .position-item {
            background: #111827;
            border: 1px solid #374151;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }
        
        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .position-pair {
            font-weight: bold;
            color: #f3f4f6;
        }
        
        .position-side {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .position-side.buy {
            background: #065f46;
            color: #10b981;
        }
        
        .position-side.sell {
            background: #7f1d1d;
            color: #f87171;
        }
        
        .position-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 8px;
            font-size: 12px;
        }

        .news-item {
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .news-item:last-child {
            border-bottom: none;
        }

        .news-time {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .news-summary {
            margin-top: 5px;
            color: #495057;
        }

        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #28a745;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: white;
            opacity: 0.8;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(15, 15, 35, 0.95);
            padding: 12px 18px;
            border-radius: 25px;
            font-size: 0.9rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            border: 1px solid #374151;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        .connection-connected {
            color: #10b981;
        }

        .connection-disconnected {
            color: #ef4444;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .metric-item:last-child {
            border-bottom: none;
        }

        .metric-value {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #2d3748;
        }

        /* NEW: Cloud System Integration Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
            margin-left: 10px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider-toggle {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #6b7280;
            transition: .4s;
            border-radius: 30px;
        }

        .slider-toggle:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider-toggle {
            background-color: #10b981;
        }

        input:checked + .slider-toggle:before {
            transform: translateX(30px);
        }

        .toggle-switch-small {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
            margin-left: 8px;
        }

        .toggle-switch-small input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider-toggle-small {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #6b7280;
            transition: .4s;
            border-radius: 20px;
        }

        .slider-toggle-small:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider-toggle-small {
            background-color: #10b981;
        }

        input:checked + .slider-toggle-small:before {
            transform: translateX(20px);
        }

        .risk-slider {
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: #374151;
            outline: none;
            -webkit-appearance: none;
        }

        .risk-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }

        .risk-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }

        .api-gauge {
            margin-bottom: 15px;
        }

        .gauge-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: white;
        }

        .gauge-bar {
            width: 100%;
            height: 20px;
            background-color: #374151;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .gauge-fill {
            height: 100%;
            transition: width 0.5s ease, background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .gauge-fill.green { background-color: #10b981; }
        .gauge-fill.yellow { background-color: #f59e0b; }
        .gauge-fill.red { background-color: #ef4444; }

        .gauge-remaining {
            margin-top: 5px;
            font-size: 0.85rem;
            color: #9ca3af;
        }

        .news-countdown {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #ef4444;
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
        }

        .ai-recommendation {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #10b981;
            box-shadow: 0 4px 16px rgba(5, 150, 105, 0.3);
        }

        #newsTimer {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-weight: 700;
            color: #ffffff;
            font-size: 1.2rem;
        }

        #tradePhase {
            font-weight: 700;
            color: #ffffff;
            font-size: 1.1rem;
        }

        .impact-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .impact-item {
            padding: 8px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.9rem;
        }

        .impact-item:last-child {
            border-bottom: none;
        }

        .impact-time {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .impact-high { color: #dc3545; }
        .impact-medium { color: #ffc107; }
        .impact-low { color: #28a745; }

        /* Enhanced Trading Details Styles */
        .trading-details-section {
            margin: 30px 0;
            grid-column: 1 / -1;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .trade-item {
            background: rgba(15, 15, 35, 0.6);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #374151;
            transition: all 0.2s ease;
        }

        .trade-item:hover {
            background: rgba(15, 15, 35, 0.8);
            border-color: #00d4ff;
        }

        .trade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .strategy-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .ultra-strict { background: #059669; color: white; }
        .gold-scalp { background: #dc2626; color: white; }
        .momentum { background: #7c3aed; color: white; }

        .trade-time {
            font-size: 0.9rem;
            color: #94a3b8;
            font-family: monospace;
        }

        .trade-details {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
            align-items: center;
        }

        .trade-pair {
            font-weight: 600;
            color: var(--info);
            font-size: 1.1rem;
        }

        .trade-levels {
            font-family: monospace;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .trade-status {
            text-align: right;
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .trade-status.profit {
            background: rgba(5, 150, 105, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
        }

        .trade-status.drawdown {
            background: rgba(220, 38, 38, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .strategy-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .strategy-name {
            font-size: 0.85rem;
            color: #94a3b8;
            font-weight: 500;
        }

        .enhanced-market-pair {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #475569;
            transition: background-color 0.2s ease;
        }

        .enhanced-market-pair:hover {
            background-color: rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            padding: 12px 12px;
            margin: 0 -12px;
        }

        .enhanced-market-pair:last-child {
            border-bottom: none;
        }

        /* AI Assistant Widget (scoped) */
        .ai-assistant-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 360px;
            max-height: 60vh;
            background: rgba(17, 24, 39, 0.95);
            border: 1px solid #374151;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            z-index: 1100;
            overflow: hidden;
        }
        .ai-assistant-header {
            padding: 12px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #111827;
            border-bottom: 1px solid #374151;
        }
        .ai-assistant-title { font-weight: 600; }
        .ai-mode-badge { font-size: 12px; color: #10b981; }
        .chat-messages { padding: 10px; overflow-y: auto; flex: 1; font-size: 14px; }
        .chat-input { display: flex; gap: 8px; padding: 10px; border-top: 1px solid #374151; }
        .chat-input textarea { flex: 1; resize: none; height: 48px; background: #0b1220; color: #e5e7eb; border: 1px solid #1f2937; border-radius: 8px; padding: 8px; }
        .send-button { background: #2563eb; color: white; border: none; border-radius: 8px; padding: 0 14px; cursor: pointer; }
        .command-preview { background: #0b1220; border: 1px solid #374151; border-radius: 8px; padding: 8px; margin: 8px 0; }
        
        .confirmation-panel {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }
        
        .confirmation-preview {
            margin-bottom: 8px;
            font-size: 14px;
            color: #92400e;
        }
        
        .confirmation-buttons {
            display: flex;
            gap: 8px;
        }
        
        .confirm-btn, .cancel-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .confirm-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .confirm-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .cancel-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .cancel-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        
        /* Trading Signals */
        .trading-signals {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .signal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 8px;
            border: 1px solid #475569;
        }
        
        .signal-pair {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .signal-action {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .signal-confidence {
            color: #94a3b8;
            font-size: 0.9rem;
        }
        .confirm-row { display: flex; gap: 8px; }
        .confirm-button { background: #10b981; color: white; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; }
        .cancel-button { background: #ef4444; color: white; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; }
        .live-guard { color: #f59e0b; font-size: 12px; margin-top: 6px; }
        
        /* Contextual Insights Styles */
        #contextual-insights { padding: 16px; }
        .context-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
        }
        .context-label { color: #94a3b8; font-weight: 600; }
        .context-value { color: #e2e8f0; font-weight: 700; }
        .key-levels { margin-top: 20px; padding-top: 16px; border-top: 2px solid rgba(168, 85, 247, 0.3); }
        .key-levels h4 { color: #a855f7; margin-bottom: 12px; }
        .levels-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px; }
        .level-group { background: rgba(168, 85, 247, 0.1); padding: 12px; border-radius: 8px; }
        .level-label { color: #94a3b8; font-size: 0.85rem; margin-bottom: 4px; }
        .level-values { color: #e2e8f0; font-weight: 600; font-size: 0.9rem; }
        .trend-indicator { background: rgba(96, 165, 250, 0.1); padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; }
        .trend-value { font-weight: 700; text-transform: uppercase; }

        /* Sidebar and Main Content Layout (Like Crypto Dashboard) */
        .navbar {
            background-color: var(--dark);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .sidebar {
            background-color: var(--bg-card);
            height: calc(100vh - 56px);
            width: 250px;
            position: fixed;
            left: 0;
            top: 56px;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
        }

        .sidebar-heading {
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 1rem 1rem 0.5rem;
            margin-top: 1rem;
        }

        .sidebar .nav-link {
            color: var(--text-secondary);
            padding: 0.75rem 1rem;
            border-radius: 0;
            transition: all 0.2s;
        }

        .sidebar .nav-link:hover {
            background-color: var(--bg-hover);
            color: var(--text-primary);
        }

        .sidebar .nav-link.active {
            background-color: var(--primary);
            color: white;
        }

        .main-content {
            margin-left: 250px;
            padding: 2rem;
            min-height: calc(100vh - 56px);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* ========================================= */
        /* HYBRID MANUAL TRADING - OPPORTUNITY CARDS */
        /* ========================================= */
        
        .opportunity-card {
            background: linear-gradient(135deg, rgba(58, 134, 255, 0.1) 0%, rgba(131, 56, 236, 0.1) 100%);
            border: 1px solid #3a86ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(58, 134, 255, 0.2);
        }
        
        .opportunity-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(58, 134, 255, 0.4);
            border-color: #60a5fa;
        }
        
        .opportunity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(58, 134, 255, 0.3);
        }
        
        .opportunity-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3a86ff;
        }
        
        .quality-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .quality-excellent { background: linear-gradient(135deg, #06d6a0, #047857); color: white; }
        .quality-good { background: linear-gradient(135deg, #3a86ff, #1e40af); color: white; }
        .quality-moderate { background: linear-gradient(135deg, #ffd166, #d97706); color: white; }
        .quality-weak { background: linear-gradient(135deg, #ef476f, #991b1b); color: white; }
        
        .opportunity-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .detail-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #3a86ff;
        }
        
        .detail-label {
            color: #d0d0d0;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }
        
        .detail-value {
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .sniper-zone-indicator {
            background: linear-gradient(135deg, #06d6a0, #047857);
            padding: 10px 15px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .pros-cons-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .pros-box {
            background: rgba(6, 214, 160, 0.1);
            border: 1px solid #06d6a0;
            border-radius: 8px;
            padding: 15px;
        }
        
        .cons-box {
            background: rgba(239, 71, 111, 0.1);
            border: 1px solid #ef476f;
            border-radius: 8px;
            padding: 15px;
        }
        
        .pros-box h5, .cons-box h5 {
            margin-bottom: 12px;
            font-size: 1rem;
        }
        
        .pros-box h5 { color: #06d6a0; }
        .cons-box h5 { color: #ef476f; }
        
        .pros-box li, .cons-box li {
            color: #ccc;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .recommendation-bar {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .rec-strong-buy { background: linear-gradient(135deg, #06d6a0, #047857); color: white; }
        .rec-buy { background: linear-gradient(135deg, #3a86ff, #1e40af); color: white; }
        .rec-consider { background: linear-gradient(135deg, #ffd166, #d97706); color: white; }
        .rec-avoid { background: linear-gradient(135deg, #ef476f, #991b1b); color: white; }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
        }
        
        .btn-approve {
            background: linear-gradient(135deg, #06d6a0, #047857);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-approve:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(6, 214, 160, 0.5);
        }
        
        .btn-dismiss {
            background: linear-gradient(135deg, #ef476f, #991b1b);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-dismiss:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(239, 71, 111, 0.5);
        }
        
        .btn-watch {
            background: linear-gradient(135deg, #ffd166, #d97706);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-watch:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 209, 102, 0.5);
        }
        
        .tp-stages {
            background: rgba(131, 56, 236, 0.1);
            border: 1px solid #8338ec;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .tp-stage-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(131, 56, 236, 0.2);
        }
        
        .tp-stage-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-graph-up me-2"></i>
                AI Trading Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="refreshData">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            Refresh Data
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="bi bi-gear me-1"></i>
                            Settings
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    
    <div class="sidebar">
        <div class="p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="m-0">Market Overview</h5>
                <span class="badge bg-success" id="connectionStatus">Live</span>
            </div>
            <div id="marketOverview">
                <!-- Market overview will be loaded here -->
            </div>
        </div>
        
        <div class="sidebar-heading">Navigation</div>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="#dashboard" data-section="dashboard">
                    <i class="bi bi-speedometer2 me-2"></i>
                    Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#accounts" data-section="accounts">
                    <i class="bi bi-briefcase me-2"></i>
                    Accounts
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#strategies" data-section="strategies">
                    <i class="bi bi-graph-up me-2"></i>
                    Strategies
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#positions" data-section="positions">
                    <i class="bi bi-bar-chart me-2"></i>
                    Positions
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#signals" data-section="signals">
                    <i class="bi bi-bullseye me-2"></i>
                    Trading Signals
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#news" data-section="news">
                    <i class="bi bi-newspaper me-2"></i>
                    News & Events
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#trade-manager" data-section="trade-manager">
                    <i class="bi bi-sliders me-2"></i>
                    Trade Manager
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#system-status" data-section="system-status">
                    <i class="bi bi-heart-pulse me-2"></i>
                    System Status
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#insights" data-section="insights">
                    <i class="bi bi-lightbulb me-2"></i>
                    AI Insights
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#strategy-switcher" data-section="strategy-switcher">
                    <i class="bi bi-shuffle me-2"></i>
                    Strategy Switcher
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#analytics" data-section="analytics">
                    <i class="bi bi-graph-up-arrow me-2"></i>
                    Analytics
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#config" data-section="config">
                    <i class="bi bi-gear me-2"></i>
                    Configuration
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#ai-copilot" data-section="ai-copilot">
                    <i class="bi bi-robot me-2"></i>
                    AI Copilot
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#reports" data-section="reports">
                    <i class="bi bi-file-earmark-bar-graph me-2"></i>
                    Reports & Analytics
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#performance" data-section="performance">
                    <i class="bi bi-graph-up-arrow me-2"></i>
                    Performance Monitoring
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#roadmap" data-section="roadmap">
                    <i class="bi bi-calendar-check me-2"></i>
                    Weekly Roadmap
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#trade-history" data-section="trade-history">
                    <i class="bi bi-clock-history me-2"></i>
                    Trade History
                </a>
            </li>
        </ul>
    </div>
    
    <div class="main-content">
        <section id="dashboard" class="content-section active">
            <div class="container-fluid">
                <div class="header">
                    <h1>ü§ñ AI Trading Dashboard</h1>
                    <p>Live Market Intelligence & Automated Trading System</p>
                    <div class="status-bar">
                        <div>
                            <span class="live-indicator"></span>
                            <span>Live Trading Active</span>
                        </div>
                        <div>
                            <a href="/strategy-manager" style="color: #a855f7; text-decoration: none; padding: 8px 16px; background: rgba(168, 85, 247, 0.1); border-radius: 8px; border: 1px solid #a855f7; margin-right: 10px; transition: all 0.2s; font-weight: 600;" onmouseover="this.style.background='rgba(168, 85, 247, 0.2)'" onmouseout="this.style.background='rgba(168, 85, 247, 0.1)'">
                                ‚öôÔ∏è Strategy Manager
                            </a>
                            <a href="/strategies" style="color: #60a5fa; text-decoration: none; padding: 8px 16px; background: rgba(96, 165, 250, 0.1); border-radius: 8px; border: 1px solid #60a5fa; margin-right: 15px; transition: all 0.2s;" onmouseover="this.style.background='rgba(96, 165, 250, 0.2)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.1)'">
                                üìä Strategy Performance
                            </a>
                            <span>Last Update: <span id="lastUpdate">Loading...</span></span>
                        </div>
                    </div>
                </div>

                <!-- NEW: AI System Performance Panel -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); border: 2px solid #3b82f6;">
                            <div class="card-header" style="background: transparent; border: none; color: white; font-weight: 600;">
                                ü§ñ AI System Performance
                            </div>
                            <div class="card-body" id="cloudPerformance" style="color: white;">
                                <div style="text-align: center; padding: 20px;">
                                    <div class="spinner-border text-light" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                    <div style="margin-top: 10px;">Loading cloud system status...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card" style="background: var(--bg-card);">
                            <div class="card-header" style="background: transparent; border-bottom: 1px solid var(--border-color); color: white;">
                                üìä API Usage Monitoring
                            </div>
                            <div class="card-body" id="apiUsage" style="color: white;">
                                <div style="text-align: center; padding: 20px;">
                                    <div class="spinner-border text-light" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                    <div style="margin-top: 10px;">Loading API usage...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEW: Trading Controls Panel -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card" style="background: var(--bg-card);">
                            <div class="card-header d-flex justify-content-between align-items-center" style="background: transparent; border-bottom: 1px solid var(--border-color); color: white;">
                                <span style="font-weight: 600;">üéõÔ∏è Trading Controls</span>
                                <button class="btn btn-sm btn-outline-light" onclick="toggleControls()">
                                    <span id="controlsToggleIcon">‚ñº</span>
                                </button>
                            </div>
                            <div class="card-body" id="tradingControls" style="color: white;">
                                <div class="row">
                                    <div class="col-md-3">
                                        <h6 style="color: white; margin-bottom: 15px;">üéØ Master Controls</h6>
                                        <div style="margin-bottom: 10px;">
                                            <label style="color: white;">Master Trading:</label>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="masterTradingToggle" checked onchange="toggleMasterTrading()">
                                                <span class="slider-toggle"></span>
                                            </label>
                                            <span id="masterTradingStatus" style="margin-left: 10px; color: #10b981;">ON</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <h6 style="color: white; margin-bottom: 15px;">üìà Strategy Controls</h6>
                                        <div style="margin-bottom: 8px;">
                                            <label style="color: white; font-size: 0.9rem;">Ultra Forex:</label>
                                            <label class="toggle-switch-small">
                                                <input type="checkbox" id="ultraForexToggle" checked onchange="toggleStrategy('ultra_forex')">
                                                <span class="slider-toggle-small"></span>
                                            </label>
                                        </div>
                                        <div style="margin-bottom: 8px;">
                                            <label style="color: white; font-size: 0.9rem;">Gold Scalping:</label>
                                            <label class="toggle-switch-small">
                                                <input type="checkbox" id="goldScalpToggle" checked onchange="toggleStrategy('gold_scalping')">
                                                <span class="slider-toggle-small"></span>
                                            </label>
                                        </div>
                                        <div style="margin-bottom: 8px;">
                                            <label style="color: white; font-size: 0.9rem;">Momentum:</label>
                                            <label class="toggle-switch-small">
                                                <input type="checkbox" id="momentumToggle" checked onchange="toggleStrategy('momentum')">
                                                <span class="slider-toggle-small"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 style="color: white; margin-bottom: 15px;">‚öñÔ∏è Risk Parameters</h6>
                                        <div style="margin-bottom: 12px;">
                                            <label style="color: white; display: block; margin-bottom: 5px;">
                                                Max Risk Per Trade: <span id="riskValue">1.5%</span>
                                            </label>
                                            <input type="range" class="risk-slider" id="riskSlider" min="0.5" max="2" step="0.1" value="1.5" oninput="updateRisk(this.value)">
                                        </div>
                                        <div style="margin-bottom: 12px;">
                                            <label style="color: white; display: block; margin-bottom: 5px;">
                                                Max Portfolio Risk: <span id="portfolioRiskValue">10%</span>
                                            </label>
                                            <input type="range" class="risk-slider" id="portfolioRiskSlider" min="5" max="15" step="0.5" value="10" oninput="updatePortfolioRisk(this.value)">
                                        </div>
                                        <div>
                                            <label style="color: white; display: block; margin-bottom: 5px;">
                                                Max Positions: <span id="maxPosValue">5</span>
                                            </label>
                                            <input type="range" class="risk-slider" id="maxPosSlider" min="1" max="10" step="1" value="5" oninput="updateMaxPos(this.value)">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Price Chart Section -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between">
                                <span>Price Chart: <span id="chartInstrument">EUR_USD</span></span>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary active" data-timeframe="1h">1h</button>
                                    <button class="btn btn-sm btn-outline-primary" data-timeframe="4h">4h</button>
                                    <button class="btn btn-sm btn-outline-primary" data-timeframe="1d">1d</button>
                                    <a id="tvLink" class="btn btn-sm btn-outline-secondary" target="_blank" rel="noopener noreferrer" style="margin-left: 6px;">
                                        TradingView ‚Üó
                                    </a>
                                </div>
                            </div>
                            <div class="card-body">
                                <canvas id="priceChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!-- Trading Signals -->
                        <div class="card">
                            <div class="card-header">Trading Signals</div>
                            <div class="card-body" id="tradingSignals">
                                <div style="text-align: center; padding: 20px; color: #666;">
                                    <div style="font-size: 18px; margin-bottom: 10px;">üìä</div>
                                    <div>Loading trading signals...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Keep existing dashboard content below -->
                <!-- Main Trading Overview -->
                <div class="main-grid">
                    <!-- Live Market Data -->
                    <div class="card market-data-section live-market-data">
                        <h3><span class="card-icon">üí±</span>Live Market Data</h3>
                        <div id="marketData">
                            <div class="enhanced-market-pair">
                                <div class="strategy-info">
                                    <div class="strategy-name">Ultra Strict Forex</div>
                                    <div class="pair-name">EUR/USD</div>
                                </div>
                                <div class="pair-price">Loading...</div>
                            </div>
                            <div class="enhanced-market-pair">
                                <div class="strategy-info">
                                    <div class="strategy-name">Gold Scalping</div>
                                    <div class="pair-name">XAU/USD</div>
                                </div>
                                <div class="pair-price">Loading...</div>
                            </div>
                            <div class="enhanced-market-pair">
                                <div class="strategy-info">
                                    <div class="strategy-name">Momentum Trading</div>
                                    <div class="pair-name">GBP/USD</div>
                                </div>
                                <div class="pair-price">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Trading Systems Status -->
                    <div class="card trading-systems-section trading-systems">
                        <h3><span class="card-icon">üìä</span>Trading Systems</h3>
                        <div id="systemsStatus">
                            <div class="system-item">
                                <div class="system-name">Ultra Strict Forex</div>
                                <div class="system-status">
                                    <span class="status-indicator status-unknown"></span>
                                    <span>Initializing...</span>
                                </div>
                            </div>
                            <div class="system-item">
                                <div class="system-name">Gold Scalping</div>
                                <div class="system-status">
                                    <span class="status-indicator status-offline"></span>
                                    <span>Offline</span>
                                </div>
                            </div>
                            <div class="system-item">
                                <div class="system-name">Momentum Trading</div>
                                <div class="system-status">
                                    <span class="status-indicator status-offline"></span>
                                    <span>Offline</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Trades & Signals Section -->
                <div class="trading-details-section">
                    <div class="card full-width trading-signals-section">
                        <h3><span class="card-icon">üìä</span>Active Trades & Signals</h3>
                        <div id="activeTradesData">
                            <!-- Live trading data will be populated here via JavaScript -->
                            <div class="no-trades-message" style="text-align: center; padding: 40px; color: #666;">
                                <div style="font-size: 24px; margin-bottom: 10px;">üìä</div>
                                <div>Loading live trading data...</div>
                                <div style="font-size: 12px; margin-top: 10px;">Connecting to OANDA accounts</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========================================= -->
                <!-- HYBRID MANUAL TRADING - AI OPPORTUNITIES  -->
                <!-- ========================================= -->
                <div style="margin-top: 30px; margin-bottom: 30px;">
                    <div class="card" style="border: 2px solid #3a86ff; box-shadow: 0 4px 20px rgba(58, 134, 255, 0.3);">
                        <h3 style="color: #3a86ff; font-size: 1.8rem; margin-bottom: 25px;">
                            <span class="card-icon">üéØ</span>AI Trade Opportunities - Manual Approval
                            <span style="float: right; font-size: 0.9rem; font-weight: normal; color: #999;">
                                <span id="opportunityCount">0</span> Active | 
                                <span id="autoCount">0</span> Auto Queue
                            </span>
                        </h3>
                        
                        <!-- Mode Selector -->
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(58, 134, 255, 0.1); border-radius: 8px; border-left: 4px solid #3a86ff;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: #3a86ff;">Trading Mode:</strong>
                                    <select id="tradingMode" style="margin-left: 10px; padding: 8px 15px; background: #2a2a2a; color: white; border: 1px solid #444; border-radius: 6px; font-size: 14px;">
                                        <option value="manual" selected>üéØ Manual Approval (You Choose)</option>
                                        <option value="auto">ü§ñ Auto Execute (AI Decides)</option>
                                        <option value="hybrid">‚ö° Hybrid (Auto on 80+ Quality)</option>
                                    </select>
                                </div>
                                <div style="text-align: right;">
                                    <span style="color: #999;">Today: </span>
                                    <span id="dailyTargetProgress" style="color: #06d6a0; font-weight: bold;">$0 / $700</span>
                                    <span style="color: #999; margin-left: 15px;">Week: </span>
                                    <span id="weeklyTargetProgress" style="color: #06d6a0; font-weight: bold;">$0 / $2,500</span>
                                </div>
                            </div>
                        </div>

                        <!-- Opportunities Feed -->
                        <div id="opportunitiesFeed" style="min-height: 200px;">
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üîç</div>
                                <div style="font-size: 18px; margin-bottom: 10px;">AI is scanning for opportunities...</div>
                                <div style="font-size: 14px; color: #999;">High-quality setups will appear here</div>
                            </div>
                        </div>
                        
                        <!-- Cleaner Dashboard - Reports moved to separate menu -->
                        
                        <!-- A/B Lane Comparison -->
                        <div style="margin-top: 30px; padding: 20px; background: rgba(131, 56, 236, 0.1); border-radius: 12px; border: 1px solid #8338ec;">
                            <h4 style="color: #8338ec; margin-bottom: 15px; font-size: 1.3rem;">
                                üìä Performance Comparison: Manual vs Auto
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <!-- Manual Lane -->
                                <div style="padding: 20px; background: rgba(6, 214, 160, 0.1); border-radius: 8px; border: 1px solid #06d6a0;">
                                    <div style="font-size: 1.1rem; font-weight: bold; color: #06d6a0; margin-bottom: 15px;">
                                        üéØ MANUAL (Your Picks)
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333;">
                                        <span style="color: #999;">Opportunities Shown:</span>
                                        <span id="manualOppsShown" style="color: white; font-weight: bold;">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333;">
                                        <span style="color: #999;">You Approved:</span>
                                        <span id="manualApproved" style="color: #06d6a0; font-weight: bold;">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333;">
                                        <span style="color: #999;">Win Rate:</span>
                                        <span id="manualWinRate" style="color: #06d6a0; font-weight: bold; font-size: 1.3rem;">--%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333;">
                                        <span style="color: #999;">Profit:</span>
                                        <span id="manualProfit" style="color: #06d6a0; font-weight: bold; font-size: 1.3rem;">$0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                        <span style="color: #999;">Avg Quality:</span>
                                        <span id="manualAvgQuality" style="color: white; font-weight: bold;">--/100</span>
                                    </div>
                                </div>
                                
                                <!-- Auto Lane -->
                                <div style="padding: 20px; background: rgba(239, 71, 111, 0.1); border-radius: 8px; border: 1px solid #ef476f;">
                                    <div style="font-size: 1.1rem; font-weight: bold; color: #ef476f; margin-bottom: 15px;">
                                        ü§ñ AUTO (AI Would Execute)
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333;">
                                        <span style="color: #999;">Opportunities:</span>
                                        <span id="autoOppsTotal" style="color: white; font-weight: bold;">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333;">
                                        <span style="color: #999;">Would Execute:</span>
                                        <span id="autoWouldExecute" style="color: #ef476f; font-weight: bold;">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333;">
                                        <span style="color: #999;">Win Rate (Est):</span>
                                        <span id="autoWinRate" style="color: #ffd166; font-weight: bold; font-size: 1.3rem;">--%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333;">
                                        <span style="color: #999;">Profit (Est):</span>
                                        <span id="autoProfit" style="color: #ffd166; font-weight: bold; font-size: 1.3rem;">$0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                        <span style="color: #999;">Avg Quality:</span>
                                        <span id="autoAvgQuality" style="color: white; font-weight: bold;">--/100</span>
                                    </div>
                                </div>
                            </div>
                            <div id="abComparison" style="margin-top: 15px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; text-align: center; font-size: 1.2rem;">
                                <span style="color: #999;">Performance Difference: </span>
                                <span id="performanceDiff" style="color: #06d6a0; font-weight: bold;">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Insights & Trade Ideas (Full-width Row) -->
                <div class="dashboard-grid">
                    <div class="card full-width" id="insightsSection">
                        <h3><span class="card-icon">üß≠</span>Market Insights</h3>
                        <div id="dashboardInsightsContent">
                            <div style="text-align: center; padding: 16px; color: #94a3b8;">Loading live insights‚Ä¶</div>
                        </div>
                    </div>
                    <div class="card full-width" id="tradeIdeasSection">
                        <h3><span class="card-icon">üí°</span>Trade Ideas</h3>
                        <div id="tradeIdeasContent">
                            <div style="text-align: center; padding: 16px; color: #94a3b8;">Loading live trade ideas‚Ä¶</div>
                        </div>
                    </div>
                </div>

                <!-- News & AI Insights Section -->
                <div class="news-ai-section">
                    <!-- AI Insights & Recommendations -->
                    <div class="card">
                        <h3><span class="card-icon">üß†</span>AI Insights & Recommendations</h3>
                        <div id="newsImpact">
                            <div class="ai-recommendation">
                                <span>Current AI Trade Phase:</span>
                                <span id="tradePhase">Analyzing market conditions...</span>
                            </div>
                            <div class="news-countdown">
                                <span>Next Major News Event:</span>
                                <span id="newsTimer">No upcoming news</span>
                            </div>
                            <div class="impact-list" id="upcomingNews">
                                <div class="impact-item">
                                    <div class="impact-time">Loading AI analysis...</div>
                                    <div class="impact-medium">System initializing</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Market Context & Quality Insights -->
                    <div class="card">
                        <h3><span class="card-icon">üéØ</span>Market Context & Quality Insights</h3>
                        <div id="contextual-insights">
                            <div class="context-item">
                                <div class="context-label">Session Quality:</div>
                                <div id="session-quality-value" class="context-value">--</div>
                            </div>
                            <div class="context-item">
                                <div class="context-label">Active Sessions:</div>
                                <div id="active-sessions-value" class="context-value">--</div>
                            </div>
                            <div class="context-item">
                                <div class="context-label">Session Description:</div>
                                <div id="session-description" class="context-value">--</div>
                            </div>
                            <div class="key-levels">
                                <h4>Key Levels</h4>
                                <div class="levels-row">
                                    <div class="level-group">
                                        <div class="level-label">Support:</div>
                                        <div id="support-levels" class="level-values">--</div>
                                    </div>
                                    <div class="level-group">
                                        <div class="level-label">Resistance:</div>
                                        <div id="resistance-levels" class="level-values">--</div>
                                    </div>
                                </div>
                                <div class="trend-indicator">
                                    <div class="level-label">Trend:</div>
                                    <div id="trend-direction" class="trend-value">--</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Live News Feed -->
                    <div class="card news-section live-news-feed">
                        <h3><span class="card-icon">üì∞</span>Live News Feed</h3>
                        <div id="newsAlerts">
                            <div class="news-item">
                                <div class="news-time">Just now</div>
                                <div class="news-summary">AI Trading System Online - Monitoring markets</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance & Risk Metrics -->
                <div class="dashboard-grid">
                    <!-- Trading Performance -->
                    <div class="card">
                        <h3><span class="card-icon">üìà</span>Trading Performance</h3>
                        <div id="tradingMetrics">
                            <div class="metric-item">
                                <span>Win Rate (24h):</span>
                                <span class="metric-value">Loading...</span>
                            </div>
                            <div class="metric-item">
                                <span>Avg Trade Duration:</span>
                                <span class="metric-value">Loading...</span>
                            </div>
                            <div class="metric-item">
                                <span>Risk/Reward Ratio:</span>
                                <span class="metric-value">Loading...</span>
                            </div>
                            <div class="metric-item">
                                <span>Success Rate:</span>
                                <span class="metric-value">Loading...</span>
                            </div>
                            <div class="metric-item">
                                <span>Profit Factor:</span>
                                <span class="metric-value">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Management -->
                    <div class="card">
                        <h3><span class="card-icon">üõ°Ô∏è</span>Risk Management</h3>
                        <div id="riskMetrics">
                            <div class="risk-metric">
                                <span>Portfolio Risk:</span>
                                <span class="risk-level risk-low">Loading...</span>
                            </div>
                            <div class="risk-metric">
                                <span>Open Positions:</span>
                                <span>Loading...</span>
                            </div>
                            <div class="risk-metric">
                                <span>Daily Trades:</span>
                                <span>Loading...</span>
                            </div>
                            <div class="risk-metric">
                                <span>Account Balance:</span>
                                <span>Loading...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Individual Account Details -->
                    <div class="card full-width">
                        <h3><span class="card-icon">üè¶</span>Individual OANDA Account Details</h3>
                        <div id="accountDetails">
                            <div class="account-loading">
                                <div style="text-align: center; padding: 20px; color: #666;">
                                    <div style="font-size: 18px; margin-bottom: 10px;">üìä</div>
                                    <div>Loading individual account balances...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="footer">
                    <p>üöÄ Google Cloud Trading System - Live OANDA Integration</p>
                    <p>Production Ready ‚Ä¢ Real-time Trading ‚Ä¢ Risk Managed</p>
                </div>
            </div>
        </section>
        
        <!-- Additional sections for other navigation items -->
        <section id="accounts" class="content-section">
            <div class="container-fluid" style="padding: 20px; background: var(--bg-dark); min-height: 600px;">
                <h2 style="color: #fff; margin-bottom: 30px; font-size: 2rem;">üìä Account Management</h2>
                <div id="accountsGrid" class="row"></div>
            </div>
        </section>

        <script>
        async function loadAccountsSection() {
            try {
                const data = await fetchJson('/api/accounts', { timeoutMs: 15000, retries: 2 });
                
                const grid = document.getElementById('accountsGrid');
                if (grid) {
                    const accounts = Object.entries(data || {});
                    if (accounts.length === 0) {
                        grid.innerHTML = '<div class="col-12"><div class="alert alert-info" style="background: rgba(6, 214, 160, 0.1); border: 1px solid #06d6a0; color: #fff; padding: 20px; border-radius: 8px;">No accounts available</div></div>';
                    } else {
                        grid.innerHTML = accounts.map(([id, acc]) => `
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5>${acc.display_name || id}</h5>
                                        <p><strong>Balance:</strong> $${acc.balance.toFixed(2)}</p>
                                        <p><strong>NAV:</strong> $${acc.nav.toFixed(2)}</p>
                                        <p><strong>P&L:</strong> <span class="${acc.unrealized_pl >= 0 ? 'text-success' : 'text-danger'}">$${acc.unrealized_pl.toFixed(2)}</span></p>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Accounts load error:', error);
                const grid = document.getElementById('accountsGrid');
                if (grid) {
                    grid.innerHTML = '<div class="col-12"><div class="alert alert-info" style="background: rgba(6, 214, 160, 0.1); border: 1px solid #06d6a0; color: #fff; padding: 20px; border-radius: 8px;">No accounts available</div></div>';
                }
            }
        }
        </script>
        
        <section id="strategies" class="content-section">
            <div class="container-fluid" style="padding: 20px; background: var(--bg-dark); min-height: 600px;">
                <h2 style="color: #fff; margin-bottom: 30px; font-size: 2rem;">üéØ Trading Strategies</h2>
                <div id="strategiesGrid" class="row"></div>
            </div>
        </section>

        <script>
        async function loadStrategiesSection() {
            try {
                const data = await fetchJson('/api/strategies/overview', { timeoutMs: 15000, retries: 2 });
                
                const grid = document.getElementById('strategiesGrid');
                if (grid) {
                    const strategies = data?.strategies || [];
                    if (strategies.length === 0) {
                        grid.innerHTML = '<div class="col-12"><div class="alert alert-info" style="background: rgba(6, 214, 160, 0.1); border: 1px solid #06d6a0; color: #fff; padding: 20px; border-radius: 8px;">No strategies available</div></div>';
                    } else {
                        grid.innerHTML = strategies.map(strat => `
                            <div class="col-md-4 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5>${strat.name}</h5>
                                        <p><strong>Win Rate:</strong> ${strat.win_rate.toFixed(1)}%</p>
                                        <p><strong>Total Trades:</strong> ${strat.total_trades}</p>
                                        <p><strong>P&L:</strong> $${strat.total_pnl.toFixed(2)}</p>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Strategies load error:', error);
                const grid = document.getElementById('strategiesGrid');
                if (grid) {
                    grid.innerHTML = '<div class="col-12"><div class="alert alert-info" style="background: rgba(6, 214, 160, 0.1); border: 1px solid #06d6a0; color: #fff; padding: 20px; border-radius: 8px;">No strategies available</div></div>';
                }
            }
        }
        </script>
        
        <section id="positions" class="content-section">
            <div class="container-fluid" style="padding: 20px; background: var(--bg-dark); min-height: 600px;">
                <h2 style="color: #fff; margin-bottom: 30px; font-size: 2rem;">üìà Open Positions</h2>
                <div id="positionsGrid" class="row"></div>
            </div>
        </section>

        <script>
        async function loadPositionsSection() {
            try {
                const data = await fetchJson('/api/positions', { timeoutMs: 15000, retries: 2 });
                
                const grid = document.getElementById('positionsGrid');
                if (grid) {
                    if (data.positions && data.positions.length > 0) {
                        grid.innerHTML = data.positions.map(pos => `
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5>${pos.instrument}</h5>
                                        <p><strong>Side:</strong> ${pos.long ? 'Long' : 'Short'}</p>
                                        <p><strong>Units:</strong> ${pos.units}</p>
                                        <p><strong>P&L:</strong> <span class="${pos.unrealizedPL >= 0 ? 'text-success' : 'text-danger'}">$${pos.unrealizedPL.toFixed(2)}</span></p>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        grid.innerHTML = '<div class="col-12"><div class="alert alert-info" style="background: rgba(6, 214, 160, 0.1); border: 1px solid #06d6a0; color: #fff; padding: 20px; border-radius: 8px;">No open positions</div></div>';
                    }
                }
            } catch (error) {
                console.error('Positions load error:', error);
                const grid = document.getElementById('positionsGrid');
                if (grid) {
                    grid.innerHTML = '<div class="col-12"><div class="alert alert-info" style="background: rgba(6, 214, 160, 0.1); border: 1px solid #06d6a0; color: #fff; padding: 20px; border-radius: 8px;">No open positions</div></div>';
                }
            }
        }
        </script>
        
        <section id="signals" class="content-section">
            <div class="container-fluid" style="padding: 20px; background: var(--bg-dark); min-height: 600px;">
                <h2 style="color: #fff; margin-bottom: 30px; font-size: 2rem;">üéØ Trading Signals</h2>
                <div id="signalsGrid" class="row"></div>
            </div>
        </section>

        <script>
        async function loadSignalsSection() {
            try {
                const data = await fetchJson('/api/signals/pending', { timeoutMs: 15000, retries: 2 });
                
                const grid = document.getElementById('signalsGrid');
                if (grid) {
                    if (data.signals && data.signals.length > 0) {
                        grid.innerHTML = `
                            <div class="col-12">
                                <div class="trading-signals">
                                    ${data.signals.map(signal => `
                                    <div class="opportunity-card">
                                        <div class="opportunity-header">
                                            <div class="opportunity-title">
                                                ${signal.direction === 'BUY' ? 'üü¢' : 'üî¥'} ${signal.instrument} ${signal.direction}
                                            </div>
                                            <div class="opportunity-quality">
                                                ${signal.quality_score}/100
                                            </div>
                                        </div>
                                        <div class="opportunity-details">
                                            <div class="detail-row">
                                                <div class="detail-item">
                                                    <span class="detail-label">Entry Price:</span>
                                                    <span class="detail-value">${signal.entry_price}</span>
                                                </div>
                                                <div class="detail-item">
                                                    <span class="detail-label">Stop Loss:</span>
                                                    <span class="detail-value">${signal.stop_loss}</span>
                                                </div>
                                            </div>
                                            <div class="detail-row">
                                                <div class="detail-item">
                                                    <span class="detail-label">Confidence:</span>
                                                    <span class="detail-value" style="color: #ffffff;">${signal.quality_score}%</span>
                                                </div>
                                                <div class="detail-item">
                                                    <span class="detail-label">Strategy:</span>
                                                    <span class="detail-value" style="color: #ffffff;">Scalping</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="opportunity-actions">
                                            <button class="action-btn approve-btn" onclick="approveSignal('${signal.id}')">
                                                ‚úî Approve Trade
                                            </button>
                                            <button class="action-btn watch-btn" onclick="watchSignal('${signal.id}')">
                                                üëÅÔ∏è Watch
                                            </button>
                                            <button class="action-btn hold-btn" onclick="holdSignal('${signal.id}')">
                                                ‚ùå Hold
                                            </button>
                                        </div>
                                    </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    } else {
                        grid.innerHTML = '<div class="col-12"><div class="alert alert-info" style="background: rgba(6, 214, 160, 0.1); border: 1px solid #06d6a0; color: #fff; padding: 20px; border-radius: 8px;">No pending signals</div></div>';
                    }
                }
            } catch (error) {
                console.error('Signals load error:', error);
                const grid = document.getElementById('signalsGrid');
                if (grid) {
                    grid.innerHTML = '<div class="col-12"><div class="alert alert-info" style="background: rgba(6, 214, 160, 0.1); border: 1px solid #06d6a0; color: #fff; padding: 20px; border-radius: 8px;">No pending signals</div></div>';
                }
            }
        }
        </script>
        
        <section id="news" class="content-section">
            <div class="container-fluid" style="padding: 20px; background: var(--bg-dark); min-height: 600px;">
                <h2 style="color: #fff; margin-bottom: 30px; font-size: 2rem;">üì∞ News & Events</h2>
                <div id="newsGrid" class="row"></div>
            </div>
        </section>

        <script>
        async function loadNewsSection() {
            try {
                const data = await fetchJson('/api/news', { timeoutMs: 15000, retries: 2 });
                
                const grid = document.getElementById('newsGrid');
                if (grid) {
                    if (data.news && data.news.length > 0) {
                        grid.innerHTML = data.news.map(article => `
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5>${article.title}</h5>
                                        <p><strong>Source:</strong> ${article.source}</p>
                                        <p><strong>Time:</strong> ${new Date(article.published_at).toLocaleString()}</p>
                                        <p>${article.summary}</p>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        grid.innerHTML = '<div class="col-12"><div class="alert alert-info" style="background: rgba(6, 214, 160, 0.1); border: 1px solid #06d6a0; color: #fff; padding: 20px; border-radius: 8px;">No news available</div></div>';
                    }
                }
            } catch (error) {
                console.error('News load error:', error);
                const grid = document.getElementById('newsGrid');
                if (grid) {
                    grid.innerHTML = '<div class="col-12"><div class="alert alert-info" style="background: rgba(6, 214, 160, 0.1); border: 1px solid #06d6a0; color: #fff; padding: 20px; border-radius: 8px;">No news available</div></div>';
                }
            }
        }

        async function loadTradeManagerSection() {
            try {
                const content = document.getElementById('tradeManagerContent');
                if (!content) return;
                
                // Fetch trade manager data
                const response = await fetch('/api/trades/count');
                const data = await response.json();

                const activeCount = (data && (data.active_trades || data.count || 0)) || 0;
                content.innerHTML = `
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5>Active Trade Management</h5>
                                    <div id="activeTrades">
                                        ${activeCount > 0 ?
                                            `<div class="alert alert-success">${activeCount} active trade${activeCount===1?'':'s'}.</div>` :
                                            '<div class="alert alert-info">No active trades</div>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Trade Manager load error:', error);
                document.getElementById('tradeManagerContent').innerHTML = 
                    '<div class="alert alert-warning">Failed to load trade manager data</div>';
            }
        }

        async function loadSystemStatusSection() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                const content = document.getElementById('systemStatusContent');
                if (content) {
                    content.innerHTML = `
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5>System Status</h5>
                                        <p><strong>Status:</strong> ${data.system_status || 'Unknown'}</p>
                                        <p><strong>Active Accounts:</strong> ${data.active_accounts || 0}</p>
                                        <p><strong>Live Data:</strong> ${data.live_data_mode ? 'Yes' : 'No'}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5>Health Metrics</h5>
                                        <div id="healthMetrics">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('System Status load error:', error);
                document.getElementById('systemStatusContent').innerHTML = 
                    '<div class="alert alert-warning">Failed to load system status</div>';
            }
        }

        async function loadConfigSection() {
            try {
                const content = document.getElementById('configContent');
                if (!content) return;
                
                // Show loading state
                content.innerHTML = `
                    <div class="text-center" style="padding: 20px;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Loading configuration...</p>
                    </div>
                `;
                
                // Fetch system status for configuration display
                const statusResponse = await fetchJson('/api/status', { timeoutMs: 15000 });
                const healthResponse = await fetchJson('/api/health', { timeoutMs: 15000 });
                
                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card" style="background: rgba(6, 214, 160, 0.1); border: 1px solid #06d6a0;">
                                <div class="card-header" style="background: rgba(6, 214, 160, 0.2); border-bottom: 1px solid #06d6a0;">
                                    <h5 style="color: #06d6a0; margin: 0;">‚öôÔ∏è System Status</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Status:</strong> <span style="color: #10b981;">${statusResponse?.system_status || 'Unknown'}</span></p>
                                    <p><strong>Live Data Mode:</strong> ${statusResponse?.live_data_mode ? '‚úÖ Enabled' : '‚ùå Disabled'}</p>
                                    <p><strong>Active Accounts:</strong> ${statusResponse?.active_accounts || 0}</p>
                                    <p><strong>Data Feed Status:</strong> ${statusResponse?.data_feed_status || 'Unknown'}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card" style="background: rgba(58, 134, 255, 0.1); border: 1px solid #3a86ff;">
                                <div class="card-header" style="background: rgba(58, 134, 255, 0.2); border-bottom: 1px solid #3a86ff;">
                                    <h5 style="color: #3a86ff; margin: 0;">üîß Trading Controls</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Master Trading:</strong> <span id="configMasterTrading">Loading...</span></p>
                                    <p><strong>Risk Management:</strong> Active</p>
                                    <p><strong>Max Risk Per Trade:</strong> 2%</p>
                                    <p><strong>Max Portfolio Risk:</strong> 75%</p>
                                    <p><small class="text-muted">Use the Trading Controls panel on the main Dashboard to modify these settings.</small></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 mb-3">
                            <div class="card" style="background: rgba(131, 56, 236, 0.1); border: 1px solid #8338ec;">
                                <div class="card-header" style="background: rgba(131, 56, 236, 0.2); border-bottom: 1px solid #8338ec;">
                                    <h5 style="color: #8338ec; margin: 0;">üìä System Information</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Last Update:</strong> ${statusResponse?.last_update || 'N/A'}</p>
                                            <p><strong>Timestamp:</strong> ${statusResponse?.timestamp || 'N/A'}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Health Status:</strong> ${healthResponse?.status || 'Unknown'}</p>
                                            <p><strong>Environment:</strong> Production</p>
                                        </div>
                                    </div>
                                    <hr>
                                    <p class="mb-0"><small class="text-muted">For advanced configuration, use the dedicated config dashboard at <a href="/config" target="_blank">/config</a></small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Config load error:', error);
                const content = document.getElementById('configContent');
                if (content) {
                    content.innerHTML = `
                        <div class="alert alert-danger">
                            <h5>Error Loading Configuration</h5>
                            <p>${error.message || 'Failed to load configuration data'}</p>
                        </div>
                    `;
                }
            }
        }

        async function loadInsightsSection() {
            try {
                const content = document.getElementById('insightsContent');
                if (!content) return;
                
                // Show loading state
                content.innerHTML = `
                    <div class="text-center" style="padding: 20px;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Loading AI insights...</p>
                    </div>
                `;
                
                // Fetch AI insights from the dashboard main section data
                const statusResponse = await fetchJson('/api/status', { timeoutMs: 15000 });
                
                if (statusResponse && statusResponse.trade_phase) {
                    const aiInsights = {
                        trade_phase: statusResponse.trade_phase || 'Monitoring markets',
                        recommendation: statusResponse.ai_recommendation || 'HOLD',
                        upcoming_news: statusResponse.upcoming_news || [],
                        session_context: statusResponse.session_context || {}
                    };
                    
                    content.innerHTML = `
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card" style="background: rgba(168, 85, 247, 0.1); border: 1px solid #a855f7;">
                                    <div class="card-header" style="background: rgba(168, 85, 247, 0.2); border-bottom: 1px solid #a855f7;">
                                        <h5 style="color: #a855f7; margin: 0;">üß† AI Trade Phase</h5>
                                    </div>
                                    <div class="card-body">
                                        <p style="font-size: 1.1rem; color: #e2e8f0;">${aiInsights.trade_phase}</p>
                                        <p><strong>Recommendation:</strong> <span style="color: #06d6a0;">${aiInsights.recommendation}</span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card" style="background: rgba(6, 214, 160, 0.1); border: 1px solid #06d6a0;">
                                    <div class="card-header" style="background: rgba(6, 214, 160, 0.2); border-bottom: 1px solid #06d6a0;">
                                        <h5 style="color: #06d6a0; margin: 0;">üìÖ Session Context</h5>
                                    </div>
                                    <div class="card-body">
                                        ${aiInsights.session_context.quality ? `
                                            <p><strong>Session Quality:</strong> ${aiInsights.session_context.quality}</p>
                                            <p><strong>Active Sessions:</strong> ${(aiInsights.session_context.active_sessions || []).join(', ') || 'None'}</p>
                                            <p><strong>Description:</strong> ${aiInsights.session_context.description || 'N/A'}</p>
                                        ` : '<p>Session context data not available</p>'}
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 mb-3">
                                <div class="card" style="background: rgba(58, 134, 255, 0.1); border: 1px solid #3a86ff;">
                                    <div class="card-header" style="background: rgba(58, 134, 255, 0.2); border-bottom: 1px solid #3a86ff;">
                                        <h5 style="color: #3a86ff; margin: 0;">üì∞ Upcoming News Events</h5>
                                    </div>
                                    <div class="card-body">
                                        ${aiInsights.upcoming_news.length > 0 ? 
                                            aiInsights.upcoming_news.map(event => `
                                                <div style="padding: 10px; margin-bottom: 10px; background: rgba(58, 134, 255, 0.1); border-radius: 6px;">
                                                    <strong>${event.time || 'Soon'}:</strong> ${event.event || 'No description'}
                                                    <br><small style="color: #94a3b8;">Impact: ${event.impact || 'medium'} | Currency: ${event.currency || 'ALL'}</small>
                                                </div>
                                            `).join('') :
                                            '<p>No upcoming news events</p>'
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="alert alert-warning">
                            <h5>AI Market Insights</h5>
                            <p>Unable to load AI insights data. The system may be initializing.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('AI Insights load error:', error);
                const content = document.getElementById('insightsContent');
                if (content) {
                    content.innerHTML = `
                        <div class="alert alert-danger">
                            <h5>Error Loading AI Insights</h5>
                            <p>${error.message || 'Failed to load AI insights data'}</p>
                        </div>
                    `;
                }
            }
        }

        async function loadStrategySwitcherSection() {
            const content = document.getElementById('strategySwitcherContent');
            if (content) {
                content.innerHTML = `
                    <div style="padding: 20px;">
                        <h3 style="color: #06d6a0; margin-bottom: 20px;">
                            <i class="bi bi-shuffle me-2"></i>Universal Strategy Switcher
                        </h3>
                        
                        <div id="strategySwitcherStatus" class="alert alert-info" style="display: none;">
                            <i class="bi bi-info-circle me-2"></i>
                            <span id="strategySwitcherMessage">Loading strategies...</span>
                        </div>
                        
                        <!-- Active Strategies -->
                        <div class="card mb-4" style="background: #1a1a2e; border: 1px solid #06d6a0;">
                            <div class="card-header" style="background: #16213e; border-bottom: 1px solid #06d6a0;">
                                <h5 style="color: #06d6a0; margin: 0;">
                                    <i class="bi bi-list-task me-2"></i>Active Strategies
                                </h5>
                            </div>
                            <div class="card-body" id="activeStrategiesList">
                                <div class="text-center" style="padding: 40px;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p style="color: #999; margin-top: 10px;">Loading active strategies...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- All Available Strategies -->
                        <div class="card mb-4" style="background: #1a1a2e; border: 1px solid #8338ec;">
                            <div class="card-header" style="background: #16213e; border-bottom: 1px solid #8338ec;">
                                <h5 style="color: #8338ec; margin: 0;">
                                    <i class="bi bi-list-ul me-2"></i>All Available Strategies
                                </h5>
                            </div>
                            <div class="card-body" id="allStrategiesList">
                                <div class="text-center" style="padding: 40px;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p style="color: #999; margin-top: 10px;">Loading strategies...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Load strategies
                await loadAllStrategies();
                await loadActiveStrategies();
            }
        }
        
        async function loadAllStrategies() {
            try {
                const response = await fetch('/api/strategy-switcher/strategies');
                const data = await response.json();
                
                const strategiesList = document.getElementById('allStrategiesList');
                if (!strategiesList) return;
                
                if (data.success && data.strategies && data.strategies.length > 0) {
                    const html = data.strategies.map(strategy => `
                        <div class="card mb-3 strategy-card" style="background: #0f3460; border: 1px solid #8338ec;" data-strategy="${strategy.name}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 style="color: #8338ec; margin-bottom: 10px;">
                                            ${strategy.name}
                                            ${strategy.enabled ? '<span class="badge bg-success ms-2">Enabled</span>' : '<span class="badge bg-secondary ms-2">Disabled</span>'}
                                            ${strategy.locked ? '<span class="badge bg-warning ms-2">Locked</span>' : ''}
                                        </h6>
                                        <div style="color: #999; font-size: 0.9em; margin-bottom: 10px;">
                                            <strong>Instruments:</strong> ${strategy.instruments ? strategy.instruments.join(', ') : 'N/A'}
                                        </div>
                                        <div style="color: #999; font-size: 0.85em;">
                                            <strong>Account:</strong> ${strategy.account || 'N/A'} |
                                            <strong>Max Trades/Day:</strong> ${strategy.parameters?.max_trades_per_day || 'N/A'} |
                                            <strong>Max Positions:</strong> ${strategy.parameters?.max_positions || 'N/A'}
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-primary me-2" onclick="editStrategyParams('${strategy.name}')">
                                            <i class="bi bi-gear"></i> Modify Params
                                        </button>
                                        <button class="btn btn-sm btn-${strategy.enabled ? 'warning' : 'success'}" onclick="toggleStrategy('${strategy.name}', ${strategy.enabled})">
                                            <i class="bi bi-toggle-${strategy.enabled ? 'on' : 'off'}"></i> ${strategy.enabled ? 'Disable' : 'Enable'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    strategiesList.innerHTML = html;
                } else {
                    strategiesList.innerHTML = '<p style="color: #999; text-align: center;">No strategies found</p>';
                }
            } catch (error) {
                console.error('Error loading strategies:', error);
                const strategiesList = document.getElementById('allStrategiesList');
                if (strategiesList) {
                    strategiesList.innerHTML = '<p style="color: #d32f2f; text-align: center;">Error loading strategies</p>';
                }
            }
        }
        
        async function loadActiveStrategies() {
            try {
                const response = await fetch('/api/strategy-switcher/active');
                const data = await response.json();
                
                const activeList = document.getElementById('activeStrategiesList');
                if (!activeList) return;
                
                if (data.success && data.active_assignments && data.active_assignments.length > 0) {
                    const html = data.active_assignments.map(assignment => `
                        <div class="card mb-3" style="background: #0f3460; border: 1px solid #06d6a0;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 style="color: #06d6a0; margin-bottom: 10px;">${assignment.account_name}</h6>
                                        <div style="color: #999; font-size: 0.9em;">
                                            <strong>Account ID:</strong> ${assignment.account_id}<br>
                                            <strong>Strategy:</strong> ${assignment.strategy}<br>
                                            <strong>Instruments:</strong> ${assignment.instruments ? assignment.instruments.join(', ') : 'N/A'}
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-warning" onclick="switchAccountStrategy('${assignment.account_id}', '${assignment.strategy}')">
                                            <i class="bi bi-arrow-repeat"></i> Change Strategy
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    activeList.innerHTML = html;
                } else {
                    activeList.innerHTML = '<p style="color: #999; text-align: center;">No active strategies</p>';
                }
            } catch (error) {
                console.error('Error loading active strategies:', error);
                const activeList = document.getElementById('activeStrategiesList');
                if (activeList) {
                    activeList.innerHTML = '<p style="color: #d32f2f; text-align: center;">Error loading active strategies</p>';
                }
            }
        }
        
        async function editStrategyParams(strategyName) {
            alert(`Modify parameters for ${strategyName}\n\nThis will open the parameter editing modal. (Implementation pending)`);
        }
        
        async function toggleStrategy(strategyName, currentlyEnabled) {
            if (!confirm(`Are you sure you want to ${currentlyEnabled ? 'disable' : 'enable'} strategy "${strategyName}"?`)) {
                return;
            }
            
            try {
                const endpoint = currentlyEnabled ? '/api/strategy-switcher/disable' : '/api/strategy-switcher/enable';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ strategy_name: strategyName })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStrategyMessage(`Strategy "${strategyName}" ${currentlyEnabled ? 'disabled' : 'enabled'} successfully`, 'success');
                    // Reload strategies
                    await loadAllStrategies();
                } else {
                    showStrategyMessage(`Failed to ${currentlyEnabled ? 'disable' : 'enable'} strategy: ${data.error}`, 'danger');
                }
            } catch (error) {
                console.error('Error toggling strategy:', error);
                showStrategyMessage('Error toggling strategy', 'danger');
            }
        }
        
        async function switchAccountStrategy(accountId, currentStrategy) {
            const newStrategy = prompt(`Enter new strategy name for account ${accountId}\n\nCurrent strategy: ${currentStrategy}\n\nWarning: This will require a system restart!`);
            
            if (!newStrategy) return;
            
            if (!confirm(`Switch account ${accountId} from "${currentStrategy}" to "${newStrategy}"?\n\nWARNING: This will restart the trading system!`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/strategies/switch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        account_id: accountId,
                        new_strategy: newStrategy
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStrategyMessage(`Strategy switched successfully. System restart required.`, 'warning');
                    // Reload active strategies
                    await loadActiveStrategies();
                } else {
                    showStrategyMessage(`Failed to switch strategy: ${data.error}`, 'danger');
                }
            } catch (error) {
                console.error('Error switching strategy:', error);
                showStrategyMessage('Error switching strategy', 'danger');
            }
        }
        
        function showStrategyMessage(message, type) {
            const statusDiv = document.getElementById('strategySwitcherStatus');
            const messageSpan = document.getElementById('strategySwitcherMessage');
            
            if (statusDiv && messageSpan) {
                statusDiv.className = `alert alert-${type}`;
                messageSpan.textContent = message;
                statusDiv.style.display = 'block';
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        async function loadAICopilotSection() {
            const content = document.getElementById('aiCopilotTabContent');
            if (content) {
                content.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <h5>AI Trading Copilot</h5>
                            <p>Your AI assistant for trading decisions and market analysis.</p>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Use the floating AI button (bottom right) for quick access from any tab!
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        async function loadReportsSection() {
            // Load daily report and weekly roadmap when reports section is accessed
            console.log('üìä Loading Reports & Analytics section...');
            
            // Show loading indicators
            const dailyContent = document.getElementById('dailyReportContent');
            const weeklyContent = document.getElementById('weeklyRoadmapContent');
            
            if (dailyContent) {
                dailyContent.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #06d6a0;">
                        <div style="font-size: 18px; margin-bottom: 10px;">‚è≥</div>
                        <div>Loading daily report...</div>
                    </div>
                `;
            }
            
            if (weeklyContent) {
                weeklyContent.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #8338ec;">
                        <div style="font-size: 18px; margin-bottom: 10px;">‚è≥</div>
                        <div>Loading weekly roadmap...</div>
                    </div>
                `;
            }
            
            try {
                await loadDailyReport();
                await loadWeeklyRoadmap();
                console.log('‚úÖ Reports & Analytics section loaded successfully');
            } catch (error) {
                console.error('‚ùå Error loading reports section:', error);
            }
        }
        
        async function loadPerformanceSection() {
            // Load performance monitoring data when performance section is accessed
            await loadPerformanceOverview();
            await loadStrategyPerformanceCards();
            await loadTradeHistoryTable();
            await loadKeyMetrics();
            await loadDatabaseStats();
        }

        async function loadRoadmapSection() {
            try {
                console.log('üìÖ Loading roadmap section...');
                const data = await fetchJson('/api/roadmap/progress', { timeoutMs: 15000 });
                
                if (!data) {
                    throw new Error('Failed to load roadmap data');
                }
                
                // Handle both wrapped and direct response formats
                const progress = (data.success && data.progress) ? data.progress : data;
                
                // Load week overview
                const weekOverview = document.getElementById('roadmapWeekOverview');
                if (weekOverview) {
                    const weekInfo = progress.week_info || {};
                    const targets = progress.targets || {};
                    weekOverview.innerHTML = `
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <div class="text-center p-3" style="background: rgba(58, 134, 255, 0.1); border-radius: 8px;">
                                    <h4 style="color: #3a86ff;">${weekInfo.current_day || 'N/A'}</h4>
                                    <small style="color: #adb5bd;">Current Day</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="text-center p-3" style="background: rgba(58, 134, 255, 0.1); border-radius: 8px;">
                                    <h4 style="color: #3a86ff;">${weekInfo.days_passed || 0}/${weekInfo.days_remaining !== undefined ? (7 - weekInfo.days_passed) : 0}</h4>
                                    <small style="color: #adb5bd;">Days Passed / Remaining</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="text-center p-3" style="background: rgba(58, 134, 255, 0.1); border-radius: 8px;">
                                    <h4 style="color: ${targets.on_track ? '#06d6a0' : '#ff6b6b'};">$${(targets.current_progress || 0).toFixed(2)}</h4>
                                    <small style="color: #adb5bd;">Current Progress</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="text-center p-3" style="background: rgba(58, 134, 255, 0.1); border-radius: 8px;">
                                    <h4 style="color: #3a86ff;">$${(targets.weekly_target || 0).toFixed(2)}</h4>
                                    <small style="color: #adb5bd;">Weekly Target</small>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="progress" style="height: 25px; background: rgba(58, 134, 255, 0.1);">
                                <div class="progress-bar" role="progressbar" style="width: ${(targets.weekly_progress_pct || 0)}%; background: ${targets.on_track ? '#06d6a0' : '#ff6b6b'};" aria-valuenow="${targets.weekly_progress_pct || 0}" aria-valuemin="0" aria-valuemax="100">
                                    ${(targets.weekly_progress_pct || 0).toFixed(1)}%
                                </div>
                            </div>
                            <p class="mt-2 mb-0" style="color: #adb5bd;">
                                Status: <span style="color: ${targets.on_track ? '#06d6a0' : '#ff6b6b'};">${targets.on_track ? '‚úÖ On Track' : '‚ö†Ô∏è Behind Target'}</span>
                                | Variance: ${(targets.variance || 0) >= 0 ? '+' : ''}$${(targets.variance || 0).toFixed(2)}
                            </p>
                        </div>
                    `;
                }
                
                // Load daily progress
                const dailyProgress = document.getElementById('roadmapDailyProgress');
                if (dailyProgress) {
                    const daily = progress.daily_progress || [];
                    if (daily.length > 0) {
                        dailyProgress.innerHTML = `
                            <div class="table-responsive">
                                <table class="table table-dark table-striped">
                                    <thead>
                                        <tr>
                                            <th style="color: #ffffff;">Day</th>
                                            <th style="color: #ffffff;">Target</th>
                                            <th style="color: #ffffff;">Actual</th>
                                            <th style="color: #ffffff;">Trades</th>
                                            <th style="color: #ffffff;">Win Rate</th>
                                            <th style="color: #ffffff;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${daily.map(day => `
                                            <tr style="background: ${day.status === 'current' ? 'rgba(58, 134, 255, 0.2)' : ''};">
                                                <td style="color: #ffffff;">${day.day}</td>
                                                <td style="color: #adb5bd;">$${(day.target || 0).toFixed(2)}</td>
                                                <td style="color: ${(day.actual || 0) >= (day.target || 0) ? '#06d6a0' : '#ff6b6b'};">$${(day.actual || 0).toFixed(2)}</td>
                                                <td style="color: #adb5bd;">${day.trades || 0}</td>
                                                <td style="color: #adb5bd;">${(day.win_rate || 0).toFixed(1)}%</td>
                                                <td>
                                                    <span class="badge" style="background: ${day.status === 'complete' ? '#06d6a0' : day.status === 'current' ? '#3a86ff' : '#6c757d'};">
                                                        ${day.status || 'upcoming'}
                                                    </span>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    } else {
                        dailyProgress.innerHTML = '<p style="color: #adb5bd; text-align: center;">No daily progress data available</p>';
                    }
                }
                
                // Load strategy progress
                const strategyProgress = document.getElementById('roadmapStrategyProgress');
                if (strategyProgress) {
                    const strategies = progress.strategy_progress || [];
                    if (strategies.length > 0) {
                        strategyProgress.innerHTML = `
                            <div class="row">
                                ${strategies.map(strategy => `
                                    <div class="col-md-6 mb-3">
                                        <div class="card" style="background: rgba(33, 37, 41, 0.6); border: 1px solid #495057;">
                                            <div class="card-body">
                                                <h5 style="color: #ffffff;">${strategy.strategy_name || strategy.strategy_id}</h5>
                                                <p class="mb-2" style="color: #adb5bd;">Pair: ${strategy.pair}</p>
                                                <div class="progress mb-2" style="height: 20px;">
                                                    <div class="progress-bar" role="progressbar" style="width: ${strategy.progress_pct || 0}%; background: ${strategy.on_track ? '#06d6a0' : '#ff6b6b'};" aria-valuenow="${strategy.progress_pct || 0}" aria-valuemin="0" aria-valuemax="100">
                                                        ${(strategy.progress_pct || 0).toFixed(1)}%
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <small style="color: #adb5bd;">Target: $${(strategy.target || 0).toFixed(2)}</small>
                                                    <small style="color: #adb5bd;">Current: $${(strategy.current || 0).toFixed(2)}</small>
                                                </div>
                                                <div class="mt-2">
                                                    <small style="color: #adb5bd;">Trades: ${strategy.trades || 0}</small>
                                                    <span class="badge ms-2" style="background: ${strategy.on_track ? '#06d6a0' : '#ff6b6b'};">
                                                        ${strategy.on_track ? '‚úÖ On Track' : '‚ö†Ô∏è Behind'}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        strategyProgress.innerHTML = '<p style="color: #adb5bd; text-align: center;">No strategy progress data available</p>';
                    }
                }
            } catch (error) {
                console.error('‚ùå Error loading roadmap section:', error);
                const weekOverview = document.getElementById('roadmapWeekOverview');
                if (weekOverview) {
                    weekOverview.innerHTML = `<p style="color: #ff6b6b;">Error loading roadmap: ${error.message}</p>`;
                }
            }
        }

        async function loadTradeHistorySection() {
            await loadFilteredTradeHistory();
        }

        async function loadFilteredTradeHistory() {
            try {
                console.log('üìã Loading filtered trade history...');
                
                const strategy = document.getElementById('filterStrategy')?.value || 'all';
                const instrument = document.getElementById('filterInstrument')?.value || 'all';
                const period = document.getElementById('filterPeriod')?.value || 'month';
                const status = document.getElementById('filterStatus')?.value || 'all';
                
                const params = new URLSearchParams({
                    strategy_id: strategy,
                    instrument: instrument,
                    period: period,
                    status: status
                });
                
                const data = await fetchJson(`/api/performance/filtered?${params.toString()}`, { timeoutMs: 15000 });
                
                if (!data || !data.success) {
                    throw new Error(data?.error || 'Failed to load trade history');
                }
                
                const performance = data.performance || data;
                const metrics = performance.metrics || {};
                const trades = performance.trades || [];
                
                // Update filter dropdowns with available options
                const strategySelect = document.getElementById('filterStrategy');
                const instrumentSelect = document.getElementById('filterInstrument');
                
                if (strategySelect && performance.strategies) {
                    const currentValue = strategySelect.value;
                    strategySelect.innerHTML = '<option value="all">All Strategies</option>';
                    performance.strategies.forEach(s => {
                        const option = document.createElement('option');
                        option.value = s.strategy_id;
                        option.textContent = s.strategy_id;
                        if (s.strategy_id === currentValue) option.selected = true;
                        strategySelect.appendChild(option);
                    });
                }
                
                if (instrumentSelect && trades.length > 0) {
                    const instruments = [...new Set(trades.map(t => t.instrument).filter(Boolean))];
                    const currentValue = instrumentSelect.value;
                    instrumentSelect.innerHTML = '<option value="all">All Instruments</option>';
                    instruments.forEach(inst => {
                        const option = document.createElement('option');
                        option.value = inst;
                        option.textContent = inst;
                        if (inst === currentValue) option.selected = true;
                        instrumentSelect.appendChild(option);
                    });
                }
                
                // Display metrics
                const content = document.getElementById('tradeHistoryContent');
                if (content) {
                    content.innerHTML = `
                        <div class="mb-4">
                            <div class="row">
                                <div class="col-md-3 mb-2">
                                    <div class="text-center p-3" style="background: rgba(58, 134, 255, 0.1); border-radius: 8px;">
                                        <h5 style="color: #3a86ff;">${metrics.total_trades || 0}</h5>
                                        <small style="color: #adb5bd;">Total Trades</small>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <div class="text-center p-3" style="background: rgba(58, 134, 255, 0.1); border-radius: 8px;">
                                        <h5 style="color: #3a86ff;">${(metrics.win_rate || 0).toFixed(1)}%</h5>
                                        <small style="color: #adb5bd;">Win Rate</small>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <div class="text-center p-3" style="background: rgba(58, 134, 255, 0.1); border-radius: 8px;">
                                        <h5 style="color: ${(metrics.total_pnl || 0) >= 0 ? '#06d6a0' : '#ff6b6b'};">$${(metrics.total_pnl || 0).toFixed(2)}</h5>
                                        <small style="color: #adb5bd;">Total P&L</small>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <div class="text-center p-3" style="background: rgba(58, 134, 255, 0.1); border-radius: 8px;">
                                        <h5 style="color: #3a86ff;">${(metrics.profit_factor || 0).toFixed(2)}</h5>
                                        <small style="color: #adb5bd;">Profit Factor</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-dark table-striped">
                                <thead>
                                    <tr>
                                        <th style="color: #ffffff;">Trade ID</th>
                                        <th style="color: #ffffff;">Strategy</th>
                                        <th style="color: #ffffff;">Instrument</th>
                                        <th style="color: #ffffff;">Direction</th>
                                        <th style="color: #ffffff;">Entry Time</th>
                                        <th style="color: #ffffff;">P&L</th>
                                        <th style="color: #ffffff;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${trades.length > 0 ? trades.slice(0, 50).map(trade => `
                                        <tr>
                                            <td style="color: #adb5bd;">${trade.trade_id || 'N/A'}</td>
                                            <td style="color: #adb5bd;">${trade.strategy_id || 'N/A'}</td>
                                            <td style="color: #adb5bd;">${trade.instrument || 'N/A'}</td>
                                            <td style="color: ${trade.direction === 'BUY' ? '#06d6a0' : '#ff6b6b'};">${trade.direction || 'N/A'}</td>
                                            <td style="color: #adb5bd;">${trade.entry_time ? new Date(trade.entry_time).toLocaleString() : 'N/A'}</td>
                                            <td style="color: ${(trade.realized_pnl || 0) >= 0 ? '#06d6a0' : '#ff6b6b'};">$${(trade.realized_pnl || 0).toFixed(2)}</td>
                                            <td>
                                                <span class="badge" style="background: ${trade.is_closed ? '#06d6a0' : '#3a86ff'};">
                                                    ${trade.is_closed ? 'Closed' : 'Open'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="7" style="text-align: center; color: #adb5bd;">No trades found</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Error loading filtered trade history:', error);
                const content = document.getElementById('tradeHistoryContent');
                if (content) {
                    content.innerHTML = `<p style="color: #ff6b6b;">Error loading trade history: ${error.message}</p>`;
                }
            }
        }
        
        async function loadAnalyticsSection() {
            try {
                console.log('üìä Loading Analytics section...');
                const content = document.getElementById('analyticsContent');
                if (!content) {
                    console.error('‚ùå analyticsContent element not found!');
                    return;
                }
                
                // Show loading state immediately
                content.innerHTML = `
                    <div class="text-center" style="padding: 40px; color: #fff;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Loading analytics data...</p>
                    </div>
                `;
                
                // Load TradeTracker data first
                await loadTradeTrackerData();
                
                // Use performance data for analytics
                console.log('üì° Fetching /api/performance/live...');
                const data = await fetchJson('/api/performance/live', { timeoutMs: 15000 });
                console.log('‚úÖ Analytics data received:', data);
                
                content.innerHTML = `
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card" style="background: rgba(131, 56, 236, 0.1); border: 1px solid #8338ec;">
                                <div class="card-header" style="background: rgba(131, 56, 236, 0.2); border-bottom: 1px solid #8338ec;">
                                    <h4 style="color: #8338ec; margin: 0;">üìä Trading Analytics Overview</h4>
                                </div>
                                <div class="card-body">
                                    <p class="mb-3">Analytics provides detailed insights into trading performance, trends, and patterns.</p>
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <div class="text-center p-3" style="background: rgba(131, 56, 236, 0.1); border-radius: 8px;">
                                                <h5 style="color: #8338ec;">${data?.totals?.open_positions || 0}</h5>
                                                <small>Open Positions</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <div class="text-center p-3" style="background: rgba(131, 56, 236, 0.1); border-radius: 8px;">
                                                <h5 style="color: #8338ec;">${data?.active_strategies || 0}</h5>
                                                <small>Active Strategies</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <div class="text-center p-3" style="background: rgba(131, 56, 236, 0.1); border-radius: 8px;">
                                                <h5 style="color: ${(data?.totals?.unrealized_pl || 0) >= 0 ? '#06d6a0' : '#ef476f'};">${(data?.totals?.unrealized_pl || 0).toFixed(2)}</h5>
                                                <small>Unrealized P&L</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <div class="text-center p-3" style="background: rgba(131, 56, 236, 0.1); border-radius: 8px;">
                                                <h5 style="color: #8338ec;">${data?.trades_today || 0}</h5>
                                                <small>Trades Today</small>
                                            </div>
                                        </div>
                                    </div>
                                    <hr>
                                    <p class="mb-0"><small class="text-muted">For detailed performance metrics, see the <a href="#performance" onclick="document.querySelector('[data-section=\"performance\"]').click()">Performance Monitoring</a> section.</small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Strategy Performance</h5>
                                </div>
                                <div class="card-body" id="analyticsStrategyCards">
                                    ${data?.accounts && data.accounts.length > 0 ? 
                                        data.accounts.slice(0, 5).map(account => `
                                            <div class="mb-2 p-2" style="background: rgba(131, 56, 236, 0.1); border-radius: 6px;">
                                                <strong>${account.display_name || account.account_id}</strong>
                                                <div class="d-flex justify-content-between mt-1">
                                                    <small>Positions: ${account.open_positions || 0}</small>
                                                    <small style="color: ${(account.unrealized_pl || 0) >= 0 ? '#06d6a0' : '#ef476f'};">
                                                        P&L: ${(account.unrealized_pl || 0).toFixed(2)}
                                                    </small>
                                                </div>
                                            </div>
                                        `).join('') : 
                                        '<p>No strategy data available</p>'
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Performance Overview</h5>
                                </div>
                                <div class="card-body">
                                    ${data?.totals ? `
                                        <div class="mb-2">
                                            <small>Total NAV:</small>
                                            <strong class="float-end">${(data.totals.total_nav || 0).toFixed(2)}</strong>
                                        </div>
                                        <div class="mb-2">
                                            <small>Open Positions:</small>
                                            <strong class="float-end">${data.totals.open_positions || 0}</strong>
                                        </div>
                                        <div class="mb-2">
                                            <small>Unrealized P&L:</small>
                                            <strong class="float-end" style="color: ${(data.totals.unrealized_pl || 0) >= 0 ? '#06d6a0' : '#ef476f'};">
                                                ${(data.totals.unrealized_pl || 0).toFixed(2)}
                                            </strong>
                                        </div>
                                    ` : '<p>No performance data available</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('‚ùå Analytics load error:', error);
                const content = document.getElementById('analyticsContent');
                if (content) {
                    content.innerHTML = `
                        <div class="alert alert-danger" style="background: rgba(239, 71, 111, 0.2); border: 1px solid #ef476f; padding: 20px; border-radius: 8px; color: #fff; margin: 20px;">
                            <h5 style="color: #ef476f; margin-bottom: 10px;">‚ùå Error Loading Analytics</h5>
                            <p style="color: #fff; margin-bottom: 5px;"><strong>Error:</strong> ${error.message || 'Failed to load analytics data'}</p>
                            <p style="color: #999; font-size: 0.9em;">Check browser console (F12) for details. API endpoint: /api/performance/live</p>
                        </div>
                    `;
                } else {
                    console.error('‚ùå analyticsContent element not found for error display!');
                }
            }
        }
        
        // TradeTracker data loading functions
        async function loadTradeTrackerData() {
            try {
                console.log('üìä Loading TradeTracker data...');
                
                // Load metrics and history in parallel
                const [metricsData, historyData, activeData] = await Promise.all([
                    fetchJson('/api/trade-tracker/metrics?days=30').catch(e => ({ success: false, error: e.message })),
                    fetchJson('/api/trade-tracker/history?limit=50').catch(e => ({ success: false, error: e.message })),
                    fetchJson('/api/trade-tracker/active').catch(e => ({ success: false, error: e.message }))
                ]);
                
                // Update analytics content with TradeTracker section
                const content = document.getElementById('analyticsContent');
                if (!content) return;
                
                let tradeTrackerHTML = '';
                
                // Performance Metrics Section
                if (metricsData.success && metricsData.metrics) {
                    const m = metricsData.metrics;
                    tradeTrackerHTML += `
                        <div class="card mb-4" style="background: rgba(15, 52, 96, 0.3); border: 1px solid rgba(58, 134, 255, 0.3);">
                            <div class="card-header" style="background: rgba(58, 134, 255, 0.2); border-bottom: 1px solid rgba(58, 134, 255, 0.3);">
                                <h4 style="color: #fff; margin: 0;"><i class="bi bi-graph-up me-2"></i>Trade Performance Metrics (Last 30 Days)</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <div style="background: rgba(6, 214, 160, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(6, 214, 160, 0.3);">
                                            <div style="color: #06d6a0; font-size: 0.9rem; margin-bottom: 5px;">Total Trades</div>
                                            <div style="color: #fff; font-size: 1.5rem; font-weight: bold;">${m.total_trades || 0}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div style="background: rgba(6, 214, 160, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(6, 214, 160, 0.3);">
                                            <div style="color: #06d6a0; font-size: 0.9rem; margin-bottom: 5px;">Win Rate</div>
                                            <div style="color: #fff; font-size: 1.5rem; font-weight: bold;">${(m.win_rate || 0).toFixed(1)}%</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div style="background: ${(m.total_profit_loss || 0) >= 0 ? 'rgba(6, 214, 160, 0.1)' : 'rgba(239, 71, 111, 0.1)'}; padding: 15px; border-radius: 8px; border: 1px solid ${(m.total_profit_loss || 0) >= 0 ? 'rgba(6, 214, 160, 0.3)' : 'rgba(239, 71, 111, 0.3)'};">
                                            <div style="color: ${(m.total_profit_loss || 0) >= 0 ? '#06d6a0' : '#ef476f'}; font-size: 0.9rem; margin-bottom: 5px;">Total P&L</div>
                                            <div style="color: #fff; font-size: 1.5rem; font-weight: bold;">${(m.total_profit_loss || 0).toFixed(2)}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div style="background: rgba(58, 134, 255, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(58, 134, 255, 0.3);">
                                            <div style="color: #3a86ff; font-size: 0.9rem; margin-bottom: 5px;">Total Pips</div>
                                            <div style="color: #fff; font-size: 1.5rem; font-weight: bold;">${(m.total_pips || 0).toFixed(1)}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-3 mb-3">
                                        <div style="background: rgba(255, 209, 102, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(255, 209, 102, 0.3);">
                                            <div style="color: #ffd166; font-size: 0.9rem; margin-bottom: 5px;">Winning Trades</div>
                                            <div style="color: #fff; font-size: 1.3rem; font-weight: bold;">${m.winning_trades || 0}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div style="background: rgba(239, 71, 111, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(239, 71, 111, 0.3);">
                                            <div style="color: #ef476f; font-size: 0.9rem; margin-bottom: 5px;">Losing Trades</div>
                                            <div style="color: #fff; font-size: 1.3rem; font-weight: bold;">${m.losing_trades || 0}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div style="background: rgba(239, 71, 111, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(239, 71, 111, 0.3);">
                                            <div style="color: #ef476f; font-size: 0.9rem; margin-bottom: 5px;">Max Drawdown</div>
                                            <div style="color: #fff; font-size: 1.3rem; font-weight: bold;">${(m.max_drawdown || 0).toFixed(2)}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div style="background: rgba(58, 134, 255, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(58, 134, 255, 0.3);">
                                            <div style="color: #3a86ff; font-size: 0.9rem; margin-bottom: 5px;">Avg Duration</div>
                                            <div style="color: #fff; font-size: 1.3rem; font-weight: bold;">${Math.round(m.avg_duration_minutes || 0)}m</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Active Trades Section
                if (activeData.success && activeData.trades && activeData.trades.length > 0) {
                    tradeTrackerHTML += `
                        <div class="card mb-4" style="background: rgba(15, 52, 96, 0.3); border: 1px solid rgba(255, 209, 102, 0.3);">
                            <div class="card-header" style="background: rgba(255, 209, 102, 0.2); border-bottom: 1px solid rgba(255, 209, 102, 0.3);">
                                <h4 style="color: #fff; margin: 0;"><i class="bi bi-activity me-2"></i>Active Trades (${activeData.count})</h4>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-dark table-striped" style="margin: 0;">
                                        <thead>
                                            <tr>
                                                <th>Instrument</th>
                                                <th>Side</th>
                                                <th>Entry Price</th>
                                                <th>Pips</th>
                                                <th>P&L</th>
                                                <th>Strategy</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${activeData.trades.map(trade => `
                                                <tr>
                                                    <td>${trade.instrument || 'N/A'}</td>
                                                    <td><span style="color: ${trade.side === 'BUY' ? '#06d6a0' : '#ef476f'}">${trade.side || 'N/A'}</span></td>
                                                    <td>${trade.entry_price ? trade.entry_price.toFixed(5) : 'N/A'}</td>
                                                    <td style="color: ${(trade.pips_profit || 0) >= 0 ? '#06d6a0' : '#ef476f'}">${(trade.pips_profit || 0).toFixed(1)}</td>
                                                    <td style="color: ${(trade.profit_loss || 0) >= 0 ? '#06d6a0' : '#ef476f'}">${(trade.profit_loss || 0).toFixed(2)}</td>
                                                    <td>${trade.strategy || 'N/A'}</td>
                                                    <td><span class="badge bg-primary">${trade.status || 'N/A'}</span></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Trade History Section
                if (historyData.success && historyData.trades && historyData.trades.length > 0) {
                    tradeTrackerHTML += `
                        <div class="card mb-4" style="background: rgba(15, 52, 96, 0.3); border: 1px solid rgba(131, 56, 236, 0.3);">
                            <div class="card-header" style="background: rgba(131, 56, 236, 0.2); border-bottom: 1px solid rgba(131, 56, 236, 0.3);">
                                <h4 style="color: #fff; margin: 0;"><i class="bi bi-clock-history me-2"></i>Recent Trade History (Last ${historyData.count} Trades)</h4>
                            </div>
                            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                <div class="table-responsive">
                                    <table class="table table-dark table-striped" style="margin: 0;">
                                        <thead style="position: sticky; top: 0; background: rgba(15, 52, 96, 0.9);">
                                            <tr>
                                                <th>Time</th>
                                                <th>Instrument</th>
                                                <th>Side</th>
                                                <th>Entry</th>
                                                <th>Exit</th>
                                                <th>Pips</th>
                                                <th>P&L</th>
                                                <th>P&L %</th>
                                                <th>Max DD Pips</th>
                                                <th>Duration</th>
                                                <th>Strategy</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${historyData.trades.map(trade => `
                                                <tr>
                                                    <td style="font-size: 0.85rem;">${trade.timestamp ? new Date(trade.timestamp).toLocaleString() : 'N/A'}</td>
                                                    <td>${trade.instrument || 'N/A'}</td>
                                                    <td><span style="color: ${trade.side === 'BUY' ? '#06d6a0' : '#ef476f'}">${trade.side || 'N/A'}</span></td>
                                                    <td>${trade.entry_price ? trade.entry_price.toFixed(5) : 'N/A'}</td>
                                                    <td>${trade.exit_price ? trade.exit_price.toFixed(5) : 'N/A'}</td>
                                                    <td style="color: ${(trade.pips_profit || 0) >= 0 ? '#06d6a0' : '#ef476f'}">${(trade.pips_profit || 0).toFixed(1)}</td>
                                                    <td style="color: ${(trade.profit_loss || 0) >= 0 ? '#06d6a0' : '#ef476f'}">${(trade.profit_loss || 0).toFixed(2)}</td>
                                                    <td style="color: ${(trade.profit_loss_pct || 0) >= 0 ? '#06d6a0' : '#ef476f'}">${(trade.profit_loss_pct || 0).toFixed(2)}%</td>
                                                    <td style="color: #ef476f">${trade.max_drawdown_pips ? trade.max_drawdown_pips.toFixed(1) : 'N/A'}</td>
                                                    <td>${trade.duration_minutes ? Math.round(trade.duration_minutes) + 'm' : 'N/A'}</td>
                                                    <td>${trade.strategy || 'N/A'}</td>
                                                    <td><span class="badge bg-${trade.status === 'filled' ? 'success' : 'warning'}">${trade.status || 'N/A'}</span></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // If no TradeTracker data, show message
                if (!metricsData.success && !historyData.success && !activeData.success) {
                    tradeTrackerHTML = `
                        <div class="card mb-4" style="background: rgba(15, 52, 96, 0.3); border: 1px solid rgba(239, 71, 111, 0.3);">
                            <div class="card-body text-center" style="padding: 40px;">
                                <h5 style="color: #ef476f;">‚ö†Ô∏è TradeTracker Not Available</h5>
                                <p style="color: #999;">TradeTracker data is not available. Make sure TradeTracker is initialized and has trade data.</p>
                            </div>
                        </div>
                    `;
                }
                
                // Insert TradeTracker section at the beginning of analytics content
                const existingContent = content.innerHTML;
                content.innerHTML = tradeTrackerHTML + existingContent;
                
                console.log('‚úÖ TradeTracker data loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Error loading TradeTracker data:', error);
            }
        }
        
        async function loadPerformanceOverview() {
            try {
                const data = await fetchJson('/api/performance/live', { timeoutMs: 15000 });

                const totals = (data && data.totals) || {};
                const overviewDiv = document.getElementById('performanceOverview');
                if (overviewDiv) {
                    overviewDiv.innerHTML = `
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <div class="text-center">
                                    <h3 style="color: #06d6a0; margin: 0;">${totals.open_trades || 0}</h3>
                                    <p style="color: #ffffff; margin: 0;">Open Trades</p>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="text-center">
                                    <h3 style="color: #06d6a0; margin: 0;">${(totals.unrealized_pl || 0).toFixed ? totals.unrealized_pl.toFixed(2) : (totals.unrealized_pl || 0)}</h3>
                                    <p style="color: #ffffff; margin: 0;">Unrealized P&L</p>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="text-center">
                                    <h3 style="color: #06d6a0; margin: 0;">${data.trades_today || 0}</h3>
                                    <p style="color: #ffffff; margin: 0;">Trades Today</p>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="text-center">
                                    <h3 style="color: #06d6a0; margin: 0;">${(data.active_strategies || 0)}</h3>
                                    <p style="color: #ffffff; margin: 0;">Active Strategies</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading performance overview:', error);
                const overviewDiv = document.getElementById('performanceOverview');
                if (overviewDiv) {
                    overviewDiv.innerHTML = '<p style="color: #ff6b6b;">Error loading performance data</p>';
                }
            }
        }
        
        async function loadStrategyPerformanceCards() {
            try {
                const data = await fetchJson('/api/performance/live', { timeoutMs: 15000 });
                
                const cardsDiv = document.getElementById('strategyPerformanceCards');
                if (cardsDiv) {
                    const strategies = (data && data.accounts) ? Object.values(data.accounts) : [];
                    if (strategies && strategies.length > 0) {
                        cardsDiv.innerHTML = strategies.slice(0,6).map(strategy => `
                            <div class="col-md-6 mb-3">
                                <div class="card" style="background: rgba(33, 37, 41, 0.6); border: 1px solid #495057;">
                                    <div class="card-body">
                                        <h5 style="color: #ffffff;">${strategy.display_name || strategy.account_id || 'Account'}</h5>
                                        <div class="row">
                                            <div class="col-6">
                                                <small style="color: #adb5bd;">Open Trades: ${strategy.open_trades || 0}</small><br>
                                                <small style="color: #adb5bd;">Open Positions: ${strategy.open_positions || 0}</small>
                                            </div>
                                            <div class="col-6">
                                                <small style="color: #adb5bd;">Unrealized P&L: ${(strategy.unrealized_pl || 0)}</small><br>
                                                <small style="color: #adb5bd;">NAV: ${(strategy.nav || 0)}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        cardsDiv.innerHTML = '<p style="color: #adb5bd; text-align: center;">No strategy performance data available</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading strategy performance:', error);
                const cardsDiv = document.getElementById('strategyPerformanceCards');
                if (cardsDiv) {
                    cardsDiv.innerHTML = '<p style="color: #ff6b6b;">Error loading strategy data</p>';
                }
            }
        }
        
        async function loadTradeHistoryTable() {
            try {
                const data = await fetchJson('/api/performance/live', { timeoutMs: 15000 });
                
                const tableDiv = document.getElementById('tradeHistoryTable');
                if (tableDiv) {
                    const trades = (data && data.recent_trades) || [];
                    if (trades.length > 0) {
                        tableDiv.innerHTML = `
                            <div class="table-responsive">
                                <table class="table table-dark table-striped">
                                    <thead>
                                        <tr>
                                            <th style="color: #ffffff;">Trade ID</th>
                                            <th style="color: #ffffff;">Strategy</th>
                                            <th style="color: #ffffff;">Instrument</th>
                                            <th style="color: #ffffff;">Direction</th>
                                            <th style="color: #ffffff;">P&L</th>
                                            <th style="color: #ffffff;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${trades.slice(0, 10).map(trade => `
                                            <tr>
                                                <td style="color: #adb5bd;">${trade.trade_id}</td>
                                                <td style="color: #adb5bd;">${trade.strategy_id}</td>
                                                <td style="color: #adb5bd;">${trade.instrument}</td>
                                                <td style="color: ${trade.direction === 'BUY' ? '#06d6a0' : '#ff6b6b'};">${trade.direction}</td>
                                                <td style="color: ${trade.realized_pnl >= 0 ? '#06d6a0' : '#ff6b6b'};">${trade.realized_pnl || 'N/A'}</td>
                                                <td style="color: #adb5bd;">${trade.is_closed ? 'Closed' : 'Open'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    } else {
                        tableDiv.innerHTML = '<p style="color: #adb5bd; text-align: center;">No trade history available</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading trade history:', error);
                const tableDiv = document.getElementById('tradeHistoryTable');
                if (tableDiv) {
                    tableDiv.innerHTML = '<p style="color: #ff6b6b;">Error loading trade history</p>';
                }
            }
        }
        
        async function loadKeyMetrics() {
            try {
                const data = await fetchJson('/api/performance/live', { timeoutMs: 15000 });
                
                const metricsDiv = document.getElementById('keyMetrics');
                if (metricsDiv) {
                    const totals = (data && data.totals) || {};
                    metricsDiv.innerHTML = `
                        <div class="row">
                            <div class="col-12 mb-2">
                                <small style="color: #adb5bd;">Open Trades: <span style="color: #ffffff;">${totals.open_trades || 0}</span></small>
                            </div>
                            <div class="col-12 mb-2">
                                <small style="color: #adb5bd;">Unrealized P&L: <span style="color: #ffffff;">${(totals.unrealized_pl || 0)}</span></small>
                            </div>
                            <div class="col-12 mb-2">
                                <small style="color: #adb5bd;">Positions: <span style="color: #ffffff;">${totals.open_positions || 0}</span></small>
                            </div>
                            <div class="col-12 mb-2">
                                <small style="color: #adb5bd;">Timestamp: <span style="color: #ffffff;">${data.timestamp || ''}</span></small>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading key metrics:', error);
                const metricsDiv = document.getElementById('keyMetrics');
                if (metricsDiv) {
                    metricsDiv.innerHTML = '<p style="color: #ff6b6b;">Error loading metrics</p>';
                }
            }
        }
        
        async function loadDatabaseStats() {
            try {
                const data = await fetchJson('/api/performance/live', { timeoutMs: 15000 });
                
                const statsDiv = document.getElementById('databaseStats');
                if (statsDiv) {
                    const totals = (data && data.totals) || {};
                    statsDiv.innerHTML = `
                        <div class="row">
                            <div class="col-12 mb-2">
                                <small style="color: #adb5bd;">Open Trades: <span style="color: #ffffff;">${totals.open_trades || 0}</span></small>
                            </div>
                            <div class="col-12 mb-2">
                                <small style="color: #adb5bd;">Open Positions: <span style="color: #ffffff;">${totals.open_positions || 0}</span></small>
                            </div>
                            <div class="col-12 mb-2">
                                <small style="color: #adb5bd;">Total NAV: <span style="color: #ffffff;">${(totals.total_nav || 0)}</span></small>
                            </div>
                            <div class="col-12 mb-2">
                                <small style="color: #adb5bd;">Last Updated: <span style="color: #ffffff;">${data.timestamp || '‚Äî'}</span></small>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading database stats:', error);
                const statsDiv = document.getElementById('databaseStats');
                if (statsDiv) {
                    statsDiv.innerHTML = '<p style="color: #ff6b6b;">Error loading database stats</p>';
                }
            }
        }
        </script>
        
        <section id="ai-copilot" class="content-section">
            <div class="container-fluid" style="padding: 20px; background: var(--bg-dark); min-height: 600px;">
                <h2 style="color: #fff; margin-bottom: 30px; font-size: 2rem;">ü§ñ AI Copilot</h2>
                <div id="aiCopilotTabContent" style="color: #fff;">
                    <div class="text-center" style="padding: 40px;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3" style="color: #fff;">Loading AI Copilot...</p>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="reports" class="content-section">
            <div class="container-fluid" style="padding: 20px; background: var(--bg-dark); min-height: 600px;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 style="color: #fff; font-size: 2rem;">üìä Reports & Analytics</h2>
                    <button class="btn btn-primary" onclick="refreshReports()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh Reports
                    </button>
                </div>
                
                <!-- Reports List -->
                <div class="row mb-4" id="reportsList">
                    <div class="col-12">
                        <div class="card" style="background: rgba(15, 52, 96, 0.5); border: 1px solid #8338ec;">
                            <div class="card-header" style="background: rgba(131, 56, 236, 0.2); border-bottom: 1px solid #8338ec;">
                                <h4 style="color: #8338ec; margin: 0; font-size: 1.2rem;">
                                    üìã Available Reports
                                </h4>
                            </div>
                            <div class="card-body">
                                <div id="reportsListContent" style="text-align: center; padding: 20px; color: #666;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading reports...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Report Viewer -->
                <div class="row">
                    <div class="col-12">
                        <div class="card" style="background: rgba(15, 52, 96, 0.5); border: 1px solid #06d6a0;">
                            <div class="card-header" style="background: rgba(6, 214, 160, 0.2); border-bottom: 1px solid #06d6a0;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h4 id="reportViewerTitle" style="color: #06d6a0; margin: 0; font-size: 1.2rem;">
                                        Select a report to view
                                    </h4>
                                    <button class="btn btn-sm btn-secondary" id="downloadReportBtn" style="display: none;" onclick="downloadCurrentReport()">
                                        <i class="bi bi-download"></i> Download
                                    </button>
                                </div>
                            </div>
                            <div class="card-body" style="max-height: 70vh; overflow-y: auto;">
                                <div id="reportViewerContent" style="color: #ccc;">
                                    <div style="text-align: center; padding: 40px; color: #666;">
                                        <div style="font-size: 48px; margin-bottom: 20px;">üìä</div>
                                        <p>Click on a report above to view its contents</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <script>
        let currentReportId = null;
        
        async function loadReportsList() {
            try {
                const response = await fetch('/api/reports');
                const data = await response.json();
                
                const container = document.getElementById('reportsListContent');
                if (!data.success || !data.reports) {
                    container.innerHTML = '<p style="color: #ef476f;">Error loading reports</p>';
                    return;
                }
                
                if (data.reports.length === 0) {
                    container.innerHTML = '<p style="color: #999;">No reports available</p>';
                    return;
                }
                
                const html = data.reports.map(report => `
                    <div class="card mb-3 report-card" style="background: ${report.available ? 'rgba(6, 214, 160, 0.1)' : 'rgba(239, 71, 111, 0.1)'}; 
                        border: 1px solid ${report.available ? '#06d6a0' : '#ef476f'}; cursor: ${report.available ? 'pointer' : 'default'};"
                        onclick="${report.available ? `loadReport('${report.id}')` : ''}" data-report-id="${report.id}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div style="flex: 1;">
                                    <h5 style="color: ${report.available ? '#06d6a0' : '#ef476f'}; margin-bottom: 10px;">
                                        ${report.title}
                                    </h5>
                                    <p style="color: #999; font-size: 0.9em; margin-bottom: 5px;">
                                        ${report.description}
                                    </p>
                                    ${report.available && report.modified ? `
                                        <small style="color: #666;">
                                            Last updated: ${new Date(report.modified).toLocaleString()}
                                        </small>
                                    ` : ''}
                                    ${!report.available ? '<span class="badge bg-danger ms-2">Not Available</span>' : ''}
                                </div>
                                ${report.available ? `
                                    <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); loadReport('${report.id}')">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading reports:', error);
                document.getElementById('reportsListContent').innerHTML = 
                    '<p style="color: #ef476f;">Error loading reports. Please try again.</p>';
            }
        }
        
        async function loadReport(reportId) {
            currentReportId = reportId;
            const viewer = document.getElementById('reportViewerContent');
            const titleEl = document.getElementById('reportViewerTitle');
            const downloadBtn = document.getElementById('downloadReportBtn');
            
            viewer.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner-border text-primary"></div><p class="mt-2">Loading report...</p></div>';
            
            try {
                const response = await fetch(`/api/reports/${reportId}?format=html`);
                const data = await response.json();
                
                if (!data.success || !data.content) {
                    viewer.innerHTML = '<p style="color: #ef476f;">Error loading report content</p>';
                    downloadBtn.style.display = 'none';
                    return;
                }
                
                titleEl.textContent = data.metadata.title;
                viewer.innerHTML = `
                    <div style="background: rgba(15, 52, 96, 0.3); padding: 20px; border-radius: 8px;">
                        ${data.content}
                    </div>
                `;
                downloadBtn.style.display = 'inline-block';
                
                // Highlight active report card
                document.querySelectorAll('.report-card').forEach(card => {
                    card.style.border = card.dataset.reportId === reportId ? '2px solid #8338ec' : '';
                });
            } catch (error) {
                console.error('Error loading report:', error);
                viewer.innerHTML = '<p style="color: #ef476f;">Error loading report. Please try again.</p>';
                downloadBtn.style.display = 'none';
            }
        }
        
        function downloadCurrentReport() {
            if (!currentReportId) return;
            window.open(`/api/reports/${currentReportId}/download`, '_blank');
        }
        
        function refreshReports() {
            loadReportsList();
        }
        
        // Load reports when section is activated
        document.addEventListener('DOMContentLoaded', function() {
            // Watch for reports section activation
            const observer = new MutationObserver(function(mutations) {
                const reportsSection = document.getElementById('reports');
                if (reportsSection && reportsSection.classList.contains('active')) {
                    loadReportsList();
                }
            });
            
            observer.observe(document.body, {
                attributes: true,
                attributeFilter: ['class'],
                subtree: true
            });
            
            // Also load if already active
            const reportsSection = document.getElementById('reports');
            if (reportsSection && reportsSection.classList.contains('active')) {
                loadReportsList();
            }
        });
        </script>
        
        <section id="performance" class="content-section">
            <div class="container-fluid" style="padding: 20px; background: var(--bg-dark); min-height: 600px;">
                <h2 style="color: #fff; margin-bottom: 30px; font-size: 2rem;">üìà Performance Monitoring</h2>
                <div class="row">
                    <!-- Performance Overview -->
                    <div class="col-12 mb-4">
                        <div class="card" style="background: rgba(6, 214, 160, 0.1); border: 1px solid #06d6a0;">
                            <div class="card-header" style="background: rgba(6, 214, 160, 0.2); border-bottom: 1px solid #06d6a0;">
                                <h4 style="color: #06d6a0; margin: 0; font-size: 1.2rem;">
                                    üìä Strategy Performance Overview
                                </h4>
                            </div>
                            <div class="card-body" id="performanceOverview">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading performance data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Strategy Performance Cards -->
                    <div class="col-12 mb-4">
                        <div class="card" style="background: rgba(33, 37, 41, 0.8); border: 1px solid #495057;">
                            <div class="card-header" style="background: rgba(33, 37, 41, 0.9); border-bottom: 1px solid #495057;">
                                <h4 style="color: #ffffff; margin: 0; font-size: 1.2rem;">
                                    üéØ Individual Strategy Performance
                                </h4>
                            </div>
                            <div class="card-body" id="strategyPerformanceCards">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading strategy data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trade History -->
                    <div class="col-12 mb-4">
                        <div class="card" style="background: rgba(33, 37, 41, 0.8); border: 1px solid #495057;">
                            <div class="card-header" style="background: rgba(33, 37, 41, 0.9); border-bottom: 1px solid #495057;">
                                <h4 style="color: #ffffff; margin: 0; font-size: 1.2rem;">
                                    üìã Recent Trade History
                                </h4>
                            </div>
                            <div class="card-body" id="tradeHistoryTable">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading trade history...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Metrics -->
                    <div class="col-md-6 mb-4">
                        <div class="card" style="background: rgba(33, 37, 41, 0.8); border: 1px solid #495057;">
                            <div class="card-header" style="background: rgba(33, 37, 41, 0.9); border-bottom: 1px solid #495057;">
                                <h4 style="color: #ffffff; margin: 0; font-size: 1.2rem;">
                                    üìä Key Metrics
                                </h4>
                            </div>
                            <div class="card-body" id="keyMetrics">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading metrics...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Database Stats -->
                    <div class="col-md-6 mb-4">
                        <div class="card" style="background: rgba(33, 37, 41, 0.8); border: 1px solid #495057;">
                            <div class="card-header" style="background: rgba(33, 37, 41, 0.9); border-bottom: 1px solid #495057;">
                                <h4 style="color: #ffffff; margin: 0; font-size: 1.2rem;">
                                    üíæ Database Statistics
                                </h4>
                            </div>
                            <div class="card-body" id="databaseStats">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading database stats...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="config" class="content-section">
            <div class="container-fluid" style="padding: 20px; background: var(--bg-dark); min-height: 600px;">
                <h2 style="color: #fff; margin-bottom: 30px; font-size: 2rem;">‚öôÔ∏è Configuration</h2>
                <div id="configContent" style="color: #fff;">
                    <div class="text-center" style="padding: 40px;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3" style="color: #fff;">Loading configuration...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Trade Manager Section -->
        <section id="trade-manager" class="content-section">
            <div class="container-fluid" style="padding: 20px; background: var(--bg-dark); min-height: 600px;">
                <h2 style="color: #fff; margin-bottom: 30px; font-size: 2rem;"><i class="bi bi-sliders me-2"></i>Trade Manager</h2>
                <div id="tradeManagerContent" style="color: #fff;">
                    <div class="text-center" style="padding: 40px;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3" style="color: #fff;">Loading trade manager...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- System Status Section -->
        <section id="system-status" class="content-section">
            <div class="container-fluid" style="padding: 20px; background: var(--bg-dark); min-height: 600px;">
                <h2 style="color: #fff; margin-bottom: 30px; font-size: 2rem;"><i class="bi bi-heart-pulse me-2"></i>System Status</h2>
                <div id="systemStatusContent" style="color: #fff;">
                    <div class="text-center" style="padding: 40px;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3" style="color: #fff;">Loading system status...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- AI Insights Section -->
        <section id="insights" class="content-section">
            <div class="container-fluid" style="padding: 20px; background: var(--bg-dark); min-height: 600px;">
                <h2 style="color: #fff; margin-bottom: 30px; font-size: 2rem;"><i class="bi bi-lightbulb me-2"></i>AI Insights</h2>
                <div id="insightsContent" style="color: #fff;">
                    <div class="text-center" style="padding: 40px;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3" style="color: #fff;">Loading AI insights...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Strategy Switcher Section -->
        <section id="strategy-switcher" class="content-section">
            <div class="container-fluid" style="padding: 20px; background: var(--bg-dark); min-height: 600px;">
                <h2 style="color: #fff; margin-bottom: 30px; font-size: 2rem;"><i class="bi bi-shuffle me-2"></i>Strategy Switcher</h2>
                <div id="strategySwitcherContent" style="color: #fff;">
                    <div class="text-center" style="padding: 40px;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3" style="color: #fff;">Loading strategy switcher...</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Analytics Section -->
        <section id="analytics" class="content-section">
            <div class="container-fluid" style="padding: 20px; background: var(--bg-dark); min-height: 600px;">
                <h2 style="color: #fff; margin-bottom: 30px; font-size: 2rem;"><i class="bi bi-graph-up-arrow me-2"></i>Analytics</h2>
                <div id="analyticsContent" style="min-height: 400px; color: #fff;">
                    <div class="text-center" style="padding: 40px; color: #fff;">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                        <p class="mt-3" style="color: #fff; font-size: 1.1rem;">Loading analytics data...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Weekly Roadmap Section -->
        <section id="roadmap" class="content-section">
            <div class="container-fluid" style="padding: 20px; background: var(--bg-dark); min-height: 600px;">
                <h2 style="color: #fff; margin-bottom: 30px; font-size: 2rem;"><i class="bi bi-calendar-check me-2"></i>Weekly Roadmap Progress</h2>
                
                <!-- Week Overview -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card" style="background: rgba(58, 134, 255, 0.1); border: 1px solid #3a86ff;">
                            <div class="card-header" style="background: rgba(58, 134, 255, 0.2); border-bottom: 1px solid #3a86ff;">
                                <h4 style="color: #3a86ff; margin: 0;">üìÖ Week Overview</h4>
                            </div>
                            <div class="card-body" id="roadmapWeekOverview">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2">Loading roadmap data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Daily Progress -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card" style="background: rgba(33, 37, 41, 0.8); border: 1px solid #495057;">
                            <div class="card-header" style="background: rgba(33, 37, 41, 0.9); border-bottom: 1px solid #495057;">
                                <h4 style="color: #ffffff; margin: 0;">üìä Daily Progress</h4>
                            </div>
                            <div class="card-body" id="roadmapDailyProgress">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2">Loading daily progress...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Strategy Progress -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card" style="background: rgba(33, 37, 41, 0.8); border: 1px solid #495057;">
                            <div class="card-header" style="background: rgba(33, 37, 41, 0.9); border-bottom: 1px solid #495057;">
                                <h4 style="color: #ffffff; margin: 0;">üéØ Strategy Progress</h4>
                            </div>
                            <div class="card-body" id="roadmapStrategyProgress">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2">Loading strategy progress...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Trade History Section -->
        <section id="trade-history" class="content-section">
            <div class="container-fluid" style="padding: 20px; background: var(--bg-dark); min-height: 600px;">
                <h2 style="color: #fff; margin-bottom: 30px; font-size: 2rem;"><i class="bi bi-clock-history me-2"></i>Trade History</h2>
                
                <!-- Filters -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card" style="background: rgba(33, 37, 41, 0.8); border: 1px solid #495057;">
                            <div class="card-header" style="background: rgba(33, 37, 41, 0.9); border-bottom: 1px solid #495057;">
                                <h4 style="color: #ffffff; margin: 0;">üîç Filters</h4>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label" style="color: #fff;">Strategy</label>
                                        <select class="form-select" id="filterStrategy" style="background: #1a1a1a; color: #fff; border: 1px solid #495057;">
                                            <option value="all">All Strategies</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label" style="color: #fff;">Instrument</label>
                                        <select class="form-select" id="filterInstrument" style="background: #1a1a1a; color: #fff; border: 1px solid #495057;">
                                            <option value="all">All Instruments</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label" style="color: #fff;">Period</label>
                                        <select class="form-select" id="filterPeriod" style="background: #1a1a1a; color: #fff; border: 1px solid #495057;">
                                            <option value="today">Today</option>
                                            <option value="week">Last 7 Days</option>
                                            <option value="month" selected>Last 30 Days</option>
                                            <option value="90days">Last 90 Days</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label" style="color: #fff;">Status</label>
                                        <select class="form-select" id="filterStatus" style="background: #1a1a1a; color: #fff; border: 1px solid #495057;">
                                            <option value="all">All</option>
                                            <option value="open">Open Only</option>
                                            <option value="closed">Closed Only</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button class="btn btn-primary w-100" onclick="loadFilteredTradeHistory()" style="background: #3a86ff; border: none;">
                                            <i class="bi bi-search me-1"></i>Apply
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trade History Table -->
                <div class="row">
                    <div class="col-12">
                        <div class="card" style="background: rgba(33, 37, 41, 0.8); border: 1px solid #495057;">
                            <div class="card-header" style="background: rgba(33, 37, 41, 0.9); border-bottom: 1px solid #495057;">
                                <h4 style="color: #ffffff; margin: 0;">üìã Trade History</h4>
                            </div>
                            <div class="card-body" id="tradeHistoryContent">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2">Loading trade history...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Floating AI Copilot Button -->
    <button id="floatingCopilotBtn" style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;">
        <i class="bi bi-robot"></i>
    </button>

    <!-- Floating AI Copilot Panel -->
    <div id="floatingCopilotPanel" style="position: fixed; bottom: 90px; right: 20px; width: 400px; height: 600px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); z-index: 999; display: none; overflow: hidden;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; color: white; display: flex; justify-content: space-between; align-items: center;">
            <h5 style="margin: 0;"><i class="bi bi-robot me-2"></i>AI Copilot</h5>
            <button id="closeCopilotBtn" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; margin-left: auto;">&times;</button>
        </div>
        <div id="floatingCopilotContent" style="height: calc(100% - 60px); overflow-y: auto; padding: 15px;">
            <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                <i class="bi bi-robot" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                <p>AI Copilot is ready to assist you with trading decisions, market analysis, and strategy optimization.</p>
                <p style="font-size: 12px; margin-top: 10px;">Click on the AI Copilot tab for full interface.</p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
      /* Minimal contrast fixes without altering layout */
      body { color: #e5e7eb; }
      .card h3, .card h4, .card h5, .sidebar .nav-link { color: #ffffff; }
      .text-muted, .text-secondary, .text-body-secondary { color: #cbd5e1 !important; }
      .nav-link { color: #d1d5db; }
      .nav-link.active { color: #ffffff; }
    </style>
    <script>
        // Lightweight fetch helper with timeout, retries, and safe JSON parsing
        async function fetchJson(url, options = {}) {
            const {
                method = 'GET',
                headers = {},
                body = null,
                timeoutMs = 12000,
                retries = 2,
                backoffMs = 800
            } = options;

            for (let attempt = 0; attempt <= retries; attempt++) {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), timeoutMs);
                try {
                    const res = await fetch(url, { method, headers, body, signal: controller.signal });
                    clearTimeout(timeout);
                    if (!res.ok) {
                        // Surface status for caller UI messages
                        const text = await res.text().catch(() => '');
                        throw new Error(`HTTP ${res.status}: ${text.slice(0, 120)}`);
                    }
                    // Defensive JSON parse
                    const text = await res.text();
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        throw new Error('Invalid JSON');
                    }
                } catch (err) {
                    clearTimeout(timeout);
                    if (attempt === retries) throw err;
                    await new Promise(r => setTimeout(r, backoffMs * Math.pow(2, attempt)));
                }
            }
        }
        // Chart Management
        let priceChart = null;
        let currentInstrument = 'EUR_USD';
        let currentTimeframe = '1h';

        async function loadChartData(instrument, timeframe) {
            try {
                const response = await fetch(`/api/chart/candles/${instrument}?timeframe=${timeframe}&count=100`);
                const data = await response.json();
                
                if (data.success && data.candles) {
                    updateChart(data.candles);
                }
            } catch (error) {
                console.error('Chart data error:', error);
            }
        }

        function updateChart(candles) {
            const ctx = document.getElementById('priceChart');
            if (!ctx) return;
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded yet');
                return;
            }
            
            const labels = candles.map(c => new Date(c.time).toLocaleString());
            const prices = candles.map(c => parseFloat(c.mid.c));
            
            if (priceChart) {
                priceChart.destroy();
            }
            
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: currentInstrument,
                        data: prices,
                        borderColor: 'rgb(58, 134, 255)',
                        backgroundColor: 'rgba(58, 134, 255, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { grid: { color: '#444' }, ticks: { color: '#ccc' } },
                        x: { grid: { color: '#444' }, ticks: { color: '#ccc', maxRotation: 45 } }
                    }
                }
            });
        }

        // Helper to update TradingView link for current instrument
        function updateTradingViewLink() {
            const tv = document.getElementById('tvLink');
            if (!tv) return;
            // Use OANDA symbols on TradingView where possible
            const symbol = currentInstrument.replace('_', '');
            tv.href = `https://www.tradingview.com/chart/?symbol=OANDA:${symbol}`;
        }

        // Sidebar Live Prices
        async function updateSidebarPrices() {
            try {
                const response = await fetch('/api/sidebar/live-prices');
                const data = await response.json();
                
                if (data.success) {
                    const html = Object.values(data.prices).map(price => `
                        <div class="mb-2 p-2" style="border-left: 3px solid var(--primary); background: var(--bg-hover);">
                            <div class="d-flex justify-content-between">
                                <small>${price.instrument}</small>
                                <small>${price.bid.toFixed(5)}</small>
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('marketOverview').innerHTML = html;
                }
            } catch (error) {
                console.error('Sidebar prices error:', error);
            }
        }

        // Update sidebar every 5 seconds
        setInterval(updateSidebarPrices, 5000);
        updateSidebarPrices();

        // Floating Copilot Toggle
        document.getElementById('floatingCopilotBtn').addEventListener('click', function() {
            const panel = document.getElementById('floatingCopilotPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        });

        document.getElementById('closeCopilotBtn').addEventListener('click', function() {
            document.getElementById('floatingCopilotPanel').style.display = 'none';
        });

        // Initialize Socket.IO connection with robust reconnection
        window.socketStats = { connects: 0, disconnects: 0, lastEvent: 'init' };
        window.socketReady = new Promise((resolve) => { window.__socketResolve = resolve; });

        function initSocket() {
            if (typeof io === 'undefined') {
                setTimeout(initSocket, 300);
                return;
            }
            window.socket = io({
                path: '/socket.io',
                transports: ['polling'],  // Use polling only for Google Cloud compatibility
                reconnection: true,
                reconnectionAttempts: Infinity,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 8000,
                timeout: 20000,
                withCredentials: false,
                forceNew: true
            });
        }
        initSocket();
        
        // Connection status
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionText = document.getElementById('connectionText');
        
        // NEW: Cloud System Integration JavaScript Functions
        
        // Load cloud system performance data
        async function loadCloudPerformance() {
            try {
                let response = await fetch('/api/cloud/performance');
                // Fallbacks for older deployments or temporary backend errors
                if (!response.ok) {
                    response = await fetch('/api/performance/live');
                }
                let data;
                if (response.ok) {
                    data = await response.json();
                } else {
                    // Final fallback: use health to infer online status
                    const health = await fetch('/api/health');
                    if (health.ok) {
                        data = { status: 'online', total_pnl: 0, win_rate: null, trades_today: 0, max_trades: 10 };
                    } else {
                        throw new Error('All cloud performance endpoints failed');
                    }
                }
                
                const container = document.getElementById('cloudPerformance');
                if (container) {
                    const status = data.status || 'offline';
                    const statusColor = status === 'offline' ? '#ef4444' : '#10b981';
                    const statusText = status === 'offline' ? '‚ö†Ô∏è Offline' : '‚úÖ Online';
                    
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-size: 0.85rem; color: #d1d5db; margin-bottom: 5px;">System Status</div>
                                <div style="font-size: 1.3rem; font-weight: 600; color: ${statusColor};">${statusText}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: #d1d5db; margin-bottom: 5px;">Total P&L</div>
                                <div style="font-size: 1.3rem; font-weight: 600; color: ${data.total_pnl >= 0 ? '#10b981' : '#ef4444'};">
                                    ${data.total_pnl >= 0 ? '+' : ''}$${data.total_pnl?.toFixed(2) || '0.00'}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: #d1d5db; margin-bottom: 5px;">Win Rate</div>
                                <div style="font-size: 1.3rem; font-weight: 600; color: white;">
                                    ${data.win_rate ? (data.win_rate * 100).toFixed(1) + '%' : 'N/A'}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: #d1d5db; margin-bottom: 5px;">Trades Today</div>
                                <div style="font-size: 1.3rem; font-weight: 600; color: white;">
                                    ${data.trades_today || '0'}/${data.max_trades || '10'}
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading cloud performance:', error);
                const container = document.getElementById('cloudPerformance');
                if (container) {
                    container.innerHTML = '<div style="color: #ef4444; text-align: center;">‚ö†Ô∏è Cloud system unavailable</div>';
                }
            }
        }
        
        // Load API usage statistics
        async function loadAPIUsage() {
            try {
                const response = await fetch('/api/usage/stats');
                const data = await response.json();
                
                const container = document.getElementById('apiUsage');
                if (container) {
                    let html = '';
                    // NOTE: Intentionally omitting OANDA usage display per user preference
                    
                    // Marketaux API
                    if (data.marketaux) {
                        const marketaux = data.marketaux;
                        const mauxPercent = marketaux.percentage_used;
                        const mauxColor = mauxPercent < 70 ? 'green' : mauxPercent < 90 ? 'yellow' : 'red';
                        
                        html += `
                            <div class="api-gauge">
                                <div class="gauge-label">
                                    <span>${marketaux.name}</span>
                                    <span>${marketaux.calls_today}/${marketaux.daily_limit}</span>
                                </div>
                                <div class="gauge-bar">
                                    <div class="gauge-fill ${mauxColor}" style="width: ${mauxPercent}%;">
                                        ${mauxPercent.toFixed(1)}%
                                    </div>
                                </div>
                                <div class="gauge-remaining">${marketaux.remaining} calls remaining</div>
                            </div>
                        `;
                    }
                    
                    // Other APIs
                    if (data.other) {
                        const other = data.other;
                        const otherPercent = other.percentage_used;
                        const otherColor = otherPercent < 70 ? 'green' : otherPercent < 90 ? 'yellow' : 'red';
                        
                        html += `
                            <div class="api-gauge">
                                <div class="gauge-label">
                                    <span>${other.name}</span>
                                    <span>${other.calls_today}/${other.daily_limit}</span>
                                </div>
                                <div class="gauge-bar">
                                    <div class="gauge-fill ${otherColor}" style="width: ${otherPercent}%;">
                                        ${otherPercent.toFixed(1)}%
                                    </div>
                                </div>
                                <div class="gauge-remaining">${other.remaining} calls remaining</div>
                            </div>
                        `;
                    }
                    
                    container.innerHTML = html || '<div style="color:#9ca3af">No non-OANDA API usage yet</div>';
                }
            } catch (error) {
                console.error('Error loading API usage:', error);
            }
        }
        
        // Toggle master trading
        async function toggleMasterTrading() {
            const toggle = document.getElementById('masterTradingToggle');
            const status = document.getElementById('masterTradingStatus');
            const action = toggle.checked ? 'on' : 'off';
            
            try {
                const response = await fetch('/api/cloud/controls/toggle', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: action})
                });
                
                const data = await response.json();
                if (data.success) {
                    status.textContent = toggle.checked ? 'ON' : 'OFF';
                    status.style.color = toggle.checked ? '#10b981' : '#ef4444';
                }
            } catch (error) {
                console.error('Error toggling master trading:', error);
            }
        }
        
        // Toggle individual strategy
        async function toggleStrategy(strategyName) {
            const toggle = document.getElementById(strategyName + 'Toggle');
            const action = toggle.checked ? 'enable' : 'disable';
            
            try {
                const response = await fetch('/api/cloud/controls/strategy', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        strategy_name: strategyName,
                        action: action
                    })
                });
                
                const data = await response.json();
                if (!data.success) {
                    console.error('Error toggling strategy:', data.error);
                }
            } catch (error) {
                console.error('Error toggling strategy:', error);
            }
        }
        
        // Update risk parameters
        function updateRisk(value) {
            document.getElementById('riskValue').textContent = value + '%';
            
            fetch('/api/cloud/controls/risk', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({max_risk_per_trade: value})
            }).catch(error => console.error('Error updating risk:', error));
        }
        
        function updatePortfolioRisk(value) {
            document.getElementById('portfolioRiskValue').textContent = value + '%';
            
            fetch('/api/cloud/controls/risk', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({max_portfolio_risk: value})
            }).catch(error => console.error('Error updating portfolio risk:', error));
        }
        
        function updateMaxPos(value) {
            document.getElementById('maxPosValue').textContent = value;
            
            fetch('/api/cloud/controls/risk', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({max_positions: value})
            }).catch(error => console.error('Error updating max positions:', error));
        }
        
        // Toggle controls visibility
        function toggleControls() {
            const controls = document.getElementById('tradingControls');
            const icon = document.getElementById('controlsToggleIcon');
            
            if (controls.style.display === 'none') {
                controls.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                controls.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }
        
        // Auto-refresh cloud data
        setInterval(loadCloudPerformance, 15000); // Every 15 seconds
        setInterval(loadAPIUsage, 30000); // Every 30 seconds
        
        document.addEventListener('DOMContentLoaded', () => {
            // Load cloud data on page load
            loadCloudPerformance();
            loadAPIUsage();
          console.log('üöÄ Dashboard DOM loaded, initializing...');
          
          // Initialize navigation system FIRST
          initNavigation();
          
          // Then initialize dashboard
          initDashboard();

          // Wire timeframe buttons after DOM is ready
          document.querySelectorAll('[data-timeframe]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-timeframe]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentTimeframe = this.getAttribute('data-timeframe');
                loadChartData(currentInstrument, currentTimeframe);
                updateTradingViewLink();
            });
          });

          // Initial chart load and TV link
          loadChartData(currentInstrument, currentTimeframe);
          updateTradingViewLink();
        });
        
        // Initialize navigation system
        function initNavigation() {
            console.log('üîó Initializing navigation system...');
            
            // Handle sidebar navigation
            const navLinks = document.querySelectorAll('.sidebar .nav-link[data-section]');
            const contentSections = document.querySelectorAll('.content-section');
            
            console.log('Found nav links:', navLinks.length);
            console.log('Found content sections:', contentSections.length);
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Navigation clicked:', this.getAttribute('data-section'));
                    
                    // Remove active class from all nav links
                    navLinks.forEach(nav => nav.classList.remove('active'));
                    
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    // Hide all content sections
                    contentSections.forEach(section => {
                        section.classList.remove('active');
                        section.style.display = 'none'; // Force hide
                    });
                    
                    // Show selected section
                    const targetSection = this.getAttribute('data-section');
                    const section = document.getElementById(targetSection);
                    console.log('Target section:', targetSection, 'Found:', section !== null);
                    
                    if (section) {
                        section.classList.add('active');
                        section.style.display = 'block'; // Force show
                        console.log('Section activated:', targetSection);
                        console.log('Section display style:', section.style.display);
                        
                        // Load section data when navigated to (lazy loading)
                        const loaders = {
                            'dashboard': () => {
                                // Dashboard is already loaded, just ensure it's refreshed if needed
                                if (typeof loadSystemStatus !== 'undefined') loadSystemStatus();
                                if (typeof loadMarketData !== 'undefined') loadMarketData();
                            },
                            'accounts': typeof loadAccountsSection !== 'undefined' ? loadAccountsSection : null,
                            'strategies': typeof loadStrategiesSection !== 'undefined' ? loadStrategiesSection : null,
                            'positions': typeof loadPositionsSection !== 'undefined' ? loadPositionsSection : null,
                            'signals': typeof loadSignalsSection !== 'undefined' ? loadSignalsSection : null,
                            'news': typeof loadNewsSection !== 'undefined' ? loadNewsSection : null,
                            'trade-manager': typeof loadTradeManagerSection !== 'undefined' ? loadTradeManagerSection : null,
                            'system-status': typeof loadSystemStatusSection !== 'undefined' ? loadSystemStatusSection : null,
                            'config': typeof loadConfigSection !== 'undefined' ? loadConfigSection : null,
                            'insights': typeof loadInsightsSection !== 'undefined' ? loadInsightsSection : null,
                            'strategy-switcher': typeof loadStrategySwitcherSection !== 'undefined' ? loadStrategySwitcherSection : null,
                            'analytics': typeof loadAnalyticsSection !== 'undefined' ? loadAnalyticsSection : null,
                            'ai-copilot': typeof loadAICopilotSection !== 'undefined' ? loadAICopilotSection : null,
                            'reports': typeof loadReportsSection !== 'undefined' ? loadReportsSection : null,
                            'performance': typeof loadPerformanceSection !== 'undefined' ? loadPerformanceSection : null,
                            'roadmap': typeof loadRoadmapSection !== 'undefined' ? loadRoadmapSection : null,
                            'trade-history': typeof loadTradeHistorySection !== 'undefined' ? loadTradeHistorySection : null
                        };
                        
                        if (loaders[targetSection]) {
                            console.log('Loading section data for:', targetSection);
                            try {
                                if (typeof loaders[targetSection] === 'function') {
                                    loaders[targetSection]();
                                } else {
                                    console.warn('Loader for', targetSection, 'is not a function');
                                }
                            } catch (error) {
                                console.error('Error loading section', targetSection, ':', error);
                            }
                        } else {
                            console.warn('No loader found for section:', targetSection);
                        }
                    }
                });
            });
            
            // Handle hash-based navigation on page load
            const hash = window.location.hash.substring(1);
            if (hash) {
                const link = document.querySelector(`[data-section="${hash}"]`);
                if (link) {
                    console.log('Triggering initial navigation to:', hash);
                    link.click();
                }
            }
        }
        
        // Initialize dashboard data
        function initDashboard() {
            console.log('üöÄ Initializing dashboard...');
            
            // Test if JavaScript is working at all
            console.log('üéØ JAVASCRIPT IS WORKING - TEST MESSAGE');
            
            // Initialize AI Assistant
            initAIAssistant();
            
            // Load initial data with proper error handling
            loadSystemStatus();
            loadMarketData();
            loadRiskMetrics();
            loadNewsData();
            loadAccountDetails();
            console.log('üéØ About to call loadTradingSignals...');
            loadTradingSignals();
            console.log('üéØ loadTradingSignals called');
            loadInsights();
            loadTradeIdeas();
            
            // Refresh data at different intervals to prevent flickering
            // Market data: Every 5 seconds (prices change fast)
            setInterval(() => {
                console.log('üîÑ Refreshing market prices...');
                loadMarketData();
            }, 5000);
            
            // System status and account details: Every 10 seconds
            setInterval(() => {
                console.log('üîÑ Refreshing system status...');
                loadSystemStatus();
                loadRiskMetrics();
                loadAccountDetails();
                loadTradingSignals();
            }, 10000);
            
            // News data: Every 5 MINUTES (news doesn't change that fast!)
            setInterval(() => {
                console.log('üîÑ Refreshing news feed...');
                loadNewsData();
            }, 300000);  // 5 minutes
            
            // Insights and trade ideas: Every 30 seconds
            setInterval(() => {
                console.log('üîÑ Refreshing insights...');
                loadInsights();
                loadTradeIdeas();
            }, 30000);
        }
        
        // Load system status data
        async function loadSystemStatus() {
            try {
                console.log('üìä Loading system status...');
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.system_status === 'online') {
                    console.log('‚úÖ System status: online');
                    
                    // Update trading systems
                    if (data.trading_systems) {
                        updateTradingSystems(data.trading_systems);
                    }
                    
                    // Update market data
                    if (data.market_data) {
                        updateMarketData(data.market_data);
                    }
                    
                    // Update news data
                    if (data.news_data) {
                        updateNewsData(data.news_data);
                    }
                    
                    // Update trading metrics - INDIVIDUAL accounts only
                    if (data.trading_metrics) {
                        const tradingMetrics = document.getElementById('tradingMetrics');
                        if (tradingMetrics && data.trading_metrics.accounts) {
                            let html = '<div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">Individual Strategy Performance (Paper Trading)</div>';
                            Object.values(data.trading_metrics.accounts).forEach(account => {
                                if (account.error) return;
                                const winRateColor = account.win_rate >= 50 ? '#10b981' : '#ef4444';
                                const profitColor = account.total_profit >= 0 ? '#10b981' : '#ef4444';
                                html += `
                                    <div class="account-item" style="padding: 12px; margin-bottom: 12px; border: 1px solid #374151; border-radius: 6px;">
                                        <div style="font-weight: 600; color: #f3f4f6; margin-bottom: 8px;">${account.strategy_name}</div>
                                        <div class="metric-item" style="margin-bottom: 4px; font-size: 0.85rem;">
                                            <span>Win Rate:</span>
                                            <span style="color: ${winRateColor}">${account.win_rate.toFixed(1)}%</span>
                                        </div>
                                        <div class="metric-item" style="margin-bottom: 4px; font-size: 0.85rem;">
                                            <span>Trades:</span>
                                            <span>${account.total_trades} (${account.winning_trades}W / ${account.losing_trades}L)</span>
                                        </div>
                                        <div class="metric-item" style="margin-bottom: 4px; font-size: 0.85rem;">
                                            <span>Profit Factor:</span>
                                            <span>${account.profit_factor.toFixed(2)}</span>
                                        </div>
                                        <div class="metric-item" style="margin-bottom: 4px; font-size: 0.85rem;">
                                            <span>Total P&L:</span>
                                            <span style="color: ${profitColor}">$${account.total_profit.toFixed(2)}</span>
                                        </div>
                                    </div>
                                `;
                            });
                            tradingMetrics.innerHTML = html;
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå System status error:', error);
            }
        }
        
        // Load market data
        async function loadMarketData() {
            try {
                console.log('üí± Loading market data...');
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.market_data) {
                    updateMarketData(data.market_data);
                }
            } catch (error) {
                console.error('‚ùå Market data error:', error);
            }
        }
        
        // Load news data
        async function loadNewsData() {
            try {
                console.log('üì∞ Loading news data...');
                const response = await fetch('/api/news');
                const data = await response.json();
                
                if (data.status === 'success' && data.news_data) {
                    updateNewsData(data.news_data);
                }
            } catch (error) {
                console.error('‚ùå News data error:', error);
            }
        }
        
        // Load risk metrics
        async function loadRiskMetrics() {
            try {
                console.log('üõ°Ô∏è Loading risk metrics...');
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Extract account_statuses which contain balance, unrealized_pl, margin info
                if (data.account_statuses) {
                    const riskMetrics = document.getElementById('riskMetrics');
                    if (!riskMetrics) return;
                    
                    let html = '<div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">Individual Strategy Risk (Paper Trading)</div>';
                    
                    // Build risk metrics from account statuses
                    for (const [accountId, accountStatus] of Object.entries(data.account_statuses)) {
                        const system = data.trading_systems[accountId];
                        if (!system) continue;
                        
                        const balance = accountStatus.balance || 0;
                        const margin_used = accountStatus.margin_used || 0;
                        const unrealized_pl = accountStatus.unrealized_pl || 0;
                        
                        const risk_percentage = balance > 0 ? (margin_used / balance * 100) : 0;
                        let riskLevel = 'risk-low';
                        if (risk_percentage > 50) {
                            riskLevel = 'risk-high';
                        } else if (risk_percentage > 25) {
                            riskLevel = 'risk-medium';
                        }
                        
                        html += `
                            <div class="account-item" style="padding: 12px; margin-bottom: 12px; border: 1px solid #374151; border-radius: 6px;">
                                <div style="font-weight: 600; color: #f3f4f6; margin-bottom: 8px;">${system.strategy_name}</div>
                                <div class="risk-metric" style="margin-bottom: 4px;">
                                    <span>Balance:</span>
                                    <span>$${balance.toLocaleString()}</span>
                                </div>
                                <div class="risk-metric" style="margin-bottom: 4px;">
                                    <span>Risk:</span>
                                    <span class="risk-level ${riskLevel}">${risk_percentage.toFixed(1)}%</span>
                                </div>
                                <div class="risk-metric" style="margin-bottom: 4px;">
                                    <span>P&L:</span>
                                    <span style="color: ${unrealized_pl >= 0 ? '#10b981' : '#ef4444'}">$${unrealized_pl.toFixed(2)}</span>
                                </div>
                            </div>
                        `;
                    }
                    
                    riskMetrics.innerHTML = html;
                }
            } catch (error) {
                console.error('‚ùå Risk metrics error:', error);
            }
        }
        
        // Load account details
        async function loadAccountDetails() {
            try {
                console.log('üè¶ Loading account details...');
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.account_statuses) {
                    updateAccountDetails(data.account_statuses);
                }
            } catch (error) {
                console.error('‚ùå Account details error:', error);
            }
        }
        
        // Update trading systems display
        function updateTradingSystems(systems) {
            console.log('üìä Updating trading systems...');
            const systemsContainer = document.getElementById('systemsStatus');
            if (!systemsContainer) return;
            
            systemsContainer.innerHTML = '';
            
            Object.entries(systems).forEach(([accountId, system]) => {
                const systemDiv = document.createElement('div');
                systemDiv.className = 'system-item';
                systemDiv.innerHTML = `
                    <div class="system-name">${system.strategy_name}</div>
                    <div class="system-status">
                        <span class="status-indicator status-active"></span>
                        <span>Active</span>
                    </div>
                    <div class="system-balance">$${system.balance.toLocaleString()}</div>
                `;
                systemsContainer.appendChild(systemDiv);
            });
        }
        
        // Update market data display
        function updateMarketData(marketData) {
            console.log('üí± Updating market data...');
            const marketContainer = document.getElementById('marketData');
            if (!marketContainer) return;
            
            marketContainer.innerHTML = '';
            
            // Get first account's market data
            const firstAccount = Object.values(marketData)[0];
            if (!firstAccount) return;
            
            Object.entries(firstAccount).forEach(([instrument, data]) => {
                const pairDiv = document.createElement('div');
                pairDiv.className = 'enhanced-market-pair';
                pairDiv.innerHTML = `
                    <div class="strategy-info">
                        <div class="strategy-name">Live Data</div>
                        <div class="pair-name">${instrument}</div>
                    </div>
                    <div class="pair-price">${data.bid.toFixed(5)}</div>
                `;
                marketContainer.appendChild(pairDiv);
            });
        }
        
        // Update news data display - STABLE, NO FLICKERING
        let currentNewsData = [];  // Cache current news
        let lastNewsUpdate = null;
        
        function updateNewsData(newsData) {
            console.log('üì∞ Processing news update...');
            const newsContainer = document.getElementById('newsAlerts');
            if (!newsContainer) return;
            
            let items = Array.isArray(newsData) ? newsData : (newsData.news_items || []);
            
            // FILTER: Show financial/market news (broader filter)
            const tradingKeywords = [
                'fed', 'interest rate', 'cpi', 'inflation', 'gdp', 'employment', 'unemployment',
                'gold', 'forex', 'dollar', 'euro', 'yen', 'pound', 'usd', 'eur', 'gbp', 'jpy',
                'central bank', 'monetary policy', 'treasury', 'bonds', 'currency', 'economy',
                'recession', 'growth', 'nonfarm', 'payroll', 'trade', 'tariff', 'ecb', 'boe',
                'market', 'stock', 'financial', 'banking', 'investor', 'earnings', 'revenue',
                'profit', 'loss', 'volatility', 'trading', 'bullish', 'bearish', 'rally',
                'sell-off', 'correction', 'bull market', 'bear market', 'analyst', 'forecast'
            ];
            
            // Filter OUT irrelevant topics
            const excludeKeywords = [
                'tripadvisor', 'nightlife', 'restaurant', 'hotel', 'travel', 'vacation',
                'sports', 'entertainment', 'celebrity', 'movie', 'music', 'gaming'
            ];
            
            const filteredItems = items.filter(item => {
                const text = ((item.title || '') + ' ' + (item.summary || '')).toLowerCase();
                
                // Exclude non-financial topics
                const isExcluded = excludeKeywords.some(keyword => text.includes(keyword));
                if (isExcluded) return false;
                
                // Include if has trading keywords OR is general financial news
                return tradingKeywords.some(keyword => text.includes(keyword)) ||
                       text.includes('financial') || 
                       text.includes('market') ||
                       text.includes('investor');
            });
            
            // STABILITY: Only update if news actually changed
            const newHash = JSON.stringify(filteredItems.map(i => i.title || i.summary).slice(0, 8));
            const currentHash = JSON.stringify(currentNewsData.map(i => i.title || i.summary).slice(0, 8));
            
            if (newHash === currentHash && window.__hasNewsRendered) {
                console.log('üì∞ News unchanged - no flicker');
                return;  // Don't re-render if content is the same
            }
            
            currentNewsData = filteredItems;
            lastNewsUpdate = new Date();
            
            if (filteredItems.length === 0) {
                // Check if it's a rate limit issue (no raw items either)
                const isRateLimited = items.length === 0;
                
                if (isRateLimited) {
                    // Show sample news with rate limit warning
                    newsContainer.innerHTML = `
                        <div style="background: rgba(245, 158, 11, 0.15); padding: 12px; border-radius: 8px; border-left: 3px solid #f59e0b; margin-bottom: 12px;">
                            <div style="color: #fbbf24; font-weight: 600; font-size: 0.9em;">
                                ‚ö†Ô∏è NEWS APIs RATE-LIMITED
                            </div>
                            <div style="color: #cbd5e1; font-size: 0.85em; margin-top: 6px;">
                                All 4 news sources temporarily unavailable due to API limits.
                                News will resume in 15-60 minutes.
                            </div>
                            <div style="color: #94a3b8; font-size: 0.75em; margin-top: 6px;">
                                Last update: ${new Date().toLocaleTimeString()} | Next retry: ${new Date(Date.now() + 15*60*1000).toLocaleTimeString()}
                            </div>
                        </div>
                        
                        <div style="color: #94a3b8; font-size: 0.9em; margin-bottom: 12px; font-weight: 600;">
                            üì∞ SAMPLE NEWS (Example of typical feed):
                        </div>
                        
                        <div class="news-item" style="background: rgba(30, 41, 59, 0.6); padding: 14px; margin-bottom: 10px; border-radius: 8px; border-left: 3px solid #ef4444; opacity: 0.7;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <div style="color: #cbd5e1; font-size: 0.9em; font-weight: 600;">2h ago</div>
                                <div style="background: rgba(59, 130, 246, 0.25); padding: 3px 10px; border-radius: 6px; font-size: 0.75em; color: #e2e8f0; font-weight: 600;">
                                    üî¥ HIGH IMPACT
                                </div>
                            </div>
                            <div style="color: #f1f5f9; font-weight: 500; line-height: 1.5;">
                                Federal Reserve Maintains Interest Rate Policy - Monitoring Inflation Data
                            </div>
                        </div>
                        
                        <div class="news-item" style="background: rgba(30, 41, 59, 0.6); padding: 14px; margin-bottom: 10px; border-radius: 8px; border-left: 3px solid #f59e0b; opacity: 0.7;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <div style="color: #cbd5e1; font-size: 0.9em; font-weight: 600;">4h ago</div>
                                <div style="background: rgba(59, 130, 246, 0.25); padding: 3px 10px; border-radius: 6px; font-size: 0.75em; color: #e2e8f0; font-weight: 600;">
                                    üü° MODERATE
                                </div>
                            </div>
                            <div style="color: #f1f5f9; font-weight: 500; line-height: 1.5;">
                                Gold Prices Rally on Safe-Haven Demand - XAU/USD Breaks 2650
                            </div>
                        </div>
                        
                        <div class="news-item" style="background: rgba(30, 41, 59, 0.6); padding: 14px; margin-bottom: 10px; border-radius: 8px; border-left: 3px solid #10b981; opacity: 0.7;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <div style="color: #cbd5e1; font-size: 0.9em; font-weight: 600;">6h ago</div>
                                <div style="background: rgba(59, 130, 246, 0.25); padding: 3px 10px; border-radius: 6px; font-size: 0.75em; color: #e2e8f0; font-weight: 600;">
                                    üü¢ RELEVANT
                                </div>
                            </div>
                            <div style="color: #f1f5f9; font-weight: 500; line-height: 1.5;">
                                EUR/USD Consolidates Near 1.1700 - Traders Await ECB Commentary
                            </div>
                        </div>
                        
                        <div style="background: rgba(100, 116, 139, 0.1); padding: 12px; border-radius: 8px; margin-top: 12px; text-align: center;">
                            <div style="color: #94a3b8; font-size: 0.85em;">
                                üí° Live news resumes when API limits reset
                            </div>
                        </div>
                    `;
                } else {
                    // Filtered out but raw items exist
                    newsContainer.innerHTML = `
                        <div class="news-item" style="background: rgba(30, 41, 59, 0.5); padding: 15px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div class="news-time" style="color: #94a3b8; font-weight: 600;">Status</div>
                                <div style="background: rgba(100, 116, 139, 0.3); padding: 3px 10px; border-radius: 6px; font-size: 0.75em; color: #cbd5e1;">
                                    üìä FILTERED
                                </div>
                            </div>
                            <div class="news-summary" style="color: #e2e8f0; font-weight: 500; margin-top: 6px;">
                                ‚ÑπÔ∏è  No high-impact trading news in last 2 hours
                            </div>
                            <div style="font-size: 0.85em; color: #94a3b8; margin-top: 8px;">
                                Monitoring: Fed, Economic data, Forex, Central banks
                            </div>
                            <div style="font-size: 0.75em; color: #64748b; margin-top: 8px;">
                                Last checked: ${new Date().toLocaleTimeString()}
                            </div>
                        </div>
                    `;
                }
                window.__hasNewsRendered = true;
                return;
            }
            
            // Time ago calculator
            function getTimeAgo(rawTs) {
                try {
                    const pubDate = new Date(rawTs);
                    if (isNaN(pubDate.getTime())) return 'Recent';
                    
                    const now = new Date();
                    const diffMs = now - pubDate;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);
                    
                    if (diffMins < 1) return 'Just now';
                    if (diffMins < 60) return `${diffMins}m ago`;
                    if (diffHours < 24) return `${diffHours}h ago`;
                    if (diffDays === 1) return 'Yesterday';
                    if (diffDays < 7) return `${diffDays}d ago`;
                    return pubDate.toLocaleDateString();
                } catch (e) {
                    return 'Recent';
                }
            }
            
            // Impact level determination
            function getRelevance(text) {
                const lowerText = text.toLowerCase();
                if (lowerText.includes('fed') || lowerText.includes('interest rate') || lowerText.includes('cpi') || lowerText.includes('inflation') || lowerText.includes('gdp')) {
                    return { emoji: 'üî¥', text: 'HIGH IMPACT', color: '#ef4444' };
                } else if (lowerText.includes('gold') || lowerText.includes('employment') || lowerText.includes('central bank')) {
                    return { emoji: 'üü°', text: 'MODERATE', color: '#f59e0b' };
                } else {
                    return { emoji: 'üü¢', text: 'RELEVANT', color: '#10b981' };
                }
            }
            
            console.log(`üì∞ Rendering ${filteredItems.length} RELEVANT news items (STABLE - no flicker)`);
            window.__hasNewsRendered = true;
            newsContainer.innerHTML = '';
            
            // Add data freshness indicator at top
            const freshnessDiv = document.createElement('div');
            freshnessDiv.style.cssText = 'background: rgba(16, 185, 129, 0.15); padding: 8px 12px; border-radius: 6px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;';
            freshnessDiv.innerHTML = `
                <div style="color: #10b981; font-size: 0.85em; font-weight: 600;">
                    ‚óè LIVE FEED (Refreshes every 5 minutes)
                </div>
                <div style="color: #94a3b8; font-size: 0.75em;">
                    Updated: ${new Date().toLocaleTimeString()}
                </div>
            `;
            newsContainer.appendChild(freshnessDiv);
            
            // Add news integration status if available
            const newsIntegrationStatus = newsData.news_integration || {};
            const overallSentiment = newsData.sentiment_score || 0;
            
            if (newsIntegrationStatus.enabled) {
                const statusDiv = document.createElement('div');
                statusDiv.style.cssText = 'background: rgba(16, 185, 129, 0.15); padding: 10px 12px; border-radius: 6px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #10b981;';
                statusDiv.innerHTML = `
                    <div style="color: #10b981; font-size: 0.85em; font-weight: 600;">
                        ü§ñ AI News Sentiment Analysis: ${newsIntegrationStatus.status || 'ACTIVE'}
                    </div>
                    <div style="color: #94a3b8; font-size: 0.75em;">
                        Overall Sentiment: <span style="color: ${overallSentiment > 0 ? '#10b981' : overallSentiment < 0 ? '#ef4444' : '#94a3b8'}; font-weight: 600;">${(overallSentiment * 100).toFixed(1)}%</span>
                    </div>
                `;
                newsContainer.appendChild(statusDiv);
            }
            
            filteredItems.slice(0, 8).forEach(item => {
                const ts = item.timestamp || item.published_at || item.time || item.date;
                const title = item.title || item.summary || item.headline || 'Market update';
                const relevance = getRelevance(title);
                
                // Get sentiment score if available
                const sentiment = item.sentiment !== undefined && item.sentiment !== null ? item.sentiment : null;
                let sentimentBadge = '';
                
                if (sentiment !== null) {
                    const sentimentPct = (sentiment * 100).toFixed(1);
                    let sentimentColor = '#94a3b8';
                    let sentimentEmoji = '‚ö™';
                    
                    if (sentiment > 0.3) {
                        sentimentColor = '#10b981';
                        sentimentEmoji = 'üü¢';
                    } else if (sentiment > 0.1) {
                        sentimentColor = '#84cc16';
                        sentimentEmoji = 'üü°';
                    } else if (sentiment < -0.3) {
                        sentimentColor = '#ef4444';
                        sentimentEmoji = 'üî¥';
                    } else if (sentiment < -0.1) {
                        sentimentColor = '#f59e0b';
                        sentimentEmoji = 'üü†';
                    }
                    
                    sentimentBadge = `<div style="margin-top: 6px; padding: 4px 8px; background: rgba(${sentiment > 0 ? '16, 185, 129' : sentiment < 0 ? '239, 68, 68' : '148, 163, 184'}, 0.15); border-radius: 4px; display: inline-block; font-size: 0.75em;">
                        <span style="color: ${sentimentColor};">${sentimentEmoji} AI Sentiment: ${sentimentPct}%</span>
                    </div>`;
                }
                
                const newsDiv = document.createElement('div');
                newsDiv.className = 'news-item';
                newsDiv.style.cssText = `background: rgba(30, 41, 59, 0.6); padding: 14px; margin-bottom: 10px; border-radius: 8px; border-left: 3px solid ${relevance.color}; transition: all 0.3s ease;`;
                newsDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div class="news-time" style="color: #cbd5e1; font-size: 0.9em; font-weight: 600;">
                            ${getTimeAgo(ts)}
                        </div>
                        <div style="background: rgba(59, 130, 246, 0.25); padding: 3px 10px; border-radius: 6px; font-size: 0.75em; color: #e2e8f0; font-weight: 600;">
                            ${relevance.emoji} ${relevance.text}
                        </div>
                    </div>
                    <div class="news-summary" style="color: #f1f5f9; font-weight: 500; line-height: 1.5; font-size: 0.95em;">
                        ${title}
                    </div>
                    ${sentimentBadge}
                `;
                newsContainer.appendChild(newsDiv);
            });
        }
        
        // Load insights
        async function loadInsights() {
            try {
                const res = await fetch('/api/insights');
                const data = await res.json();
                const el = document.getElementById('dashboardInsightsContent');
                if (!el) return;
                if (data.status === 'ok' && data.insights) {
                    const s = data.insights;
                    el.innerHTML = `
                        <div><b>Market impact:</b> ${s.market_impact || 'neutral'}</div>
                        <div><b>Sentiment:</b> ${(s.overall_sentiment ?? 0).toFixed(2)}</div>
                        <div><b>Confidence:</b> ${(s.confidence ?? 0).toFixed(2)}</div>
                        <div><b>Opportunities:</b> ${(s.opportunities || []).length}</div>
                    `;
                }
            } catch (e) { /* noop */ }
        }

        // Update account details display
        function updateAccountDetails(accounts) {
            console.log('üè¶ Updating account details...');
            const accountContainer = document.getElementById('accountDetails');
            if (!accountContainer) return;
            
            accountContainer.innerHTML = '';
            
            Object.entries(accounts).forEach(([accountId, account]) => {
                const accountDiv = document.createElement('div');
                accountDiv.className = 'account-item';
                
                // Check if this is account 008 (AI-Enhanced)
                const isAIEnhanced = account.ai_enhanced === true || accountId === "101-004-30719775-008";
                const newsIntegration = account.news_integration || {};
                const aiFeatures = account.ai_features || {};
                
                let aiBadge = '';
                let newsStatus = '';
                let aiFeaturesList = '';
                
                if (isAIEnhanced) {
                    aiBadge = '<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: 8px;">ü§ñ AI-ENHANCED</span>';
                    
                    if (newsIntegration.enabled) {
                        newsStatus = `<div style="margin-top: 8px; padding: 8px; background: rgba(16, 185, 129, 0.1); border-left: 3px solid #10b981; border-radius: 4px;">
                            <div style="font-size: 12px; color: #10b981;">‚úÖ News Integration: ${newsIntegration.status || 'ACTIVE'}</div>
                            <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">API Keys: ${newsIntegration.api_keys_loaded || 0} loaded</div>
                        </div>`;
                    }
                    
                    if (Object.keys(aiFeatures).length > 0) {
                        const featuresList = Object.entries(aiFeatures)
                            .filter(([key, value]) => value === true)
                            .map(([key]) => key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()))
                            .join(', ');
                        
                        aiFeaturesList = `<div style="margin-top: 8px; font-size: 11px; color: #94a3b8;">
                            <strong style="color: #f3f4f6;">AI Features:</strong> ${featuresList}
                        </div>`;
                    }
                }
                
                accountDiv.innerHTML = `
                    <div class="account-header">
                        <div class="account-name">${account.account_name || accountId}${aiBadge}</div>
                        <div class="account-status status-active">Active</div>
                    </div>
                    <div class="account-balance">$${account.balance.toLocaleString()}</div>
                    <div class="account-strategy">${account.strategy || 'N/A'}</div>
                    ${newsStatus}
                    ${aiFeaturesList}
                `;
                accountContainer.appendChild(accountDiv);
            });
        }
        
        // Initialize AI Assistant (removed duplicate - handled by separate script below)
        function initAIAssistant() {
            console.log('ü§ñ AI Assistant handled by separate script');
        }
        
        // Load trading signals
        async function loadTradingSignals() {
            console.log('üéØ loadTradingSignals() called - STARTING');
            try {
                console.log('üéØ Loading trading signals...');
                const response = await fetch('/api/signals/pending');
                console.log('üéØ Response received:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üéØ Data received:', data);
                    if (data.signals && data.signals.length > 0) {
                        console.log('üéØ Calling updateTradingSignals with', data.signals.length, 'signals');
                        updateTradingSignals(data);
                        return;
                    }
                }

                // Fallback: show recent signals if pending is empty
                try {
                    const recentRes = await fetch('/api/signals/recent');
                    if (recentRes.ok) {
                        const recent = await recentRes.json();
                        if (recent && Array.isArray(recent.signals) && recent.signals.length > 0) {
                            const mapped = {
                                signals: recent.signals.map(s => ({
                                    id: s.id || s.signal_id || Math.random().toString(36).slice(2),
                                    instrument: s.instrument || s.pair || 'UNKNOWN',
                                    direction: (s.side || s.signal_type || '').toUpperCase(),
                                    entry_price: s.entry_price || s.price || s.current_price || '-',
                                    stop_loss: s.stop_loss || s.sl || '-',
                                    take_profit: s.take_profit || s.tp || '-',
                                    quality_score: Math.round((s.confidence || 0.7) * 100)
                                }))
                            };
                            updateTradingSignals(mapped);
                            return;
                        }
                    }
                } catch (fallbackErr) {
                    console.warn('Recent signals fallback failed:', fallbackErr);
                }
            } catch (error) {
                console.error('‚ùå Trading signals error:', error);
            }
            console.log('üéØ loadTradingSignals() finished');
        }
        
        // Update trading signals display
        function updateTradingSignals(data) {
            console.log('üéØ Updating trading signals...');
            const signalsContainer = document.getElementById('tradingSignals');
            if (!signalsContainer) return;
            
            const signals = data.signals || [];
            if (signals.length === 0) {
                signalsContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <div style="font-size: 18px; margin-bottom: 10px;">üìä</div>
                        <div>No active signals</div>
                    </div>
                `;
                return;
            }
            
            signalsContainer.innerHTML = `
                <div class="trading-signals">
                    ${signals.map(signal => {
                        // Check for AI boost information
                        const aiBoost = signal.ai_boost || null;
                        const boostedConfidence = signal.boosted_confidence ? Math.round(signal.boosted_confidence * 100) : signal.quality_score;
                        const baseConfidence = signal.confidence ? Math.round(signal.confidence * 100) : signal.quality_score;
                        
                        let aiBoostBadge = '';
                        let aiBoostInfo = '';
                        
                        if (aiBoost && aiBoost.enabled) {
                            if (aiBoost.type === 'BOOST') {
                                aiBoostBadge = `<span style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 2px 8px; border-radius: 8px; font-size: 10px; font-weight: 600; margin-left: 6px;">ü§ñ AI +${aiBoost.multiplier.toFixed(2)}x</span>`;
                                aiBoostInfo = `<div style="margin-top: 8px; padding: 6px; background: rgba(16, 185, 129, 0.1); border-left: 2px solid #10b981; border-radius: 4px; font-size: 11px;">
                                    <div style="color: #10b981;">${aiBoost.description}</div>
                                    ${signal.news_sentiment !== null && signal.news_sentiment !== undefined ? `<div style="color: #94a3b8; margin-top: 2px;">Sentiment: ${(signal.news_sentiment * 100).toFixed(1)}%</div>` : ''}
                                </div>`;
                            } else if (aiBoost.type === 'REDUCTION') {
                                aiBoostBadge = `<span style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 2px 8px; border-radius: 8px; font-size: 10px; font-weight: 600; margin-left: 6px;">ü§ñ AI ${aiBoost.multiplier.toFixed(2)}x</span>`;
                                aiBoostInfo = `<div style="margin-top: 8px; padding: 6px; background: rgba(239, 68, 68, 0.1); border-left: 2px solid #ef4444; border-radius: 4px; font-size: 11px;">
                                    <div style="color: #ef4444;">${aiBoost.description}</div>
                                </div>`;
                            }
                        }
                        
                        return `
                    <div class="opportunity-card">
                        <div class="opportunity-header">
                            <div class="opportunity-title">
                                ${signal.direction === 'BUY' ? 'üü¢' : 'üî¥'} ${signal.instrument} ${signal.direction}${aiBoostBadge}
                            </div>
                            <div class="opportunity-quality">
                                ${boostedConfidence}/100${aiBoost && aiBoost.enabled ? `<span style="font-size: 10px; color: #94a3b8; margin-left: 4px;">(${baseConfidence} base)</span>` : ''}
                            </div>
                        </div>
                        <div class="opportunity-details">
                            <div class="detail-row">
                                <div class="detail-item">
                                    <span class="detail-label">Entry Price:</span>
                                    <span class="detail-value">${signal.entry_price}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Stop Loss:</span>
                                    <span class="detail-value">${signal.stop_loss}</span>
                                </div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-item">
                                    <span class="detail-label">Confidence:</span>
                                    <span class="detail-value" style="color: #ffffff;">${boostedConfidence}%</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Strategy:</span>
                                    <span class="detail-value" style="color: #ffffff;">Scalping</span>
                                </div>
                            </div>
                            ${aiBoostInfo}
                        </div>
                        <div class="opportunity-actions">
                            <button class="action-btn approve-btn" onclick="approveSignal('${signal.id}')">
                                ‚úî Approve Trade
                            </button>
                            <button class="action-btn watch-btn" onclick="watchSignal('${signal.id}')">
                                üëÅÔ∏è Watch
                            </button>
                            <button class="action-btn hold-btn" onclick="holdSignal('${signal.id}')">
                                ‚ùå Hold
                            </button>
                        </div>
                    </div>
                    `).join('')}
                </div>
            `;
        }

        // Signal action functions
        function approveSignal(signalId) {
            console.log('‚úÖ Approving signal:', signalId);
            // TODO: Implement signal approval logic
            alert(`Signal ${signalId} approved!`);
        }

        function watchSignal(signalId) {
            console.log('üëÅÔ∏è Watching signal:', signalId);
            // TODO: Implement signal watch logic
            alert(`Signal ${signalId} added to watchlist!`);
        }

        function holdSignal(signalId) {
            console.log('‚ùå Holding signal:', signalId);
            // TODO: Implement signal hold logic
            alert(`Signal ${signalId} held!`);
        }

        // Handle slash commands
        async function handleSlashCommand(cmd, messages) {
            const lower = cmd.toLowerCase();
            let url = null;
            if (lower.startsWith('/status')) url = '/api/status';
            else if (lower.startsWith('/accounts')) url = '/api/accounts';
            else if (lower.startsWith('/risk')) url = '/api/risk';
            else if (lower.startsWith('/metrics')) url = '/api/metrics';
            else if (lower.startsWith('/positions')) url = '/api/positions';
            else if (lower.startsWith('/signals')) url = '/api/signals/recent';
            else if (lower.startsWith('/news')) url = '/api/news';
            else if (lower.startsWith('/insights')) url = '/api/insights';
            else if (lower.startsWith('/ideas')) url = '/api/trade_ideas';
            else if (lower.startsWith('/action strategy')) url = '/actions/strategy';
            else if (lower.startsWith('/action risk')) url = '/actions/risk';
            else if (lower.startsWith('/action orders')) url = '/actions/orders';

            const aiMsg = document.createElement('div');
            aiMsg.className = 'message ai-message';

            if (!url) {
                aiMsg.textContent = 'Unknown command. Try: /status /accounts /risk /metrics /positions /signals /news /insights /ideas';
                messages.appendChild(aiMsg);
                return;
            }
            try {
                const isAction = url.startsWith('/actions/');
                const res = await fetch(url, {
                    method: isAction ? 'POST' : 'GET',
                    headers: isAction ? { 'Content-Type': 'application/json' } : undefined,
                    body: isAction ? buildActionBody(lower) : undefined
                });
                const data = await res.json();
                // If action pending with action_id, render confirm/cancel buttons
                if (url.startsWith('/actions/') && data && data.confirm_required && data.action_id) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'message ai-message';
                    const pre = document.createElement('pre');
                    pre.textContent = JSON.stringify(data.preview, null, 2);
                    const row = document.createElement('div');
                    row.style.display = 'flex';
                    row.style.gap = '8px';
                    row.style.marginTop = '8px';
                    const confirmBtn = document.createElement('button');
                    confirmBtn.textContent = 'Confirm';
                    confirmBtn.className = 'confirm-button';
                    confirmBtn.onclick = async () => {
                        confirmBtn.disabled = true;
                        const r = await fetch('/actions/confirm', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action_id: data.action_id }) });
                        const rd = await r.json();
                        const done = document.createElement('pre');
                        done.textContent = JSON.stringify(rd, null, 2);
                        wrapper.appendChild(done);
                    };
                    const cancelBtn = document.createElement('button');
                    cancelBtn.textContent = 'Cancel';
                    cancelBtn.className = 'cancel-button';
                    cancelBtn.onclick = () => { wrapper.remove(); };
                    row.appendChild(confirmBtn);
                    row.appendChild(cancelBtn);
                    wrapper.appendChild(pre);
                    wrapper.appendChild(row);
                    messages.appendChild(wrapper);
                } else {
                    aiMsg.textContent = JSON.stringify(data, null, 2);
                    messages.appendChild(aiMsg);
                }
            } catch (e) {
                aiMsg.textContent = 'Error: ' + e;
                messages.appendChild(aiMsg);
            }
        }

        function buildActionBody(cmd) {
            // Simple parser for demo: examples
            // /action strategy pause all
            // /action risk account=101-... max_risk_per_trade=0.02
            // /action orders close_positions instrument=EUR_USD
            const parts = cmd.split(/\s+/);
            if (cmd.startsWith('/action strategy')) {
                return JSON.stringify({ action: parts[2] || 'pause', target: parts[3] || 'all' });
            }
            if (cmd.startsWith('/action risk')) {
                const payload = { account_id: '', changes: {} };
                parts.slice(3).forEach(p => {
                    const [k,v] = p.split('=');
                    if (k === 'account' || k === 'account_id') payload.account_id = v;
                    else if (k) payload.changes[k] = v;
                });
                return JSON.stringify(payload);
            }
            if (cmd.startsWith('/action orders')) {
                const payload = { op: parts[2] || 'close_positions', filter: {} };
                parts.slice(3).forEach(p => {
                    const [k,v] = p.split('=');
                    if (k) payload.filter[k] = v;
                });
                return JSON.stringify(payload);
            }
            return JSON.stringify({});
        }

        // Load insights
        // Removed duplicate loadInsights() function - using the one above that targets dashboardInsightsContent

        // Load trade ideas
        async function loadTradeIdeas() {
            try {
                const res = await fetch('/api/trade_ideas');
                const data = await res.json();
                if (data.status === 'success' && Array.isArray(data.ideas)) {
                    renderTradeIdeas(data.ideas);
                }
            } catch (e) {
                console.error('‚ùå Trade ideas error:', e);
            }
        }

        // Render trade ideas
        function renderTradeIdeas(ideas) {
            const el = document.getElementById('tradeIdeasContent');
            if (!el) return;
            if (!ideas.length) {
                el.innerHTML = '<div class="muted" style="padding: 12px;">No current ideas</div>';
                return;
            }
            el.innerHTML = ideas.slice(0, 6).map(idea => `
                <div class="signal-item">
                    <div class="signal-pair">${idea.instrument}</div>
                    <div class="signal-action">${idea.action}</div>
                    <div class="signal-confidence">${idea.confidence}%</div>
                </div>
                <div class="muted" style="margin-top:-8px; margin-bottom:8px;">${idea.reason}</div>
            `).join('');
        }
        function safeSocket(cb){ if (window.socket) cb(window.socket); }

        // Enhanced countdown timer with importance indicators
        let countdownInterval = null;
        let nextMajorEvent = null;
        
        async function fetchEconomicCalendar() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Look for real upcoming events
                const upcoming = data.upcoming_news || [];
                nextMajorEvent = null;
                
                // Find next event with timestamp
                for (const event of upcoming) {
                    if (event.timestamp) {
                        nextMajorEvent = event;
                        break;
                    }
                }
                
                // If no timestamped events, create synthetic next economic release
                if (!nextMajorEvent) {
                    const nextRelease = new Date();
                    nextRelease.setDate(1);
                    nextRelease.setMonth(nextRelease.getMonth() + 1);
                    nextRelease.setHours(8, 30, 0);
                    
                    nextMajorEvent = {
                        timestamp: nextRelease.toISOString(),
                        event: 'Next Major Economic Data Release (CPI/Fed)',
                        impact: 'high',
                        currency: 'USD'
                    };
                }
                
                updateCountdownDisplay();
            } catch (error) {
                console.error('‚ùå Calendar fetch failed:', error);
                updateCountdownDisplay();
            }
        }
        
        function updateCountdownDisplay() {
            const newsTimer = document.getElementById('newsTimer');
            const upcomingNews = document.getElementById('upcomingNews');
            
            if (!newsTimer) return;
            
            if (nextMajorEvent && nextMajorEvent.timestamp) {
                const eventTime = new Date(nextMajorEvent.timestamp);
                const now = new Date();
                const timeUntil = eventTime - now;
                
                if (timeUntil > 0) {
                    const days = Math.floor(timeUntil / 86400000);
                    const hours = Math.floor((timeUntil % 86400000) / 3600000);
                    const minutes = Math.floor((timeUntil % 3600000) / 60000);
                    const seconds = Math.floor((timeUntil % 60000) / 1000);
                    
                    let countdownText = '';
                    let urgencyClass = '';
                    
                    if (days > 0) {
                        countdownText = `${days}d ${hours}h ${minutes}m`;
                        urgencyClass = 'countdown-normal';
                    } else if (hours > 2) {
                        countdownText = `${hours}h ${minutes}m ${seconds}s`;
                        urgencyClass = 'countdown-normal';
                    } else if (hours > 0) {
                        countdownText = `${hours}h ${minutes}m ${seconds}s`;
                        urgencyClass = 'countdown-warning';
                    } else if (minutes > 10) {
                        countdownText = `${minutes}m ${seconds}s`;
                        urgencyClass = 'countdown-warning';
                    } else {
                        countdownText = `${minutes}m ${seconds}s`;
                        urgencyClass = 'countdown-critical';
                    }
                    
                    newsTimer.innerHTML = `<span class="${urgencyClass}">${countdownText}</span>`;
                    
                    if (upcomingNews) {
                        const impact = nextMajorEvent.impact || 'medium';
                        const impactEmoji = impact === 'high' ? 'üî¥' : impact === 'medium' ? 'üü°' : 'üü¢';
                        const impactText = impact === 'high' ? 'HIGH IMPACT' : impact === 'medium' ? 'MODERATE' : 'LOW IMPACT';
                        
                        upcomingNews.innerHTML = `
                            <div class="impact-item" style="background: rgba(239, 68, 68, ${impact === 'high' ? 0.2 : 0.1}); border-left: 3px solid ${impact === 'high' ? '#ef4444' : '#f59e0b'};">
                                <div class="impact-time">${eventTime.toLocaleString()}</div>
                                <div class="impact-${impact}" style="font-weight: 600;">
                                    ${impactEmoji} ${impactText}: ${nextMajorEvent.event}
                                </div>
                                <div style="font-size: 0.85em; color: #94a3b8; margin-top: 4px;">
                                    Currency: ${nextMajorEvent.currency || 'USD'} | Countdown: ${countdownText}
                                </div>
                            </div>
                        `;
                    }
                    
                    if (!countdownInterval) {
                        countdownInterval = setInterval(updateCountdownDisplay, 1000);
                    }
                } else {
                    newsTimer.innerHTML = '<span class="countdown-critical">‚ö° EVENT NOW!</span>';
                    if (upcomingNews) {
                        upcomingNews.innerHTML = `
                            <div class="impact-item" style="background: rgba(239, 68, 68, 0.3); border-left: 3px solid #ef4444;">
                                <div class="impact-high" style="font-weight: 600;">üö® LIVE: ${nextMajorEvent.event}</div>
                                <div style="font-size: 0.85em; color: #fbbf24; margin-top: 4px;">
                                    ‚ö†Ô∏è High volatility expected
                                </div>
                            </div>
                        `;
                    }
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    setTimeout(fetchEconomicCalendar, 60000);
                }
            } else {
                newsTimer.innerHTML = '<span style="color: #94a3b8;">üìä No scheduled events</span>';
                if (upcomingNews) {
                    upcomingNews.innerHTML = `
                        <div class="impact-item" style="background: rgba(100, 116, 139, 0.1);">
                            <div class="impact-time">Status</div>
                            <div class="impact-info">‚ÑπÔ∏è  No major releases in next 24 hours</div>
                            <div style="font-size: 0.85em; color: #94a3b8; margin-top: 4px;">
                                Monitoring Fed, CPI, and GDP data
                            </div>
                        </div>
                    `;
                }
                setTimeout(fetchEconomicCalendar, 300000);
            }
        }
        
        function updateCountdownTimer(data) {
            // Legacy function for WebSocket compatibility
            if (data.next_news && data.next_news.timestamp) {
                nextMajorEvent = data.next_news;
                updateCountdownDisplay();
            }
        }
        
        // Start countdown
        fetchEconomicCalendar();

        safeSocket((socket) => socket.on('connect', function() {
            connectionText.textContent = 'Connected';
            connectionStatus.className = 'connection-status connection-connected';
            window.socketStats.connects += 1;
            window.socketStats.lastEvent = 'connect';
            if (window.__socketResolve) window.__socketResolve();
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            console.log('üîå Socket connected, requesting initial update...');
            socket.emit('request_update');
        }));
        
        safeSocket((socket) => socket.on('disconnect', function() {
            connectionText.textContent = 'Disconnected';
            connectionStatus.className = 'connection-status connection-disconnected';
            window.socketStats.disconnects += 1;
            window.socketStats.lastEvent = 'disconnect';
        }));
        
        // Debug: Log all socket events
        socket.onAny(function(eventName, ...args) {
            console.log('üîå Socket event received:', eventName, args);
        });

        // Helper functions for enhanced display
        function extractCurrencyPair(accountId) {
            // Extract currency pair from account ID like "101-004-30719775-001_EUR_USD"
            if (accountId.includes('_')) {
                const parts = accountId.split('_');
                const currencyPart = parts[parts.length - 1];
                return currencyPart.replace('_', '/');
            }
            return accountId; // fallback
        }

        function getStrategyName(accountId) {
            if (accountId.includes('101-004-30719775-001')) return 'Ultra Strict Forex';
            if (accountId.includes('101-004-30719775-002')) return 'Gold Scalping';  
            if (accountId.includes('101-004-30719775-003')) return 'Momentum Trading';
            return 'Trading Strategy';
        }

        // Update systems status
        socket.on('systems_update', function(data) {
            const systemsStatus = document.getElementById('systemsStatus');
            systemsStatus.innerHTML = '';
            
            for (const [key, system] of Object.entries(data)) {
                const systemItem = document.createElement('div');
                systemItem.className = 'system-item';
                
                let statusClass = 'status-unknown';
                let statusText = 'Unknown';
                
                if (system.status === 'running') {
                    statusClass = 'status-running';
                    statusText = 'Running';
                } else if (system.status === 'offline') {
                    statusClass = 'status-offline';
                    statusText = 'Offline';
                } else if (system.status === 'warning') {
                    statusClass = 'status-warning';
                    statusText = 'Warning';
                }
                
                systemItem.innerHTML = `
                    <div class="system-name">${system.strategy_name || system.name || 'Trading System'}</div>
                    <div class="system-status">
                        <span class="status-indicator ${statusClass}"></span>
                        <span>${statusText}</span>
                    </div>
                `;
                
                systemsStatus.appendChild(systemItem);
            }
        });
        
        // Enhanced market data display - FIXED to show clean currency pairs
        socket.on('market_update', function(data) {
            const marketData = document.getElementById('marketData');
            marketData.innerHTML = '';
            
            for (const [pair, market] of Object.entries(data)) {
                const marketPair = document.createElement('div');
                marketPair.className = 'enhanced-market-pair';
                
                // Extract clean currency pair from account ID string
                const cleanPair = extractCurrencyPair(pair);
                const strategyName = getStrategyName(pair);
                
                const liveIndicator = market.is_live ? '<span class="live-indicator"></span>' : '';
                const price = `${market.bid.toFixed(5)} / ${market.ask.toFixed(5)}`;
                
                marketPair.innerHTML = `
                    <div class="strategy-info">
                        <div class="strategy-name">${strategyName}</div>
                        <div class="pair-name">${liveIndicator}${cleanPair}</div>
                    </div>
                    <div class="pair-price">${price}</div>
                `;
                
                marketData.appendChild(marketPair);
            }
        });
        
        // Update risk metrics - INDIVIDUAL accounts only (no aggregation)
        socket.on('risk_update', function(data) {
            const riskMetrics = document.getElementById('riskMetrics');
            
            if (!data || !data.accounts) {
                riskMetrics.innerHTML = '<div class="risk-metric"><span>Loading individual account risk...</span></div>';
                return;
            }
            
            let html = '<div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">Individual Strategy Risk (Paper Trading)</div>';
            
            Object.values(data.accounts).forEach(account => {
                if (account.error) {
                    return; // Skip accounts with errors
                }
                
                let riskLevel = 'risk-low';
                if (account.risk_percentage > 50) {
                    riskLevel = 'risk-high';
                } else if (account.risk_percentage > 25) {
                    riskLevel = 'risk-medium';
                }
                
                html += `
                    <div class="account-item" style="padding: 12px; margin-bottom: 12px; border: 1px solid #374151; border-radius: 6px;">
                        <div style="font-weight: 600; color: #f3f4f6; margin-bottom: 8px;">${account.name}</div>
                        <div class="risk-metric" style="margin-bottom: 4px;">
                            <span>Balance:</span>
                            <span>$${account.balance.toLocaleString()}</span>
                        </div>
                        <div class="risk-metric" style="margin-bottom: 4px;">
                            <span>Risk:</span>
                            <span class="risk-level ${riskLevel}">${account.risk_percentage.toFixed(1)}%</span>
                        </div>
                        <div class="risk-metric" style="margin-bottom: 4px;">
                            <span>P&L:</span>
                            <span style="color: ${account.unrealized_pl >= 0 ? '#10b981' : '#ef4444'}">$${account.unrealized_pl.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            });
            
            riskMetrics.innerHTML = html;
        });
        
        // Update news and alerts
        socket.on('news_update', function(data) {
            const newsAlerts = document.getElementById('newsAlerts');
            newsAlerts.innerHTML = '';
            
            data.forEach(news => {
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item';
                
                const time = new Date(news.timestamp).toLocaleTimeString();
                
                newsItem.innerHTML = `
                    <div class="news-time">${time}</div>
                    <div class="news-summary">${news.summary}</div>
                `;
                
                newsAlerts.appendChild(newsItem);
            });
        });
        
        // Request initial data
        socket.emit('request_update');
        
        // Update trading metrics - INDIVIDUAL accounts only (no aggregation)
        socket.on('metrics_update', function(data) {
            const tradingMetrics = document.getElementById('tradingMetrics');
            
            if (!data || !data.accounts) {
                tradingMetrics.innerHTML = '<div class="metric-item"><span>Loading individual strategy metrics...</span></div>';
                return;
            }
            
            let html = '<div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">Individual Strategy Performance (Paper Trading)</div>';
            
            Object.values(data.accounts).forEach(account => {
                if (account.error) {
                    return; // Skip accounts with errors
                }
                
                const winRateColor = account.win_rate >= 50 ? '#10b981' : '#ef4444';
                const profitColor = account.total_profit >= 0 ? '#10b981' : '#ef4444';
                
                html += `
                    <div class="account-item" style="padding: 12px; margin-bottom: 12px; border: 1px solid #374151; border-radius: 6px;">
                        <div style="font-weight: 600; color: #f3f4f6; margin-bottom: 8px;">${account.strategy_name}</div>
                        <div class="metric-item" style="margin-bottom: 4px; font-size: 0.85rem;">
                            <span>Win Rate:</span>
                            <span style="color: ${winRateColor}">${account.win_rate.toFixed(1)}%</span>
                        </div>
                        <div class="metric-item" style="margin-bottom: 4px; font-size: 0.85rem;">
                            <span>Trades:</span>
                            <span>${account.total_trades} (${account.winning_trades}W / ${account.losing_trades}L)</span>
                        </div>
                        <div class="metric-item" style="margin-bottom: 4px; font-size: 0.85rem;">
                            <span>Profit Factor:</span>
                            <span>${account.profit_factor.toFixed(2)}</span>
                        </div>
                        <div class="metric-item" style="margin-bottom: 4px; font-size: 0.85rem;">
                            <span>Total P&L:</span>
                            <span style="color: ${profitColor}">$${account.total_profit.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            });
            
            tradingMetrics.innerHTML = html;
        });

        // Update news impact
        socket.on('news_impact_update', function(data) {
            console.log('üìä Received news_impact_update:', data);
            const newsTimer = document.getElementById('newsTimer');
            const tradePhase = document.getElementById('tradePhase');
            const upcomingNews = document.getElementById('upcomingNews');
            
            // Update countdown with enhanced functionality
            updateCountdownTimer(data);
            
            // Update AI trade phase
            if (data.trade_phase) {
                tradePhase.textContent = data.trade_phase;
                console.log('‚úÖ Updated trade phase:', data.trade_phase);
            }
            
            // Update upcoming news list
            upcomingNews.innerHTML = '';
            if (data.upcoming_news && data.upcoming_news.length > 0) {
                data.upcoming_news.forEach(news => {
                    const newsItem = document.createElement('div');
                    newsItem.className = 'impact-item';
                    
                    const time = news.time || 'Now';
                    const impact = news.impact || 'medium';
                    const impactClass = `impact-${impact.toLowerCase()}`;
                    
                    newsItem.innerHTML = `
                        <div class="impact-time">${time}</div>
                        <div class="${impactClass}">${news.event || news.title || 'Market Update'}</div>
                    `;
                    
                    upcomingNews.appendChild(newsItem);
                });
                console.log('‚úÖ Updated upcoming news:', data.upcoming_news.length, 'items');
            } else {
                // Show default message if no news
                upcomingNews.innerHTML = '<div class="impact-item"><div class="impact-time">Now</div><div class="impact-info">No scheduled high-impact events</div></div>';
            }
        });

        // Listen for live trades updates
        socket.on('trades_update', (data) => {
            console.log('üìä Received live trades update:', data);
            updateActiveTrades(data);
        });

        // Listen for individual account updates
        socket.on('account_update', (data) => {
            console.log('üìä Received account update:', data);
            updateAccountDetails(data);
        });

        // Function to display live trading data
        function updateActiveTrades(tradesData) {
            const container = document.getElementById('activeTradesData');
            
            if (!tradesData || tradesData.length === 0) {
                container.innerHTML = `
                    <div class="no-trades-message" style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 24px; margin-bottom: 10px;">üìä</div>
                        <div>No active trades</div>
                        <div style="font-size: 12px; margin-top: 10px;">Live OANDA data - No positions open</div>
                    </div>
                `;
                return;
            }
            
            // Display real trading data
            container.innerHTML = '';
            tradesData.forEach(trade => {
                const tradeItem = document.createElement('div');
                tradeItem.className = 'trade-item';
                
                const statusClass = trade.unrealized_pl >= 0 ? 'profit' : 'drawdown';
                const statusText = trade.unrealized_pl >= 0 ? 'In Profit' : 'In Drawdown';
                
                tradeItem.innerHTML = `
                    <div class="trade-header">
                        <div class="strategy-badge ${trade.strategy.toLowerCase().replace(' ', '-')}">${trade.strategy}</div>
                        <div class="trade-time">Opened: ${new Date(trade.open_time).toLocaleTimeString()}</div>
                    </div>
                    <div class="trade-details">
                        <div class="trade-pair">${trade.instrument} ${trade.side.toUpperCase()}</div>
                        <div class="trade-levels">
                            Entry: ${trade.entry_price} | SL: ${trade.stop_loss} | TP: ${trade.take_profit}
                        </div>
                        <div class="trade-status ${statusClass}">
                            ${trade.unrealized_pl >= 0 ? '+' : ''}${trade.unrealized_pl.toFixed(2)} | ${statusText} | Duration: ${trade.duration}
                        </div>
                    </div>
                `;
                
                container.appendChild(tradeItem);
            });
        }

        // Function to display individual account details
        function updateAccountDetails(accountsData) {
            const container = document.getElementById('accountDetails');
            
            if (!accountsData || Object.keys(accountsData).length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 24px; margin-bottom: 10px;">üìä</div>
                        <div>No account data available</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            Object.entries(accountsData).forEach(([accountId, accountData]) => {
                const accountItem = document.createElement('div');
                accountItem.className = 'account-item';
                
                // Get account name from ID
                let accountName = 'Unknown Account';
                if (accountId.includes('101-004-30719775-001')) {
                    accountName = 'Primary Account (Ultra Strict Forex)';
                } else if (accountId.includes('101-004-30719775-002')) {
                    accountName = 'Gold Scalping Account';
                } else if (accountId.includes('101-004-30719775-003')) {
                    accountName = 'Strategy Alpha Account (Momentum)';
                }
                
                const balance = accountData.balance || 0;
                const unrealizedPL = accountData.unrealized_pl || 0;
                const realizedPL = accountData.realized_pl || 0;
                const openTrades = (accountData.open_trade_count ?? accountData.open_trades ?? accountData.openTrades ?? 0);
                const openPositions = (accountData.open_position_count ?? accountData.open_positions ?? accountData.openPositions ?? 0);
                const positions = accountData.positions || [];
                
                accountItem.innerHTML = `
                    <div class="account-header">
                        <div class="account-name">${accountName}</div>
                        <div class="account-balance">$${balance.toFixed(2)}</div>
                    </div>
                    
                    <div class="account-metrics">
                        <div class="account-metric">
                            <span>Unrealized P&L:</span>
                            <span style="color: ${unrealizedPL >= 0 ? '#10b981' : '#ef4444'}">${unrealizedPL >= 0 ? '+' : ''}$${unrealizedPL.toFixed(2)}</span>
                        </div>
                        <div class="account-metric">
                            <span>Realized P&L:</span>
                            <span style="color: ${realizedPL >= 0 ? '#10b981' : '#ef4444'}">${realizedPL >= 0 ? '+' : ''}$${realizedPL.toFixed(2)}</span>
                        </div>
                        <div class="account-metric">
                            <span>Open Trades:</span>
                            <span>${openTrades}</span>
                        </div>
                        <div class="account-metric">
                            <span>Open Positions:</span>
                            <span>${openPositions}</span>
                        </div>
                    </div>
                    
                    ${positions.length > 0 ? `
                        <div class="positions-list">
                            <h4 style="color: #f3f4f6; margin-bottom: 10px;">Open Positions:</h4>
                            ${positions.map(position => `
                                <div class="position-item">
                                    <div class="position-header">
                                        <div class="position-pair">${position.instrument}</div>
                                        <div class="position-side ${position.side.toLowerCase()}">${position.side.toUpperCase()}</div>
                                    </div>
                                    <div class="position-details">
                                        <div><span>Units:</span> <span>${position.units}</span></div>
                                        <div><span>Entry:</span> <span>${position.entry_price}</span></div>
                                        <div><span>P&L:</span> <span style="color: ${position.unrealized_pl >= 0 ? '#10b981' : '#ef4444'}">${position.unrealized_pl >= 0 ? '+' : ''}$${position.unrealized_pl.toFixed(2)}</span></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 20px; color: #9ca3af;">
                            <div style="font-size: 16px; margin-bottom: 5px;">üìä</div>
                            <div>No open positions</div>
                        </div>
                    `}
                `;
                
                container.appendChild(accountItem);
            });
        }

        // Request updates every 30 seconds and update timestamp
        setInterval(() => {
            safeSocket((socket) => {
                console.log('üîÑ Requesting periodic update...');
                socket.emit('request_update');
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            });
        }, 30000);
        
        // INITIAL DATA LOAD: Fetch AI insights on page load (don't wait for WebSocket)
        async function loadInitialAIInsights() {
            try {
                console.log('üîÑ Loading initial AI insights...');
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Update Trade Phase
                const tradePhase = document.getElementById('tradePhase');
                if (tradePhase && data.trade_phase) {
                    tradePhase.textContent = data.trade_phase;
                    console.log('‚úÖ Initial trade phase loaded:', data.trade_phase);
                }
                
                // Update Upcoming News
                const upcomingNews = document.getElementById('upcomingNews');
                if (upcomingNews && data.upcoming_news && data.upcoming_news.length > 0) {
                    upcomingNews.innerHTML = '';
                    data.upcoming_news.forEach(news => {
                        const newsItem = document.createElement('div');
                        newsItem.className = 'impact-item';
                        const time = news.time || 'Now';
                        const impact = news.impact || 'medium';
                        newsItem.innerHTML = `
                            <div class="impact-time">${time}</div>
                            <div class="impact-${impact.toLowerCase()}">${news.event || news.title || 'Market Update'}</div>
                        `;
                        upcomingNews.appendChild(newsItem);
                    });
                    console.log('‚úÖ Initial upcoming news loaded:', data.upcoming_news.length, 'items');
                } else if (upcomingNews) {
                    upcomingNews.innerHTML = '<div class="impact-item"><div class="impact-time">Now</div><div class="impact-info">AI monitoring all instruments</div></div>';
                }
            } catch (error) {
                console.error('‚ùå Failed to load initial AI insights:', error);
            }
        }
        
        // Load AI insights after 2 seconds (give time for page to fully load)
        setTimeout(loadInitialAIInsights, 2000);
        
        // Update Contextual Insights
        async function updateContextualInsights() {
            try {
                // Get primary instrument from market data or default to XAU_USD
                const instrument = 'XAU_USD';
                
                const response = await fetch(`/api/contextual/${instrument}`);
                if (!response.ok) {
                    console.log('‚ö†Ô∏è Contextual insights not available yet');
                    return;
                }
                
                const data = await response.json();
                console.log('‚úÖ Contextual insights loaded:', data);
                
                // Update session context from main status if available
                const statusResponse = await fetch('/api/status');
                if (statusResponse.ok) {
                    const statusData = await statusResponse.json();
                    if (statusData.session_context) {
                        document.getElementById('session-quality-value').textContent = 
                            `${statusData.session_context.quality}/100`;
                        document.getElementById('active-sessions-value').textContent = 
                            statusData.session_context.active_sessions.join(', ') || 'None';
                        document.getElementById('session-description').textContent = 
                            statusData.session_context.description || 'No session data';
                    }
                }
                
                // Update price context
                if (data.price_context) {
                    const support = data.price_context.support_levels || [];
                    const resistance = data.price_context.resistance_levels || [];
                    
                    document.getElementById('support-levels').textContent = 
                        support.length > 0 ? support.map(l => l.toFixed(2)).join(', ') : 'None';
                    document.getElementById('resistance-levels').textContent = 
                        resistance.length > 0 ? resistance.map(l => l.toFixed(2)).join(', ') : 'None';
                    document.getElementById('trend-direction').textContent = 
                        data.price_context.trend || 'Unknown';
                }
            } catch (error) {
                console.error('‚ùå Failed to update contextual insights:', error);
            }
        }
        
        // Update contextual insights every 30 seconds
        setInterval(updateContextualInsights, 30000);
        // Initial load after 3 seconds
        setTimeout(updateContextualInsights, 3000);
        
        // ========================================
        // HYBRID MANUAL TRADING - OPPORTUNITIES
        // ========================================
        
        async function loadTradeOpportunities() {
            try {
                const response = await fetch('/api/opportunities');
                const data = await response.json();
                
                if (data.opportunities && data.opportunities.length > 0) {
                    displayOpportunities(data.opportunities);
                    updateABComparison(data.stats);
                } else {
                    document.getElementById('opportunitiesFeed').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 15px;">‚úÖ</div>
                            <div style="font-size: 18px; margin-bottom: 10px;">No opportunities right now</div>
                            <div style="font-size: 14px; color: #999;">AI is monitoring. Quality setups will appear here.</div>
                        </div>
                    `;
                }
                
                // Update counts
                document.getElementById('opportunityCount').textContent = data.opportunities?.length || 0;
                document.getElementById('autoCount').textContent = data.auto_queue?.length || 0;
                
            } catch (error) {
                console.error('Failed to load opportunities:', error);
            }
        }
        
        function displayOpportunities(opportunities) {
            const feed = document.getElementById('opportunitiesFeed');
            feed.innerHTML = '';
            
            opportunities.forEach(opp => {
                const card = createOpportunityCard(opp);
                feed.appendChild(card);
            });
        }
        
        function createOpportunityCard(opp) {
            const card = document.createElement('div');
            card.className = 'opportunity-card';
            
            // Map API fields to template fields
            const pair = opp.instrument || opp.pair || 'Unknown';
            const signal = opp.direction || opp.signal || 'SELL';
            const reason = (opp.pros && opp.pros.length > 0) ? opp.pros[0] : opp.reason || opp.recommendation || 'Trading signal detected';
            const entryPrice = opp.suggested_entry || opp.entry || opp.entry_price;
            const stopLoss = opp.fixed_stop_loss || opp.stop_loss;
            const takeProfit = opp.target || opp.take_profit;
            const confidence = opp.expected_win_rate || opp.confidence || 0.65;
            const riskReward = opp.risk_reward_ratio || opp.risk_reward || 1.5;
            const strategy = opp.strategy || 'Scalping';
            
            card.id = `opp_${pair.replace('/', '_')}_${opp.id || 'unknown'}`;
            
            const qualityClass = opp.quality_score >= 80 ? 'quality-excellent' :
                                opp.quality_score >= 60 ? 'quality-good' :
                                opp.quality_score >= 40 ? 'quality-moderate' : 'quality-weak';
            
            const recClass = signal === 'BUY' ? 'rec-buy' : 'rec-sell';
            
            const stars = '‚≠ê'.repeat(Math.ceil(opp.quality_score / 20));
            
            card.innerHTML = `
                <div class="opportunity-header">
                    <div class="opportunity-title">
                        ${signal === 'BUY' ? 'üü¢' : 'üî¥'} ${pair} ${signal}
                    </div>
                    <div class="quality-badge ${qualityClass}">
                        ${stars} ${opp.quality_score}/100
                    </div>
                </div>
                
                <div style="padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; margin-bottom: 15px;">
                    <div style="color: #ffffff; font-size: 0.95rem; margin-bottom: 12px;">
                        üìù ${reason}
                    </div>
                </div>
                
                <div class="opportunity-details">
                    <div class="detail-item">
                        <div class="detail-label">Entry Price</div>
                        <div class="detail-value">${entryPrice ? entryPrice.toFixed(5) : 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Stop Loss</div>
                        <div class="detail-value">${stopLoss ? stopLoss.toFixed(5) : 'N/A'}</div>
                    </div>
                    <div class="detail-item" style="border-left-color: #06d6a0;">
                        <div class="detail-label">Take Profit</div>
                        <div class="detail-value" style="color: #06d6a0;">${takeProfit ? takeProfit.toFixed(5) : 'N/A'}</div>
                    </div>
                    <div class="detail-item" style="border-left-color: #3a86ff;">
                        <div class="detail-label">Confidence</div>
                        <div class="detail-value" style="color: #ffffff;">${(confidence * 100).toFixed(0)}%</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                    <div style="background: rgba(58, 134, 255, 0.1); padding: 12px; border-radius: 6px; border: 1px solid #3a86ff;">
                        <div style="color: #ffffff; font-size: 0.85rem;">Risk/Reward Ratio</div>
                        <div style="color: #ffffff; font-size: 1.5rem; font-weight: bold;">1:${riskReward.toFixed(1)}</div>
                    </div>
                    <div style="background: rgba(6, 214, 160, 0.1); padding: 12px; border-radius: 6px; border: 1px solid #06d6a0;">
                        <div style="color: #ffffff; font-size: 0.85rem;">Quality Score</div>
                        <div style="color: #06d6a0; font-size: 1.5rem; font-weight: bold;">${opp.quality_score}/100</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px; padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #ffffff;">Strategy:</span>
                        <span style="color: #ffffff; font-weight: bold;">${strategy}</span>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: rgba(255, 209, 102, 0.1); border-radius: 6px; border-left: 3px solid #ffd166;">
                    <div style="font-size: 0.85rem; color: #ffffff;">
                        ‚ö° ${signal === 'BUY' ? 'BULLISH' : 'BEARISH'} Signal | Quality Score: ${opp.quality_score}/100
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px;">
                    <button onclick="approveOpportunity('${opp.id}')" style="
                        background: linear-gradient(135deg, #06d6a0, #05b587);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        font-weight: bold;
                        font-size: 0.95rem;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 15px rgba(6, 214, 160, 0.3);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(6, 214, 160, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(6, 214, 160, 0.3)'">
                        ‚úÖ Approve Trade
                    </button>
                    <button onclick="watchOpportunity('${opp.id}')" style="
                        background: linear-gradient(135deg, #3a86ff, #2563eb);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        font-weight: bold;
                        font-size: 0.95rem;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 15px rgba(58, 134, 255, 0.3);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(58, 134, 255, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(58, 134, 255, 0.3)'">
                        üëÅÔ∏è Watch
                    </button>
                    <button onclick="dismissOpportunity('${opp.id}')" style="
                        background: linear-gradient(135deg, #ef476f, #c7304f);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        font-weight: bold;
                        font-size: 0.95rem;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 15px rgba(239, 71, 111, 0.3);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(239, 71, 111, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(239, 71, 111, 0.3)'">
                        ‚ùå Hold
                    </button>
                </div>
            `;
            
            return card;
        }
        
        async function approveOpportunity(oppId) {
            try {
                const response = await fetch('/api/opportunities/approve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ opportunity_id: oppId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success toast
                    showToast('‚úÖ Trade Approved!', `Executing ${result.instrument} ${result.direction}...`, 'success');
                    
                    // Remove card and reload
                    document.getElementById(`opp_${oppId}`)?.remove();
                    setTimeout(loadTradeOpportunities, 2000);
                } else {
                    showToast('‚ùå Approval Failed', result.message, 'error');
                }
            } catch (error) {
                console.error('Failed to approve:', error);
                showToast('‚ùå Error', 'Failed to approve trade', 'error');
            }
        }
        
        async function dismissOpportunity(oppId) {
            const reason = prompt('Why dismiss this opportunity? (helps AI learn your style):');
            if (!reason) return;
            
            try {
                const response = await fetch('/api/opportunities/dismiss', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ opportunity_id: oppId, reason: reason })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('üìù Dismissed', `AI learning: ${result.learning_update}`, 'info');
                    document.getElementById(`opp_${oppId}`)?.remove();
                    setTimeout(loadTradeOpportunities, 1000);
                }
            } catch (error) {
                console.error('Failed to dismiss:', error);
            }
        }
        
        function watchOpportunity(oppId) {
            showToast('‚è∏Ô∏è Watching', 'Opportunity moved to watch list', 'info');
            // In production: move to separate watch list
        }
        
        function updateABComparison(stats) {
            if (!stats) return;
            
            // Update Manual Lane
            document.getElementById('manualOppsShown').textContent = stats.manual?.shown || 0;
            document.getElementById('manualApproved').textContent = stats.manual?.approved || 0;
            document.getElementById('manualWinRate').textContent = `${(stats.manual?.win_rate || 0).toFixed(1)}%`;
            document.getElementById('manualProfit').textContent = `$${(stats.manual?.profit || 0).toFixed(0)}`;
            document.getElementById('manualAvgQuality').textContent = `${(stats.manual?.avg_quality || 0).toFixed(0)}/100`;
            
            // Update Auto Lane
            document.getElementById('autoOppsTotal').textContent = stats.auto?.total || 0;
            document.getElementById('autoWouldExecute').textContent = stats.auto?.would_execute || 0;
            document.getElementById('autoWinRate').textContent = `${(stats.auto?.win_rate || 0).toFixed(1)}%`;
            document.getElementById('autoProfit').textContent = `$${(stats.auto?.profit || 0).toFixed(0)}`;
            document.getElementById('autoAvgQuality').textContent = `${(stats.auto?.avg_quality || 0).toFixed(0)}/100`;
            
            // Performance difference
            const diff = (stats.manual?.profit || 0) - (stats.auto?.profit || 0);
            const diffPct = stats.manual?.win_rate - stats.auto?.win_rate || 0;
            document.getElementById('performanceDiff').textContent = 
                diff > 0 ? `YOU'RE AHEAD by $${diff.toFixed(0)} (+${diffPct.toFixed(1)}% WR)` :
                diff < 0 ? `AUTO AHEAD by $${Math.abs(diff).toFixed(0)} (${Math.abs(diffPct).toFixed(1)}% WR)` :
                'TIED';
            document.getElementById('performanceDiff').style.color = diff >= 0 ? '#06d6a0' : '#ef476f';
        }
        
        function showToast(title, message, type) {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 20px;
                background: ${type === 'success' ? '#06d6a0' : type === 'error' ? '#ef476f' : '#3a86ff'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 9999;
                min-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            toast.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">${title}</div>
                <div style="font-size: 0.9rem;">${message}</div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
        
        // Load opportunities every 10 seconds
        setInterval(loadTradeOpportunities, 10000);
        setTimeout(loadTradeOpportunities, 2000);  // Initial load
        
        // Load Daily Report
        async function loadDailyReport() {
            try {
                const response = await fetch('/api/reports');
                const data = await response.json();
                const report = (data && data.reports && data.reports[0]) || null;
                if (data.status === 'success' && report) {
                    displayDailyReport(report);
                } else {
                    document.getElementById('dailyReportContent').innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #ef476f;">
                            <div style="font-size: 18px; margin-bottom: 10px;">‚ùå</div>
                            <div>Error loading daily report</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load daily report:', error);
                document.getElementById('dailyReportContent').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #ef476f;">
                        <div style="font-size: 18px; margin-bottom: 10px;">‚ùå</div>
                        <div>Failed to load daily report</div>
                    </div>
                `;
            }
        }
        
        function displayDailyReport(report) {
            const content = document.getElementById('dailyReportContent');
            const netPl = report.trading_summary.net_pl;
            const dailyReturn = report.trading_summary.daily_return_pct;
            const progressPct = report.daily_targets.progress_pct;
            
            content.innerHTML = `
                <div style="padding: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span style="color: #999;">Current Time:</span>
                        <span style="color: white; font-weight: bold;">${report.current_time}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span style="color: #999;">Session:</span>
                        <span style="color: #06d6a0; font-weight: bold;">${report.session_status}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span style="color: #999;">Next:</span>
                        <span style="color: #999; font-size: 12px;">${report.next_session}</span>
                    </div>
                    
                    <div style="border-top: 1px solid #333; padding-top: 15px; margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #999;">Total Balance:</span>
                            <span style="color: white; font-weight: bold;">$${report.portfolio_summary.total_balance.toLocaleString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #999;">Open Positions:</span>
                            <span style="color: white; font-weight: bold;">${report.portfolio_summary.open_positions}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #999;">Total Trades:</span>
                            <span style="color: white; font-weight: bold;">${report.trading_summary.total_trades}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #999;">Win Rate:</span>
                            <span style="color: white; font-weight: bold;">${report.trading_summary.win_rate.toFixed(1)}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #999;">Net P/L:</span>
                            <span style="color: ${netPl >= 0 ? '#06d6a0' : '#ef476f'}; font-weight: bold;">$${netPl.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <span style="color: #999;">Daily Return:</span>
                            <span style="color: ${dailyReturn >= 0 ? '#06d6a0' : '#ef476f'}; font-weight: bold;">${dailyReturn.toFixed(2)}%</span>
                        </div>
                        
                        <div style="border-top: 1px solid #333; padding-top: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #999;">Daily Target:</span>
                                <span style="color: white; font-weight: bold;">$${report.daily_targets.daily_target}</span>
                            </div>
                            <div style="background: rgba(0,0,0,0.3); border-radius: 4px; height: 8px; margin-bottom: 8px;">
                                <div style="background: #06d6a0; height: 100%; width: ${Math.min(progressPct, 100)}%; border-radius: 4px; transition: width 0.3s;"></div>
                            </div>
                            <div style="text-align: center; color: #999; font-size: 12px;">
                                ${progressPct.toFixed(1)}% Complete
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Load Weekly Roadmap
        async function loadWeeklyRoadmap() {
            try {
                const response = await fetch('/api/roadmap');
                const data = await response.json();
                
                if (data.status === 'success' && data.roadmap) {
                    displayWeeklyRoadmap(data.roadmap);
                } else {
                    document.getElementById('weeklyRoadmapContent').innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #ef476f;">
                            <div style="font-size: 18px; margin-bottom: 10px;">‚ùå</div>
                            <div>Error loading weekly roadmap</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load weekly roadmap:', error);
                document.getElementById('weeklyRoadmapContent').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #ef476f;">
                        <div style="font-size: 18px; margin-bottom: 10px;">‚ùå</div>
                        <div>Failed to load weekly roadmap</div>
                    </div>
                `;
            }
        }
        
        function displayWeeklyRoadmap(roadmap) {
            const content = document.getElementById('weeklyRoadmapContent');
            const weekProgress = roadmap.week_info.week_progress_pct;
            const weeklyProgress = roadmap.targets.weekly_progress_pct;
            const onTrack = roadmap.targets.on_track;
            
            content.innerHTML = `
                <div style="padding: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span style="color: #999;">Current Day:</span>
                        <span style="color: white; font-weight: bold;">${roadmap.week_info.current_day}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span style="color: #999;">Week Progress:</span>
                        <span style="color: #8338ec; font-weight: bold;">${roadmap.week_info.days_passed}/7 days</span>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); border-radius: 4px; height: 8px; margin-bottom: 15px;">
                        <div style="background: #8338ec; height: 100%; width: ${weekProgress}%; border-radius: 4px; transition: width 0.3s;"></div>
                    </div>
                    
                    <div style="border-top: 1px solid #333; padding-top: 15px; margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #999;">Weekly Target:</span>
                            <span style="color: white; font-weight: bold;">$${roadmap.targets.weekly_target}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #999;">Current Progress:</span>
                            <span style="color: white; font-weight: bold;">$${roadmap.targets.current_progress.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #999;">Expected:</span>
                            <span style="color: #999; font-weight: bold;">$${roadmap.targets.expected_progress.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <span style="color: #999;">Status:</span>
                            <span style="color: ${onTrack ? '#06d6a0' : '#ef476f'}; font-weight: bold;">${onTrack ? 'ON TRACK' : 'BEHIND'}</span>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.3); border-radius: 4px; height: 8px; margin-bottom: 15px;">
                            <div style="background: ${onTrack ? '#06d6a0' : '#ef476f'}; height: 100%; width: ${Math.min(weeklyProgress, 100)}%; border-radius: 4px; transition: width 0.3s;"></div>
                        </div>
                        
                        <div style="border-top: 1px solid #333; padding-top: 15px;">
                            <div style="color: #999; margin-bottom: 10px; font-size: 12px;">Weekly Goals:</div>
                            ${roadmap.weekly_goals.map(goal => `
                                <div style="color: #999; font-size: 11px; margin-bottom: 5px;">‚Ä¢ ${goal}</div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Reports are now loaded on-demand when user navigates to Reports & Analytics section
        
    </script>

    <!-- AI Assistant Widget Loader (flag + health-checked) -->
    <script>
      (async function initAIAssistant() {
        try {
          const res = await fetch('/ai/health', { method: 'GET' });
          if (!res.ok) return; // Assistant disabled or not registered
          
          // Prevent duplicate panels if one already exists
          if (document.querySelector('.ai-assistant-panel')) return;

          // Build widget DOM
          const panel = document.createElement('div');
          panel.className = 'ai-assistant-panel';
          panel.innerHTML = `
            <div class="ai-assistant-header">
              <div class="ai-assistant-title">ü§ñ AI Assistant</div>
              <div class="ai-mode-badge">Live</div>
            </div>
            <div class="chat-messages"></div>
            <div class="chat-input">
              <textarea placeholder="Ask or use /commands (actions need Confirm)" class="ai-chat-input"></textarea>
              <button class="send-button">Send</button>
            </div>
          `;
          document.body.appendChild(panel);

          const messages = panel.querySelector('.chat-messages');
          const input = panel.querySelector('textarea');
          const sendBtn = panel.querySelector('.send-button');

          function appendMessage(text, cls = '') {
            const div = document.createElement('div');
            div.textContent = text;
            if (cls) div.className = cls;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
          }

          async function interpret(message) {
            try {
              const r = await fetch('/ai/interpret', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: message, session_id: 'dashboard' })
              });
              const ct = r.headers.get('content-type') || '';
              if (!r.ok) throw new Error(`HTTP ${r.status}`);
              if (!ct.includes('application/json')) {
                const text = await r.text();
                throw new Error(`Unexpected response: ${text.slice(0,120)}...`);
              }
              return await r.json();
            } catch (e) {
              throw e;
            }
          }

          async function confirmAction(confirmation_id, confirm) {
            const r = await fetch('/ai/confirm', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ confirmation_id, confirm, session_id: 'dashboard' })
            });
            const ct = r.headers.get('content-type') || '';
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            if (!ct.includes('application/json')) {
              const text = await r.text();
              throw new Error(`Unexpected response: ${text.slice(0,120)}...`);
            }
            return r.json();
          }

          let sending = false;
          async function handleSend() {
            if (sending) return;
            const text = (input.value || '').trim();
            if (!text) return;
            sending = true;
            sendBtn.disabled = true;
            try {
              appendMessage(`You: ${text}`);
              input.value = '';
              const resp = await interpret(text);
              if (resp.reply) appendMessage(`Assistant: ${resp.reply}`);
              if (resp.preview) {
                const pv = document.createElement('div');
                pv.className = 'command-preview';
                pv.innerHTML = `<div><strong>Preview:</strong> ${resp.preview.summary || 'N/A'}</div>`;
                const row = document.createElement('div');
                row.className = 'confirm-row';
                if (resp.live_guard) {
                  const lg = document.createElement('div');
                  lg.className = 'live-guard';
                  lg.textContent = 'LIVE action requires token: "LIVE CONFIRM YES" and explicit confirmation';
                  pv.appendChild(lg);
                }
                if (resp.requires_confirmation && resp.confirmation_id) {
                  const confirmBtn = document.createElement('button');
                  confirmBtn.className = 'confirm-button';
                  confirmBtn.textContent = 'Confirm';
                  const cancelBtn = document.createElement('button');
                  cancelBtn.className = 'cancel-button';
                  cancelBtn.textContent = 'Cancel';
                  row.appendChild(confirmBtn);
                  row.appendChild(cancelBtn);
                  pv.appendChild(row);

                  confirmBtn.addEventListener('click', async () => {
                    try {
                      const result = await confirmAction(resp.confirmation_id, true);
                      appendMessage(`Result: ${result.result?.note || result.status}`, 'command-result');
                    } catch (e) {
                      appendMessage(`Error: ${(e && e.message) || e}`, 'command-result');
                    }
                  });
                  cancelBtn.addEventListener('click', async () => {
                    try {
                      const result = await confirmAction(resp.confirmation_id, false);
                      appendMessage(`Result: ${result.status}`, 'command-result');
                    } catch (e) {
                      appendMessage(`Error: ${(e && e.message) || e}`, 'command-result');
                    }
                  });
                }
                messages.appendChild(pv);
                messages.scrollTop = messages.scrollHeight;
              }
            } catch (e) {
              console.error('AI assistant error:', e);
              appendMessage(`Assistant error: ${(e && e.message) || e}`);
            } finally {
              sending = false;
              sendBtn.disabled = false;
            }
          }

          sendBtn.addEventListener('click', handleSend);
          input.addEventListener('keydown', (ev) => {
            if (ev.key === 'Enter' && !ev.shiftKey) {
              ev.preventDefault();
              handleSend();
            }
          });

          // Optional: Socket namespace hookup for live chat events
          try {
            const aiSocket = io({ path: '/socket.io', forceNew: true, transports: ['websocket', 'polling'] });
            aiSocket.on('connect', () => {
              aiSocket.emit('chat_message', { message: 'Hello from dashboard', session_id: 'dashboard' });
            });
            aiSocket.on('assistant_reply', (data) => {
              if (data && data.reply) appendMessage(`Assistant: ${data.reply}`);
            });
          } catch (e) {
            console.warn('AI Socket not available:', e);
          }
        } catch (e) {
          // Assistant disabled or unreachable; do nothing
        }
        
        // Fallback: Ensure AI assistant panel is always available
        setTimeout(() => {
          if (!document.querySelector('.ai-assistant-panel')) {
            console.log('Creating fallback AI assistant panel...');
            const panel = document.createElement('div');
            panel.className = 'ai-assistant-panel';
            panel.innerHTML = `
              <div class="ai-assistant-header">
                <div class="ai-assistant-title">ü§ñ AI Assistant</div>
                <div class="ai-mode-badge">Live</div>
              </div>
              <div class="chat-messages"></div>
              <div class="chat-input">
                <textarea placeholder="Ask or use /commands (actions need Confirm)" class="ai-chat-input"></textarea>
                <button class="send-button">Send</button>
              </div>
            `;
            document.body.appendChild(panel);
          }
        }, 2000);
      })();
    </script>
    
    <!-- Toast Notification System -->
    {% include 'components/toast_notifications.html' %}
</body>
</html>