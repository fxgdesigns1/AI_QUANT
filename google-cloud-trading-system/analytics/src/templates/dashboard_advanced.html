<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trading Dashboard - Live Market Intelligence</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a0d2e 0%, #16213e 50%, #2d1b69 100%);
            color: #e2e8f0;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #2d1b69 0%, #1a0d2e 100%);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #5b21b6;
            box-shadow: 0 8px 32px rgba(91, 33, 182, 0.3);
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #a855f7, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .header p {
            font-size: 1.3rem;
            color: #94a3b8;
            font-weight: 300;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px 20px;
            background: rgba(15, 15, 35, 0.8);
            border-radius: 12px;
            border: 1px solid #374151;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-running { background-color: #4CAF50; }
        .status-warning { background-color: #FF9800; }
        .status-offline { background-color: #F44336; }
        .status-unknown { background-color: #9E9E9E; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 24px;
            margin-bottom: 30px;
        }

        .main-grid {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        .news-ai-section {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #475569;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
        }

        .card h3 {
            color: #f1f5f9;
            margin-bottom: 20px;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 1.6rem;
        }

        .system-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #475569;
            transition: background-color 0.2s ease;
        }

        .system-item:hover {
            background-color: rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            padding: 16px 12px;
            margin: 0 -12px;
        }

        .system-item:last-child {
            border-bottom: none;
        }

        .system-name {
            font-weight: 600;
            color: #f1f5f9;
            font-size: 1.1rem;
        }

        .system-status {
            display: flex;
            align-items: center;
            font-size: 0.95rem;
            gap: 8px;
        }

        .market-pair {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #475569;
            transition: background-color 0.2s ease;
        }

        .market-pair:hover {
            background-color: rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            padding: 12px 12px;
            margin: 0 -12px;
        }

        .market-pair:last-child {
            border-bottom: none;
        }

        .pair-name {
            font-weight: 600;
            color: #f1f5f9;
            font-size: 1.1rem;
        }

        .pair-price {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            color: #00d4ff;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .risk-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .risk-level {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .risk-low { background-color: #d4edda; color: #155724; }
        .risk-medium { background-color: #fff3cd; color: #856404; }
        .risk-high { background-color: #f8d7da; color: #721c24; }

        /* Account Details Styling */
        .account-item {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .account-name {
            font-weight: bold;
            color: #f3f4f6;
            font-size: 16px;
        }
        
        .account-balance {
            font-size: 18px;
            font-weight: bold;
            color: #10b981;
        }
        
        .account-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .account-metric {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #374151;
        }
        
        .account-metric:last-child {
            border-bottom: none;
        }
        
        .account-metric span:first-child {
            color: #9ca3af;
        }
        
        .account-metric span:last-child {
            color: #f3f4f6;
            font-weight: 500;
        }
        
        .positions-list {
            margin-top: 10px;
        }
        
        .position-item {
            background: #111827;
            border: 1px solid #374151;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }
        
        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .position-pair {
            font-weight: bold;
            color: #f3f4f6;
        }
        
        .position-side {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .position-side.buy {
            background: #065f46;
            color: #10b981;
        }
        
        .position-side.sell {
            background: #7f1d1d;
            color: #f87171;
        }
        
        .position-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 8px;
            font-size: 12px;
        }

        .news-item {
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .news-item:last-child {
            border-bottom: none;
        }

        .news-time {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .news-summary {
            margin-top: 5px;
            color: #495057;
        }

        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #28a745;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: white;
            opacity: 0.8;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(15, 15, 35, 0.95);
            padding: 12px 18px;
            border-radius: 25px;
            font-size: 0.9rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            border: 1px solid #374151;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        .connection-connected {
            color: #10b981;
        }

        .connection-disconnected {
            color: #ef4444;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .metric-item:last-child {
            border-bottom: none;
        }

        .metric-value {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #2d3748;
        }

        .news-countdown {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #ef4444;
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
        }

        .ai-recommendation {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #10b981;
            box-shadow: 0 4px 16px rgba(5, 150, 105, 0.3);
        }

        #newsTimer {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-weight: 700;
            color: #ffffff;
            font-size: 1.2rem;
        }

        #tradePhase {
            font-weight: 700;
            color: #ffffff;
            font-size: 1.1rem;
        }

        .impact-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .impact-item {
            padding: 8px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.9rem;
        }

        .impact-item:last-child {
            border-bottom: none;
        }

        .impact-time {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .impact-high { color: #dc3545; }
        .impact-medium { color: #ffc107; }
        .impact-low { color: #28a745; }

        /* Enhanced Trading Details Styles */
        .trading-details-section {
            margin: 30px 0;
            grid-column: 1 / -1;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .trade-item {
            background: rgba(15, 15, 35, 0.6);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #374151;
            transition: all 0.2s ease;
        }

        .trade-item:hover {
            background: rgba(15, 15, 35, 0.8);
            border-color: #00d4ff;
        }

        .trade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .strategy-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .ultra-strict { background: #059669; color: white; }
        .gold-scalp { background: #dc2626; color: white; }
        .momentum { background: #7c3aed; color: white; }

        .trade-time {
            font-size: 0.9rem;
            color: #94a3b8;
            font-family: monospace;
        }

        .trade-details {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
            align-items: center;
        }

        .trade-pair {
            font-weight: 600;
            color: #00d4ff;
            font-size: 1.1rem;
        }

        .trade-levels {
            font-family: monospace;
            color: #f1f5f9;
            font-size: 0.95rem;
        }

        .trade-status {
            text-align: right;
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .trade-status.profit {
            background: rgba(5, 150, 105, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
        }

        .trade-status.drawdown {
            background: rgba(220, 38, 38, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .strategy-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .strategy-name {
            font-size: 0.85rem;
            color: #94a3b8;
            font-weight: 500;
        }

        .enhanced-market-pair {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #475569;
            transition: background-color 0.2s ease;
        }

        .enhanced-market-pair:hover {
            background-color: rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            padding: 12px 12px;
            margin: 0 -12px;
        }

        .enhanced-market-pair:last-child {
            border-bottom: none;
        }

        /* AI Assistant Widget (scoped) */
        .ai-assistant-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 360px;
            max-height: 60vh;
            background: rgba(17, 24, 39, 0.95);
            border: 1px solid #374151;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            z-index: 1100;
            overflow: hidden;
        }
        .ai-assistant-header {
            padding: 12px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #111827;
            border-bottom: 1px solid #374151;
        }
        .ai-assistant-title { font-weight: 600; }
        .ai-mode-badge { font-size: 12px; color: #10b981; }
        .chat-messages { padding: 10px; overflow-y: auto; flex: 1; font-size: 14px; }
        .chat-input { display: flex; gap: 8px; padding: 10px; border-top: 1px solid #374151; }
        .chat-input textarea { flex: 1; resize: none; height: 48px; background: #0b1220; color: #e5e7eb; border: 1px solid #1f2937; border-radius: 8px; padding: 8px; }
        .send-button { background: #2563eb; color: white; border: none; border-radius: 8px; padding: 0 14px; cursor: pointer; }
        .command-preview { background: #0b1220; border: 1px solid #374151; border-radius: 8px; padding: 8px; margin: 8px 0; }
        
        .confirmation-panel {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }
        
        .confirmation-preview {
            margin-bottom: 8px;
            font-size: 14px;
            color: #92400e;
        }
        
        .confirmation-buttons {
            display: flex;
            gap: 8px;
        }
        
        .confirm-btn, .cancel-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .confirm-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .confirm-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .cancel-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .cancel-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        
        /* Trading Signals */
        .trading-signals {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .signal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 8px;
            border: 1px solid #475569;
        }
        
        .signal-pair {
            font-weight: 600;
            color: #f1f5f9;
        }
        
        .signal-action {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .signal-confidence {
            color: #94a3b8;
            font-size: 0.9rem;
        }
        .confirm-row { display: flex; gap: 8px; }
        .confirm-button { background: #10b981; color: white; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; }
        .cancel-button { background: #ef4444; color: white; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; }
        .live-guard { color: #f59e0b; font-size: 12px; margin-top: 6px; }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        <span class="live-indicator"></span>
        <span id="connectionText">Connecting...</span>
    </div>

    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Trading Dashboard</h1>
            <p>Live Market Intelligence & Automated Trading System</p>
            <div class="status-bar">
                <div>
                    <span class="live-indicator"></span>
                    <span>Live Trading Active</span>
                </div>
                <div>
                    <span>Last Update: <span id="lastUpdate">Loading...</span></span>
                </div>
            </div>
        </div>

        <!-- Main Trading Overview -->
        <div class="main-grid">
            <!-- Live Market Data -->
            <div class="card market-data-section live-market-data">
                <h3><span class="card-icon">üí±</span>Live Market Data</h3>
                <div id="marketData">
                    <div class="enhanced-market-pair">
                        <div class="strategy-info">
                            <div class="strategy-name">Ultra Strict Forex</div>
                            <div class="pair-name">EUR/USD</div>
                        </div>
                        <div class="pair-price">Loading...</div>
                    </div>
                    <div class="enhanced-market-pair">
                        <div class="strategy-info">
                            <div class="strategy-name">Gold Scalping</div>
                            <div class="pair-name">XAU/USD</div>
                        </div>
                        <div class="pair-price">Loading...</div>
                    </div>
                    <div class="enhanced-market-pair">
                        <div class="strategy-info">
                            <div class="strategy-name">Momentum Trading</div>
                            <div class="pair-name">GBP/USD</div>
                        </div>
                        <div class="pair-price">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Trading Systems Status -->
            <div class="card trading-systems-section trading-systems">
                <h3><span class="card-icon">üìä</span>Trading Systems</h3>
                <div id="systemsStatus">
                    <div class="system-item">
                        <div class="system-name">Ultra Strict Forex</div>
                        <div class="system-status">
                            <span class="status-indicator status-unknown"></span>
                            <span>Initializing...</span>
                        </div>
                    </div>
                    <div class="system-item">
                        <div class="system-name">Gold Scalping</div>
                        <div class="system-status">
                            <span class="status-indicator status-offline"></span>
                            <span>Offline</span>
                        </div>
                    </div>
                    <div class="system-item">
                        <div class="system-name">Momentum Trading</div>
                        <div class="system-status">
                            <span class="status-indicator status-offline"></span>
                            <span>Offline</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Trades & Signals Section -->
        <div class="trading-details-section">
            <div class="card full-width trading-signals-section">
                <h3><span class="card-icon">üìä</span>Active Trades & Signals</h3>
                <div id="activeTradesData">
                    <!-- Live trading data will be populated here via JavaScript -->
                    <div class="no-trades-message" style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 24px; margin-bottom: 10px;">üìä</div>
                        <div>Loading live trading data...</div>
                        <div style="font-size: 12px; margin-top: 10px;">Connecting to OANDA accounts</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insights & Trade Ideas (Full-width Row) -->
        <div class="dashboard-grid">
            <div class="card full-width" id="insightsSection">
                <h3><span class="card-icon">üß≠</span>Market Insights</h3>
                <div id="insightsContent">
                    <div style="text-align: center; padding: 16px; color: #94a3b8;">Loading live insights‚Ä¶</div>
                </div>
            </div>
            <div class="card full-width" id="tradeIdeasSection">
                <h3><span class="card-icon">üí°</span>Trade Ideas</h3>
                <div id="tradeIdeasContent">
                    <div style="text-align: center; padding: 16px; color: #94a3b8;">Loading live trade ideas‚Ä¶</div>
                </div>
            </div>
        </div>

        <!-- News & AI Insights Section -->
        <div class="news-ai-section">
            <!-- AI Insights & Recommendations -->
            <div class="card">
                <h3><span class="card-icon">üß†</span>AI Insights & Recommendations</h3>
                <div id="newsImpact">
                    <div class="ai-recommendation">
                        <span>Current AI Trade Phase:</span>
                        <span id="tradePhase">Analyzing market conditions...</span>
                    </div>
                    <div class="news-countdown">
                        <span>Next Major News Event:</span>
                        <span id="newsTimer">No upcoming news</span>
                    </div>
                    <div class="impact-list" id="upcomingNews">
                        <div class="impact-item">
                            <div class="impact-time">Loading AI analysis...</div>
                            <div class="impact-medium">System initializing</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live News Feed -->
            <div class="card news-section live-news-feed">
                <h3><span class="card-icon">üì∞</span>Live News Feed</h3>
                <div id="newsAlerts">
                    <div class="news-item">
                        <div class="news-time">Just now</div>
                        <div class="news-summary">AI Trading System Online - Monitoring markets</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance & Risk Metrics -->
        <div class="dashboard-grid">
            <!-- Trading Performance -->
            <div class="card">
                <h3><span class="card-icon">üìà</span>Trading Performance</h3>
                <div id="tradingMetrics">
                    <div class="metric-item">
                        <span>Win Rate (24h):</span>
                        <span class="metric-value">Loading...</span>
                    </div>
                    <div class="metric-item">
                        <span>Avg Trade Duration:</span>
                        <span class="metric-value">Loading...</span>
                    </div>
                    <div class="metric-item">
                        <span>Risk/Reward Ratio:</span>
                        <span class="metric-value">Loading...</span>
                    </div>
                    <div class="metric-item">
                        <span>Success Rate:</span>
                        <span class="metric-value">Loading...</span>
                    </div>
                    <div class="metric-item">
                        <span>Profit Factor:</span>
                        <span class="metric-value">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Risk Management -->
            <div class="card">
                <h3><span class="card-icon">üõ°Ô∏è</span>Risk Management</h3>
                <div id="riskMetrics">
                    <div class="risk-metric">
                        <span>Portfolio Risk:</span>
                        <span class="risk-level risk-low">Loading...</span>
                    </div>
                    <div class="risk-metric">
                        <span>Open Positions:</span>
                        <span>Loading...</span>
                    </div>
                    <div class="risk-metric">
                        <span>Daily Trades:</span>
                        <span>Loading...</span>
                    </div>
                    <div class="risk-metric">
                        <span>Account Balance:</span>
                        <span>Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Individual Account Details -->
            <div class="card full-width">
                <h3><span class="card-icon">üè¶</span>Individual OANDA Account Details</h3>
                <div id="accountDetails">
                    <div class="account-loading">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <div style="font-size: 18px; margin-bottom: 10px;">üìä</div>
                            <div>Loading individual account balances...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>üöÄ Google Cloud Trading System - Live OANDA Integration</p>
            <p>Production Ready ‚Ä¢ Real-time Trading ‚Ä¢ Risk Managed</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // Initialize Socket.IO connection with robust reconnection
        window.socketStats = { connects: 0, disconnects: 0, lastEvent: 'init' };
        window.socketReady = new Promise((resolve) => { window.__socketResolve = resolve; });

        function initSocket() {
            if (typeof io === 'undefined') {
                setTimeout(initSocket, 300);
                return;
            }
            window.socket = io({
                path: '/socket.io',
                transports: ['polling'],  // Use polling only for Google Cloud compatibility
                reconnection: true,
                reconnectionAttempts: Infinity,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 8000,
                timeout: 20000,
                withCredentials: false,
                forceNew: true
            });
        }
        initSocket();
        
        // Connection status
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionText = document.getElementById('connectionText');
        
        document.addEventListener('DOMContentLoaded', () => {
          console.log('üöÄ Dashboard DOM loaded, initializing...');
          initDashboard();
        });
        
        // Initialize dashboard data
        function initDashboard() {
            console.log('üöÄ Initializing dashboard...');
            
            // Initialize AI Assistant
            initAIAssistant();
            
            // Load initial data with proper error handling
            loadSystemStatus();
            loadMarketData();
            loadNewsData();
            loadAccountDetails();
            loadTradingSignals();
            loadInsights();
            loadTradeIdeas();
            
            // Force refresh data every 5 seconds
            setInterval(() => {
                console.log('üîÑ Refreshing dashboard data...');
                loadSystemStatus();
                loadMarketData();
                loadNewsData();
                loadAccountDetails();
                loadTradingSignals();
                loadInsights();
                loadTradeIdeas();
            }, 5000);
        }
        
        // Load system status data
        async function loadSystemStatus() {
            try {
                console.log('üìä Loading system status...');
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.system_status === 'online') {
                    console.log('‚úÖ System status: online');
                    
                    // Update trading systems
                    if (data.trading_systems) {
                        updateTradingSystems(data.trading_systems);
                    }
                    
                    // Update market data
                    if (data.market_data) {
                        updateMarketData(data.market_data);
                    }
                    
                    // Update news data
                    if (data.news_data) {
                        updateNewsData(data.news_data);
                    }
                }
            } catch (error) {
                console.error('‚ùå System status error:', error);
            }
        }
        
        // Load market data
        async function loadMarketData() {
            try {
                console.log('üí± Loading market data...');
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.market_data) {
                    updateMarketData(data.market_data);
                }
            } catch (error) {
                console.error('‚ùå Market data error:', error);
            }
        }
        
        // Load news data
        async function loadNewsData() {
            try {
                console.log('üì∞ Loading news data...');
                const response = await fetch('/api/news');
                const data = await response.json();
                
                if (data.status === 'success' && data.news_data) {
                    updateNewsData(data.news_data);
                }
            } catch (error) {
                console.error('‚ùå News data error:', error);
            }
        }
        
        // Load account details
        async function loadAccountDetails() {
            try {
                console.log('üè¶ Loading account details...');
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.account_statuses) {
                    updateAccountDetails(data.account_statuses);
                }
            } catch (error) {
                console.error('‚ùå Account details error:', error);
            }
        }
        
        // Update trading systems display
        function updateTradingSystems(systems) {
            console.log('üìä Updating trading systems...');
            const systemsContainer = document.getElementById('systemsStatus');
            if (!systemsContainer) return;
            
            systemsContainer.innerHTML = '';
            
            Object.entries(systems).forEach(([accountId, system]) => {
                const systemDiv = document.createElement('div');
                systemDiv.className = 'system-item';
                systemDiv.innerHTML = `
                    <div class="system-name">${system.strategy_name}</div>
                    <div class="system-status">
                        <span class="status-indicator status-active"></span>
                        <span>Active</span>
                    </div>
                    <div class="system-balance">$${system.balance.toLocaleString()}</div>
                `;
                systemsContainer.appendChild(systemDiv);
            });
        }
        
        // Update market data display
        function updateMarketData(marketData) {
            console.log('üí± Updating market data...');
            const marketContainer = document.getElementById('marketData');
            if (!marketContainer) return;
            
            marketContainer.innerHTML = '';
            
            // Get first account's market data
            const firstAccount = Object.values(marketData)[0];
            if (!firstAccount) return;
            
            Object.entries(firstAccount).forEach(([instrument, data]) => {
                const pairDiv = document.createElement('div');
                pairDiv.className = 'enhanced-market-pair';
                pairDiv.innerHTML = `
                    <div class="strategy-info">
                        <div class="strategy-name">Live Data</div>
                        <div class="pair-name">${instrument}</div>
                    </div>
                    <div class="pair-price">${data.bid.toFixed(5)}</div>
                `;
                marketContainer.appendChild(pairDiv);
            });
        }
        
        // Update news data display
        function updateNewsData(newsData) {
            console.log('üì∞ Updating news data...');
            const newsContainer = document.getElementById('newsAlerts');
            if (!newsContainer) return;
            
            // Normalize payload: support array or { news_items: [...] }
            let items = Array.isArray(newsData) ? newsData : (newsData.news_items || []);
            
            if (items.length === 0) {
                // Do not clear existing feed if no new items to prevent flicker
                if (!window.__hasNewsRendered) {
                    newsContainer.innerHTML = `
                        <div class="news-item">
                            <div class="news-time">Just now</div>
                            <div class="news-summary">Awaiting live news feed‚Ä¶</div>
                        </div>
                    `;
                }
                return;
            }
            
            function safeFormatTime(rawTs) {
                try {
                    if (!rawTs) return 'Just now';
                    // Support various formats
                    const parsed = new Date(rawTs);
                    if (!isNaN(parsed.getTime())) return parsed.toLocaleString();
                    // Try seconds to ms
                    if (typeof rawTs === 'number') {
                        const n = rawTs < 10_000_000_000 ? rawTs * 1000 : rawTs;
                        const d = new Date(n);
                        if (!isNaN(d.getTime())) return d.toLocaleString();
                    }
                    // Try removing Z
                    if (typeof rawTs === 'string') {
                        const s = rawTs.replace('Z', '');
                        const d2 = new Date(s);
                        if (!isNaN(d2.getTime())) return d2.toLocaleString();
                    }
                } catch (_) {}
                return 'Just now';
            }
            
            window.__hasNewsRendered = true;
            newsContainer.innerHTML = '';
            items.slice(0, 10).forEach(news => {
                const ts = news.timestamp || news.published_at || news.time || news.date || news.datetime || null;
                const title = news.title || news.summary || news.headline || news.description || 'News update';
                const newsDiv = document.createElement('div');
                newsDiv.className = 'news-item';
                newsDiv.innerHTML = `
                    <div class="news-time">${safeFormatTime(ts)}</div>
                    <div class="news-summary">${title}</div>
                `;
                newsContainer.appendChild(newsDiv);
            });
        }
        
        // Load insights
        async function loadInsights() {
            try {
                const res = await fetch('/api/insights');
                const data = await res.json();
                const el = document.getElementById('insightsContent');
                if (!el) return;
                if (data.status === 'ok' && data.insights) {
                    const s = data.insights;
                    el.innerHTML = `
                        <div><b>Market impact:</b> ${s.market_impact || 'neutral'}</div>
                        <div><b>Sentiment:</b> ${(s.overall_sentiment ?? 0).toFixed(2)}</div>
                        <div><b>Confidence:</b> ${(s.confidence ?? 0).toFixed(2)}</div>
                        <div><b>Opportunities:</b> ${(s.opportunities || []).length}</div>
                    `;
                }
            } catch (e) { /* noop */ }
        }

        // Update account details display
        function updateAccountDetails(accounts) {
            console.log('üè¶ Updating account details...');
            const accountContainer = document.getElementById('accountDetails');
            if (!accountContainer) return;
            
            accountContainer.innerHTML = '';
            
            Object.entries(accounts).forEach(([accountId, account]) => {
                const accountDiv = document.createElement('div');
                accountDiv.className = 'account-item';
                accountDiv.innerHTML = `
                    <div class="account-header">
                        <div class="account-name">${account.account_name}</div>
                        <div class="account-status status-active">Active</div>
                    </div>
                    <div class="account-balance">$${account.balance.toLocaleString()}</div>
                    <div class="account-strategy">${account.strategy}</div>
                `;
                accountContainer.appendChild(accountDiv);
            });
        }
        
        // Initialize AI Assistant
        function initAIAssistant() {
            console.log('ü§ñ Initializing AI Assistant...');
            
            // Create AI assistant panel if it doesn't exist
            if (!document.querySelector('.ai-assistant-panel')) {
                const panel = document.createElement('div');
                panel.className = 'ai-assistant-panel';
                panel.innerHTML = `
                    <div class="ai-assistant-header">
                        <div class="ai-assistant-title">ü§ñ AI Assistant</div>
                        <div class="ai-mode-badge">Live</div>
                    </div>
                    <div class="chat-messages"></div>
                    <div class="chat-input">
                        <textarea placeholder="Ask or use /commands (actions need Confirm)" class="ai-chat-input"></textarea>
                        <button class="send-button">Send</button>
                    </div>
                `;
                document.body.appendChild(panel);
                
                // Add event listeners
                const input = panel.querySelector('.ai-chat-input');
                const sendButton = panel.querySelector('.send-button');
                const messages = panel.querySelector('.chat-messages');
                
                function sendMessage() {
                    const message = input.value.trim();
                    if (!message) return;
                    
                    // Add user message
                    const userMsg = document.createElement('div');
                    userMsg.className = 'message user-message';
                    userMsg.textContent = message;
                    messages.appendChild(userMsg);
                    
                    // Clear input
                    input.value = '';
                    
                    // Show typing indicator
                    const typingMsg = document.createElement('div');
                    typingMsg.className = 'message ai-message typing';
                    typingMsg.textContent = 'ü§ñ AI is thinking...';
                    messages.appendChild(typingMsg);
                    messages.scrollTop = messages.scrollHeight;
                    
                    // Call real AI assistant API
                    fetch('/ai/interpret', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ text: message })
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Remove typing indicator
                        messages.removeChild(typingMsg);
                        
                        // Add AI response
                        const aiMsg = document.createElement('div');
                        aiMsg.className = 'message ai-message';
                        aiMsg.innerHTML = data.reply.replace(/\n/g, '<br>');
                        messages.appendChild(aiMsg);
                        
                        // Handle confirmation flow
                        if (data.requires_confirmation && data.confirmation_id) {
                            const confirmDiv = document.createElement('div');
                            confirmDiv.className = 'confirmation-panel';
                            confirmDiv.innerHTML = `
                                <div class="confirmation-preview">
                                    <strong>Preview:</strong> ${data.preview.summary}
                                </div>
                                <div class="confirmation-buttons">
                                    <button class="confirm-btn" data-id="${data.confirmation_id}">Confirm</button>
                                    <button class="cancel-btn" data-id="${data.confirmation_id}">Cancel</button>
                                </div>
                            `;
                            messages.appendChild(confirmDiv);
                            
                            // Add event listeners
                            const confirmBtn = confirmDiv.querySelector('.confirm-btn');
                            const cancelBtn = confirmDiv.querySelector('.cancel-btn');
                            
                            confirmBtn.addEventListener('click', async () => {
                                try {
                                    const response = await fetch('/ai/confirm', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ 
                                            confirmation_id: data.confirmation_id, 
                                            confirm: true 
                                        })
                                    });
                                    const result = await response.json();
                                    
                                    const resultMsg = document.createElement('div');
                                    resultMsg.className = 'message ai-message result';
                                    resultMsg.textContent = `Result: ${result.message || result.status}`;
                                    messages.appendChild(resultMsg);
                                    
                                } catch (error) {
                                    const errorMsg = document.createElement('div');
                                    errorMsg.className = 'message ai-message error';
                                    errorMsg.textContent = `Error: ${error.message}`;
                                    messages.appendChild(errorMsg);
                                }
                                
                                // Remove confirmation panel
                                messages.removeChild(confirmDiv);
                                messages.scrollTop = messages.scrollHeight;
                            });
                            
                            cancelBtn.addEventListener('click', async () => {
                                try {
                                    await fetch('/ai/confirm', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ 
                                            confirmation_id: data.confirmation_id, 
                                            confirm: false 
                                        })
                                    });
                                    
                                    const cancelMsg = document.createElement('div');
                                    cancelMsg.className = 'message ai-message';
                                    cancelMsg.textContent = 'Action cancelled';
                                    messages.appendChild(cancelMsg);
                                    
                                } catch (error) {
                                    console.error('Cancel error:', error);
                                }
                                
                                // Remove confirmation panel
                                messages.removeChild(confirmDiv);
                                messages.scrollTop = messages.scrollHeight;
                            });
                        }
                        
                        // Scroll to bottom
                        messages.scrollTop = messages.scrollHeight;
                    })
                    .catch(error => {
                        // Remove typing indicator
                        messages.removeChild(typingMsg);
                        
                        // Add error message
                        const errorMsg = document.createElement('div');
                        errorMsg.className = 'message ai-message error';
                        errorMsg.textContent = 'Sorry, I encountered an error. Please try again.';
                        messages.appendChild(errorMsg);
                        
                        // Scroll to bottom
                        messages.scrollTop = messages.scrollHeight;
                    });
                }
                
                sendButton.addEventListener('click', sendMessage);
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
        }
        
        // Generate AI response
        function generateAIResponse(message) {
            const responses = [
                "üìä Market Analysis: Current market conditions show moderate volatility. EUR/USD is trending upward with strong support at 1.0850. Consider monitoring key resistance levels at 1.0950.",
                "üì∞ News Impact: Recent economic data shows mixed signals. The Federal Reserve's stance on interest rates continues to influence market sentiment.",
                "‚ö†Ô∏è Risk Management: Current portfolio risk is within acceptable limits. Ensure proper position sizing and maintain stop-loss orders.",
                "üéØ Trading Strategy: The system is currently monitoring multiple timeframes for entry signals. Gold scalping strategy shows promising setups on 5-minute charts.",
                "üîß System Status: All trading systems are operational. Data feeds are live and stable. Risk management protocols are active.",
                "üí° Trade Ideas: Based on current market analysis, consider monitoring EUR/USD for potential breakout opportunities above 1.1750.",
                "üìà Performance: System is performing within expected parameters. All risk metrics are green and systems are optimized for current market conditions."
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        // Load trading signals
        async function loadTradingSignals() {
            try {
                console.log('üéØ Loading trading signals...');
                const response = await fetch('/tasks/full_scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.ok) {
                        updateTradingSignals(data);
                    }
                }
            } catch (error) {
                console.error('‚ùå Trading signals error:', error);
            }
        }
        
        // Update trading signals display
        function updateTradingSignals(signals) {
            console.log('üéØ Updating trading signals...');
            const signalsContainer = document.getElementById('activeTradesData');
            if (!signalsContainer) return;
            
            signalsContainer.innerHTML = `
                <div class="trading-signals">
                    <div class="signal-item">
                        <div class="signal-pair">EUR/USD</div>
                        <div class="signal-action">BUY</div>
                        <div class="signal-confidence">85%</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-pair">XAU/USD</div>
                        <div class="signal-action">SELL</div>
                        <div class="signal-confidence">78%</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-pair">GBP/USD</div>
                        <div class="signal-action">HOLD</div>
                        <div class="signal-confidence">92%</div>
                    </div>
                </div>
            `;
        }

        // Handle slash commands
        async function handleSlashCommand(cmd, messages) {
            const lower = cmd.toLowerCase();
            let url = null;
            if (lower.startsWith('/status')) url = '/api/status';
            else if (lower.startsWith('/accounts')) url = '/api/accounts';
            else if (lower.startsWith('/risk')) url = '/api/risk';
            else if (lower.startsWith('/metrics')) url = '/api/metrics';
            else if (lower.startsWith('/positions')) url = '/api/positions';
            else if (lower.startsWith('/signals')) url = '/api/signals/recent';
            else if (lower.startsWith('/news')) url = '/api/news';
            else if (lower.startsWith('/insights')) url = '/api/insights';
            else if (lower.startsWith('/ideas')) url = '/api/trade_ideas';
            else if (lower.startsWith('/action strategy')) url = '/actions/strategy';
            else if (lower.startsWith('/action risk')) url = '/actions/risk';
            else if (lower.startsWith('/action orders')) url = '/actions/orders';

            const aiMsg = document.createElement('div');
            aiMsg.className = 'message ai-message';

            if (!url) {
                aiMsg.textContent = 'Unknown command. Try: /status /accounts /risk /metrics /positions /signals /news /insights /ideas';
                messages.appendChild(aiMsg);
                return;
            }
            try {
                const isAction = url.startsWith('/actions/');
                const res = await fetch(url, {
                    method: isAction ? 'POST' : 'GET',
                    headers: isAction ? { 'Content-Type': 'application/json' } : undefined,
                    body: isAction ? buildActionBody(lower) : undefined
                });
                const data = await res.json();
                // If action pending with action_id, render confirm/cancel buttons
                if (url.startsWith('/actions/') && data && data.confirm_required && data.action_id) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'message ai-message';
                    const pre = document.createElement('pre');
                    pre.textContent = JSON.stringify(data.preview, null, 2);
                    const row = document.createElement('div');
                    row.style.display = 'flex';
                    row.style.gap = '8px';
                    row.style.marginTop = '8px';
                    const confirmBtn = document.createElement('button');
                    confirmBtn.textContent = 'Confirm';
                    confirmBtn.className = 'confirm-button';
                    confirmBtn.onclick = async () => {
                        confirmBtn.disabled = true;
                        const r = await fetch('/actions/confirm', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action_id: data.action_id }) });
                        const rd = await r.json();
                        const done = document.createElement('pre');
                        done.textContent = JSON.stringify(rd, null, 2);
                        wrapper.appendChild(done);
                    };
                    const cancelBtn = document.createElement('button');
                    cancelBtn.textContent = 'Cancel';
                    cancelBtn.className = 'cancel-button';
                    cancelBtn.onclick = () => { wrapper.remove(); };
                    row.appendChild(confirmBtn);
                    row.appendChild(cancelBtn);
                    wrapper.appendChild(pre);
                    wrapper.appendChild(row);
                    messages.appendChild(wrapper);
                } else {
                    aiMsg.textContent = JSON.stringify(data, null, 2);
                    messages.appendChild(aiMsg);
                }
            } catch (e) {
                aiMsg.textContent = 'Error: ' + e;
                messages.appendChild(aiMsg);
            }
        }

        function buildActionBody(cmd) {
            // Simple parser for demo: examples
            // /action strategy pause all
            // /action risk account=101-... max_risk_per_trade=0.02
            // /action orders close_positions instrument=EUR_USD
            const parts = cmd.split(/\s+/);
            if (cmd.startsWith('/action strategy')) {
                return JSON.stringify({ action: parts[2] || 'pause', target: parts[3] || 'all' });
            }
            if (cmd.startsWith('/action risk')) {
                const payload = { account_id: '', changes: {} };
                parts.slice(3).forEach(p => {
                    const [k,v] = p.split('=');
                    if (k === 'account' || k === 'account_id') payload.account_id = v;
                    else if (k) payload.changes[k] = v;
                });
                return JSON.stringify(payload);
            }
            if (cmd.startsWith('/action orders')) {
                const payload = { op: parts[2] || 'close_positions', filter: {} };
                parts.slice(3).forEach(p => {
                    const [k,v] = p.split('=');
                    if (k) payload.filter[k] = v;
                });
                return JSON.stringify(payload);
            }
            return JSON.stringify({});
        }

        // Load insights
        async function loadInsights() {
            try {
                const res = await fetch('/api/insights');
                const data = await res.json();
                if (data.status === 'success' && data.insights) {
                    renderInsights(data.insights);
                }
            } catch (e) {
                console.error('‚ùå Insights error:', e);
            }
        }

        // Render insights
        function renderInsights(insights) {
            const el = document.getElementById('insightsContent');
            if (!el) return;
            try {
                const focus = (insights.focus || []).map(x => `<span class="tag">${x}</span>`).join(' ');
                const regimes = Object.entries(insights.regimes || {}).map(([k,v]) => `<div class="kv"><span>${k}</span><span class="pill">${v}</span></div>`).join('');
                el.innerHTML = `
                    <div class="insights">
                        <div class="summary">${insights.summary || 'Live market insights unavailable right now.'}</div>
                        <div class="focus"><span class="label">Focus:</span> ${focus || '<span class="muted">n/a</span>'}</div>
                        <div class="grid2">${regimes || '<div class="muted">No regime data</div>'}</div>
                        <div class="risk">Risk Level: <span class="pill">${insights.risk_level || 'low'}</span></div>
                    </div>
                `;
            } catch (e) {
                el.innerHTML = '<div class="muted" style="padding: 12px;">Insights temporarily unavailable.</div>';
            }
        }

        // Load trade ideas
        async function loadTradeIdeas() {
            try {
                const res = await fetch('/api/trade_ideas');
                const data = await res.json();
                if (data.status === 'success' && Array.isArray(data.ideas)) {
                    renderTradeIdeas(data.ideas);
                }
            } catch (e) {
                console.error('‚ùå Trade ideas error:', e);
            }
        }

        // Render trade ideas
        function renderTradeIdeas(ideas) {
            const el = document.getElementById('tradeIdeasContent');
            if (!el) return;
            if (!ideas.length) {
                el.innerHTML = '<div class="muted" style="padding: 12px;">No current ideas</div>';
                return;
            }
            el.innerHTML = ideas.slice(0, 6).map(idea => `
                <div class="signal-item">
                    <div class="signal-pair">${idea.instrument}</div>
                    <div class="signal-action">${idea.action}</div>
                    <div class="signal-confidence">${idea.confidence}%</div>
                </div>
                <div class="muted" style="margin-top:-8px; margin-bottom:8px;">${idea.reason}</div>
            `).join('');
        }
        function safeSocket(cb){ if (window.socket) cb(window.socket); }

        // Enhanced countdown timer functionality
        function updateCountdownTimer(data) {
            const newsTimer = document.getElementById('newsTimer');
            if (!newsTimer) return;
            
            if (data.next_news && data.next_news.timestamp) {
                const timeUntil = new Date(data.next_news.timestamp) - new Date();
                if (timeUntil > 0) {
                    const hours = Math.floor(timeUntil / 3600000);
                    const minutes = Math.floor((timeUntil % 3600000) / 60000);
                    const seconds = Math.floor((timeUntil % 60000) / 1000);
                    
                    if (hours > 0) {
                        newsTimer.textContent = `${hours}h ${minutes}m ${seconds}s`;
                    } else if (minutes > 0) {
                        newsTimer.textContent = `${minutes}m ${seconds}s`;
                    } else {
                        newsTimer.textContent = `${seconds}s`;
                    }
                    
                    // Update countdown every second
                    setTimeout(() => updateCountdownTimer(data), 1000);
                } else {
                    newsTimer.textContent = 'Event in progress';
                }
            } else {
                newsTimer.textContent = 'No upcoming news';
            }
        }

        safeSocket((socket) => socket.on('connect', function() {
            connectionText.textContent = 'Connected';
            connectionStatus.className = 'connection-status connection-connected';
            window.socketStats.connects += 1;
            window.socketStats.lastEvent = 'connect';
            if (window.__socketResolve) window.__socketResolve();
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            console.log('üîå Socket connected, requesting initial update...');
            socket.emit('request_update');
        }));
        
        safeSocket((socket) => socket.on('disconnect', function() {
            connectionText.textContent = 'Disconnected';
            connectionStatus.className = 'connection-status connection-disconnected';
            window.socketStats.disconnects += 1;
            window.socketStats.lastEvent = 'disconnect';
        }));
        
        // Debug: Log all socket events
        socket.onAny(function(eventName, ...args) {
            console.log('üîå Socket event received:', eventName, args);
        });

        // Helper functions for enhanced display
        function extractCurrencyPair(accountId) {
            // Extract currency pair from account ID like "101-004-30719775-001_EUR_USD"
            if (accountId.includes('_')) {
                const parts = accountId.split('_');
                const currencyPart = parts[parts.length - 1];
                return currencyPart.replace('_', '/');
            }
            return accountId; // fallback
        }

        function getStrategyName(accountId) {
            if (accountId.includes('101-004-30719775-001')) return 'Ultra Strict Forex';
            if (accountId.includes('101-004-30719775-002')) return 'Gold Scalping';  
            if (accountId.includes('101-004-30719775-003')) return 'Momentum Trading';
            return 'Trading Strategy';
        }

        // Update systems status
        socket.on('systems_update', function(data) {
            const systemsStatus = document.getElementById('systemsStatus');
            systemsStatus.innerHTML = '';
            
            for (const [key, system] of Object.entries(data)) {
                const systemItem = document.createElement('div');
                systemItem.className = 'system-item';
                
                let statusClass = 'status-unknown';
                let statusText = 'Unknown';
                
                if (system.status === 'running') {
                    statusClass = 'status-running';
                    statusText = 'Running';
                } else if (system.status === 'offline') {
                    statusClass = 'status-offline';
                    statusText = 'Offline';
                } else if (system.status === 'warning') {
                    statusClass = 'status-warning';
                    statusText = 'Warning';
                }
                
                systemItem.innerHTML = `
                    <div class="system-name">${system.strategy_name || system.name || 'Trading System'}</div>
                    <div class="system-status">
                        <span class="status-indicator ${statusClass}"></span>
                        <span>${statusText}</span>
                    </div>
                `;
                
                systemsStatus.appendChild(systemItem);
            }
        });
        
        // Enhanced market data display - FIXED to show clean currency pairs
        socket.on('market_update', function(data) {
            const marketData = document.getElementById('marketData');
            marketData.innerHTML = '';
            
            for (const [pair, market] of Object.entries(data)) {
                const marketPair = document.createElement('div');
                marketPair.className = 'enhanced-market-pair';
                
                // Extract clean currency pair from account ID string
                const cleanPair = extractCurrencyPair(pair);
                const strategyName = getStrategyName(pair);
                
                const liveIndicator = market.is_live ? '<span class="live-indicator"></span>' : '';
                const price = `${market.bid.toFixed(5)} / ${market.ask.toFixed(5)}`;
                
                marketPair.innerHTML = `
                    <div class="strategy-info">
                        <div class="strategy-name">${strategyName}</div>
                        <div class="pair-name">${liveIndicator}${cleanPair}</div>
                    </div>
                    <div class="pair-price">${price}</div>
                `;
                
                marketData.appendChild(marketPair);
            }
        });
        
        // Update risk metrics
        socket.on('risk_update', function(data) {
            const riskMetrics = document.getElementById('riskMetrics');
            
            let riskLevel = 'risk-low';
            let riskText = 'Low';
            
            if (data.risk_percentage > 7) {
                riskLevel = 'risk-high';
                riskText = 'High';
            } else if (data.risk_percentage > 3) {
                riskLevel = 'risk-medium';
                riskText = 'Medium';
            }
            
            riskMetrics.innerHTML = `
                <div class="risk-metric">
                    <span>Portfolio Risk:</span>
                    <span class="risk-level ${riskLevel}">${data.risk_percentage.toFixed(1)}%</span>
                </div>
                <div class="risk-metric">
                    <span>Total Open Positions:</span>
                    <span>${data.open_positions || 0}</span>
                </div>
                <div class="risk-metric">
                    <span>Total Daily Trades:</span>
                    <span>${data.trades_today || 0}</span>
                </div>
                <div class="risk-metric">
                    <span>Total Balance:</span>
                    <span>$${(data.account_balance || 0).toFixed(2)}</span>
                </div>
            `;
        });
        
        // Update news and alerts
        socket.on('news_update', function(data) {
            const newsAlerts = document.getElementById('newsAlerts');
            newsAlerts.innerHTML = '';
            
            data.forEach(news => {
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item';
                
                const time = new Date(news.timestamp).toLocaleTimeString();
                
                newsItem.innerHTML = `
                    <div class="news-time">${time}</div>
                    <div class="news-summary">${news.summary}</div>
                `;
                
                newsAlerts.appendChild(newsItem);
            });
        });
        
        // Request initial data
        socket.emit('request_update');
        
        // Update trading metrics
        socket.on('metrics_update', function(data) {
            const tradingMetrics = document.getElementById('tradingMetrics');
            
            tradingMetrics.innerHTML = `
                <div class="metric-item">
                    <span>Win Rate (24h):</span>
                    <span class="metric-value">${(data.win_rate * 100).toFixed(1)}%</span>
                </div>
                <div class="metric-item">
                    <span>Avg Trade Duration:</span>
                    <span class="metric-value">${data.avg_duration}</span>
                </div>
                <div class="metric-item">
                    <span>Risk/Reward Ratio:</span>
                    <span class="metric-value">${data.risk_reward_ratio.toFixed(2)}</span>
                </div>
                <div class="metric-item">
                    <span>Success Rate:</span>
                    <span class="metric-value">${(data.success_rate * 100).toFixed(1)}%</span>
                </div>
                <div class="metric-item">
                    <span>Profit Factor:</span>
                    <span class="metric-value">${data.profit_factor.toFixed(2)}</span>
                </div>
            `;
        });

        // Update news impact
        socket.on('news_impact_update', function(data) {
            console.log('üìä Received news_impact_update:', data);
            const newsTimer = document.getElementById('newsTimer');
            const tradePhase = document.getElementById('tradePhase');
            const upcomingNews = document.getElementById('upcomingNews');
            
            // Update countdown with enhanced functionality
            updateCountdownTimer(data);
            
            // Update AI trade phase
            if (data.trade_phase) {
                tradePhase.textContent = data.trade_phase;
                console.log('‚úÖ Updated trade phase:', data.trade_phase);
            }
            
            // Update upcoming news list
            upcomingNews.innerHTML = '';
            if (data.upcoming_news && data.upcoming_news.length > 0) {
                data.upcoming_news.forEach(news => {
                    const newsItem = document.createElement('div');
                    newsItem.className = 'impact-item';
                    
                    const time = new Date(news.timestamp).toLocaleTimeString();
                    const impactClass = `impact-${news.impact.toLowerCase()}`;
                    
                    newsItem.innerHTML = `
                        <div class="impact-time">${time}</div>
                        <div class="${impactClass}">${news.title}</div>
                    `;
                    
                    upcomingNews.appendChild(newsItem);
                });
                console.log('‚úÖ Updated upcoming news:', data.upcoming_news.length, 'items');
            }
        });

        // Listen for live trades updates
        socket.on('trades_update', (data) => {
            console.log('üìä Received live trades update:', data);
            updateActiveTrades(data);
        });

        // Listen for individual account updates
        socket.on('account_update', (data) => {
            console.log('üìä Received account update:', data);
            updateAccountDetails(data);
        });

        // Function to display live trading data
        function updateActiveTrades(tradesData) {
            const container = document.getElementById('activeTradesData');
            
            if (!tradesData || tradesData.length === 0) {
                container.innerHTML = `
                    <div class="no-trades-message" style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 24px; margin-bottom: 10px;">üìä</div>
                        <div>No active trades</div>
                        <div style="font-size: 12px; margin-top: 10px;">Live OANDA data - No positions open</div>
                    </div>
                `;
                return;
            }
            
            // Display real trading data
            container.innerHTML = '';
            tradesData.forEach(trade => {
                const tradeItem = document.createElement('div');
                tradeItem.className = 'trade-item';
                
                const statusClass = trade.unrealized_pl >= 0 ? 'profit' : 'drawdown';
                const statusText = trade.unrealized_pl >= 0 ? 'In Profit' : 'In Drawdown';
                
                tradeItem.innerHTML = `
                    <div class="trade-header">
                        <div class="strategy-badge ${trade.strategy.toLowerCase().replace(' ', '-')}">${trade.strategy}</div>
                        <div class="trade-time">Opened: ${new Date(trade.open_time).toLocaleTimeString()}</div>
                    </div>
                    <div class="trade-details">
                        <div class="trade-pair">${trade.instrument} ${trade.side.toUpperCase()}</div>
                        <div class="trade-levels">
                            Entry: ${trade.entry_price} | SL: ${trade.stop_loss} | TP: ${trade.take_profit}
                        </div>
                        <div class="trade-status ${statusClass}">
                            ${trade.unrealized_pl >= 0 ? '+' : ''}${trade.unrealized_pl.toFixed(2)} | ${statusText} | Duration: ${trade.duration}
                        </div>
                    </div>
                `;
                
                container.appendChild(tradeItem);
            });
        }

        // Function to display individual account details
        function updateAccountDetails(accountsData) {
            const container = document.getElementById('accountDetails');
            
            if (!accountsData || Object.keys(accountsData).length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 24px; margin-bottom: 10px;">üìä</div>
                        <div>No account data available</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            Object.entries(accountsData).forEach(([accountId, accountData]) => {
                const accountItem = document.createElement('div');
                accountItem.className = 'account-item';
                
                // Get account name from ID
                let accountName = 'Unknown Account';
                if (accountId.includes('101-004-30719775-001')) {
                    accountName = 'Primary Account (Ultra Strict Forex)';
                } else if (accountId.includes('101-004-30719775-002')) {
                    accountName = 'Gold Scalping Account';
                } else if (accountId.includes('101-004-30719775-003')) {
                    accountName = 'Strategy Alpha Account (Momentum)';
                }
                
                const balance = accountData.balance || 0;
                const unrealizedPL = accountData.unrealized_pl || 0;
                const realizedPL = accountData.realized_pl || 0;
                const openTrades = (accountData.open_trade_count ?? accountData.open_trades ?? accountData.openTrades ?? 0);
                const openPositions = (accountData.open_position_count ?? accountData.open_positions ?? accountData.openPositions ?? 0);
                const positions = accountData.positions || [];
                
                accountItem.innerHTML = `
                    <div class="account-header">
                        <div class="account-name">${accountName}</div>
                        <div class="account-balance">$${balance.toFixed(2)}</div>
                    </div>
                    
                    <div class="account-metrics">
                        <div class="account-metric">
                            <span>Unrealized P&L:</span>
                            <span style="color: ${unrealizedPL >= 0 ? '#10b981' : '#ef4444'}">${unrealizedPL >= 0 ? '+' : ''}$${unrealizedPL.toFixed(2)}</span>
                        </div>
                        <div class="account-metric">
                            <span>Realized P&L:</span>
                            <span style="color: ${realizedPL >= 0 ? '#10b981' : '#ef4444'}">${realizedPL >= 0 ? '+' : ''}$${realizedPL.toFixed(2)}</span>
                        </div>
                        <div class="account-metric">
                            <span>Open Trades:</span>
                            <span>${openTrades}</span>
                        </div>
                        <div class="account-metric">
                            <span>Open Positions:</span>
                            <span>${openPositions}</span>
                        </div>
                    </div>
                    
                    ${positions.length > 0 ? `
                        <div class="positions-list">
                            <h4 style="color: #f3f4f6; margin-bottom: 10px;">Open Positions:</h4>
                            ${positions.map(position => `
                                <div class="position-item">
                                    <div class="position-header">
                                        <div class="position-pair">${position.instrument}</div>
                                        <div class="position-side ${position.side.toLowerCase()}">${position.side.toUpperCase()}</div>
                                    </div>
                                    <div class="position-details">
                                        <div><span>Units:</span> <span>${position.units}</span></div>
                                        <div><span>Entry:</span> <span>${position.entry_price}</span></div>
                                        <div><span>P&L:</span> <span style="color: ${position.unrealized_pl >= 0 ? '#10b981' : '#ef4444'}">${position.unrealized_pl >= 0 ? '+' : ''}$${position.unrealized_pl.toFixed(2)}</span></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 20px; color: #9ca3af;">
                            <div style="font-size: 16px; margin-bottom: 5px;">üìä</div>
                            <div>No open positions</div>
                        </div>
                    `}
                `;
                
                container.appendChild(accountItem);
            });
        }

        // Request updates every 30 seconds and update timestamp
        setInterval(() => {
            safeSocket((socket) => {
                console.log('üîÑ Requesting periodic update...');
                socket.emit('request_update');
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            });
        }, 30000);
    </script>

    <!-- AI Assistant Widget Loader (flag + health-checked) -->
    <script>
      (async function initAIAssistant() {
        try {
          const res = await fetch('/ai/health', { method: 'GET' });
          if (!res.ok) return; // Assistant disabled or not registered
          
          // Prevent duplicate panels if one already exists
          if (document.querySelector('.ai-assistant-panel')) return;

          // Build widget DOM
          const panel = document.createElement('div');
          panel.className = 'ai-assistant-panel';
          panel.innerHTML = `
            <div class="ai-assistant-header">
              <div class="ai-assistant-title">ü§ñ AI Assistant</div>
              <div class="ai-mode-badge">Live</div>
            </div>
            <div class="chat-messages"></div>
            <div class="chat-input">
              <textarea placeholder="Ask or use /commands (actions need Confirm)" class="ai-chat-input"></textarea>
              <button class="send-button">Send</button>
            </div>
          `;
          document.body.appendChild(panel);

          const messages = panel.querySelector('.chat-messages');
          const input = panel.querySelector('textarea');
          const sendBtn = panel.querySelector('.send-button');

          function appendMessage(text, cls = '') {
            const div = document.createElement('div');
            div.textContent = text;
            if (cls) div.className = cls;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
          }

          async function interpret(message) {
            try {
              const r = await fetch('/ai/interpret', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: message, session_id: 'dashboard' })
              });
              const ct = r.headers.get('content-type') || '';
              if (!r.ok) throw new Error(`HTTP ${r.status}`);
              if (!ct.includes('application/json')) {
                const text = await r.text();
                throw new Error(`Unexpected response: ${text.slice(0,120)}...`);
              }
              return await r.json();
            } catch (e) {
              throw e;
            }
          }

          async function confirmAction(confirmation_id, confirm) {
            const r = await fetch('/ai/confirm', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ confirmation_id, confirm, session_id: 'dashboard' })
            });
            const ct = r.headers.get('content-type') || '';
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            if (!ct.includes('application/json')) {
              const text = await r.text();
              throw new Error(`Unexpected response: ${text.slice(0,120)}...`);
            }
            return r.json();
          }

          let sending = false;
          async function handleSend() {
            if (sending) return;
            const text = (input.value || '').trim();
            if (!text) return;
            sending = true;
            sendBtn.disabled = true;
            try {
              appendMessage(`You: ${text}`);
              input.value = '';
              const resp = await interpret(text);
              if (resp.reply) appendMessage(`Assistant: ${resp.reply}`);
              if (resp.preview) {
                const pv = document.createElement('div');
                pv.className = 'command-preview';
                pv.innerHTML = `<div><strong>Preview:</strong> ${resp.preview.summary || 'N/A'}</div>`;
                const row = document.createElement('div');
                row.className = 'confirm-row';
                if (resp.live_guard) {
                  const lg = document.createElement('div');
                  lg.className = 'live-guard';
                  lg.textContent = 'LIVE action requires token: "LIVE CONFIRM YES" and explicit confirmation';
                  pv.appendChild(lg);
                }
                if (resp.requires_confirmation && resp.confirmation_id) {
                  const confirmBtn = document.createElement('button');
                  confirmBtn.className = 'confirm-button';
                  confirmBtn.textContent = 'Confirm';
                  const cancelBtn = document.createElement('button');
                  cancelBtn.className = 'cancel-button';
                  cancelBtn.textContent = 'Cancel';
                  row.appendChild(confirmBtn);
                  row.appendChild(cancelBtn);
                  pv.appendChild(row);

                  confirmBtn.addEventListener('click', async () => {
                    try {
                      const result = await confirmAction(resp.confirmation_id, true);
                      appendMessage(`Result: ${result.result?.note || result.status}`, 'command-result');
                    } catch (e) {
                      appendMessage(`Error: ${(e && e.message) || e}`, 'command-result');
                    }
                  });
                  cancelBtn.addEventListener('click', async () => {
                    try {
                      const result = await confirmAction(resp.confirmation_id, false);
                      appendMessage(`Result: ${result.status}`, 'command-result');
                    } catch (e) {
                      appendMessage(`Error: ${(e && e.message) || e}`, 'command-result');
                    }
                  });
                }
                messages.appendChild(pv);
                messages.scrollTop = messages.scrollHeight;
              }
            } catch (e) {
              console.error('AI assistant error:', e);
              appendMessage(`Assistant error: ${(e && e.message) || e}`);
            } finally {
              sending = false;
              sendBtn.disabled = false;
            }
          }

          sendBtn.addEventListener('click', handleSend);
          input.addEventListener('keydown', (ev) => {
            if (ev.key === 'Enter' && !ev.shiftKey) {
              ev.preventDefault();
              handleSend();
            }
          });

          // Optional: Socket namespace hookup for live chat events
          try {
            const aiSocket = io({ path: '/socket.io', forceNew: true, transports: ['websocket', 'polling'] });
            aiSocket.on('connect', () => {
              aiSocket.emit('chat_message', { message: 'Hello from dashboard', session_id: 'dashboard' });
            });
            aiSocket.on('assistant_reply', (data) => {
              if (data && data.reply) appendMessage(`Assistant: ${data.reply}`);
            });
          } catch (e) {
            console.warn('AI Socket not available:', e);
          }
        } catch (e) {
          // Assistant disabled or unreachable; do nothing
        }
        
        // Fallback: Ensure AI assistant panel is always available
        setTimeout(() => {
          if (!document.querySelector('.ai-assistant-panel')) {
            console.log('Creating fallback AI assistant panel...');
            const panel = document.createElement('div');
            panel.className = 'ai-assistant-panel';
            panel.innerHTML = `
              <div class="ai-assistant-header">
                <div class="ai-assistant-title">ü§ñ AI Assistant</div>
                <div class="ai-mode-badge">Live</div>
              </div>
              <div class="chat-messages"></div>
              <div class="chat-input">
                <textarea placeholder="Ask or use /commands (actions need Confirm)" class="ai-chat-input"></textarea>
                <button class="send-button">Send</button>
              </div>
            `;
            document.body.appendChild(panel);
          }
        }, 2000);
      })();
    </script>
</body>
</html>