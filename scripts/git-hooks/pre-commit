#!/usr/bin/env bash
set -euo pipefail

# Fail-closed scan of STAGED *ADDED* lines only.
# Exclude hook files themselves from scan.

STAGED_FILES="$(git diff --cached --name-only)"
HOOK_FILES="$(echo "$STAGED_FILES" | grep -E '(git-hooks/pre-commit|install_git_hooks\.sh)' || true)"

# Pattern for secrets (variable name chosen to not trigger itself)
SEC_PAT='-----BEGIN|PRIVATE KEY|OPENSSH|AIza|xox[baprs]-|bot[0-9]+:'
KEY_PAT='OANDA_API_KEY[[:space:]]*=[[:space:]]*["\x27]|TELEGRAM_BOT_TOKEN[[:space:]]*=[[:space:]]*["\x27]'
GEN_PAT='api[_-]?key[[:space:]]*=[[:space:]]*["\x27]|token[[:space:]]*=[[:space:]]*["\x27]|secret[[:space:]]*=[[:space:]]*["\x27]|password[[:space:]]*=[[:space:]]*["\x27]'
FULL_PATTERN="${SEC_PAT}|${KEY_PAT}|${GEN_PAT}"

# Scan only non-hook files
for file in $STAGED_FILES; do
  if echo "$HOOK_FILES" | grep -q "^$file$"; then
    continue  # Skip hook files
  fi
  ADDED_LINES="$(git diff --cached --unified=0 -- "$file" | grep -E '^\+' | grep -vE '^\+\+\+' || true)"
  if [ -n "$ADDED_LINES" ]; then
    echo "$ADDED_LINES" | grep -nE -- "$FULL_PATTERN" >/dev/null
    RC=$?
    if [ $RC -eq 0 ]; then
      echo "ERROR: possible secret in $file (staged additions). Commit blocked." >&2
      echo "$ADDED_LINES" | grep -nE -- "$FULL_PATTERN" || true
      exit 1
    elif [ $RC -ne 1 ]; then
      echo "ERROR: secret scan failed (grep rc=$RC) for $file. Commit blocked." >&2
      exit 2
    fi
  fi
done

exit 0
