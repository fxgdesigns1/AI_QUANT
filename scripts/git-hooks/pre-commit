#!/usr/bin/env bash
set -euo pipefail

# Scan ONLY added lines from staged diff (ignores deletions).
# Allow safe placeholder examples in templates/docs (still fail on real-looking tokens).

ADDED_LINES="$(git diff --cached --unified=0 | grep -E '^\+' | grep -vE '^\+\+\+' || true)"

# Exclude this hook file from scanning to avoid self-pattern false positives
ADDED_LINES="$(echo "$ADDED_LINES" | grep -vE '^\+.*(scripts/git-hooks/pre-commit|\.git/hooks/pre-commit)' || true)"

# Secret-like patterns (tuned to reduce false positives, still fail-closed).
# NOTE: Environment=OANDA_API_KEY= REDACTED catches systemd inline secret injection
PATTERN='-----BEGIN|PRIVATE KEY|OPENSSH|xox[baprs]-|bot[0-9]+:|AIza[0-9A-Za-z_\-]{10,}|sk-[0-9A-Za-z_\-]{10,}|c01de9eb4d79|a3699a9d6b6d94d4e2c4c59748e73e2d|7248728383:|Environment=(OANDA_API_KEY|TELEGRAM_BOT_TOKEN|OPENAI_API_KEY|GEMINI_API_KEY|GOOGLE_API_KEY|MARKETAUX_KEY|MARKETAUX_KEYS)=|OANDA_API_KEY[[:space:]]*=[[:space:]]*["\x27]|TELEGRAM_BOT_TOKEN[[:space:]]*=[[:space:]]*["\x27]|api[_-]?key[[:space:]]*=[[:space:]]*["\x27]|token[[:space:]]*=[[:space:]]*["\x27]|secret[[:space:]]*=[[:space:]]*["\x27]|password[[:space:]]*=[[:space:]]*["\x27]'

# Skip placeholder examples (templates/docs) and documentation references.
# NOTE: if you paste a real key into templates/docs, it should still be caught by sk-/AIza strong patterns above.
FILTERED="$(echo "$ADDED_LINES" | grep -vE 'your_key_here|sk-your|AIza-your|<your_key>|<your_token>|REPLACE_ME|INSERT_KEY_HERE|hardcoded_value|fallback_value|c01de9eb4d79.*REDACTED|Pattern.*c01de9eb4d79|secrets_scan_raw_hits|PRIVATE KEY.*grep|OANDA_API_KEY.*environment|sk-new-key-here|AIza-new-key-here' || true)"

if [ -n "$FILTERED" ]; then
  if echo "$FILTERED" | grep -nE -- "$PATTERN" >/dev/null; then
    echo "ERROR: possible secret detected in ADDED staged diff. Commit blocked." >&2
    echo "$FILTERED" | grep -nE -- "$PATTERN" || true
    exit 1
  fi
fi

exit 0
