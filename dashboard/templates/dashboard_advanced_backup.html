<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trading Dashboard - Live Market Intelligence</title>
    
    <!-- Bootstrap 5.3 for Toast Notifications -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Socket.IO for Real-time Toast Notifications -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <style>
        /* CSS Variables for Consistent Theming (Like Crypto Dashboard) */
        :root {
            --primary: #3a86ff;
            --secondary: #8338ec;
            --success: #06d6a0;
            --danger: #ef476f;
            --warning: #ffd166;
            --info: #118ab2;
            --dark: #073b4c;
            --light: #f8f9fa;
            --bg-dark: #0a0a0a;
            --bg-card: #1a1a1a;
            --bg-hover: #2a2a2a;
            --border-color: #444;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #999999;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: var(--dark);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .header p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            font-weight: 300;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px 20px;
            background: rgba(15, 15, 35, 0.8);
            border-radius: 12px;
            border: 1px solid #374151;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-running { background-color: var(--success); }
        .status-warning { background-color: var(--warning); }
        .status-offline { background-color: var(--danger); }
        .status-unknown { background-color: var(--text-muted); }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 24px;
            margin-bottom: 30px;
        }

        .main-grid {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        .news-ai-section {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            background-color: var(--bg-hover);
            border-color: var(--primary);
        }

        .card h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 1.6rem;
        }

        .system-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #475569;
            transition: background-color 0.2s ease;
        }

        .system-item:hover {
            background-color: rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            padding: 16px 12px;
            margin: 0 -12px;
        }

        .system-item:last-child {
            border-bottom: none;
        }

        .system-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .system-status {
            display: flex;
            align-items: center;
            font-size: 0.95rem;
            gap: 8px;
        }

        .market-pair {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #475569;
            transition: background-color 0.2s ease;
        }

        .market-pair:hover {
            background-color: rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            padding: 12px 12px;
            margin: 0 -12px;
        }

        .market-pair:last-child {
            border-bottom: none;
        }

        .pair-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .pair-price {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            color: var(--info);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .risk-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .risk-level {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .risk-low { background-color: var(--success); color: var(--text-primary); }
        .risk-medium { background-color: var(--warning); color: var(--text-primary); }
        .risk-high { background-color: var(--danger); color: var(--text-primary); }

        /* Account Details Styling */
        .account-item {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .account-name {
            font-weight: bold;
            color: #f3f4f6;
            font-size: 16px;
        }
        
        .account-balance {
            font-size: 18px;
            font-weight: bold;
            color: #10b981;
        }
        
        .account-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .account-metric {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #374151;
        }
        
        .account-metric:last-child {
            border-bottom: none;
        }
        
        .account-metric span:first-child {
            color: #9ca3af;
        }
        
        .account-metric span:last-child {
            color: #f3f4f6;
            font-weight: 500;
        }
        
        .positions-list {
            margin-top: 10px;
        }
        
        .position-item {
            background: #111827;
            border: 1px solid #374151;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }
        
        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .position-pair {
            font-weight: bold;
            color: #f3f4f6;
        }
        
        .position-side {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .position-side.buy {
            background: #065f46;
            color: #10b981;
        }
        
        .position-side.sell {
            background: #7f1d1d;
            color: #f87171;
        }
        
        .position-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 8px;
            font-size: 12px;
        }

        .news-item {
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .news-item:last-child {
            border-bottom: none;
        }

        .news-time {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .news-summary {
            margin-top: 5px;
            color: #495057;
        }

        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #28a745;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: white;
            opacity: 0.8;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(15, 15, 35, 0.95);
            padding: 12px 18px;
            border-radius: 25px;
            font-size: 0.9rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            border: 1px solid #374151;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        .connection-connected {
            color: #10b981;
        }

        .connection-disconnected {
            color: #ef4444;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .metric-item:last-child {
            border-bottom: none;
        }

        .metric-value {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #2d3748;
        }

        .news-countdown {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #ef4444;
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
        }

        .ai-recommendation {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #10b981;
            box-shadow: 0 4px 16px rgba(5, 150, 105, 0.3);
        }

        #newsTimer {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-weight: 700;
            color: #ffffff;
            font-size: 1.2rem;
        }

        #tradePhase {
            font-weight: 700;
            color: #ffffff;
            font-size: 1.1rem;
        }

        .impact-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .impact-item {
            padding: 8px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.9rem;
        }

        .impact-item:last-child {
            border-bottom: none;
        }

        .impact-time {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .impact-high { color: #dc3545; }
        .impact-medium { color: #ffc107; }
        .impact-low { color: #28a745; }

        /* Enhanced Trading Details Styles */
        .trading-details-section {
            margin: 30px 0;
            grid-column: 1 / -1;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .trade-item {
            background: rgba(15, 15, 35, 0.6);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #374151;
            transition: all 0.2s ease;
        }

        .trade-item:hover {
            background: rgba(15, 15, 35, 0.8);
            border-color: #00d4ff;
        }

        .trade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .strategy-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .ultra-strict { background: #059669; color: white; }
        .gold-scalp { background: #dc2626; color: white; }
        .momentum { background: #7c3aed; color: white; }

        .trade-time {
            font-size: 0.9rem;
            color: #94a3b8;
            font-family: monospace;
        }

        .trade-details {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
            align-items: center;
        }

        .trade-pair {
            font-weight: 600;
            color: var(--info);
            font-size: 1.1rem;
        }

        .trade-levels {
            font-family: monospace;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .trade-status {
            text-align: right;
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .trade-status.profit {
            background: rgba(5, 150, 105, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
        }

        .trade-status.drawdown {
            background: rgba(220, 38, 38, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .strategy-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .strategy-name {
            font-size: 0.85rem;
            color: #94a3b8;
            font-weight: 500;
        }

        .enhanced-market-pair {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #475569;
            transition: background-color 0.2s ease;
        }

        .enhanced-market-pair:hover {
            background-color: rgba(71, 85, 105, 0.3);
            border-radius: 8px;
            padding: 12px 12px;
            margin: 0 -12px;
        }

        .enhanced-market-pair:last-child {
            border-bottom: none;
        }

        /* AI Assistant Widget (scoped) */
        .ai-assistant-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 360px;
            max-height: 60vh;
            background: rgba(17, 24, 39, 0.95);
            border: 1px solid #374151;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            z-index: 1100;
            overflow: hidden;
        }
        .ai-assistant-header {
            padding: 12px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #111827;
            border-bottom: 1px solid #374151;
        }
        .ai-assistant-title { font-weight: 600; }
        .ai-mode-badge { font-size: 12px; color: #10b981; }
        .chat-messages { padding: 10px; overflow-y: auto; flex: 1; font-size: 14px; }
        .chat-input { display: flex; gap: 8px; padding: 10px; border-top: 1px solid #374151; }
        .chat-input textarea { flex: 1; resize: none; height: 48px; background: #0b1220; color: #e5e7eb; border: 1px solid #1f2937; border-radius: 8px; padding: 8px; }
        .send-button { background: #2563eb; color: white; border: none; border-radius: 8px; padding: 0 14px; cursor: pointer; }
        .command-preview { background: #0b1220; border: 1px solid #374151; border-radius: 8px; padding: 8px; margin: 8px 0; }
        
        .confirmation-panel {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }
        
        .confirmation-preview {
            margin-bottom: 8px;
            font-size: 14px;
            color: #92400e;
        }
        
        .confirmation-buttons {
            display: flex;
            gap: 8px;
        }
        
        .confirm-btn, .cancel-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .confirm-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .confirm-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .cancel-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .cancel-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        
        /* Trading Signals */
        .trading-signals {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .signal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 8px;
            border: 1px solid #475569;
        }
        
        .signal-pair {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .signal-action {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .signal-confidence {
            color: #94a3b8;
            font-size: 0.9rem;
        }
        .confirm-row { display: flex; gap: 8px; }
        .confirm-button { background: #10b981; color: white; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; }
        .cancel-button { background: #ef4444; color: white; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; }
        .live-guard { color: #f59e0b; font-size: 12px; margin-top: 6px; }
        
        /* Contextual Insights Styles */
        #contextual-insights { padding: 16px; }
        .context-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
        }
        .context-label { color: #94a3b8; font-weight: 600; }
        .context-value { color: #e2e8f0; font-weight: 700; }
        .key-levels { margin-top: 20px; padding-top: 16px; border-top: 2px solid rgba(168, 85, 247, 0.3); }
        .key-levels h4 { color: #a855f7; margin-bottom: 12px; }
        .levels-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px; }
        .level-group { background: rgba(168, 85, 247, 0.1); padding: 12px; border-radius: 8px; }
        .level-label { color: #94a3b8; font-size: 0.85rem; margin-bottom: 4px; }
        .level-values { color: #e2e8f0; font-weight: 600; font-size: 0.9rem; }
        .trend-indicator { background: rgba(96, 165, 250, 0.1); padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; }
        .trend-value { font-weight: 700; text-transform: uppercase; }

        /* Sidebar and Main Content Layout (Like Crypto Dashboard) */
        .navbar {
            background-color: var(--dark);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .sidebar {
            background-color: var(--bg-card);
            height: calc(100vh - 56px);
            width: 250px;
            position: fixed;
            left: 0;
            top: 56px;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
        }

        .sidebar-heading {
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 1rem 1rem 0.5rem;
            margin-top: 1rem;
        }

        .sidebar .nav-link {
            color: var(--text-secondary);
            padding: 0.75rem 1rem;
            border-radius: 0;
            transition: all 0.2s;
        }

        .sidebar .nav-link:hover {
            background-color: var(--bg-hover);
            color: var(--text-primary);
        }

        .sidebar .nav-link.active {
            background-color: var(--primary);
            color: white;
        }

        .main-content {
            margin-left: 250px;
            padding: 2rem;
            min-height: calc(100vh - 56px);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* ========================================= */
        /* HYBRID MANUAL TRADING - OPPORTUNITY CARDS */
        /* ========================================= */
        
        .opportunity-card {
            background: linear-gradient(135deg, rgba(58, 134, 255, 0.1) 0%, rgba(131, 56, 236, 0.1) 100%);
            border: 1px solid #3a86ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(58, 134, 255, 0.2);
        }
        
        .opportunity-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(58, 134, 255, 0.4);
            border-color: #60a5fa;
        }
        
        .opportunity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(58, 134, 255, 0.3);
        }
        
        .opportunity-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3a86ff;
        }
        
        .quality-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .quality-excellent { background: linear-gradient(135deg, #06d6a0, #047857); color: white; }
        .quality-good { background: linear-gradient(135deg, #3a86ff, #1e40af); color: white; }
        .quality-moderate { background: linear-gradient(135deg, #ffd166, #d97706); color: white; }
        .quality-weak { background: linear-gradient(135deg, #ef476f, #991b1b); color: white; }
        
        .opportunity-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .detail-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #3a86ff;
        }
        
        .detail-label {
            color: #999;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }
        
        .detail-value {
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .sniper-zone-indicator {
            background: linear-gradient(135deg, #06d6a0, #047857);
            padding: 10px 15px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .pros-cons-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .pros-box {
            background: rgba(6, 214, 160, 0.1);
            border: 1px solid #06d6a0;
            border-radius: 8px;
            padding: 15px;
        }
        
        .cons-box {
            background: rgba(239, 71, 111, 0.1);
            border: 1px solid #ef476f;
            border-radius: 8px;
            padding: 15px;
        }
        
        .pros-box h5, .cons-box h5 {
            margin-bottom: 12px;
            font-size: 1rem;
        }
        
        .pros-box h5 { color: #06d6a0; }
        .cons-box h5 { color: #ef476f; }
        
        .pros-box li, .cons-box li {
            color: #ccc;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .recommendation-bar {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .rec-strong-buy { background: linear-gradient(135deg, #06d6a0, #047857); color: white; }
        .rec-buy { background: linear-gradient(135deg, #3a86ff, #1e40af); color: white; }
        .rec-consider { background: linear-gradient(135deg, #ffd166, #d97706); color: white; }
        .rec-avoid { background: linear-gradient(135deg, #ef476f, #991b1b); color: white; }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
        }
        
        .btn-approve {
            background: linear-gradient(135deg, #06d6a0, #047857);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-approve:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(6, 214, 160, 0.5);
        }
        
        .btn-dismiss {
            background: linear-gradient(135deg, #ef476f, #991b1b);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-dismiss:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(239, 71, 111, 0.5);
        }
        
        .btn-watch {
            background: linear-gradient(135deg, #ffd166, #d97706);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-watch:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 209, 102, 0.5);
        }
        
        .tp-stages {
            background: rgba(131, 56, 236, 0.1);
            border: 1px solid #8338ec;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .tp-stage-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(131, 56, 236, 0.2);
        }
        
        .tp-stage-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-graph-up me-2"></i>
                AI Trading Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="refreshData">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            Refresh Data
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="bi bi-gear me-1"></i>
                            Settings
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    
    <div class="sidebar">
        <div class="p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="m-0">Market Overview</h5>
                <span class="badge bg-success" id="connectionStatus">Live</span>
            </div>
            <div id="marketOverview">
                <!-- Market overview will be loaded here -->
            </div>
        </div>
        
        <div class="sidebar-heading">Navigation</div>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="#dashboard" data-section="dashboard">
                    <i class="bi bi-speedometer2 me-2"></i>
                    Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#accounts" data-section="accounts">
                    <i class="bi bi-briefcase me-2"></i>
                    Accounts
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#strategies" data-section="strategies">
                    <i class="bi bi-graph-up me-2"></i>
                    Strategies
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#positions" data-section="positions">
                    <i class="bi bi-bar-chart me-2"></i>
                    Positions
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#signals" data-section="signals">
                    <i class="bi bi-bullseye me-2"></i>
                    Trading Signals
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#news" data-section="news">
                    <i class="bi bi-newspaper me-2"></i>
                    News & Events
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#trade-manager" data-section="trade-manager">
                    <i class="bi bi-sliders me-2"></i>
                    Trade Manager
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#system-status" data-section="system-status">
                    <i class="bi bi-heart-pulse me-2"></i>
                    System Status
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#insights" data-section="insights">
                    <i class="bi bi-lightbulb me-2"></i>
                    AI Insights
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#strategy-switcher" data-section="strategy-switcher">
                    <i class="bi bi-shuffle me-2"></i>
                    Strategy Switcher
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#analytics" data-section="analytics">
                    <i class="bi bi-graph-up-arrow me-2"></i>
                    Analytics
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#config" data-section="config">
                    <i class="bi bi-gear me-2"></i>
                    Configuration
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#ai-copilot" data-section="ai-copilot">
                    <i class="bi bi-robot me-2"></i>
                    AI Copilot
                </a>
            </li>
        </ul>
    </div>
    
    <div class="main-content">
        <section id="dashboard" class="content-section active">
            <div class="container-fluid">
                <div class="header">
                    <h1>ü§ñ AI Trading Dashboard</h1>
                    <p>Live Market Intelligence & Automated Trading System</p>
                    <div class="status-bar">
                        <div>
                            <span class="live-indicator"></span>
                            <span>Live Trading Active</span>
                        </div>
                        <div>
                            <a href="/strategy-manager" style="color: #a855f7; text-decoration: none; padding: 8px 16px; background: rgba(168, 85, 247, 0.1); border-radius: 8px; border: 1px solid #a855f7; margin-right: 10px; transition: all 0.2s; font-weight: 600;" onmouseover="this.style.background='rgba(168, 85, 247, 0.2)'" onmouseout="this.style.background='rgba(168, 85, 247, 0.1)'">
                                ‚öôÔ∏è Strategy Manager
                            </a>
                            <a href="/strategies" style="color: #60a5fa; text-decoration: none; padding: 8px 16px; background: rgba(96, 165, 250, 0.1); border-radius: 8px; border: 1px solid #60a5fa; margin-right: 15px; transition: all 0.2s;" onmouseover="this.style.background='rgba(96, 165, 250, 0.2)'" onmouseout="this.style.background='rgba(96, 165, 250, 0.1)'">
                                üìä Strategy Performance
                            </a>
                            <span>Last Update: <span id="lastUpdate">Loading...</span></span>
                        </div>
                    </div>
                </div>

                <!-- Price Chart Section - Full Width -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between">
                                <div class="d-flex align-items-center">
                                    <span>Price Chart: <span id="chartInstrument">EURUSD</span></span>
                                    <select id="symbolSelector" class="form-select form-select-sm ms-2" style="width: auto;">
                                        <option value="EURUSD">EUR/USD</option>
                                        <option value="GBPUSD">GBP/USD</option>
                                        <option value="USDJPY">USD/JPY</option>
                                        <option value="AUDUSD">AUD/USD</option>
                                        <option value="USDCAD">USD/CAD</option>
                                        <option value="NZDUSD">NZD/USD</option>
                                        <option value="USDCHF">USD/CHF</option>
                                        <option value="EURGBP">EUR/GBP</option>
                                        <option value="EURJPY">EUR/JPY</option>
                                        <option value="GBPJPY">GBP/JPY</option>
                                        <option value="XAUUSD">Gold (XAU/USD)</option>
                                        <option value="XAGUSD">Silver (XAG/USD)</option>
                                        <option value="BTCUSD">Bitcoin (BTC/USD)</option>
                                        <option value="ETHUSD">Ethereum (ETH/USD)</option>
                                    </select>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" data-timeframe="15m">15m</button>
                                    <button class="btn btn-sm btn-outline-primary" data-timeframe="30m">30m</button>
                                    <button class="btn btn-sm btn-outline-primary active" data-timeframe="1h">1h</button>
                                    <button class="btn btn-sm btn-outline-primary" data-timeframe="4h">4h</button>
                                    <button class="btn btn-sm btn-outline-primary" data-timeframe="1d">1d</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- TradingView Widget - Larger -->
                                <div id="tradingview_widget" style="height: 600px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Trading Signals Section - Moved Below Chart -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">Trading Signals</div>
                            <div class="card-body" id="tradingSignals">
                                <div style="text-align: center; padding: 20px; color: #666;">
                                    <div style="font-size: 18px; margin-bottom: 10px;">üìä</div>
                                    <div>Loading trading signals...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Keep existing dashboard content below -->
                <!-- Main Trading Overview -->
                <div class="main-grid">
                    <!-- Live Market Data -->
                    <div class="card market-data-section live-market-data">
                        <h3><span class="card-icon">üí±</span>Live Market Data</h3>
                        <div id="marketData">
                            <div class="enhanced-market-pair">
                                <div class="strategy-info">
                                    <div class="strategy-name">Ultra Strict Forex</div>
                                    <div class="pair-name">EUR/USD</div>
                                </div>
                                <div class="pair-price">Loading...</div>
                            </div>
                            <div class="enhanced-market-pair">
                                <div class="strategy-info">
                                    <div class="strategy-name">Gold Scalping</div>
                                    <div class="pair-name">XAU/USD</div>
                                </div>
                                <div class="pair-price">Loading...</div>
                            </div>
                            <div class="enhanced-market-pair">
                                <div class="strategy-info">
                                    <div class="strategy-name">Momentum Trading</div>
                                    <div class="pair-name">GBP/USD</div>
                                </div>
                                <div class="pair-price">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Trading Systems Status -->
                    <div class="card trading-systems-section trading-systems">
                        <h3><span class="card-icon">üìä</span>Trading Systems</h3>
                        <div id="systemsStatus">
                            <div class="system-item">
                                <div class="system-name">Ultra Strict Forex</div>
                                <div class="system-status">
                                    <span class="status-indicator status-unknown"></span>
                                    <span>Initializing...</span>
                                </div>
                            </div>
                            <div class="system-item">
                                <div class="system-name">Gold Scalping</div>
                                <div class="system-status">
                                    <span class="status-indicator status-offline"></span>
                                    <span>Offline</span>
                                </div>
                            </div>
                            <div class="system-item">
                                <div class="system-name">Momentum Trading</div>
                                <div class="system-status">
                                    <span class="status-indicator status-offline"></span>
                                    <span>Offline</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Trades & Signals Section -->
                <div class="trading-details-section">
                    <div class="card full-width trading-signals-section">
                        <h3><span class="card-icon">üìä</span>Active Trades & Signals</h3>
                        <div id="activeTradesData">
                            <!-- Live trading data will be populated here via JavaScript -->
                            <div class="no-trades-message" style="text-align: center; padding: 40px; color: #666;">
                                <div style="font-size: 24px; margin-bottom: 10px;">üìä</div>
                                <div>Loading live trading data...</div>
                                <div style="font-size: 12px; margin-top: 10px;">Connecting to OANDA accounts</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========================================= -->
                <!-- HYBRID MANUAL TRADING - AI OPPORTUNITIES  -->
                <!-- ========================================= -->
                <div style="margin-top: 30px; margin-bottom: 30px;">
                    <div class="card" style="border: 2px solid #3a86ff; box-shadow: 0 4px 20px rgba(58, 134, 255, 0.3);">
                        <h3 style="color: #3a86ff; font-size: 1.8rem; margin-bottom: 25px;">
                            <span class="card-icon">üéØ</span>AI Trade Opportunities - Manual Approval
                            <span style="float: right; font-size: 0.9rem; font-weight: normal; color: #999;">
                                <span id="opportunityCount">0</span> Active | 
                                <span id="autoCount">0</span> Auto Queue
                            </span>
                        </h3>
                        
                        <!-- Mode Selector -->
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(58, 134, 255, 0.1); border-radius: 8px; border-left: 4px solid #3a86ff;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: #3a86ff;">Trading Mode:</strong>
                                    <select id="tradingMode" style="margin-left: 10px; padding: 8px 15px; background: #2a2a2a; color: white; border: 1px solid #444; border-radius: 6px; font-size: 14px;">
                                        <option value="manual" selected>üéØ Manual Approval (You Choose)</option>
                                        <option value="auto">ü§ñ Auto Execute (AI Decides)</option>
                                        <option value="hybrid">‚ö° Hybrid (Auto on 80+ Quality)</option>
                                    </select>
                                </div>
                                <div style="text-align: right;">
                                    <span style="color: #999;">Today: </span>
                                    <span id="dailyTargetProgress" style="color: #06d6a0; font-weight: bold;">$0 / $700</span>
                                    <span style="color: #999; margin-left: 15px;">Week: </span>
                                    <span id="weeklyTargetProgress" style="color: #06d6a0; font-weight: bold;">$0 / $2,500</span>
                                </div>
                            </div>
                        </div>

                        <!-- Opportunities Feed -->
                        <div id="opportunitiesFeed" style="min-height: 200px;">
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üîç</div>
                                <div style="font-size: 18px; margin-bottom: 10px;">AI is scanning for opportunities...</div>
                                <div style="font-size: 14px; color: #999;">High-quality setups will appear here</div>
                            </div>
                        </div>
                        
                        <!-- A/B Lane Comparison -->
                        <div style="margin-top: 30px; padding: 20px; background: rgba(131, 56, 236, 0.1); border-radius: 12px; border: 1px solid #8338ec;">
                            <h4 style="color: #8338ec; margin-bottom: 15px; font-size: 1.3rem;">
                                üìä Performance Comparison: Manual vs Auto
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <!-- Manual Lane -->
                                <div style="padding: 20px; background: rgba(6, 214, 160, 0.1); border-radius: 8px; border: 1px solid #06d6a0;">
                                    <div style="font-size: 1.1rem; font-weight: bold; color: #06d6a0; margin-bottom: 15px;">
                                        üéØ MANUAL (Your Picks)
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333;">
                                        <span style="color: #999;">Opportunities Shown:</span>
                                        <span id="manualOppsShown" style="color: white; font-weight: bold;">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333;">
                                        <span style="color: #999;">You Approved:</span>
                                        <span id="manualApproved" style="color: #06d6a0; font-weight: bold;">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333;">
                                        <span style="color: #999;">Win Rate:</span>
                                        <span id="manualWinRate" style="color: #06d6a0; font-weight: bold; font-size: 1.3rem;">--%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333;">
                                        <span style="color: #999;">Profit:</span>
                                        <span id="manualProfit" style="color: #06d6a0; font-weight: bold; font-size: 1.3rem;">$0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                        <span style="color: #999;">Avg Quality:</span>
                                        <span id="manualAvgQuality" style="color: white; font-weight: bold;">--/100</span>
                                    </div>
                                </div>
                                
                                <!-- Auto Lane -->
                                <div style="padding: 20px; background: rgba(239, 71, 111, 0.1); border-radius: 8px; border: 1px solid #ef476f;">
                                    <div style="font-size: 1.1rem; font-weight: bold; color: #ef476f; margin-bottom: 15px;">
                                        ü§ñ AUTO (AI Would Execute)
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333;">
                                        <span style="color: #999;">Opportunities:</span>
                                        <span id="autoOppsTotal" style="color: white; font-weight: bold;">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333;">
                                        <span style="color: #999;">Would Execute:</span>
                                        <span id="autoWouldExecute" style="color: #ef476f; font-weight: bold;">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333;">
                                        <span style="color: #999;">Win Rate (Est):</span>
                                        <span id="autoWinRate" style="color: #ffd166; font-weight: bold; font-size: 1.3rem;">--%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333;">
                                        <span style="color: #999;">Profit (Est):</span>
                                        <span id="autoProfit" style="color: #ffd166; font-weight: bold; font-size: 1.3rem;">$0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                        <span style="color: #999;">Avg Quality:</span>
                                        <span id="autoAvgQuality" style="color: white; font-weight: bold;">--/100</span>
                                    </div>
                                </div>
                            </div>
                            <div id="abComparison" style="margin-top: 15px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; text-align: center; font-size: 1.2rem;">
                                <span style="color: #999;">Performance Difference: </span>
                                <span id="performanceDiff" style="color: #06d6a0; font-weight: bold;">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Insights & Trade Ideas (Full-width Row) -->
                <div class="dashboard-grid">
                    <div class="card full-width" id="insightsSection">
                        <h3><span class="card-icon">üß≠</span>Market Insights</h3>
                        <div id="insightsContent">
                            <div style="text-align: center; padding: 16px; color: #94a3b8;">Loading live insights‚Ä¶</div>
                        </div>
                    </div>
                    <div class="card full-width" id="tradeIdeasSection">
                        <h3><span class="card-icon">üí°</span>Trade Ideas</h3>
                        <div id="tradeIdeasContent">
                            <div style="text-align: center; padding: 16px; color: #94a3b8;">Loading live trade ideas‚Ä¶</div>
                        </div>
                    </div>
                </div>

                <!-- News & AI Insights Section -->
                <div class="news-ai-section">
                    <!-- AI Insights & Recommendations -->
                    <div class="card">
                        <h3><span class="card-icon">üß†</span>AI Insights & Recommendations</h3>
                        <div id="newsImpact">
                            <div class="ai-recommendation">
                                <span>Current AI Trade Phase:</span>
                                <span id="tradePhase">Analyzing market conditions...</span>
                            </div>
                            <div class="news-countdown">
                                <span>Next Major News Event:</span>
                                <span id="newsTimer">No upcoming news</span>
                            </div>
                            <div class="impact-list" id="upcomingNews">
                                <div class="impact-item">
                                    <div class="impact-time">Loading AI analysis...</div>
                                    <div class="impact-medium">System initializing</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Market Context & Quality Insights -->
                    <div class="card">
                        <h3><span class="card-icon">üéØ</span>Market Context & Quality Insights</h3>
                        <div id="contextual-insights">
                            <div class="context-item">
                                <div class="context-label">Session Quality:</div>
                                <div id="session-quality-value" class="context-value">--</div>
                            </div>
                            <div class="context-item">
                                <div class="context-label">Active Sessions:</div>
                                <div id="active-sessions-value" class="context-value">--</div>
                            </div>
                            <div class="context-item">
                                <div class="context-label">Session Description:</div>
                                <div id="session-description" class="context-value">--</div>
                            </div>
                            <div class="key-levels">
                                <h4>Key Levels</h4>
                                <div class="levels-row">
                                    <div class="level-group">
                                        <div class="level-label">Support:</div>
                                        <div id="support-levels" class="level-values">--</div>
                                    </div>
                                    <div class="level-group">
                                        <div class="level-label">Resistance:</div>
                                        <div id="resistance-levels" class="level-values">--</div>
                                    </div>
                                </div>
                                <div class="trend-indicator">
                                    <div class="level-label">Trend:</div>
                                    <div id="trend-direction" class="trend-value">--</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Live News Feed -->
                    <div class="card news-section live-news-feed">
                        <h3><span class="card-icon">üì∞</span>Live News Feed</h3>
                        <div id="newsAlerts">
                            <div class="news-item">
                                <div class="news-time">Just now</div>
                                <div class="news-summary">AI Trading System Online - Monitoring markets</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance & Risk Metrics -->
                <div class="dashboard-grid">
                    <!-- Trading Performance -->
                    <div class="card">
                        <h3><span class="card-icon">üìà</span>Trading Performance</h3>
                        <div id="tradingMetrics">
                            <div class="metric-item">
                                <span>Win Rate (24h):</span>
                                <span class="metric-value">Loading...</span>
                            </div>
                            <div class="metric-item">
                                <span>Avg Trade Duration:</span>
                                <span class="metric-value">Loading...</span>
                            </div>
                            <div class="metric-item">
                                <span>Risk/Reward Ratio:</span>
                                <span class="metric-value">Loading...</span>
                            </div>
                            <div class="metric-item">
                                <span>Success Rate:</span>
                                <span class="metric-value">Loading...</span>
                            </div>
                            <div class="metric-item">
                                <span>Profit Factor:</span>
                                <span class="metric-value">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Management -->
                    <div class="card">
                        <h3><span class="card-icon">üõ°Ô∏è</span>Risk Management</h3>
                        <div id="riskMetrics">
                            <div class="risk-metric">
                                <span>Portfolio Risk:</span>
                                <span class="risk-level risk-low">Loading...</span>
                            </div>
                            <div class="risk-metric">
                                <span>Open Positions:</span>
                                <span>Loading...</span>
                            </div>
                            <div class="risk-metric">
                                <span>Daily Trades:</span>
                                <span>Loading...</span>
                            </div>
                            <div class="risk-metric">
                                <span>Account Balance:</span>
                                <span>Loading...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Individual Account Details -->
                    <div class="card full-width">
                        <h3><span class="card-icon">üè¶</span>Individual OANDA Account Details</h3>
                        <div id="accountDetails">
                            <div class="account-loading">
                                <div style="text-align: center; padding: 20px; color: #666;">
                                    <div style="font-size: 18px; margin-bottom: 10px;">üìä</div>
                                    <div>Loading individual account balances...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="footer">
                    <p>üöÄ Google Cloud Trading System - Live OANDA Integration</p>
                    <p>Production Ready ‚Ä¢ Real-time Trading ‚Ä¢ Risk Managed</p>
                </div>
            </div>
        </section>
        
        <!-- Additional sections for other navigation items -->
        <section id="accounts" class="content-section">
            <div class="container-fluid">
                <h2>üìä Account Management</h2>
                <div id="accountsGrid" class="row"></div>
            </div>
        </section>

        <script>
        async function loadAccountsSection() {
            try {
                const response = await fetch('/api/accounts');
                const data = await response.json();
                
                const grid = document.getElementById('accountsGrid');
                if (grid) {
                    grid.innerHTML = Object.entries(data).map(([id, acc]) => `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5>${acc.display_name || id}</h5>
                                    <p><strong>Balance:</strong> $${acc.balance.toFixed(2)}</p>
                                    <p><strong>NAV:</strong> $${acc.nav.toFixed(2)}</p>
                                    <p><strong>P&L:</strong> <span class="${acc.unrealized_pl >= 0 ? 'text-success' : 'text-danger'}">$${acc.unrealized_pl.toFixed(2)}</span></p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Accounts load error:', error);
                const grid = document.getElementById('accountsGrid');
                if (grid) {
                    grid.innerHTML = '<div class="col-12"><div class="alert alert-warning">Failed to load account data</div></div>';
                }
            }
        }
        </script>
        
        <section id="strategies" class="content-section">
            <div class="container-fluid">
                <h2>üéØ Trading Strategies</h2>
                <div id="strategiesGrid" class="row"></div>
            </div>
        </section>

        <script>
        async function loadStrategiesSection() {
            try {
                const response = await fetch('/api/strategies/overview');
                const data = await response.json();
                
                const grid = document.getElementById('strategiesGrid');
                if (grid) {
                    grid.innerHTML = data.strategies.map(strat => `
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5>${strat.name}</h5>
                                    <p><strong>Win Rate:</strong> ${strat.win_rate.toFixed(1)}%</p>
                                    <p><strong>Total Trades:</strong> ${strat.total_trades}</p>
                                    <p><strong>P&L:</strong> $${strat.total_pnl.toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Strategies load error:', error);
                const grid = document.getElementById('strategiesGrid');
                if (grid) {
                    grid.innerHTML = '<div class="col-12"><div class="alert alert-warning">Failed to load strategy data</div></div>';
                }
            }
        }
        </script>
        
        <section id="positions" class="content-section">
            <div class="container-fluid">
                <h2>üìà Open Positions</h2>
                <div id="positionsGrid" class="row"></div>
            </div>
        </section>

        <script>
        async function loadPositionsSection() {
            try {
                const response = await fetch('/api/positions');
                const data = await response.json();
                
                const grid = document.getElementById('positionsGrid');
                if (grid) {
                    if (data.positions && data.positions.length > 0) {
                        grid.innerHTML = data.positions.map(pos => `
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5>${pos.instrument}</h5>
                                        <p><strong>Side:</strong> ${pos.long ? 'Long' : 'Short'}</p>
                                        <p><strong>Units:</strong> ${pos.units}</p>
                                        <p><strong>P&L:</strong> <span class="${pos.unrealizedPL >= 0 ? 'text-success' : 'text-danger'}">$${pos.unrealizedPL.toFixed(2)}</span></p>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        grid.innerHTML = '<div class="col-12"><div class="alert alert-info">No open positions</div></div>';
                    }
                }
            } catch (error) {
                console.error('Positions load error:', error);
                const grid = document.getElementById('positionsGrid');
                if (grid) {
                    grid.innerHTML = '<div class="col-12"><div class="alert alert-warning">Failed to load positions data</div></div>';
                }
            }
        }
        </script>
        
        <section id="signals" class="content-section">
            <div class="container-fluid">
                <h2>üéØ Trading Signals</h2>
                <div id="signalsGrid" class="row"></div>
            </div>
        </section>

        <script>
        async function loadSignalsSection() {
            try {
                const response = await fetch('/api/signals/pending');
                const data = await response.json();
                
                const grid = document.getElementById('signalsGrid');
                if (grid) {
                    if (data.signals && data.signals.length > 0) {
                        grid.innerHTML = data.signals.map(signal => `
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5>${signal.instrument}</h5>
                                        <p><strong>Type:</strong> ${signal.type}</p>
                                        <p><strong>Entry:</strong> ${signal.entry_price}</p>
                                        <p><strong>Stop Loss:</strong> ${signal.stop_loss}</p>
                                        <p><strong>Take Profit:</strong> ${signal.take_profit}</p>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        grid.innerHTML = '<div class="col-12"><div class="alert alert-info">No pending signals</div></div>';
                    }
                }
            } catch (error) {
                console.error('Signals load error:', error);
                const grid = document.getElementById('signalsGrid');
                if (grid) {
                    grid.innerHTML = '<div class="col-12"><div class="alert alert-warning">Failed to load signals data</div></div>';
                }
            }
        }
        </script>
        
        <section id="news" class="content-section">
            <div class="container-fluid">
                <h2>üì∞ News & Events</h2>
                <div id="newsGrid" class="row"></div>
            </div>
        </section>

        <script>
        async function loadNewsSection() {
            try {
                const response = await fetch('/api/news');
                const data = await response.json();
                
                const grid = document.getElementById('newsGrid');
                if (grid) {
                    if (data.news && data.news.length > 0) {
                        grid.innerHTML = data.news.map(article => `
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5>${article.title}</h5>
                                        <p><strong>Source:</strong> ${article.source}</p>
                                        <p><strong>Time:</strong> ${new Date(article.published_at).toLocaleString()}</p>
                                        <p>${article.summary}</p>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        grid.innerHTML = '<div class="col-12"><div class="alert alert-info">No news available</div></div>';
                    }
                }
            } catch (error) {
                console.error('News load error:', error);
                const grid = document.getElementById('newsGrid');
                if (grid) {
                    grid.innerHTML = '<div class="col-12"><div class="alert alert-warning">Failed to load news data</div></div>';
                }
            }
        }

        async function loadTradeManagerSection() {
            try {
                const content = document.getElementById('tradeManagerContent');
                if (!content) return;
                
                // Fetch trade manager data
                const response = await fetch('/api/trades/pending');
                const data = await response.json();
                
                content.innerHTML = `
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5>Active Trade Management</h5>
                                    <div id="activeTrades">
                                        ${data.trades && data.trades.length > 0 ? 
                                            data.trades.map(trade => `
                                                <div class="mb-2 p-3 border rounded">
                                                    <strong>${trade.instrument}</strong> - 
                                                    ${trade.side} ${trade.units} units @ ${trade.price}
                                                </div>
                                            `).join('') :
                                            '<div class="alert alert-info">No active trades</div>'
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Trade Manager load error:', error);
                document.getElementById('tradeManagerContent').innerHTML = 
                    '<div class="alert alert-warning">Failed to load trade manager data</div>';
            }
        }

        async function loadSystemStatusSection() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                const content = document.getElementById('systemStatusContent');
                if (content) {
                    content.innerHTML = `
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5>System Status</h5>
                                        <p><strong>Status:</strong> ${data.system_status || 'Unknown'}</p>
                                        <p><strong>Active Accounts:</strong> ${data.active_accounts || 0}</p>
                                        <p><strong>Live Data:</strong> ${data.live_data_mode ? 'Yes' : 'No'}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5>Health Metrics</h5>
                                        <div id="healthMetrics">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('System Status load error:', error);
                document.getElementById('systemStatusContent').innerHTML = 
                    '<div class="alert alert-warning">Failed to load system status</div>';
            }
        }

        async function loadConfigSection() {
            const content = document.getElementById('configContent');
            if (content) {
                content.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <h5>System Configuration</h5>
                            <p>Configuration interface coming soon...</p>
                            <p><a href="/config" class="btn btn-primary">Open Full Config Dashboard</a></p>
                        </div>
                    </div>
                `;
            }
        }

        async function loadInsightsSection() {
            const content = document.getElementById('insightsContent');
            if (content) {
                content.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <h5>AI Market Insights</h5>
                            <p>Loading AI insights...</p>
                            <p><a href="/insights" class="btn btn-primary">Open Full Insights Dashboard</a></p>
                        </div>
                    </div>
                `;
            }
        }

        async function loadStrategySwitcherSection() {
            const content = document.getElementById('strategySwitcherContent');
            if (content) {
                content.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <h5>Strategy Switcher</h5>
                            <p>Switch between trading strategies...</p>
                            <p><a href="/strategy-switcher" class="btn btn-primary">Open Strategy Switcher</a></p>
                        </div>
                    </div>
                `;
            }
        }

        async function loadAICopilotSection() {
            const content = document.getElementById('aiCopilotTabContent');
            if (content) {
                content.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <h5>AI Trading Copilot</h5>
                            <p>Your AI assistant for trading decisions and market analysis.</p>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Use the floating AI button (bottom right) for quick access from any tab!
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        </script>
        
        <section id="ai-copilot" class="content-section">
            <div class="container-fluid">
                <h2>ü§ñ AI Copilot</h2>
                <div id="aiCopilotTabContent">
                    <p>Loading AI Copilot...</p>
                </div>
            </div>
        </section>
        
        <section id="analytics" class="content-section">
            <div class="container-fluid">
                <h2>üìä Analytics</h2>
                <p>Performance analytics and reports will be displayed here.</p>
            </div>
        </section>
        
        <section id="config" class="content-section">
            <div class="container-fluid">
                <h2>‚öôÔ∏è Configuration</h2>
                <div id="configContent">
                    <p>Loading configuration...</p>
                </div>
            </div>
        </section>

        <!-- Trade Manager Section -->
        <section id="trade-manager" class="content-section">
            <div class="container-fluid">
                <h2><i class="bi bi-sliders me-2"></i>Trade Manager</h2>
                <div id="tradeManagerContent">
                    <p>Loading trade manager...</p>
                </div>
            </div>
        </section>

        <!-- System Status Section -->
        <section id="system-status" class="content-section">
            <div class="container-fluid">
                <h2><i class="bi bi-heart-pulse me-2"></i>System Status</h2>
                <div id="systemStatusContent">
                    <p>Loading system status...</p>
                </div>
            </div>
        </section>

        <!-- AI Insights Section -->
        <section id="insights" class="content-section">
            <div class="container-fluid">
                <h2><i class="bi bi-lightbulb me-2"></i>AI Insights</h2>
                <div id="insightsContent">
                    <p>Loading AI insights...</p>
                </div>
            </div>
        </section>

        <!-- Strategy Switcher Section -->
        <section id="strategy-switcher" class="content-section">
            <div class="container-fluid">
                <h2><i class="bi bi-shuffle me-2"></i>Strategy Switcher</h2>
                <div id="strategySwitcherContent">
                    <p>Loading strategy switcher...</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Floating AI Copilot Button -->
    <button id="floatingCopilotBtn" style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;">
        <i class="bi bi-robot"></i>
    </button>

    <!-- Floating AI Copilot Panel -->
    <div id="floatingCopilotPanel" style="position: fixed; bottom: 90px; right: 20px; width: 400px; height: 600px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); z-index: 999; display: none; overflow: hidden;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; color: white; display: flex; justify-content: space-between; align-items: center;">
            <h5 style="margin: 0;"><i class="bi bi-robot me-2"></i>AI Copilot</h5>
            <button id="closeCopilotBtn" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; margin-left: auto;">&times;</button>
        </div>
        <div id="floatingCopilotContent" style="height: calc(100% - 60px); overflow-y: auto; padding: 15px;">
            <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                <i class="bi bi-robot" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                <p>AI Copilot is ready to assist you with trading decisions, market analysis, and strategy optimization.</p>
                <p style="font-size: 12px; margin-top: 10px;">Click on the AI Copilot tab for full interface.</p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        // Navigation System (Like Crypto Dashboard)
        document.addEventListener('DOMContentLoaded', function() {
            // Handle sidebar navigation
            const navLinks = document.querySelectorAll('.sidebar .nav-link[data-section]');
            const contentSections = document.querySelectorAll('.content-section');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all nav links
                    navLinks.forEach(nav => nav.classList.remove('active'));
                    
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    // Hide all content sections
                    contentSections.forEach(section => section.classList.remove('active'));
                    
                    // Show selected section
                    const targetSection = this.getAttribute('data-section');
                    const section = document.getElementById(targetSection);
                    if (section) {
                        section.classList.add('active');
                        
                        // Load section data when navigated to (lazy loading)
                        const loaders = {
                            'accounts': loadAccountsSection,
                            'strategies': loadStrategiesSection,
                            'positions': loadPositionsSection,
                            'signals': loadSignalsSection,
                            'news': loadNewsSection,
                            'trade-manager': loadTradeManagerSection,
                            'system-status': loadSystemStatusSection,
                            'config': loadConfigSection,
                            'insights': loadInsightsSection,
                            'strategy-switcher': loadStrategySwitcherSection,
                            'ai-copilot': loadAICopilotSection
                        };
                        
                        if (loaders[targetSection]) {
                            loaders[targetSection]();
                        }
                    }
                });
            });
            
            // Handle refresh data button
            const refreshBtn = document.getElementById('refreshData');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Trigger data refresh
                    if (typeof loadDashboardData === 'function') {
                        loadDashboardData();
                    }
                    // Show toast notification
                    if (typeof showInfoToast === 'function') {
                        showInfoToast('üîÑ Refreshing dashboard data...');
                    }
                });
            }

            // Handle hash-based navigation on page load
            const hash = window.location.hash.substring(1); // Remove #
            if (hash) {
                const link = document.querySelector(`[data-section="${hash}"]`);
                if (link) {
                    link.click();
                }
            }
        });

        // Chart Management
        let priceChart = null;
        let currentInstrument = 'EUR_USD';
        let currentTimeframe = '1h';

        async function loadChartData(instrument, timeframe) {
            try {
                const response = await fetch(`/api/chart/candles/${instrument}?timeframe=${timeframe}&count=100`);
                const data = await response.json();
                
                if (data.success && data.candles) {
                    updateChart(data.candles);
                }
            } catch (error) {
                console.error('Chart data error:', error);
            }
        }

        function updateChart(candles) {
            const ctx = document.getElementById('priceChart');
            if (!ctx) return;
            
            const labels = candles.map(c => new Date(c.time).toLocaleString());
            const prices = candles.map(c => parseFloat(c.mid.c));
            
            if (priceChart) {
                priceChart.destroy();
            }
            
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: currentInstrument,
                        data: prices,
                        borderColor: 'rgb(58, 134, 255)',
                        backgroundColor: 'rgba(58, 134, 255, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { grid: { color: '#444' }, ticks: { color: '#ccc' } },
                        x: { grid: { color: '#444' }, ticks: { color: '#ccc', maxRotation: 45 } }
                    }
                }
            });
        }

        // Timeframe button handlers
        document.querySelectorAll('[data-timeframe]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-timeframe]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentTimeframe = this.getAttribute('data-timeframe');
                loadChartData(currentInstrument, currentTimeframe);
            });
        });

        // Initial load
        loadChartData(currentInstrument, currentTimeframe);

        // Sidebar Live Prices
        async function updateSidebarPrices() {
            try {
                const response = await fetch('/api/sidebar/live-prices');
                const data = await response.json();
                
                if (data.success) {
                    const html = Object.values(data.prices).map(price => `
                        <div class="mb-2 p-2" style="border-left: 3px solid var(--primary); background: var(--bg-hover);">
                            <div class="d-flex justify-content-between">
                                <small>${price.instrument}</small>
                                <small>${price.bid.toFixed(5)}</small>
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('marketOverview').innerHTML = html;
                }
            } catch (error) {
                console.error('Sidebar prices error:', error);
            }
        }

        // Update sidebar every 5 seconds
        setInterval(updateSidebarPrices, 5000);
        updateSidebarPrices();

        // Floating Copilot Toggle
        document.getElementById('floatingCopilotBtn').addEventListener('click', function() {
            const panel = document.getElementById('floatingCopilotPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        });

        document.getElementById('closeCopilotBtn').addEventListener('click', function() {
            document.getElementById('floatingCopilotPanel').style.display = 'none';
        });

        // Initialize Socket.IO connection with robust reconnection
        window.socketStats = { connects: 0, disconnects: 0, lastEvent: 'init' };
        window.socketReady = new Promise((resolve) => { window.__socketResolve = resolve; });

        function initSocket() {
            if (typeof io === 'undefined') {
                setTimeout(initSocket, 300);
                return;
            }
            window.socket = io({
                path: '/socket.io',
                transports: ['polling'],  // Use polling only for Google Cloud compatibility
                reconnection: true,
                reconnectionAttempts: Infinity,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 8000,
                timeout: 20000,
                withCredentials: false,
                forceNew: true
            });
        }
        initSocket();
        
        // Connection status
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionText = document.getElementById('connectionText');
        
        document.addEventListener('DOMContentLoaded', () => {
          console.log('üöÄ Dashboard DOM loaded, initializing...');
          initDashboard();
        });
        
        // Initialize dashboard data
        function initDashboard() {
            console.log('üöÄ Initializing dashboard...');
            
            // Initialize AI Assistant
            initAIAssistant();
            
            // Load initial data with proper error handling
            loadSystemStatus();
            loadMarketData();
            loadRiskMetrics();
            loadNewsData();
            loadAccountDetails();
            loadTradingSignals();
            loadInsights();
            loadTradeIdeas();
            
            // Refresh data at different intervals to prevent flickering
            // Market data: Every 5 seconds (prices change fast)
            setInterval(() => {
                console.log('üîÑ Refreshing market prices...');
                loadMarketData();
            }, 5000);
            
            // System status and account details: Every 10 seconds
            setInterval(() => {
                console.log('üîÑ Refreshing system status...');
                loadSystemStatus();
                loadRiskMetrics();
                loadAccountDetails();
                loadTradingSignals();
            }, 10000);
            
            // News data: Every 5 MINUTES (news doesn't change that fast!)
            setInterval(() => {
                console.log('üîÑ Refreshing news feed...');
                loadNewsData();
            }, 300000);  // 5 minutes
            
            // Insights and trade ideas: Every 30 seconds
            setInterval(() => {
                console.log('üîÑ Refreshing insights...');
                loadInsights();
                loadTradeIdeas();
            }, 30000);
        }
        
        // Load system status data
        async function loadSystemStatus() {
            try {
                console.log('üìä Loading system status...');
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.system_status === 'online') {
                    console.log('‚úÖ System status: online');
                    
                    // Update trading systems
                    if (data.trading_systems) {
                        updateTradingSystems(data.trading_systems);
                    }
                    
                    // Update market data
                    if (data.market_data) {
                        updateMarketData(data.market_data);
                    }
                    
                    // Update news data
                    if (data.news_data) {
                        updateNewsData(data.news_data);
                    }
                    
                    // Update trading metrics - INDIVIDUAL accounts only
                    if (data.trading_metrics) {
                        const tradingMetrics = document.getElementById('tradingMetrics');
                        if (tradingMetrics && data.trading_metrics.accounts) {
                            let html = '<div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">Individual Strategy Performance (Paper Trading)</div>';
                            Object.values(data.trading_metrics.accounts).forEach(account => {
                                if (account.error) return;
                                const winRateColor = account.win_rate >= 50 ? '#10b981' : '#ef4444';
                                const profitColor = account.total_profit >= 0 ? '#10b981' : '#ef4444';
                                html += `
                                    <div class="account-item" style="padding: 12px; margin-bottom: 12px; border: 1px solid #374151; border-radius: 6px;">
                                        <div style="font-weight: 600; color: #f3f4f6; margin-bottom: 8px;">${account.strategy_name}</div>
                                        <div class="metric-item" style="margin-bottom: 4px; font-size: 0.85rem;">
                                            <span>Win Rate:</span>
                                            <span style="color: ${winRateColor}">${account.win_rate.toFixed(1)}%</span>
                                        </div>
                                        <div class="metric-item" style="margin-bottom: 4px; font-size: 0.85rem;">
                                            <span>Trades:</span>
                                            <span>${account.total_trades} (${account.winning_trades}W / ${account.losing_trades}L)</span>
                                        </div>
                                        <div class="metric-item" style="margin-bottom: 4px; font-size: 0.85rem;">
                                            <span>Profit Factor:</span>
                                            <span>${account.profit_factor.toFixed(2)}</span>
                                        </div>
                                        <div class="metric-item" style="margin-bottom: 4px; font-size: 0.85rem;">
                                            <span>Total P&L:</span>
                                            <span style="color: ${profitColor}">$${account.total_profit.toFixed(2)}</span>
                                        </div>
                                    </div>
                                `;
                            });
                            tradingMetrics.innerHTML = html;
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå System status error:', error);
            }
        }
        
        // Load market data
        async function loadMarketData() {
            try {
                console.log('üí± Loading market data...');
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.market_data) {
                    updateMarketData(data.market_data);
                }
            } catch (error) {
                console.error('‚ùå Market data error:', error);
            }
        }
        
        // Load news data
        async function loadNewsData() {
            try {
                console.log('üì∞ Loading news data...');
                const response = await fetch('/api/news');
                const data = await response.json();
                
                if (data.status === 'success' && data.news_data) {
                    updateNewsData(data.news_data);
                }
            } catch (error) {
                console.error('‚ùå News data error:', error);
            }
        }
        
        // Load risk metrics
        async function loadRiskMetrics() {
            try {
                console.log('üõ°Ô∏è Loading risk metrics...');
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Extract account_statuses which contain balance, unrealized_pl, margin info
                if (data.account_statuses) {
                    const riskMetrics = document.getElementById('riskMetrics');
                    if (!riskMetrics) return;
                    
                    let html = '<div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">Individual Strategy Risk (Paper Trading)</div>';
                    
                    // Build risk metrics from account statuses
                    for (const [accountId, accountStatus] of Object.entries(data.account_statuses)) {
                        const system = data.trading_systems[accountId];
                        if (!system) continue;
                        
                        const balance = accountStatus.balance || 0;
                        const margin_used = accountStatus.margin_used || 0;
                        const unrealized_pl = accountStatus.unrealized_pl || 0;
                        
                        const risk_percentage = balance > 0 ? (margin_used / balance * 100) : 0;
                        let riskLevel = 'risk-low';
                        if (risk_percentage > 50) {
                            riskLevel = 'risk-high';
                        } else if (risk_percentage > 25) {
                            riskLevel = 'risk-medium';
                        }
                        
                        html += `
                            <div class="account-item" style="padding: 12px; margin-bottom: 12px; border: 1px solid #374151; border-radius: 6px;">
                                <div style="font-weight: 600; color: #f3f4f6; margin-bottom: 8px;">${system.strategy_name}</div>
                                <div class="risk-metric" style="margin-bottom: 4px;">
                                    <span>Balance:</span>
                                    <span>$${balance.toLocaleString()}</span>
                                </div>
                                <div class="risk-metric" style="margin-bottom: 4px;">
                                    <span>Risk:</span>
                                    <span class="risk-level ${riskLevel}">${risk_percentage.toFixed(1)}%</span>
                                </div>
                                <div class="risk-metric" style="margin-bottom: 4px;">
                                    <span>P&L:</span>
                                    <span style="color: ${unrealized_pl >= 0 ? '#10b981' : '#ef4444'}">$${unrealized_pl.toFixed(2)}</span>
                                </div>
                            </div>
                        `;
                    }
                    
                    riskMetrics.innerHTML = html;
                }
            } catch (error) {
                console.error('‚ùå Risk metrics error:', error);
            }
        }
        
        // Load account details
        async function loadAccountDetails() {
            try {
                console.log('üè¶ Loading account details...');
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.account_statuses) {
                    updateAccountDetails(data.account_statuses);
                }
            } catch (error) {
                console.error('‚ùå Account details error:', error);
            }
        }
        
        // Update trading systems display
        function updateTradingSystems(systems) {
            console.log('üìä Updating trading systems...');
            const systemsContainer = document.getElementById('systemsStatus');
            if (!systemsContainer) return;
            
            systemsContainer.innerHTML = '';
            
            Object.entries(systems).forEach(([accountId, system]) => {
                const systemDiv = document.createElement('div');
                systemDiv.className = 'system-item';
                systemDiv.innerHTML = `
                    <div class="system-name">${system.strategy_name}</div>
                    <div class="system-status">
                        <span class="status-indicator status-active"></span>
                        <span>Active</span>
                    </div>
                    <div class="system-balance">$${system.balance.toLocaleString()}</div>
                `;
                systemsContainer.appendChild(systemDiv);
            });
        }
        
        // Update market data display
        function updateMarketData(marketData) {
            console.log('üí± Updating market data...');
            const marketContainer = document.getElementById('marketData');
            if (!marketContainer) return;
            
            marketContainer.innerHTML = '';
            
            // Get first account's market data
            const firstAccount = Object.values(marketData)[0];
            if (!firstAccount) return;
            
            Object.entries(firstAccount).forEach(([instrument, data]) => {
                const pairDiv = document.createElement('div');
                pairDiv.className = 'enhanced-market-pair';
                pairDiv.innerHTML = `
                    <div class="strategy-info">
                        <div class="strategy-name">Live Data</div>
                        <div class="pair-name">${instrument}</div>
                    </div>
                    <div class="pair-price">${data.bid.toFixed(5)}</div>
                `;
                marketContainer.appendChild(pairDiv);
            });
        }
        
        // Update news data display - STABLE, NO FLICKERING
        let currentNewsData = [];  // Cache current news
        let lastNewsUpdate = null;
        
        function updateNewsData(newsData) {
            console.log('üì∞ Processing news update...');
            const newsContainer = document.getElementById('newsAlerts');
            if (!newsContainer) return;
            
            let items = Array.isArray(newsData) ? newsData : (newsData.news_items || []);
            
            // FILTER: Show financial/market news (broader filter)
            const tradingKeywords = [
                'fed', 'interest rate', 'cpi', 'inflation', 'gdp', 'employment', 'unemployment',
                'gold', 'forex', 'dollar', 'euro', 'yen', 'pound', 'usd', 'eur', 'gbp', 'jpy',
                'central bank', 'monetary policy', 'treasury', 'bonds', 'currency', 'economy',
                'recession', 'growth', 'nonfarm', 'payroll', 'trade', 'tariff', 'ecb', 'boe',
                'market', 'stock', 'financial', 'banking', 'investor', 'earnings', 'revenue',
                'profit', 'loss', 'volatility', 'trading', 'bullish', 'bearish', 'rally',
                'sell-off', 'correction', 'bull market', 'bear market', 'analyst', 'forecast'
            ];
            
            // Filter OUT irrelevant topics
            const excludeKeywords = [
                'tripadvisor', 'nightlife', 'restaurant', 'hotel', 'travel', 'vacation',
                'sports', 'entertainment', 'celebrity', 'movie', 'music', 'gaming'
            ];
            
            const filteredItems = items.filter(item => {
                const text = ((item.title || '') + ' ' + (item.summary || '')).toLowerCase();
                
                // Exclude non-financial topics
                const isExcluded = excludeKeywords.some(keyword => text.includes(keyword));
                if (isExcluded) return false;
                
                // Include if has trading keywords OR is general financial news
                return tradingKeywords.some(keyword => text.includes(keyword)) ||
                       text.includes('financial') || 
                       text.includes('market') ||
                       text.includes('investor');
            });
            
            // STABILITY: Only update if news actually changed
            const newHash = JSON.stringify(filteredItems.map(i => i.title || i.summary).slice(0, 8));
            const currentHash = JSON.stringify(currentNewsData.map(i => i.title || i.summary).slice(0, 8));
            
            if (newHash === currentHash && window.__hasNewsRendered) {
                console.log('üì∞ News unchanged - no flicker');
                return;  // Don't re-render if content is the same
            }
            
            currentNewsData = filteredItems;
            lastNewsUpdate = new Date();
            
            if (filteredItems.length === 0) {
                // Check if it's a rate limit issue (no raw items either)
                const isRateLimited = items.length === 0;
                
                if (isRateLimited) {
                    // Show sample news with rate limit warning
                    newsContainer.innerHTML = `
                        <div style="background: rgba(245, 158, 11, 0.15); padding: 12px; border-radius: 8px; border-left: 3px solid #f59e0b; margin-bottom: 12px;">
                            <div style="color: #fbbf24; font-weight: 600; font-size: 0.9em;">
                                ‚ö†Ô∏è NEWS APIs RATE-LIMITED
                            </div>
                            <div style="color: #cbd5e1; font-size: 0.85em; margin-top: 6px;">
                                All 4 news sources temporarily unavailable due to API limits.
                                News will resume in 15-60 minutes.
                            </div>
                            <div style="color: #94a3b8; font-size: 0.75em; margin-top: 6px;">
                                Last update: ${new Date().toLocaleTimeString()} | Next retry: ${new Date(Date.now() + 15*60*1000).toLocaleTimeString()}
                            </div>
                        </div>
                        
                        <div style="color: #94a3b8; font-size: 0.9em; margin-bottom: 12px; font-weight: 600;">
                            üì∞ SAMPLE NEWS (Example of typical feed):
                        </div>
                        
                        <div class="news-item" style="background: rgba(30, 41, 59, 0.6); padding: 14px; margin-bottom: 10px; border-radius: 8px; border-left: 3px solid #ef4444; opacity: 0.7;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <div style="color: #cbd5e1; font-size: 0.9em; font-weight: 600;">2h ago</div>
                                <div style="background: rgba(59, 130, 246, 0.25); padding: 3px 10px; border-radius: 6px; font-size: 0.75em; color: #e2e8f0; font-weight: 600;">
                                    üî¥ HIGH IMPACT
                                </div>
                            </div>
                            <div style="color: #f1f5f9; font-weight: 500; line-height: 1.5;">
                                Federal Reserve Maintains Interest Rate Policy - Monitoring Inflation Data
                            </div>
                        </div>
                        
                        <div class="news-item" style="background: rgba(30, 41, 59, 0.6); padding: 14px; margin-bottom: 10px; border-radius: 8px; border-left: 3px solid #f59e0b; opacity: 0.7;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <div style="color: #cbd5e1; font-size: 0.9em; font-weight: 600;">4h ago</div>
                                <div style="background: rgba(59, 130, 246, 0.25); padding: 3px 10px; border-radius: 6px; font-size: 0.75em; color: #e2e8f0; font-weight: 600;">
                                    üü° MODERATE
                                </div>
                            </div>
                            <div style="color: #f1f5f9; font-weight: 500; line-height: 1.5;">
                                Gold Prices Rally on Safe-Haven Demand - XAU/USD Breaks 2650
                            </div>
                        </div>
                        
                        <div class="news-item" style="background: rgba(30, 41, 59, 0.6); padding: 14px; margin-bottom: 10px; border-radius: 8px; border-left: 3px solid #10b981; opacity: 0.7;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <div style="color: #cbd5e1; font-size: 0.9em; font-weight: 600;">6h ago</div>
                                <div style="background: rgba(59, 130, 246, 0.25); padding: 3px 10px; border-radius: 6px; font-size: 0.75em; color: #e2e8f0; font-weight: 600;">
                                    üü¢ RELEVANT
                                </div>
                            </div>
                            <div style="color: #f1f5f9; font-weight: 500; line-height: 1.5;">
                                EUR/USD Consolidates Near 1.1700 - Traders Await ECB Commentary
                            </div>
                        </div>
                        
                        <div style="background: rgba(100, 116, 139, 0.1); padding: 12px; border-radius: 8px; margin-top: 12px; text-align: center;">
                            <div style="color: #94a3b8; font-size: 0.85em;">
                                üí° Live news resumes when API limits reset
                            </div>
                        </div>
                    `;
                } else {
                    // Filtered out but raw items exist
                    newsContainer.innerHTML = `
                        <div class="news-item" style="background: rgba(30, 41, 59, 0.5); padding: 15px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div class="news-time" style="color: #94a3b8; font-weight: 600;">Status</div>
                                <div style="background: rgba(100, 116, 139, 0.3); padding: 3px 10px; border-radius: 6px; font-size: 0.75em; color: #cbd5e1;">
                                    üìä FILTERED
                                </div>
                            </div>
                            <div class="news-summary" style="color: #e2e8f0; font-weight: 500; margin-top: 6px;">
                                ‚ÑπÔ∏è  No high-impact trading news in last 2 hours
                            </div>
                            <div style="font-size: 0.85em; color: #94a3b8; margin-top: 8px;">
                                Monitoring: Fed, Economic data, Forex, Central banks
                            </div>
                            <div style="font-size: 0.75em; color: #64748b; margin-top: 8px;">
                                Last checked: ${new Date().toLocaleTimeString()}
                            </div>
                        </div>
                    `;
                }
                window.__hasNewsRendered = true;
                return;
            }
            
            // Time ago calculator
            function getTimeAgo(rawTs) {
                try {
                    const pubDate = new Date(rawTs);
                    if (isNaN(pubDate.getTime())) return 'Recent';
                    
                    const now = new Date();
                    const diffMs = now - pubDate;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);
                    
                    if (diffMins < 1) return 'Just now';
                    if (diffMins < 60) return `${diffMins}m ago`;
                    if (diffHours < 24) return `${diffHours}h ago`;
                    if (diffDays === 1) return 'Yesterday';
                    if (diffDays < 7) return `${diffDays}d ago`;
                    return pubDate.toLocaleDateString();
                } catch (e) {
                    return 'Recent';
                }
            }
            
            // Impact level determination
            function getRelevance(text) {
                const lowerText = text.toLowerCase();
                if (lowerText.includes('fed') || lowerText.includes('interest rate') || lowerText.includes('cpi') || lowerText.includes('inflation') || lowerText.includes('gdp')) {
                    return { emoji: 'üî¥', text: 'HIGH IMPACT', color: '#ef4444' };
                } else if (lowerText.includes('gold') || lowerText.includes('employment') || lowerText.includes('central bank')) {
                    return { emoji: 'üü°', text: 'MODERATE', color: '#f59e0b' };
                } else {
                    return { emoji: 'üü¢', text: 'RELEVANT', color: '#10b981' };
                }
            }
            
            console.log(`üì∞ Rendering ${filteredItems.length} RELEVANT news items (STABLE - no flicker)`);
            window.__hasNewsRendered = true;
            newsContainer.innerHTML = '';
            
            // Add data freshness indicator at top
            const freshnessDiv = document.createElement('div');
            freshnessDiv.style.cssText = 'background: rgba(16, 185, 129, 0.15); padding: 8px 12px; border-radius: 6px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;';
            freshnessDiv.innerHTML = `
                <div style="color: #10b981; font-size: 0.85em; font-weight: 600;">
                    ‚óè LIVE FEED (Refreshes every 5 minutes)
                </div>
                <div style="color: #94a3b8; font-size: 0.75em;">
                    Updated: ${new Date().toLocaleTimeString()}
                </div>
            `;
            newsContainer.appendChild(freshnessDiv);
            
            filteredItems.slice(0, 8).forEach(item => {
                const ts = item.timestamp || item.published_at || item.time || item.date;
                const title = item.title || item.summary || item.headline || 'Market update';
                const relevance = getRelevance(title);
                
                const newsDiv = document.createElement('div');
                newsDiv.className = 'news-item';
                newsDiv.style.cssText = `background: rgba(30, 41, 59, 0.6); padding: 14px; margin-bottom: 10px; border-radius: 8px; border-left: 3px solid ${relevance.color}; transition: all 0.3s ease;`;
                newsDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div class="news-time" style="color: #cbd5e1; font-size: 0.9em; font-weight: 600;">
                            ${getTimeAgo(ts)}
                        </div>
                        <div style="background: rgba(59, 130, 246, 0.25); padding: 3px 10px; border-radius: 6px; font-size: 0.75em; color: #e2e8f0; font-weight: 600;">
                            ${relevance.emoji} ${relevance.text}
                        </div>
                    </div>
                    <div class="news-summary" style="color: #f1f5f9; font-weight: 500; line-height: 1.5; font-size: 0.95em;">
                        ${title}
                    </div>
                `;
                newsContainer.appendChild(newsDiv);
            });
        }
        
        // Load insights
        async function loadInsights() {
            try {
                const res = await fetch('/api/insights');
                const data = await res.json();
                const el = document.getElementById('insightsContent');
                if (!el) return;
                if (data.status === 'ok' && data.insights) {
                    const s = data.insights;
                    el.innerHTML = `
                        <div><b>Market impact:</b> ${s.market_impact || 'neutral'}</div>
                        <div><b>Sentiment:</b> ${(s.overall_sentiment ?? 0).toFixed(2)}</div>
                        <div><b>Confidence:</b> ${(s.confidence ?? 0).toFixed(2)}</div>
                        <div><b>Opportunities:</b> ${(s.opportunities || []).length}</div>
                    `;
                }
            } catch (e) { /* noop */ }
        }

        // Update account details display
        function updateAccountDetails(accounts) {
            console.log('üè¶ Updating account details...');
            const accountContainer = document.getElementById('accountDetails');
            if (!accountContainer) return;
            
            accountContainer.innerHTML = '';
            
            Object.entries(accounts).forEach(([accountId, account]) => {
                const accountDiv = document.createElement('div');
                accountDiv.className = 'account-item';
                accountDiv.innerHTML = `
                    <div class="account-header">
                        <div class="account-name">${account.account_name}</div>
                        <div class="account-status status-active">Active</div>
                    </div>
                    <div class="account-balance">$${account.balance.toLocaleString()}</div>
                    <div class="account-strategy">${account.strategy}</div>
                `;
                accountContainer.appendChild(accountDiv);
            });
        }
        
        // Initialize AI Assistant
        function initAIAssistant() {
            console.log('ü§ñ Initializing AI Assistant...');
            
            // Create AI assistant panel if it doesn't exist
            if (!document.querySelector('.ai-assistant-panel')) {
                const panel = document.createElement('div');
                panel.className = 'ai-assistant-panel';
                panel.innerHTML = `
                    <div class="ai-assistant-header">
                        <div class="ai-assistant-title">ü§ñ AI Assistant</div>
                        <div class="ai-mode-badge">Live</div>
                    </div>
                    <div class="chat-messages"></div>
                    <div class="chat-input">
                        <textarea placeholder="Ask or use /commands (actions need Confirm)" class="ai-chat-input"></textarea>
                        <button class="send-button">Send</button>
                    </div>
                `;
                document.body.appendChild(panel);
                
                // Add event listeners
                const input = panel.querySelector('.ai-chat-input');
                const sendButton = panel.querySelector('.send-button');
                const messages = panel.querySelector('.chat-messages');
                
                function sendMessage() {
                    const message = input.value.trim();
                    if (!message) return;
                    
                    // Add user message
                    const userMsg = document.createElement('div');
                    userMsg.className = 'message user-message';
                    userMsg.textContent = message;
                    messages.appendChild(userMsg);
                    
                    // Clear input
                    input.value = '';
                    
                    // Show typing indicator
                    const typingMsg = document.createElement('div');
                    typingMsg.className = 'message ai-message typing';
                    typingMsg.textContent = 'ü§ñ AI is thinking...';
                    messages.appendChild(typingMsg);
                    messages.scrollTop = messages.scrollHeight;
                    
                    // Call real AI assistant API
                    fetch('/ai/interpret', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ text: message })
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Remove typing indicator
                        messages.removeChild(typingMsg);
                        
                        // Add AI response
                        const aiMsg = document.createElement('div');
                        aiMsg.className = 'message ai-message';
                        aiMsg.innerHTML = data.reply.replace(/\n/g, '<br>');
                        messages.appendChild(aiMsg);
                        
                        // Handle confirmation flow
                        if (data.requires_confirmation && data.confirmation_id) {
                            const confirmDiv = document.createElement('div');
                            confirmDiv.className = 'confirmation-panel';
                            confirmDiv.innerHTML = `
                                <div class="confirmation-preview">
                                    <strong>Preview:</strong> ${data.preview.summary}
                                </div>
                                <div class="confirmation-buttons">
                                    <button class="confirm-btn" data-id="${data.confirmation_id}">Confirm</button>
                                    <button class="cancel-btn" data-id="${data.confirmation_id}">Cancel</button>
                                </div>
                            `;
                            messages.appendChild(confirmDiv);
                            
                            // Add event listeners
                            const confirmBtn = confirmDiv.querySelector('.confirm-btn');
                            const cancelBtn = confirmDiv.querySelector('.cancel-btn');
                            
                            confirmBtn.addEventListener('click', async () => {
                                try {
                                    const response = await fetch('/ai/confirm', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ 
                                            confirmation_id: data.confirmation_id, 
                                            confirm: true 
                                        })
                                    });
                                    const result = await response.json();
                                    
                                    const resultMsg = document.createElement('div');
                                    resultMsg.className = 'message ai-message result';
                                    resultMsg.textContent = `Result: ${result.message || result.status}`;
                                    messages.appendChild(resultMsg);
                                    
                                } catch (error) {
                                    const errorMsg = document.createElement('div');
                                    errorMsg.className = 'message ai-message error';
                                    errorMsg.textContent = `Error: ${error.message}`;
                                    messages.appendChild(errorMsg);
                                }
                                
                                // Remove confirmation panel
                                messages.removeChild(confirmDiv);
                                messages.scrollTop = messages.scrollHeight;
                            });
                            
                            cancelBtn.addEventListener('click', async () => {
                                try {
                                    await fetch('/ai/confirm', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ 
                                            confirmation_id: data.confirmation_id, 
                                            confirm: false 
                                        })
                                    });
                                    
                                    const cancelMsg = document.createElement('div');
                                    cancelMsg.className = 'message ai-message';
                                    cancelMsg.textContent = 'Action cancelled';
                                    messages.appendChild(cancelMsg);
                                    
                                } catch (error) {
                                    console.error('Cancel error:', error);
                                }
                                
                                // Remove confirmation panel
                                messages.removeChild(confirmDiv);
                                messages.scrollTop = messages.scrollHeight;
                            });
                        }
                        
                        // Scroll to bottom
                        messages.scrollTop = messages.scrollHeight;
                    })
                    .catch(error => {
                        // Remove typing indicator
                        messages.removeChild(typingMsg);
                        
                        // Add error message
                        const errorMsg = document.createElement('div');
                        errorMsg.className = 'message ai-message error';
                        errorMsg.textContent = 'Sorry, I encountered an error. Please try again.';
                        messages.appendChild(errorMsg);
                        
                        // Scroll to bottom
                        messages.scrollTop = messages.scrollHeight;
                    });
                }
                
                sendButton.addEventListener('click', sendMessage);
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
        }
        
        // Generate AI response
        function generateAIResponse(message) {
            const responses = [
                "üìä Market Analysis: Current market conditions show moderate volatility. EUR/USD is trending upward with strong support at 1.0850. Consider monitoring key resistance levels at 1.0950.",
                "üì∞ News Impact: Recent economic data shows mixed signals. The Federal Reserve's stance on interest rates continues to influence market sentiment.",
                "‚ö†Ô∏è Risk Management: Current portfolio risk is within acceptable limits. Ensure proper position sizing and maintain stop-loss orders.",
                "üéØ Trading Strategy: The system is currently monitoring multiple timeframes for entry signals. Gold scalping strategy shows promising setups on 5-minute charts.",
                "üîß System Status: All trading systems are operational. Data feeds are live and stable. Risk management protocols are active.",
                "üí° Trade Ideas: Based on current market analysis, consider monitoring EUR/USD for potential breakout opportunities above 1.1750.",
                "üìà Performance: System is performing within expected parameters. All risk metrics are green and systems are optimized for current market conditions."
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        // Load trading signals
        async function loadTradingSignals() {
            try {
                console.log('üéØ Loading trading signals...');
                const response = await fetch('/tasks/full_scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.ok) {
                        updateTradingSignals(data);
                    }
                }
            } catch (error) {
                console.error('‚ùå Trading signals error:', error);
            }
        }
        
        // Update trading signals display
        function updateTradingSignals(signals) {
            console.log('üéØ Updating trading signals...');
            const signalsContainer = document.getElementById('activeTradesData');
            if (!signalsContainer) return;
            
            signalsContainer.innerHTML = `
                <div class="trading-signals">
                    <div class="signal-item">
                        <div class="signal-pair">EUR/USD</div>
                        <div class="signal-action">BUY</div>
                        <div class="signal-confidence">85%</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-pair">XAU/USD</div>
                        <div class="signal-action">SELL</div>
                        <div class="signal-confidence">78%</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-pair">GBP/USD</div>
                        <div class="signal-action">HOLD</div>
                        <div class="signal-confidence">92%</div>
                    </div>
                </div>
            `;
        }

        // Handle slash commands
        async function handleSlashCommand(cmd, messages) {
            const lower = cmd.toLowerCase();
            let url = null;
            if (lower.startsWith('/status')) url = '/api/status';
            else if (lower.startsWith('/accounts')) url = '/api/accounts';
            else if (lower.startsWith('/risk')) url = '/api/risk';
            else if (lower.startsWith('/metrics')) url = '/api/metrics';
            else if (lower.startsWith('/positions')) url = '/api/positions';
            else if (lower.startsWith('/signals')) url = '/api/signals/recent';
            else if (lower.startsWith('/news')) url = '/api/news';
            else if (lower.startsWith('/insights')) url = '/api/insights';
            else if (lower.startsWith('/ideas')) url = '/api/trade_ideas';
            else if (lower.startsWith('/action strategy')) url = '/actions/strategy';
            else if (lower.startsWith('/action risk')) url = '/actions/risk';
            else if (lower.startsWith('/action orders')) url = '/actions/orders';

            const aiMsg = document.createElement('div');
            aiMsg.className = 'message ai-message';

            if (!url) {
                aiMsg.textContent = 'Unknown command. Try: /status /accounts /risk /metrics /positions /signals /news /insights /ideas';
                messages.appendChild(aiMsg);
                return;
            }
            try {
                const isAction = url.startsWith('/actions/');
                const res = await fetch(url, {
                    method: isAction ? 'POST' : 'GET',
                    headers: isAction ? { 'Content-Type': 'application/json' } : undefined,
                    body: isAction ? buildActionBody(lower) : undefined
                });
                const data = await res.json();
                // If action pending with action_id, render confirm/cancel buttons
                if (url.startsWith('/actions/') && data && data.confirm_required && data.action_id) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'message ai-message';
                    const pre = document.createElement('pre');
                    pre.textContent = JSON.stringify(data.preview, null, 2);
                    const row = document.createElement('div');
                    row.style.display = 'flex';
                    row.style.gap = '8px';
                    row.style.marginTop = '8px';
                    const confirmBtn = document.createElement('button');
                    confirmBtn.textContent = 'Confirm';
                    confirmBtn.className = 'confirm-button';
                    confirmBtn.onclick = async () => {
                        confirmBtn.disabled = true;
                        const r = await fetch('/actions/confirm', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action_id: data.action_id }) });
                        const rd = await r.json();
                        const done = document.createElement('pre');
                        done.textContent = JSON.stringify(rd, null, 2);
                        wrapper.appendChild(done);
                    };
                    const cancelBtn = document.createElement('button');
                    cancelBtn.textContent = 'Cancel';
                    cancelBtn.className = 'cancel-button';
                    cancelBtn.onclick = () => { wrapper.remove(); };
                    row.appendChild(confirmBtn);
                    row.appendChild(cancelBtn);
                    wrapper.appendChild(pre);
                    wrapper.appendChild(row);
                    messages.appendChild(wrapper);
                } else {
                    aiMsg.textContent = JSON.stringify(data, null, 2);
                    messages.appendChild(aiMsg);
                }
            } catch (e) {
                aiMsg.textContent = 'Error: ' + e;
                messages.appendChild(aiMsg);
            }
        }

        function buildActionBody(cmd) {
            // Simple parser for demo: examples
            // /action strategy pause all
            // /action risk account=101-... max_risk_per_trade=0.02
            // /action orders close_positions instrument=EUR_USD
            const parts = cmd.split(/\s+/);
            if (cmd.startsWith('/action strategy')) {
                return JSON.stringify({ action: parts[2] || 'pause', target: parts[3] || 'all' });
            }
            if (cmd.startsWith('/action risk')) {
                const payload = { account_id: '', changes: {} };
                parts.slice(3).forEach(p => {
                    const [k,v] = p.split('=');
                    if (k === 'account' || k === 'account_id') payload.account_id = v;
                    else if (k) payload.changes[k] = v;
                });
                return JSON.stringify(payload);
            }
            if (cmd.startsWith('/action orders')) {
                const payload = { op: parts[2] || 'close_positions', filter: {} };
                parts.slice(3).forEach(p => {
                    const [k,v] = p.split('=');
                    if (k) payload.filter[k] = v;
                });
                return JSON.stringify(payload);
            }
            return JSON.stringify({});
        }

        // Load insights
        async function loadInsights() {
            try {
                const res = await fetch('/api/insights');
                const data = await res.json();
                if (data.status === 'success' && data.insights) {
                    renderInsights(data.insights);
                }
            } catch (e) {
                console.error('‚ùå Insights error:', e);
            }
        }

        // Render insights
        function renderInsights(insights) {
            const el = document.getElementById('insightsContent');
            if (!el) return;
            try {
                const focus = (insights.focus || []).map(x => `<span class="tag">${x}</span>`).join(' ');
                const regimes = Object.entries(insights.regimes || {}).map(([k,v]) => `<div class="kv"><span>${k}</span><span class="pill">${v}</span></div>`).join('');
                el.innerHTML = `
                    <div class="insights">
                        <div class="summary">${insights.summary || 'Live market insights unavailable right now.'}</div>
                        <div class="focus"><span class="label">Focus:</span> ${focus || '<span class="muted">n/a</span>'}</div>
                        <div class="grid2">${regimes || '<div class="muted">No regime data</div>'}</div>
                        <div class="risk">Risk Level: <span class="pill">${insights.risk_level || 'low'}</span></div>
                    </div>
                `;
            } catch (e) {
                el.innerHTML = '<div class="muted" style="padding: 12px;">Insights temporarily unavailable.</div>';
            }
        }

        // Load trade ideas
        async function loadTradeIdeas() {
            try {
                const res = await fetch('/api/trade_ideas');
                const data = await res.json();
                if (data.status === 'success' && Array.isArray(data.ideas)) {
                    renderTradeIdeas(data.ideas);
                }
            } catch (e) {
                console.error('‚ùå Trade ideas error:', e);
            }
        }

        // Render trade ideas
        function renderTradeIdeas(ideas) {
            const el = document.getElementById('tradeIdeasContent');
            if (!el) return;
            if (!ideas.length) {
                el.innerHTML = '<div class="muted" style="padding: 12px;">No current ideas</div>';
                return;
            }
            el.innerHTML = ideas.slice(0, 6).map(idea => `
                <div class="signal-item">
                    <div class="signal-pair">${idea.instrument}</div>
                    <div class="signal-action">${idea.action}</div>
                    <div class="signal-confidence">${idea.confidence}%</div>
                </div>
                <div class="muted" style="margin-top:-8px; margin-bottom:8px;">${idea.reason}</div>
            `).join('');
        }
        function safeSocket(cb){ if (window.socket) cb(window.socket); }

        // Enhanced countdown timer with importance indicators
        let countdownInterval = null;
        let nextMajorEvent = null;
        
        async function fetchEconomicCalendar() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Look for real upcoming events
                const upcoming = data.upcoming_news || [];
                nextMajorEvent = null;
                
                // Find next event with timestamp
                for (const event of upcoming) {
                    if (event.timestamp) {
                        nextMajorEvent = event;
                        break;
                    }
                }
                
                // If no timestamped events, create synthetic next economic release
                if (!nextMajorEvent) {
                    const nextRelease = new Date();
                    nextRelease.setDate(1);
                    nextRelease.setMonth(nextRelease.getMonth() + 1);
                    nextRelease.setHours(8, 30, 0);
                    
                    nextMajorEvent = {
                        timestamp: nextRelease.toISOString(),
                        event: 'Next Major Economic Data Release (CPI/Fed)',
                        impact: 'high',
                        currency: 'USD'
                    };
                }
                
                updateCountdownDisplay();
            } catch (error) {
                console.error('‚ùå Calendar fetch failed:', error);
                updateCountdownDisplay();
            }
        }
        
        function updateCountdownDisplay() {
            const newsTimer = document.getElementById('newsTimer');
            const upcomingNews = document.getElementById('upcomingNews');
            
            if (!newsTimer) return;
            
            if (nextMajorEvent && nextMajorEvent.timestamp) {
                const eventTime = new Date(nextMajorEvent.timestamp);
                const now = new Date();
                const timeUntil = eventTime - now;
                
                if (timeUntil > 0) {
                    const days = Math.floor(timeUntil / 86400000);
                    const hours = Math.floor((timeUntil % 86400000) / 3600000);
                    const minutes = Math.floor((timeUntil % 3600000) / 60000);
                    const seconds = Math.floor((timeUntil % 60000) / 1000);
                    
                    let countdownText = '';
                    let urgencyClass = '';
                    
                    if (days > 0) {
                        countdownText = `${days}d ${hours}h ${minutes}m`;
                        urgencyClass = 'countdown-normal';
                    } else if (hours > 2) {
                        countdownText = `${hours}h ${minutes}m ${seconds}s`;
                        urgencyClass = 'countdown-normal';
                    } else if (hours > 0) {
                        countdownText = `${hours}h ${minutes}m ${seconds}s`;
                        urgencyClass = 'countdown-warning';
                    } else if (minutes > 10) {
                        countdownText = `${minutes}m ${seconds}s`;
                        urgencyClass = 'countdown-warning';
                    } else {
                        countdownText = `${minutes}m ${seconds}s`;
                        urgencyClass = 'countdown-critical';
                    }
                    
                    newsTimer.innerHTML = `<span class="${urgencyClass}">${countdownText}</span>`;
                    
                    if (upcomingNews) {
                        const impact = nextMajorEvent.impact || 'medium';
                        const impactEmoji = impact === 'high' ? 'üî¥' : impact === 'medium' ? 'üü°' : 'üü¢';
                        const impactText = impact === 'high' ? 'HIGH IMPACT' : impact === 'medium' ? 'MODERATE' : 'LOW IMPACT';
                        
                        upcomingNews.innerHTML = `
                            <div class="impact-item" style="background: rgba(239, 68, 68, ${impact === 'high' ? 0.2 : 0.1}); border-left: 3px solid ${impact === 'high' ? '#ef4444' : '#f59e0b'};">
                                <div class="impact-time">${eventTime.toLocaleString()}</div>
                                <div class="impact-${impact}" style="font-weight: 600;">
                                    ${impactEmoji} ${impactText}: ${nextMajorEvent.event}
                                </div>
                                <div style="font-size: 0.85em; color: #94a3b8; margin-top: 4px;">
                                    Currency: ${nextMajorEvent.currency || 'USD'} | Countdown: ${countdownText}
                                </div>
                            </div>
                        `;
                    }
                    
                    if (!countdownInterval) {
                        countdownInterval = setInterval(updateCountdownDisplay, 1000);
                    }
                } else {
                    newsTimer.innerHTML = '<span class="countdown-critical">‚ö° EVENT NOW!</span>';
                    if (upcomingNews) {
                        upcomingNews.innerHTML = `
                            <div class="impact-item" style="background: rgba(239, 68, 68, 0.3); border-left: 3px solid #ef4444;">
                                <div class="impact-high" style="font-weight: 600;">üö® LIVE: ${nextMajorEvent.event}</div>
                                <div style="font-size: 0.85em; color: #fbbf24; margin-top: 4px;">
                                    ‚ö†Ô∏è High volatility expected
                                </div>
                            </div>
                        `;
                    }
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    setTimeout(fetchEconomicCalendar, 60000);
                }
            } else {
                newsTimer.innerHTML = '<span style="color: #94a3b8;">üìä No scheduled events</span>';
                if (upcomingNews) {
                    upcomingNews.innerHTML = `
                        <div class="impact-item" style="background: rgba(100, 116, 139, 0.1);">
                            <div class="impact-time">Status</div>
                            <div class="impact-info">‚ÑπÔ∏è  No major releases in next 24 hours</div>
                            <div style="font-size: 0.85em; color: #94a3b8; margin-top: 4px;">
                                Monitoring Fed, CPI, and GDP data
                            </div>
                        </div>
                    `;
                }
                setTimeout(fetchEconomicCalendar, 300000);
            }
        }
        
        function updateCountdownTimer(data) {
            // Legacy function for WebSocket compatibility
            if (data.next_news && data.next_news.timestamp) {
                nextMajorEvent = data.next_news;
                updateCountdownDisplay();
            }
        }
        
        // Start countdown
        fetchEconomicCalendar();

        safeSocket((socket) => socket.on('connect', function() {
            connectionText.textContent = 'Connected';
            connectionStatus.className = 'connection-status connection-connected';
            window.socketStats.connects += 1;
            window.socketStats.lastEvent = 'connect';
            if (window.__socketResolve) window.__socketResolve();
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            console.log('üîå Socket connected, requesting initial update...');
            socket.emit('request_update');
        }));
        
        safeSocket((socket) => socket.on('disconnect', function() {
            connectionText.textContent = 'Disconnected';
            connectionStatus.className = 'connection-status connection-disconnected';
            window.socketStats.disconnects += 1;
            window.socketStats.lastEvent = 'disconnect';
        }));
        
        // Debug: Log all socket events
        socket.onAny(function(eventName, ...args) {
            console.log('üîå Socket event received:', eventName, args);
        });

        // Helper functions for enhanced display
        function extractCurrencyPair(accountId) {
            // Extract currency pair from account ID like "101-004-30719775-001_EUR_USD"
            if (accountId.includes('_')) {
                const parts = accountId.split('_');
                const currencyPart = parts[parts.length - 1];
                return currencyPart.replace('_', '/');
            }
            return accountId; // fallback
        }

        function getStrategyName(accountId) {
            if (accountId.includes('101-004-30719775-001')) return 'Ultra Strict Forex';
            if (accountId.includes('101-004-30719775-002')) return 'Gold Scalping';  
            if (accountId.includes('101-004-30719775-003')) return 'Momentum Trading';
            return 'Trading Strategy';
        }

        // Update systems status
        socket.on('systems_update', function(data) {
            const systemsStatus = document.getElementById('systemsStatus');
            systemsStatus.innerHTML = '';
            
            for (const [key, system] of Object.entries(data)) {
                const systemItem = document.createElement('div');
                systemItem.className = 'system-item';
                
                let statusClass = 'status-unknown';
                let statusText = 'Unknown';
                
                if (system.status === 'running') {
                    statusClass = 'status-running';
                    statusText = 'Running';
                } else if (system.status === 'offline') {
                    statusClass = 'status-offline';
                    statusText = 'Offline';
                } else if (system.status === 'warning') {
                    statusClass = 'status-warning';
                    statusText = 'Warning';
                }
                
                systemItem.innerHTML = `
                    <div class="system-name">${system.strategy_name || system.name || 'Trading System'}</div>
                    <div class="system-status">
                        <span class="status-indicator ${statusClass}"></span>
                        <span>${statusText}</span>
                    </div>
                `;
                
                systemsStatus.appendChild(systemItem);
            }
        });
        
        // Enhanced market data display - FIXED to show clean currency pairs
        socket.on('market_update', function(data) {
            const marketData = document.getElementById('marketData');
            marketData.innerHTML = '';
            
            for (const [pair, market] of Object.entries(data)) {
                const marketPair = document.createElement('div');
                marketPair.className = 'enhanced-market-pair';
                
                // Extract clean currency pair from account ID string
                const cleanPair = extractCurrencyPair(pair);
                const strategyName = getStrategyName(pair);
                
                const liveIndicator = market.is_live ? '<span class="live-indicator"></span>' : '';
                const price = `${market.bid.toFixed(5)} / ${market.ask.toFixed(5)}`;
                
                marketPair.innerHTML = `
                    <div class="strategy-info">
                        <div class="strategy-name">${strategyName}</div>
                        <div class="pair-name">${liveIndicator}${cleanPair}</div>
                    </div>
                    <div class="pair-price">${price}</div>
                `;
                
                marketData.appendChild(marketPair);
            }
        });
        
        // Update risk metrics - INDIVIDUAL accounts only (no aggregation)
        socket.on('risk_update', function(data) {
            const riskMetrics = document.getElementById('riskMetrics');
            
            if (!data || !data.accounts) {
                riskMetrics.innerHTML = '<div class="risk-metric"><span>Loading individual account risk...</span></div>';
                return;
            }
            
            let html = '<div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">Individual Strategy Risk (Paper Trading)</div>';
            
            Object.values(data.accounts).forEach(account => {
                if (account.error) {
                    return; // Skip accounts with errors
                }
                
                let riskLevel = 'risk-low';
                if (account.risk_percentage > 50) {
                    riskLevel = 'risk-high';
                } else if (account.risk_percentage > 25) {
                    riskLevel = 'risk-medium';
                }
                
                html += `
                    <div class="account-item" style="padding: 12px; margin-bottom: 12px; border: 1px solid #374151; border-radius: 6px;">
                        <div style="font-weight: 600; color: #f3f4f6; margin-bottom: 8px;">${account.name}</div>
                        <div class="risk-metric" style="margin-bottom: 4px;">
                            <span>Balance:</span>
                            <span>$${account.balance.toLocaleString()}</span>
                        </div>
                        <div class="risk-metric" style="margin-bottom: 4px;">
                            <span>Risk:</span>
                            <span class="risk-level ${riskLevel}">${account.risk_percentage.toFixed(1)}%</span>
                        </div>
                        <div class="risk-metric" style="margin-bottom: 4px;">
                            <span>P&L:</span>
                            <span style="color: ${account.unrealized_pl >= 0 ? '#10b981' : '#ef4444'}">$${account.unrealized_pl.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            });
            
            riskMetrics.innerHTML = html;
        });
        
        // Update news and alerts
        socket.on('news_update', function(data) {
            const newsAlerts = document.getElementById('newsAlerts');
            newsAlerts.innerHTML = '';
            
            data.forEach(news => {
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item';
                
                const time = new Date(news.timestamp).toLocaleTimeString();
                
                newsItem.innerHTML = `
                    <div class="news-time">${time}</div>
                    <div class="news-summary">${news.summary}</div>
                `;
                
                newsAlerts.appendChild(newsItem);
            });
        });
        
        // Request initial data
        socket.emit('request_update');
        
        // Update trading metrics - INDIVIDUAL accounts only (no aggregation)
        socket.on('metrics_update', function(data) {
            const tradingMetrics = document.getElementById('tradingMetrics');
            
            if (!data || !data.accounts) {
                tradingMetrics.innerHTML = '<div class="metric-item"><span>Loading individual strategy metrics...</span></div>';
                return;
            }
            
            let html = '<div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">Individual Strategy Performance (Paper Trading)</div>';
            
            Object.values(data.accounts).forEach(account => {
                if (account.error) {
                    return; // Skip accounts with errors
                }
                
                const winRateColor = account.win_rate >= 50 ? '#10b981' : '#ef4444';
                const profitColor = account.total_profit >= 0 ? '#10b981' : '#ef4444';
                
                html += `
                    <div class="account-item" style="padding: 12px; margin-bottom: 12px; border: 1px solid #374151; border-radius: 6px;">
                        <div style="font-weight: 600; color: #f3f4f6; margin-bottom: 8px;">${account.strategy_name}</div>
                        <div class="metric-item" style="margin-bottom: 4px; font-size: 0.85rem;">
                            <span>Win Rate:</span>
                            <span style="color: ${winRateColor}">${account.win_rate.toFixed(1)}%</span>
                        </div>
                        <div class="metric-item" style="margin-bottom: 4px; font-size: 0.85rem;">
                            <span>Trades:</span>
                            <span>${account.total_trades} (${account.winning_trades}W / ${account.losing_trades}L)</span>
                        </div>
                        <div class="metric-item" style="margin-bottom: 4px; font-size: 0.85rem;">
                            <span>Profit Factor:</span>
                            <span>${account.profit_factor.toFixed(2)}</span>
                        </div>
                        <div class="metric-item" style="margin-bottom: 4px; font-size: 0.85rem;">
                            <span>Total P&L:</span>
                            <span style="color: ${profitColor}">$${account.total_profit.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            });
            
            tradingMetrics.innerHTML = html;
        });

        // Update news impact
        socket.on('news_impact_update', function(data) {
            console.log('üìä Received news_impact_update:', data);
            const newsTimer = document.getElementById('newsTimer');
            const tradePhase = document.getElementById('tradePhase');
            const upcomingNews = document.getElementById('upcomingNews');
            
            // Update countdown with enhanced functionality
            updateCountdownTimer(data);
            
            // Update AI trade phase
            if (data.trade_phase) {
                tradePhase.textContent = data.trade_phase;
                console.log('‚úÖ Updated trade phase:', data.trade_phase);
            }
            
            // Update upcoming news list
            upcomingNews.innerHTML = '';
            if (data.upcoming_news && data.upcoming_news.length > 0) {
                data.upcoming_news.forEach(news => {
                    const newsItem = document.createElement('div');
                    newsItem.className = 'impact-item';
                    
                    const time = news.time || 'Now';
                    const impact = news.impact || 'medium';
                    const impactClass = `impact-${impact.toLowerCase()}`;
                    
                    newsItem.innerHTML = `
                        <div class="impact-time">${time}</div>
                        <div class="${impactClass}">${news.event || news.title || 'Market Update'}</div>
                    `;
                    
                    upcomingNews.appendChild(newsItem);
                });
                console.log('‚úÖ Updated upcoming news:', data.upcoming_news.length, 'items');
            } else {
                // Show default message if no news
                upcomingNews.innerHTML = '<div class="impact-item"><div class="impact-time">Now</div><div class="impact-info">No scheduled high-impact events</div></div>';
            }
        });

        // Listen for live trades updates
        socket.on('trades_update', (data) => {
            console.log('üìä Received live trades update:', data);
            updateActiveTrades(data);
        });

        // Listen for individual account updates
        socket.on('account_update', (data) => {
            console.log('üìä Received account update:', data);
            updateAccountDetails(data);
        });

        // Function to display live trading data
        function updateActiveTrades(tradesData) {
            const container = document.getElementById('activeTradesData');
            
            if (!tradesData || tradesData.length === 0) {
                container.innerHTML = `
                    <div class="no-trades-message" style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 24px; margin-bottom: 10px;">üìä</div>
                        <div>No active trades</div>
                        <div style="font-size: 12px; margin-top: 10px;">Live OANDA data - No positions open</div>
                    </div>
                `;
                return;
            }
            
            // Display real trading data
            container.innerHTML = '';
            tradesData.forEach(trade => {
                const tradeItem = document.createElement('div');
                tradeItem.className = 'trade-item';
                
                const statusClass = trade.unrealized_pl >= 0 ? 'profit' : 'drawdown';
                const statusText = trade.unrealized_pl >= 0 ? 'In Profit' : 'In Drawdown';
                
                tradeItem.innerHTML = `
                    <div class="trade-header">
                        <div class="strategy-badge ${trade.strategy.toLowerCase().replace(' ', '-')}">${trade.strategy}</div>
                        <div class="trade-time">Opened: ${new Date(trade.open_time).toLocaleTimeString()}</div>
                    </div>
                    <div class="trade-details">
                        <div class="trade-pair">${trade.instrument} ${trade.side.toUpperCase()}</div>
                        <div class="trade-levels">
                            Entry: ${trade.entry_price} | SL: ${trade.stop_loss} | TP: ${trade.take_profit}
                        </div>
                        <div class="trade-status ${statusClass}">
                            ${trade.unrealized_pl >= 0 ? '+' : ''}${trade.unrealized_pl.toFixed(2)} | ${statusText} | Duration: ${trade.duration}
                        </div>
                    </div>
                `;
                
                container.appendChild(tradeItem);
            });
        }

        // Function to display individual account details
        function updateAccountDetails(accountsData) {
            const container = document.getElementById('accountDetails');
            
            if (!accountsData || Object.keys(accountsData).length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 24px; margin-bottom: 10px;">üìä</div>
                        <div>No account data available</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            Object.entries(accountsData).forEach(([accountId, accountData]) => {
                const accountItem = document.createElement('div');
                accountItem.className = 'account-item';
                
                // Get account name from ID
                let accountName = 'Unknown Account';
                if (accountId.includes('101-004-30719775-001')) {
                    accountName = 'Primary Account (Ultra Strict Forex)';
                } else if (accountId.includes('101-004-30719775-002')) {
                    accountName = 'Gold Scalping Account';
                } else if (accountId.includes('101-004-30719775-003')) {
                    accountName = 'Strategy Alpha Account (Momentum)';
                }
                
                const balance = accountData.balance || 0;
                const unrealizedPL = accountData.unrealized_pl || 0;
                const realizedPL = accountData.realized_pl || 0;
                const openTrades = (accountData.open_trade_count ?? accountData.open_trades ?? accountData.openTrades ?? 0);
                const openPositions = (accountData.open_position_count ?? accountData.open_positions ?? accountData.openPositions ?? 0);
                const positions = accountData.positions || [];
                
                accountItem.innerHTML = `
                    <div class="account-header">
                        <div class="account-name">${accountName}</div>
                        <div class="account-balance">$${balance.toFixed(2)}</div>
                    </div>
                    
                    <div class="account-metrics">
                        <div class="account-metric">
                            <span>Unrealized P&L:</span>
                            <span style="color: ${unrealizedPL >= 0 ? '#10b981' : '#ef4444'}">${unrealizedPL >= 0 ? '+' : ''}$${unrealizedPL.toFixed(2)}</span>
                        </div>
                        <div class="account-metric">
                            <span>Realized P&L:</span>
                            <span style="color: ${realizedPL >= 0 ? '#10b981' : '#ef4444'}">${realizedPL >= 0 ? '+' : ''}$${realizedPL.toFixed(2)}</span>
                        </div>
                        <div class="account-metric">
                            <span>Open Trades:</span>
                            <span>${openTrades}</span>
                        </div>
                        <div class="account-metric">
                            <span>Open Positions:</span>
                            <span>${openPositions}</span>
                        </div>
                    </div>
                    
                    ${positions.length > 0 ? `
                        <div class="positions-list">
                            <h4 style="color: #f3f4f6; margin-bottom: 10px;">Open Positions:</h4>
                            ${positions.map(position => `
                                <div class="position-item">
                                    <div class="position-header">
                                        <div class="position-pair">${position.instrument}</div>
                                        <div class="position-side ${position.side.toLowerCase()}">${position.side.toUpperCase()}</div>
                                    </div>
                                    <div class="position-details">
                                        <div><span>Units:</span> <span>${position.units}</span></div>
                                        <div><span>Entry:</span> <span>${position.entry_price}</span></div>
                                        <div><span>P&L:</span> <span style="color: ${position.unrealized_pl >= 0 ? '#10b981' : '#ef4444'}">${position.unrealized_pl >= 0 ? '+' : ''}$${position.unrealized_pl.toFixed(2)}</span></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 20px; color: #9ca3af;">
                            <div style="font-size: 16px; margin-bottom: 5px;">üìä</div>
                            <div>No open positions</div>
                        </div>
                    `}
                `;
                
                container.appendChild(accountItem);
            });
        }

        // Request updates every 30 seconds and update timestamp
        setInterval(() => {
            safeSocket((socket) => {
                console.log('üîÑ Requesting periodic update...');
                socket.emit('request_update');
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            });
        }, 30000);
        
        // INITIAL DATA LOAD: Fetch AI insights on page load (don't wait for WebSocket)
        async function loadInitialAIInsights() {
            try {
                console.log('üîÑ Loading initial AI insights...');
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Update Trade Phase
                const tradePhase = document.getElementById('tradePhase');
                if (tradePhase && data.trade_phase) {
                    tradePhase.textContent = data.trade_phase;
                    console.log('‚úÖ Initial trade phase loaded:', data.trade_phase);
                }
                
                // Update Upcoming News
                const upcomingNews = document.getElementById('upcomingNews');
                if (upcomingNews && data.upcoming_news && data.upcoming_news.length > 0) {
                    upcomingNews.innerHTML = '';
                    data.upcoming_news.forEach(news => {
                        const newsItem = document.createElement('div');
                        newsItem.className = 'impact-item';
                        const time = news.time || 'Now';
                        const impact = news.impact || 'medium';
                        newsItem.innerHTML = `
                            <div class="impact-time">${time}</div>
                            <div class="impact-${impact.toLowerCase()}">${news.event || news.title || 'Market Update'}</div>
                        `;
                        upcomingNews.appendChild(newsItem);
                    });
                    console.log('‚úÖ Initial upcoming news loaded:', data.upcoming_news.length, 'items');
                } else if (upcomingNews) {
                    upcomingNews.innerHTML = '<div class="impact-item"><div class="impact-time">Now</div><div class="impact-info">AI monitoring all instruments</div></div>';
                }
            } catch (error) {
                console.error('‚ùå Failed to load initial AI insights:', error);
            }
        }
        
        // Load AI insights after 2 seconds (give time for page to fully load)
        setTimeout(loadInitialAIInsights, 2000);
        
        // Update Contextual Insights
        async function updateContextualInsights() {
            try {
                // Get primary instrument from market data or default to XAU_USD
                const instrument = 'XAU_USD';
                
                const response = await fetch(`/api/contextual/${instrument}`);
                if (!response.ok) {
                    console.log('‚ö†Ô∏è Contextual insights not available yet');
                    return;
                }
                
                const data = await response.json();
                console.log('‚úÖ Contextual insights loaded:', data);
                
                // Update session context from main status if available
                const statusResponse = await fetch('/api/status');
                if (statusResponse.ok) {
                    const statusData = await statusResponse.json();
                    if (statusData.session_context) {
                        document.getElementById('session-quality-value').textContent = 
                            `${statusData.session_context.quality}/100`;
                        document.getElementById('active-sessions-value').textContent = 
                            statusData.session_context.active_sessions.join(', ') || 'None';
                        document.getElementById('session-description').textContent = 
                            statusData.session_context.description || 'No session data';
                    }
                }
                
                // Update price context
                if (data.price_context) {
                    const support = data.price_context.support_levels || [];
                    const resistance = data.price_context.resistance_levels || [];
                    
                    document.getElementById('support-levels').textContent = 
                        support.length > 0 ? support.map(l => l.toFixed(2)).join(', ') : 'None';
                    document.getElementById('resistance-levels').textContent = 
                        resistance.length > 0 ? resistance.map(l => l.toFixed(2)).join(', ') : 'None';
                    document.getElementById('trend-direction').textContent = 
                        data.price_context.trend || 'Unknown';
                }
            } catch (error) {
                console.error('‚ùå Failed to update contextual insights:', error);
            }
        }
        
        // Update contextual insights every 30 seconds
        setInterval(updateContextualInsights, 30000);
        // Initial load after 3 seconds
        setTimeout(updateContextualInsights, 3000);
        
        // ========================================
        // HYBRID MANUAL TRADING - OPPORTUNITIES
        // ========================================
        
        async function loadTradeOpportunities() {
            try {
                const response = await fetch('/api/opportunities');
                const data = await response.json();
                
                if (data.opportunities && data.opportunities.length > 0) {
                    displayOpportunities(data.opportunities);
                    updateABComparison(data.stats);
                } else {
                    document.getElementById('opportunitiesFeed').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 15px;">‚úÖ</div>
                            <div style="font-size: 18px; margin-bottom: 10px;">No opportunities right now</div>
                            <div style="font-size: 14px; color: #999;">AI is monitoring. Quality setups will appear here.</div>
                        </div>
                    `;
                }
                
                // Update counts
                document.getElementById('opportunityCount').textContent = data.opportunities?.length || 0;
                document.getElementById('autoCount').textContent = data.auto_queue?.length || 0;
                
            } catch (error) {
                console.error('Failed to load opportunities:', error);
            }
        }
        
        function displayOpportunities(opportunities) {
            const feed = document.getElementById('opportunitiesFeed');
            feed.innerHTML = '';
            
            opportunities.forEach(opp => {
                const card = createOpportunityCard(opp);
                feed.appendChild(card);
            });
        }
        
        function createOpportunityCard(opp) {
            const card = document.createElement('div');
            card.className = 'opportunity-card';
            card.id = `opp_${opp.id}`;
            
            const qualityClass = opp.quality_score >= 80 ? 'quality-excellent' :
                                opp.quality_score >= 60 ? 'quality-good' :
                                opp.quality_score >= 40 ? 'quality-moderate' : 'quality-weak';
            
            const recClass = opp.recommendation === 'STRONG BUY' ? 'rec-strong-buy' :
                            opp.recommendation === 'BUY' ? 'rec-buy' :
                            opp.recommendation === 'CONSIDER' ? 'rec-consider' : 'rec-avoid';
            
            const stars = '‚≠ê'.repeat(Math.ceil(opp.quality_score / 20));
            
            card.innerHTML = `
                <div class="opportunity-header">
                    <div class="opportunity-title">
                        ${opp.direction === 'BUY' ? 'üü¢' : 'üî¥'} ${opp.instrument} ${opp.direction}
                    </div>
                    <div class="quality-badge ${qualityClass}">
                        ${stars} ${opp.quality_score}/100
                    </div>
                </div>
                
                ${opp.at_sniper_zone ? `
                    <div class="sniper-zone-indicator">
                        üéØ AT SNIPER ZONE: ${opp.zone_type.toUpperCase()} (${opp.zone_level})
                    </div>
                ` : ''}
                
                <div class="opportunity-details">
                    <div class="detail-item">
                        <div class="detail-label">Entry Price</div>
                        <div class="detail-value">${opp.suggested_entry.toFixed(5)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Stop Loss</div>
                        <div class="detail-value">${opp.fixed_stop_loss.toFixed(5)} (${opp.stop_loss_pips.toFixed(1)} pips)</div>
                    </div>
                    <div class="detail-item" style="border-left-color: #06d6a0;">
                        <div class="detail-label">Risk Amount</div>
                        <div class="detail-value" style="color: #ef476f;">-$${opp.expected_loss.toFixed(0)}</div>
                    </div>
                    <div class="detail-item" style="border-left-color: #06d6a0;">
                        <div class="detail-label">Expected Profit</div>
                        <div class="detail-value" style="color: #06d6a0;">+$${opp.expected_profit.toFixed(0)}</div>
                    </div>
                </div>
                
                <div class="tp-stages">
                    <h5 style="color: #8338ec; margin-bottom: 12px;">üéØ Multi-Stage Take Profit Targets:</h5>
                    ${opp.take_profit_stages.map((stage, idx) => `
                        <div class="tp-stage-item">
                            <span style="color: #999;">TP${idx + 1}: +${stage.pips?.toFixed(1) || 0} pips (${stage.price?.toFixed(5) || 0})</span>
                            <span style="color: #8338ec; font-weight: bold;">Close ${(stage.close_pct * 100).toFixed(0)}%</span>
                        </div>
                    `).join('')}
                    <div class="tp-stage-item">
                        <span style="color: #999;">Remaining 20%:</span>
                        <span style="color: #ffd166; font-weight: bold;">Trail with tight stop</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div style="background: rgba(58, 134, 255, 0.1); padding: 12px; border-radius: 6px; border: 1px solid #3a86ff;">
                        <div style="color: #999; font-size: 0.85rem;">Risk/Reward Ratio</div>
                        <div style="color: #3a86ff; font-size: 1.5rem; font-weight: bold;">1:${opp.risk_reward_ratio.toFixed(1)}</div>
                    </div>
                    <div style="background: rgba(6, 214, 160, 0.1); padding: 12px; border-radius: 6px; border: 1px solid #06d6a0;">
                        <div style="color: #999; font-size: 0.85rem;">Expected Win Rate</div>
                        <div style="color: #06d6a0; font-size: 1.5rem; font-weight: bold;">${(opp.expected_win_rate * 100).toFixed(0)}%</div>
                    </div>
                </div>
                
                <div class="pros-cons-section">
                    <div class="pros-box">
                        <h5>‚úÖ PROS (${opp.pros.length})</h5>
                        <ul style="list-style: none; padding: 0;">
                            ${opp.pros.map(pro => `<li>${pro}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="cons-box">
                        <h5>‚ö†Ô∏è CONS (${opp.cons.length})</h5>
                        <ul style="list-style: none; padding: 0;">
                            ${opp.cons.map(con => `<li>${con}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                
                <div class="recommendation-bar ${recClass}">
                    ü§ñ AI RECOMMENDATION: ${opp.recommendation}
                </div>
                
                <div style="margin-bottom: 15px; padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #999;">Strategy:</span>
                        <span style="color: white; font-weight: bold;">${opp.strategy_name}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #999;">Trades Today:</span>
                        <span style="color: white;">${opp.trades_today} / ${opp.max_trades_remaining + opp.trades_today}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #999;">Daily Target Progress:</span>
                        <span style="color: ${opp.daily_target_progress >= 100 ? '#06d6a0' : '#ffd166'}; font-weight: bold;">${opp.daily_target_progress.toFixed(0)}%</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn-approve" onclick="approveOpportunity('${opp.id}')">
                        ‚úÖ APPROVE & EXECUTE NOW
                    </button>
                    <button class="btn-dismiss" onclick="dismissOpportunity('${opp.id}')">
                        ‚ùå DISMISS
                    </button>
                    <button class="btn-watch" onclick="watchOpportunity('${opp.id}')">
                        ‚è∏Ô∏è WATCH
                    </button>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: rgba(255, 209, 102, 0.1); border-radius: 6px; border-left: 3px solid #ffd166;">
                    <div style="font-size: 0.85rem; color: #ffd166;">
                        ‚ö° Auto Lane: ${opp.quality_score >= 70 ? 'Would execute automatically' : 'Would skip (quality < 70)'}
                    </div>
                </div>
            `;
            
            return card;
        }
        
        async function approveOpportunity(oppId) {
            try {
                const response = await fetch('/api/opportunities/approve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ opportunity_id: oppId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success toast
                    showToast('‚úÖ Trade Approved!', `Executing ${result.instrument} ${result.direction}...`, 'success');
                    
                    // Remove card and reload
                    document.getElementById(`opp_${oppId}`)?.remove();
                    setTimeout(loadTradeOpportunities, 2000);
                } else {
                    showToast('‚ùå Approval Failed', result.message, 'error');
                }
            } catch (error) {
                console.error('Failed to approve:', error);
                showToast('‚ùå Error', 'Failed to approve trade', 'error');
            }
        }
        
        async function dismissOpportunity(oppId) {
            const reason = prompt('Why dismiss this opportunity? (helps AI learn your style):');
            if (!reason) return;
            
            try {
                const response = await fetch('/api/opportunities/dismiss', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ opportunity_id: oppId, reason: reason })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('üìù Dismissed', `AI learning: ${result.learning_update}`, 'info');
                    document.getElementById(`opp_${oppId}`)?.remove();
                    setTimeout(loadTradeOpportunities, 1000);
                }
            } catch (error) {
                console.error('Failed to dismiss:', error);
            }
        }
        
        function watchOpportunity(oppId) {
            showToast('‚è∏Ô∏è Watching', 'Opportunity moved to watch list', 'info');
            // In production: move to separate watch list
        }
        
        function updateABComparison(stats) {
            if (!stats) return;
            
            // Update Manual Lane
            document.getElementById('manualOppsShown').textContent = stats.manual?.shown || 0;
            document.getElementById('manualApproved').textContent = stats.manual?.approved || 0;
            document.getElementById('manualWinRate').textContent = `${(stats.manual?.win_rate || 0).toFixed(1)}%`;
            document.getElementById('manualProfit').textContent = `$${(stats.manual?.profit || 0).toFixed(0)}`;
            document.getElementById('manualAvgQuality').textContent = `${(stats.manual?.avg_quality || 0).toFixed(0)}/100`;
            
            // Update Auto Lane
            document.getElementById('autoOppsTotal').textContent = stats.auto?.total || 0;
            document.getElementById('autoWouldExecute').textContent = stats.auto?.would_execute || 0;
            document.getElementById('autoWinRate').textContent = `${(stats.auto?.win_rate || 0).toFixed(1)}%`;
            document.getElementById('autoProfit').textContent = `$${(stats.auto?.profit || 0).toFixed(0)}`;
            document.getElementById('autoAvgQuality').textContent = `${(stats.auto?.avg_quality || 0).toFixed(0)}/100`;
            
            // Performance difference
            const diff = (stats.manual?.profit || 0) - (stats.auto?.profit || 0);
            const diffPct = stats.manual?.win_rate - stats.auto?.win_rate || 0;
            document.getElementById('performanceDiff').textContent = 
                diff > 0 ? `YOU'RE AHEAD by $${diff.toFixed(0)} (+${diffPct.toFixed(1)}% WR)` :
                diff < 0 ? `AUTO AHEAD by $${Math.abs(diff).toFixed(0)} (${Math.abs(diffPct).toFixed(1)}% WR)` :
                'TIED';
            document.getElementById('performanceDiff').style.color = diff >= 0 ? '#06d6a0' : '#ef476f';
        }
        
        function showToast(title, message, type) {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 20px;
                background: ${type === 'success' ? '#06d6a0' : type === 'error' ? '#ef476f' : '#3a86ff'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 9999;
                min-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            toast.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">${title}</div>
                <div style="font-size: 0.9rem;">${message}</div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
        
        // Load opportunities every 10 seconds
        setInterval(loadTradeOpportunities, 10000);
        setTimeout(loadTradeOpportunities, 2000);  // Initial load
        
    </script>

    <!-- AI Assistant Widget Loader (flag + health-checked) -->
    <script>
      (async function initAIAssistant() {
        try {
          const res = await fetch('/ai/health', { method: 'GET' });
          if (!res.ok) return; // Assistant disabled or not registered
          
          // Prevent duplicate panels if one already exists
          if (document.querySelector('.ai-assistant-panel')) return;

          // Build widget DOM
          const panel = document.createElement('div');
          panel.className = 'ai-assistant-panel';
          panel.innerHTML = `
            <div class="ai-assistant-header">
              <div class="ai-assistant-title">ü§ñ AI Assistant</div>
              <div class="ai-mode-badge">Live</div>
            </div>
            <div class="chat-messages"></div>
            <div class="chat-input">
              <textarea placeholder="Ask or use /commands (actions need Confirm)" class="ai-chat-input"></textarea>
              <button class="send-button">Send</button>
            </div>
          `;
          document.body.appendChild(panel);

          const messages = panel.querySelector('.chat-messages');
          const input = panel.querySelector('textarea');
          const sendBtn = panel.querySelector('.send-button');

          function appendMessage(text, cls = '') {
            const div = document.createElement('div');
            div.textContent = text;
            if (cls) div.className = cls;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
          }

          async function interpret(message) {
            try {
              const r = await fetch('/ai/interpret', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: message, session_id: 'dashboard' })
              });
              const ct = r.headers.get('content-type') || '';
              if (!r.ok) throw new Error(`HTTP ${r.status}`);
              if (!ct.includes('application/json')) {
                const text = await r.text();
                throw new Error(`Unexpected response: ${text.slice(0,120)}...`);
              }
              return await r.json();
            } catch (e) {
              throw e;
            }
          }

          async function confirmAction(confirmation_id, confirm) {
            const r = await fetch('/ai/confirm', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ confirmation_id, confirm, session_id: 'dashboard' })
            });
            const ct = r.headers.get('content-type') || '';
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            if (!ct.includes('application/json')) {
              const text = await r.text();
              throw new Error(`Unexpected response: ${text.slice(0,120)}...`);
            }
            return r.json();
          }

          let sending = false;
          async function handleSend() {
            if (sending) return;
            const text = (input.value || '').trim();
            if (!text) return;
            sending = true;
            sendBtn.disabled = true;
            try {
              appendMessage(`You: ${text}`);
              input.value = '';
              const resp = await interpret(text);
              if (resp.reply) appendMessage(`Assistant: ${resp.reply}`);
              if (resp.preview) {
                const pv = document.createElement('div');
                pv.className = 'command-preview';
                pv.innerHTML = `<div><strong>Preview:</strong> ${resp.preview.summary || 'N/A'}</div>`;
                const row = document.createElement('div');
                row.className = 'confirm-row';
                if (resp.live_guard) {
                  const lg = document.createElement('div');
                  lg.className = 'live-guard';
                  lg.textContent = 'LIVE action requires token: "LIVE CONFIRM YES" and explicit confirmation';
                  pv.appendChild(lg);
                }
                if (resp.requires_confirmation && resp.confirmation_id) {
                  const confirmBtn = document.createElement('button');
                  confirmBtn.className = 'confirm-button';
                  confirmBtn.textContent = 'Confirm';
                  const cancelBtn = document.createElement('button');
                  cancelBtn.className = 'cancel-button';
                  cancelBtn.textContent = 'Cancel';
                  row.appendChild(confirmBtn);
                  row.appendChild(cancelBtn);
                  pv.appendChild(row);

                  confirmBtn.addEventListener('click', async () => {
                    try {
                      const result = await confirmAction(resp.confirmation_id, true);
                      appendMessage(`Result: ${result.result?.note || result.status}`, 'command-result');
                    } catch (e) {
                      appendMessage(`Error: ${(e && e.message) || e}`, 'command-result');
                    }
                  });
                  cancelBtn.addEventListener('click', async () => {
                    try {
                      const result = await confirmAction(resp.confirmation_id, false);
                      appendMessage(`Result: ${result.status}`, 'command-result');
                    } catch (e) {
                      appendMessage(`Error: ${(e && e.message) || e}`, 'command-result');
                    }
                  });
                }
                messages.appendChild(pv);
                messages.scrollTop = messages.scrollHeight;
              }
            } catch (e) {
              console.error('AI assistant error:', e);
              appendMessage(`Assistant error: ${(e && e.message) || e}`);
            } finally {
              sending = false;
              sendBtn.disabled = false;
            }
          }

          sendBtn.addEventListener('click', handleSend);
          input.addEventListener('keydown', (ev) => {
            if (ev.key === 'Enter' && !ev.shiftKey) {
              ev.preventDefault();
              handleSend();
            }
          });

          // Optional: Socket namespace hookup for live chat events
          try {
            const aiSocket = io({ path: '/socket.io', forceNew: true, transports: ['websocket', 'polling'] });
            aiSocket.on('connect', () => {
              aiSocket.emit('chat_message', { message: 'Hello from dashboard', session_id: 'dashboard' });
            });
            aiSocket.on('assistant_reply', (data) => {
              if (data && data.reply) appendMessage(`Assistant: ${data.reply}`);
            });
          } catch (e) {
            console.warn('AI Socket not available:', e);
          }
        } catch (e) {
          // Assistant disabled or unreachable; do nothing
        }
        
        // Fallback: Ensure AI assistant panel is always available
        setTimeout(() => {
          if (!document.querySelector('.ai-assistant-panel')) {
            console.log('Creating fallback AI assistant panel...');
            const panel = document.createElement('div');
            panel.className = 'ai-assistant-panel';
            panel.innerHTML = `
              <div class="ai-assistant-header">
                <div class="ai-assistant-title">ü§ñ AI Assistant</div>
                <div class="ai-mode-badge">Live</div>
              </div>
              <div class="chat-messages"></div>
              <div class="chat-input">
                <textarea placeholder="Ask or use /commands (actions need Confirm)" class="ai-chat-input"></textarea>
                <button class="send-button">Send</button>
              </div>
            `;
            document.body.appendChild(panel);
          }
        }, 2000);
      })();
      
      // TradingView Widget Initialization
      var tradingViewWidget = null;
      var currentSymbol = 'EURUSD';
      var currentTimeframe = '1h';
      
      function initTradingView() {
        if (typeof TradingView !== 'undefined') {
          tradingViewWidget = new TradingView.widget({
            "autosize": true,
            "symbol": currentSymbol,
            "interval": currentTimeframe,
            "timezone": "Etc/UTC",
            "theme": "light",
            "style": "1",
            "locale": "en",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "hide_top_toolbar": false,
            "hide_legend": false,
            "save_image": false,
            "container_id": "tradingview_widget",
            "studies": [
              "RSI@tv-basicstudies",
              "MACD@tv-basicstudies",
              "Volume@tv-basicstudies"
            ],
            "show_popup_button": true,
            "popup_width": "1000",
            "popup_height": "650"
          });
          
          console.log('üìä TradingView widget initialized');
        } else {
          console.error('‚ùå TradingView library not loaded');
        }
      }
      
      // Update chart symbol
      function updateChartSymbol(symbol) {
        currentSymbol = symbol;
        console.log(`üìä Updating chart symbol to: ${symbol}`);
        
        if (tradingViewWidget) {
          try {
            // Reinitialize the widget with the new symbol
            currentSymbol = symbol;
            initTradingView();
            document.getElementById('chartInstrument').textContent = symbol;
            console.log(`‚úÖ Chart updated to: ${symbol}`);
          } catch (error) {
            console.error('‚ùå Error updating chart symbol:', error);
            // Fallback: just update the display
            document.getElementById('chartInstrument').textContent = symbol;
          }
        } else {
          // Widget not ready, just update display
          document.getElementById('chartInstrument').textContent = symbol;
          console.log(`üìä Chart symbol set to: ${symbol} (widget not ready)`);
        }
      }
      
      // Update chart timeframe
      function updateChartTimeframe(timeframe) {
        currentTimeframe = timeframe;
        console.log(`üìä Updating chart timeframe to: ${timeframe}`);
        
        if (tradingViewWidget) {
          try {
            // Reinitialize the widget with the new timeframe
            currentTimeframe = timeframe;
            initTradingView();
            console.log(`‚úÖ Chart timeframe updated to: ${timeframe}`);
          } catch (error) {
            console.error('‚ùå Error updating chart timeframe:', error);
          }
        } else {
          console.log(`üìä Chart timeframe set to: ${timeframe} (widget not ready)`);
        }
      }
      
      // Initialize TradingView when page loads
      document.addEventListener('DOMContentLoaded', function() {
        // Wait a bit for TradingView library to load
        setTimeout(() => {
          initTradingView();
        }, 1000);
        
        // Add event listener for symbol selector
        const symbolSelector = document.getElementById('symbolSelector');
        if (symbolSelector) {
          console.log('üìä Setting up symbol selector event listener');
          
          // Add new event listener
          symbolSelector.addEventListener('change', function() {
            const selectedSymbol = this.value;
            console.log(`üìä Symbol changed to: ${selectedSymbol}`);
            
            // Update chart instrument display immediately
            const chartInstrument = document.getElementById('chartInstrument');
            if (chartInstrument) {
              chartInstrument.textContent = selectedSymbol;
              console.log(`‚úÖ Chart instrument updated to: ${selectedSymbol}`);
            }
            
            // Update TradingView chart
            updateChartSymbol(selectedSymbol);
          });
          
          console.log('‚úÖ Symbol selector event listener attached');
        } else {
          console.log('‚ùå Symbol selector not found');
        }
        
        // Add event listeners for timeframe buttons
        const timeframeButtons = document.querySelectorAll('[data-timeframe]');
        timeframeButtons.forEach(button => {
          button.addEventListener('click', function() {
            const timeframe = this.getAttribute('data-timeframe');
            
            // Update active button
            timeframeButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Update chart
            updateChartTimeframe(timeframe);
          });
        });
      });
    </script>
    
    <!-- Toast Notification System -->
    {% include 'components/toast_notifications.html' %}
</body>
</html>