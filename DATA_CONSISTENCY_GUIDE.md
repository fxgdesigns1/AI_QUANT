# Data Consistency Guide - All Dashboards Synced

## ✅ YES - Everything Is Synced to One Source

### 📁 Single Source of Truth

**ALL data comes from:**
```
accounts.yaml
```

**ALL components use:**
```python
from src.core.yaml_manager import get_yaml_manager
yaml_mgr = get_yaml_manager()  # Singleton - same instance everywhere
```

## 🔄 Data Flow Architecture

```
┌─────────────────────────────────────────────┐
│          accounts.yaml                      │
│     (Single Source of Truth)                │
└──────────────┬──────────────────────────────┘
               ↓
         YAMLManager
         (Singleton)
               ↓
    ┌──────────┼──────────┬──────────┐
    ↓          ↓          ↓          ↓
Scanner    DataFeed    Dashboard  API Endpoints
    ↓          ↓          ↓          ↓
SignalTracker  Prices   Display   JSON Data
    ↓          ↓          ↓          ↓
    └──────────┴──────────┴──────────┘
               ↓
        All Dashboards
      (Consistent Data)
```

## 📊 What Each Dashboard Shows

### 1. Main Dashboard (`/` or `/dashboard`)
- **Source:** `accounts.yaml` + Live OANDA data
- **Shows:** 
  - All active accounts
  - Live P/L from OANDA
  - Open positions from OANDA
  - System status
- **Updates:** Real-time via WebSocket

### 2. Signals Dashboard (`/signals`) **← NEW**
- **Source:** `SignalTracker` (which gets signals from Scanner)
- **Scanner Source:** `accounts.yaml`
- **Shows:**
  - Pending signals (from active strategies)
  - Active trades (from active accounts)
  - AI insights (generated by strategies)
- **Updates:** Real-time (5 seconds + WebSocket)

### 3. Status Dashboard (`/status`)
- **Source:** `accounts.yaml` + Scanner stats
- **Shows:**
  - System health
  - Scanner status
  - Strategy performance
- **Updates:** Polling

### 4. Config Dashboard (`/config`)
- **Source:** `accounts.yaml` (read/write)
- **Shows:**
  - Account list
  - Strategy assignments
  - Settings
- **Updates:** Manual (you make changes)

## ⚠️ CRITICAL: Changes Require Restart

### What Happens When You Change Config

**Scenario:** You change Account 5 from "Momentum V2" to "Champion 75WR" in Config Dashboard

```
Step 1: Config Dashboard writes to accounts.yaml
        ✅ accounts.yaml now has Champion 75WR

Step 2: Scanner is still running
        ❌ Scanner has Momentum V2 loaded in memory
        ❌ Scanner generates signals using OLD strategy
        ❌ Signal Dashboard shows Momentum V2 signals

Step 3: Apply changes with graceful restart
        ✅ Scanner stops
        ✅ Scanner reloads from accounts.yaml
        ✅ Scanner now uses Champion 75WR
        ✅ Signal Dashboard shows Champion 75WR signals
```

### Why Scanner Doesn't Auto-Reload

**Performance & Stability:**
- Scanner loads strategies at initialization (expensive)
- Strategies build price history in memory
- Reloading mid-operation would lose history
- Open positions need proper handling
- Graceful restart ensures safety

## ✅ How to Apply Config Changes Properly

### Method 1: Via Config Dashboard (Recommended)

```
1. Go to: https://ai-quant-trading.uc.r.appspot.com/config

2. Make your changes:
   - Switch strategies
   - Toggle accounts on/off
   - Change instruments
   - Modify settings

3. Click "Preview Changes"
   - Shows what will change
   - Shows current open positions
   - Warns if positions are open

4. Click "Apply Changes"
   - Saves to accounts.yaml ✅
   - Checks for open positions
   - Waits for positions to close (30 sec timeout)
   - Restarts scanner with new config
   - All dashboards now sync ✅

5. Verify on Signals Dashboard
   - New strategy appears
   - New signals match new strategy
```

### Method 2: Via API

```bash
# Apply pending changes
curl -X POST https://ai-quant-trading.uc.r.appspot.com/api/strategies/apply

# Force restart (even with open positions)
curl -X POST https://ai-quant-trading.uc.r.appspot.com/api/strategies/apply \
  -H "Content-Type: application/json" \
  -d '{"force": true}'
```

### Method 3: Manual Restart

```bash
# SSH to server or locally
cd google-cloud-trading-system

# Stop scanner
# (it will auto-restart via APScheduler)

# Or redeploy
gcloud app deploy
```

## 🔍 Verify Sync Status

### Check if Config Matches Running System

```bash
# Run verification script
python3 verify_config_sync.py
```

**Output Example:**
```
🔍 Checking Configuration Sync...
============================================================

📄 accounts.yaml Configuration:
  • Total accounts: 9
  • Active accounts: 7
  • Momentum Trading V2: momentum_v2 (4 instruments)
  • Champion 75WR: champion_75wr (4 instruments)
  ...

🔄 Scanner Running Configuration:
  • Loaded strategies: 7
  • Loaded accounts: 7
  • momentum_v2: 4 instruments
  • champion_75wr: 4 instruments
  ...

✅ Configuration Comparison:
  ✅ Strategies MATCH
```

**If they DON'T match:**
```
✅ Configuration Comparison:
  ⚠️ Strategies DIFFER
     YAML has: {'momentum_v2', 'champion_75wr', 'ultra_strict_v2'}
     Scanner has: {'momentum_trading', 'champion_75wr', 'ultra_strict_v2'}
     → You need to restart scanner to sync!
```

## 📋 What Gets Synced Automatically

### ✅ Always Synced (No Restart Needed)

1. **Account Metadata**
   - Account names
   - Display names
   - Account IDs
   - Balance (from OANDA)

2. **Live Market Data**
   - Current prices
   - Spreads
   - Open positions
   - P/L

3. **Statistics**
   - Win rate
   - Trade counts
   - Performance metrics

4. **Global Settings** (some)
   - Max positions
   - Portfolio risk
   - Daily limits

### ❌ Requires Restart to Sync

1. **Strategy Assignments**
   - Which strategy each account uses
   - Scanner must reload

2. **Instrument Lists**
   - Which pairs each account trades
   - Data feed must reload

3. **Strategy Parameters**
   - Timeframes
   - Confidence thresholds
   - Risk settings

4. **Active/Inactive Status**
   - Which accounts are active
   - Scanner includes only active

## 🎯 Best Practices

### 1. Make Changes During Low Activity

```
✅ Good times:
   - Before London open (7am London)
   - After NY close (10pm London)
   - Weekends (markets closed)

❌ Avoid:
   - During prime time (1pm-5pm London)
   - During news events
   - When many positions open
```

### 2. Preview Before Applying

```
Always check:
- How many positions are open
- What the changes are
- If it makes sense
```

### 3. Verify After Restart

```
After applying changes:
1. Check Signals Dashboard - new strategy signals appear
2. Check Main Dashboard - accounts show correct strategy
3. Check logs - no errors
4. Monitor for 5-10 minutes
```

### 4. Use Graceful Restart (Not Force)

```
✅ Graceful restart:
   - Waits for positions to close
   - Safe transition
   - No losses

❌ Force restart:
   - Closes positions immediately
   - May cause losses
   - Only for emergencies
```

## 🚨 What To Do If Dashboards Don't Match

### Scenario: Signals Dashboard shows wrong strategy

**Problem:** Changed strategy in config, but signals dashboard still shows old strategy signals

**Solution:**
```bash
1. Check if restart was triggered:
   - Look at logs
   - Check /api/strategies/status

2. If restart didn't happen:
   - Go to /config
   - Click "Apply Changes" again
   
3. If restart failed:
   - Check for open positions
   - Wait for them to close
   - Try again

4. If still not working:
   - Check logs for errors
   - Redeploy: gcloud app deploy
```

### Scenario: Config Dashboard shows different accounts than Main Dashboard

**Problem:** This should NEVER happen (they read from same source)

**Solution:**
```bash
1. Clear browser cache
2. Hard refresh (Cmd/Ctrl + Shift + R)
3. Check accounts.yaml directly
4. If still different, there's a bug - report it
```

## 📊 Dashboard Consistency Checklist

Use this to verify all dashboards are synced:

```
□ Main Dashboard shows same accounts as accounts.yaml
□ Signals Dashboard shows signals from current strategies (not old)
□ Config Dashboard can edit accounts.yaml
□ Status Dashboard shows correct scanner status
□ All dashboards show same account names
□ All dashboards show same instrument lists
□ Signal strategies match account strategy assignments
□ No conflicting data between dashboards
```

## 🎉 Summary

**YES - All dashboards are synced:**
- ✅ Single source of truth (`accounts.yaml`)
- ✅ All components use same `YAMLManager`
- ✅ No separate databases or caches
- ✅ Consistent data everywhere

**BUT - Changes require graceful restart:**
- ⚠️ Scanner loads config at initialization
- ⚠️ Strategies run in memory
- ⚠️ Must restart to pick up changes
- ✅ Graceful restart system handles this safely

**To make changes:**
1. Edit in Config Dashboard
2. Preview changes
3. Apply changes (triggers restart)
4. Verify on all dashboards
5. System is now 100% synced ✅

**Your system will always reach the same conclusion because everything reads from the same source!**



