# Data Consistency Guide - All Dashboards Synced

## âœ… YES - Everything Is Synced to One Source

### ğŸ“ Single Source of Truth

**ALL data comes from:**
```
accounts.yaml
```

**ALL components use:**
```python
from src.core.yaml_manager import get_yaml_manager
yaml_mgr = get_yaml_manager()  # Singleton - same instance everywhere
```

## ğŸ”„ Data Flow Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          accounts.yaml                      â”‚
â”‚     (Single Source of Truth)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
         YAMLManager
         (Singleton)
               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“          â†“          â†“          â†“
Scanner    DataFeed    Dashboard  API Endpoints
    â†“          â†“          â†“          â†“
SignalTracker  Prices   Display   JSON Data
    â†“          â†“          â†“          â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
        All Dashboards
      (Consistent Data)
```

## ğŸ“Š What Each Dashboard Shows

### 1. Main Dashboard (`/` or `/dashboard`)
- **Source:** `accounts.yaml` + Live OANDA data
- **Shows:** 
  - All active accounts
  - Live P/L from OANDA
  - Open positions from OANDA
  - System status
- **Updates:** Real-time via WebSocket

### 2. Signals Dashboard (`/signals`) **â† NEW**
- **Source:** `SignalTracker` (which gets signals from Scanner)
- **Scanner Source:** `accounts.yaml`
- **Shows:**
  - Pending signals (from active strategies)
  - Active trades (from active accounts)
  - AI insights (generated by strategies)
- **Updates:** Real-time (5 seconds + WebSocket)

### 3. Status Dashboard (`/status`)
- **Source:** `accounts.yaml` + Scanner stats
- **Shows:**
  - System health
  - Scanner status
  - Strategy performance
- **Updates:** Polling

### 4. Config Dashboard (`/config`)
- **Source:** `accounts.yaml` (read/write)
- **Shows:**
  - Account list
  - Strategy assignments
  - Settings
- **Updates:** Manual (you make changes)

## âš ï¸ CRITICAL: Changes Require Restart

### What Happens When You Change Config

**Scenario:** You change Account 5 from "Momentum V2" to "Champion 75WR" in Config Dashboard

```
Step 1: Config Dashboard writes to accounts.yaml
        âœ… accounts.yaml now has Champion 75WR

Step 2: Scanner is still running
        âŒ Scanner has Momentum V2 loaded in memory
        âŒ Scanner generates signals using OLD strategy
        âŒ Signal Dashboard shows Momentum V2 signals

Step 3: Apply changes with graceful restart
        âœ… Scanner stops
        âœ… Scanner reloads from accounts.yaml
        âœ… Scanner now uses Champion 75WR
        âœ… Signal Dashboard shows Champion 75WR signals
```

### Why Scanner Doesn't Auto-Reload

**Performance & Stability:**
- Scanner loads strategies at initialization (expensive)
- Strategies build price history in memory
- Reloading mid-operation would lose history
- Open positions need proper handling
- Graceful restart ensures safety

## âœ… How to Apply Config Changes Properly

### Method 1: Via Config Dashboard (Recommended)

```
1. Go to: https://ai-quant-trading.uc.r.appspot.com/config

2. Make your changes:
   - Switch strategies
   - Toggle accounts on/off
   - Change instruments
   - Modify settings

3. Click "Preview Changes"
   - Shows what will change
   - Shows current open positions
   - Warns if positions are open

4. Click "Apply Changes"
   - Saves to accounts.yaml âœ…
   - Checks for open positions
   - Waits for positions to close (30 sec timeout)
   - Restarts scanner with new config
   - All dashboards now sync âœ…

5. Verify on Signals Dashboard
   - New strategy appears
   - New signals match new strategy
```

### Method 2: Via API

```bash
# Apply pending changes
curl -X POST https://ai-quant-trading.uc.r.appspot.com/api/strategies/apply

# Force restart (even with open positions)
curl -X POST https://ai-quant-trading.uc.r.appspot.com/api/strategies/apply \
  -H "Content-Type: application/json" \
  -d '{"force": true}'
```

### Method 3: Manual Restart

```bash
# SSH to server or locally
cd google-cloud-trading-system

# Stop scanner
# (it will auto-restart via APScheduler)

# Or redeploy
gcloud app deploy
```

## ğŸ” Verify Sync Status

### Check if Config Matches Running System

```bash
# Run verification script
python3 verify_config_sync.py
```

**Output Example:**
```
ğŸ” Checking Configuration Sync...
============================================================

ğŸ“„ accounts.yaml Configuration:
  â€¢ Total accounts: 9
  â€¢ Active accounts: 7
  â€¢ Momentum Trading V2: momentum_v2 (4 instruments)
  â€¢ Champion 75WR: champion_75wr (4 instruments)
  ...

ğŸ”„ Scanner Running Configuration:
  â€¢ Loaded strategies: 7
  â€¢ Loaded accounts: 7
  â€¢ momentum_v2: 4 instruments
  â€¢ champion_75wr: 4 instruments
  ...

âœ… Configuration Comparison:
  âœ… Strategies MATCH
```

**If they DON'T match:**
```
âœ… Configuration Comparison:
  âš ï¸ Strategies DIFFER
     YAML has: {'momentum_v2', 'champion_75wr', 'ultra_strict_v2'}
     Scanner has: {'momentum_trading', 'champion_75wr', 'ultra_strict_v2'}
     â†’ You need to restart scanner to sync!
```

## ğŸ“‹ What Gets Synced Automatically

### âœ… Always Synced (No Restart Needed)

1. **Account Metadata**
   - Account names
   - Display names
   - Account IDs
   - Balance (from OANDA)

2. **Live Market Data**
   - Current prices
   - Spreads
   - Open positions
   - P/L

3. **Statistics**
   - Win rate
   - Trade counts
   - Performance metrics

4. **Global Settings** (some)
   - Max positions
   - Portfolio risk
   - Daily limits

### âŒ Requires Restart to Sync

1. **Strategy Assignments**
   - Which strategy each account uses
   - Scanner must reload

2. **Instrument Lists**
   - Which pairs each account trades
   - Data feed must reload

3. **Strategy Parameters**
   - Timeframes
   - Confidence thresholds
   - Risk settings

4. **Active/Inactive Status**
   - Which accounts are active
   - Scanner includes only active

## ğŸ¯ Best Practices

### 1. Make Changes During Low Activity

```
âœ… Good times:
   - Before London open (7am London)
   - After NY close (10pm London)
   - Weekends (markets closed)

âŒ Avoid:
   - During prime time (1pm-5pm London)
   - During news events
   - When many positions open
```

### 2. Preview Before Applying

```
Always check:
- How many positions are open
- What the changes are
- If it makes sense
```

### 3. Verify After Restart

```
After applying changes:
1. Check Signals Dashboard - new strategy signals appear
2. Check Main Dashboard - accounts show correct strategy
3. Check logs - no errors
4. Monitor for 5-10 minutes
```

### 4. Use Graceful Restart (Not Force)

```
âœ… Graceful restart:
   - Waits for positions to close
   - Safe transition
   - No losses

âŒ Force restart:
   - Closes positions immediately
   - May cause losses
   - Only for emergencies
```

## ğŸš¨ What To Do If Dashboards Don't Match

### Scenario: Signals Dashboard shows wrong strategy

**Problem:** Changed strategy in config, but signals dashboard still shows old strategy signals

**Solution:**
```bash
1. Check if restart was triggered:
   - Look at logs
   - Check /api/strategies/status

2. If restart didn't happen:
   - Go to /config
   - Click "Apply Changes" again
   
3. If restart failed:
   - Check for open positions
   - Wait for them to close
   - Try again

4. If still not working:
   - Check logs for errors
   - Redeploy: gcloud app deploy
```

### Scenario: Config Dashboard shows different accounts than Main Dashboard

**Problem:** This should NEVER happen (they read from same source)

**Solution:**
```bash
1. Clear browser cache
2. Hard refresh (Cmd/Ctrl + Shift + R)
3. Check accounts.yaml directly
4. If still different, there's a bug - report it
```

## ğŸ“Š Dashboard Consistency Checklist

Use this to verify all dashboards are synced:

```
â–¡ Main Dashboard shows same accounts as accounts.yaml
â–¡ Signals Dashboard shows signals from current strategies (not old)
â–¡ Config Dashboard can edit accounts.yaml
â–¡ Status Dashboard shows correct scanner status
â–¡ All dashboards show same account names
â–¡ All dashboards show same instrument lists
â–¡ Signal strategies match account strategy assignments
â–¡ No conflicting data between dashboards
```

## ğŸ‰ Summary

**YES - All dashboards are synced:**
- âœ… Single source of truth (`accounts.yaml`)
- âœ… All components use same `YAMLManager`
- âœ… No separate databases or caches
- âœ… Consistent data everywhere

**BUT - Changes require graceful restart:**
- âš ï¸ Scanner loads config at initialization
- âš ï¸ Strategies run in memory
- âš ï¸ Must restart to pick up changes
- âœ… Graceful restart system handles this safely

**To make changes:**
1. Edit in Config Dashboard
2. Preview changes
3. Apply changes (triggers restart)
4. Verify on all dashboards
5. System is now 100% synced âœ…

**Your system will always reach the same conclusion because everything reads from the same source!**



